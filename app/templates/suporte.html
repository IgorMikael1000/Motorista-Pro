{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* Estilos originais mantidos */
    .support-card { background: var(--glass-bg); backdrop-filter: var(--backdrop-blur); border: var(--glass-border); border-radius: 24px; padding: 25px; margin-bottom: 20px; box-shadow: var(--glass-shadow); text-align: center; }
    .support-icon { width: 60px; height: 60px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: inline-flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px; }
    .contact-btn { display: flex; align-items: center; gap: 15px; background: white; padding: 16px; border-radius: 16px; margin-bottom: 12px; text-decoration: none; color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: transform 0.2s; border: 1px solid transparent; cursor: pointer; }
    .contact-btn:active { transform: scale(0.98); }
    .contact-btn.locked { background: #F1F5F9; color: var(--text-secondary); opacity: 0.8; border-color: rgba(0,0,0,0.05); }
    .contact-icon { font-size: 22px; width: 30px; text-align: center; }
    .wa-color { color: #25D366; } .email-color { color: #EA4335; }
    .locked .contact-icon { color: var(--text-secondary); filter: grayscale(1); }
    .contact-info h4 { margin: 0; font-size: 15px; font-weight: 700; }
    .contact-info p { margin: 2px 0 0 0; font-size: 12px; color: var(--text-secondary); }

    /* Lista de Tickets */
    .ticket-list { margin-top: 30px; }
    .ticket-item { background: rgba(255,255,255,0.5); padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
    .ticket-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
    .status-badge { padding: 2px 8px; border-radius: 10px; font-weight: 700; font-size: 10px; text-transform: uppercase; }
    .st-aberto { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .st-fechado { background: rgba(0,0,0,0.05); color: var(--text-secondary); }

    /* Modal de Chat */
    #chatModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
    .chat-card { background: var(--bg-body); width: 90%; max-width: 400px; height: 80vh; display: flex; flex-direction: column; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid var(--glass-border); overflow: hidden; }
    
    .chat-header { padding: 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    
    .msg-bubble { padding: 12px 16px; border-radius: 16px; max-width: 80%; font-size: 13px; line-height: 1.4; position: relative; }
    .msg-user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .msg-admin { align-self: flex-start; background: white; color: var(--text-main); border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    
    .chat-footer { padding: 15px; background: white; border-top: 1px solid #eee; }
    .chat-input-group { display: flex; gap: 10px; }
    .chat-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-family: inherit; font-size: 13px; background: #f9f9f9; }
    .chat-send { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    /* Modal Novo Ticket e Upsell (Mantidos) */
    #newTicketModal, #upsellModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
    .modal-card { background:var(--bg-body); width:90%; max-width:350px; padding:25px; border-radius:25px; }
    .upsell-card { width:90%; max-width:350px; text-align:center; padding:30px; background: white; border-radius: 25px; position: relative; }
    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/configuracoes" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Suporte</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Central de Ajuda</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">
    
    <div class="support-card">
        <div class="support-icon"><i class="fas fa-headset"></i></div>
        <h3 style="margin:0 0 10px 0; color:var(--text-main); font-size:18px;">Precisa de ajuda?</h3>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:25px; line-height:1.5;">
            Escolha o canal de atendimento. Membros Premium têm prioridade via WhatsApp.
        </p>
        
        {% if current_user.plan_type == 'basic' %}
            <div onclick="openUpsell()" class="contact-btn locked">
                <i class="fab fa-whatsapp contact-icon"></i>
                <div class="contact-info"><h4>WhatsApp Business</h4><p>Exclusivo para Premium <i class="fas fa-lock" style="font-size:10px; margin-left:5px;"></i></p></div>
            </div>
        {% else %}
            <a href="https://wa.me/5511991167709" target="_blank" class="contact-btn">
                <i class="fab fa-whatsapp contact-icon wa-color"></i>
                <div class="contact-info"><h4>WhatsApp Business</h4><p>Resposta rápida (Prioritário)</p></div>
                <i class="fas fa-chevron-right" style="margin-left:auto; color:var(--text-secondary); font-size:12px;"></i>
            </a>
        {% endif %}
        
        <a href="mailto:appmotoristapro@gmail.com" class="contact-btn">
            <i class="far fa-envelope contact-icon email-color"></i>
            <div class="contact-info"><h4>E-mail</h4><p>appmotoristapro@gmail.com</p></div>
            <i class="fas fa-chevron-right" style="margin-left:auto; color:var(--text-secondary); font-size:12px;"></i>
        </a>
    </div>

    <button onclick="openNewTicketModal()" class="btn" style="width:100%; border-radius:50px; padding:16px; background:var(--glass-bg); color:var(--primary); border:1px solid var(--primary);">
        <i class="fas fa-ticket-alt"></i> Abrir Chamado no App
    </button>

    <div class="ticket-list">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; padding:0 5px;">
            <span style="font-size:12px; font-weight:700; color:var(--text-secondary); text-transform:uppercase;">Seus Chamados</span>
        </div>
        
        {% if tickets %}
            {% for t in tickets %}
            <!-- CORREÇÃO ITEM 4: Chama openChat com ID e Dados -->
            <div class="ticket-item" onclick="openChat('{{ t.id }}', '{{ t.motivo }}', '{{ t.status }}')">
                <div class="ticket-header">
                    <span style="font-weight:700;">#{{ t.id }} - {{ t.motivo }}</span>
                    <span class="status-badge {{ 'st-aberto' if t.status == 'Aberto' else 'st-fechado' }}">{{ t.status }}</span>
                </div>
                <p style="margin:0; font-size:12px; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ t.messages[-1].message if t.messages else t.mensagem }}
                </p>
                <!-- Armazena mensagens ocultas para o JS carregar no modal -->
                <div id="msgs-{{ t.id }}" style="display:none;">
                    <div class="msg-bubble msg-user">{{ t.mensagem }}</div>
                    {% for m in t.messages %}
                        <div class="msg-bubble {{ 'msg-user' if m.sender_type == 'user' else 'msg-admin' }}">
                            {{ m.message }}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align:center; color:var(--text-secondary); font-size:12px; opacity:0.6; margin-top:20px;">Nenhum chamado aberto.</div>
        {% endif %}
    </div>

</div>

<!-- MODAL CHAT (FUNCIONAL) -->
<div id="chatModal">
    <div class="chat-card">
        <div class="chat-header">
            <div>
                <h4 style="margin:0; font-size:14px; color:var(--text-main);" id="chatTitle">Chamado</h4>
                <span id="chatStatus" style="font-size:10px; color:var(--text-secondary);"></span>
            </div>
            <button onclick="document.getElementById('chatModal').style.display='none'" style="background:none; border:none; font-size:24px; color:var(--text-secondary); cursor:pointer;">&times;</button>
        </div>
        <div class="chat-body" id="chatBody"></div>
        
        <div class="chat-footer" id="chatFooter">
            <form id="replyForm" method="POST" class="chat-input-group">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="text" name="mensagem" class="chat-input" placeholder="Escreva uma resposta..." required>
                <button type="submit" class="chat-send"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
</div>

<!-- MODAL NOVO TICKET -->
<div id="newTicketModal">
    <div class="modal-card" style="box-shadow:0 20px 60px rgba(0,0,0,0.3); border:1px solid var(--glass-border);">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3 style="margin:0; font-size:18px; color:var(--text-main);">Novo Chamado</h3>
            <button onclick="document.getElementById('newTicketModal').style.display='none'" style="background:none; border:none; font-size:24px; color:var(--text-secondary); cursor:pointer;">&times;</button>
        </div>
        <form action="/suporte/novo" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">ASSUNTO</label>
            <select name="motivo" required style="width:100%; padding:12px; border-radius:12px; border:none; background:rgba(0,0,0,0.05); margin-bottom:15px; color:var(--text-main); font-weight:600;">
                <option value="Dúvida Financeira">Financeiro</option>
                <option value="Problema Técnico">Erro no App</option>
                <option value="Sugestão">Sugestão</option>
            </select>
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">MENSAGEM</label>
            <textarea name="mensagem" rows="4" placeholder="Descreva aqui..." required style="width:100%; padding:15px; border-radius:15px; border:none; background:rgba(0,0,0,0.05); color:var(--text-main); resize:none; margin-bottom:20px;"></textarea>
            <button type="submit" class="btn" style="width:100%; border-radius:50px; padding:15px;">Enviar</button>
        </form>
    </div>
</div>

<!-- MODAL UPSELL -->
<div id="upsellModal">
    <div class="upsell-card">
        <button class="close-modal" onclick="document.getElementById('upsellModal').style.display='none'">&times;</button>
        <div style="width:70px; height:70px; background:rgba(37, 211, 102, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto; color:#25D366; font-size:30px;">
            <i class="fab fa-whatsapp"></i>
        </div>
        <h3 style="margin:0 0 10px 0; color:var(--text-main); font-size:20px; font-weight:800;">Suporte VIP</h3>
        <p style="font-size:14px; color:var(--text-secondary); margin-bottom:25px; line-height:1.5;">O atendimento via WhatsApp é exclusivo para membros Premium. Garanta prioridade na fila.</p>
        <a href="/assinar?plan=premium" class="btn" style="border-radius:50px; background:var(--primary); box-shadow: 0 10px 30px rgba(37,99,235,0.4);">Quero ser VIP</a>
    </div>
</div>

<script>
    function openNewTicketModal() { document.getElementById('newTicketModal').style.display = 'flex'; }
    function openUpsell() { document.getElementById('upsellModal').style.display = 'flex'; }
    
    // Função para abrir o chat real
    function openChat(id, motivo, status) {
        document.getElementById('chatTitle').innerText = motivo;
        document.getElementById('chatStatus').innerText = status;
        
        // Pega mensagens escondidas no HTML
        const msgs = document.getElementById('msgs-' + id).innerHTML;
        const body = document.getElementById('chatBody');
        body.innerHTML = msgs;
        
        // Scroll para o fim
        body.scrollTop = body.scrollHeight;
        
        // Configura form
        const form = document.getElementById('replyForm');
        const footer = document.getElementById('chatFooter');
        
        if (status === 'Encerrado' || status === 'Solucionado') {
            footer.style.display = 'none'; // Não responde a tickets fechados
        } else {
            footer.style.display = 'block';
            form.action = `/suporte/responder/${id}`;
        }
        
        document.getElementById('chatModal').style.display = 'flex';
    }
</script>
{% endblock %}



