<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEO Dashboard - Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4318FF; --secondary: #A3AED0; --success: #05CD99; --warning: #FFB547; --danger: #EE5D50; --bg: #F4F7FE; --card: #FFFFFF; --text: #2B3674; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { margin: 0; font-size: 24px; font-weight: 700; }
        .btn-back { background: var(--card); color: var(--text); padding: 10px 20px; border-radius: 12px; text-decoration: none; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; align-items: center; gap: 5px; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .kpi-title { font-size: 12px; color: var(--secondary); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .kpi-val { font-size: 28px; font-weight: 800; color: var(--text); }
        .kpi-sub { font-size: 11px; color: var(--secondary); margin-top: 5px; font-weight: 500; }
        .kpi-icon { position: absolute; right: 20px; top: 20px; font-size: 35px; opacity: 0.1; }

        .card-mrr { border-left: 5px solid var(--success); }
        .card-risk { border-left: 5px solid var(--danger); }
        
        .breakdown-row { display: flex; gap: 15px; font-size: 11px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
        .bd-item { display: flex; align-items: center; gap: 5px; font-weight: 600; }
        
        .section-title { font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 15px; margin-top: 30px; display:flex; justify-content:space-between; align-items:center; }

        .chart-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); height: 350px; display: flex; flex-direction: column; }
        .chart-title { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 20px; flex-shrink: 0; }
        .chart-wrapper { flex: 1; position: relative; min-height: 0; width: 100%; }

        .ranking-list { background: var(--card); border-radius: 20px; padding: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .ranking-item:last-child { border-bottom: none; }
        .rank-pos { width: 30px; height: 30px; background: #E9EDF7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); margin-right: 15px; }
        .rank-pos.gold { background: #FFD700; color: white; }
        .rank-info h4 { margin: 0; font-size: 14px; font-weight: 700; }
        .rank-info p { margin: 2px 0 0 0; font-size: 11px; color: var(--secondary); }
        .rank-value { font-weight: 800; color: var(--success); }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Painel Executivo</h1>
            <p style="margin:0; font-size:12px; color:var(--secondary);">Métricas de Negócio em Tempo Real</p>
        </div>
        <a href="/admin/dashboard" class="btn-back"><i class="fas fa-arrow-left"></i> Gestão Operacional</a>
    </div>

    <!-- ROW 1: RECEITA -->
    <div class="kpi-grid">
        <div class="kpi-card card-mrr">
            <div class="kpi-title">MRR Líquido (Mensal)</div>
            <div class="kpi-val">R$ {{ "%.2f"|format(mrr_liquido) }}</div>
            <div class="breakdown-row">
                <span class="bd-item" style="color: #64748B;"><i class="fas fa-user"></i> Basic: R$ {{ "%.2f"|format(mrr_basic) }}</span>
                <span class="bd-item" style="color: var(--primary);"><i class="fas fa-crown"></i> Pro: R$ {{ "%.2f"|format(mrr_premium) }}</span>
            </div>
            <i class="fas fa-chart-line kpi-icon" style="color:var(--success);"></i>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-title">Assinantes Ativos</div>
            <div class="kpi-val">{{ count_basic + count_premium }}</div>
            <div class="breakdown-row">
                <span class="bd-item">{{ count_basic }} Basic</span>
                <span class="bd-item">{{ count_premium }} Premium</span>
            </div>
            <i class="fas fa-users kpi-icon" style="color:var(--primary);"></i>
        </div>

        <div class="kpi-card">
            <div class="kpi-title">ARR Projetado (Anual)</div>
            <div class="kpi-val">R$ {{ "%.2f"|format(arr) }}</div>
            <div class="kpi-sub">Baseado no MRR atual</div>
            <i class="fas fa-globe kpi-icon" style="color:#9C27B0;"></i>
        </div>
        
        <div class="kpi-card card-risk">
            <div class="kpi-title">Risco de Churn</div>
            <div class="kpi-val" style="color:var(--danger);">{{ qtd_risco }}</div>
            <div class="kpi-sub">Assinantes inativos > 7 dias</div>
            <i class="fas fa-exclamation-triangle kpi-icon" style="color:var(--danger);"></i>
        </div>
    </div>

    <!-- ROW 2: OPERACIONAL -->
    <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr;">
        <div class="kpi-card">
            <div class="kpi-title">LTV (Valor Vitalício)</div>
            <div class="kpi-val">R$ {{ "%.2f"|format(ltv) }}</div>
            <i class="fas fa-gem kpi-icon" style="color:#E91E63;"></i>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Stickiness (Engajamento)</div>
            <div class="kpi-val">{{ "%.1f"|format(stickiness) }}%</div>
            <i class="fas fa-magnet kpi-icon" style="color:var(--warning);"></i>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Ganho Médio/KM (Plataforma)</div>
            <div class="kpi-val">R$ {{ "%.2f"|format(media_reais_km) }}</div>
            <i class="fas fa-tachometer-alt kpi-icon" style="color:#607D8B;"></i>
        </div>
    </div>

    <!-- ROW 3: GRÁFICOS -->
    <div class="chart-row">
        <div class="chart-container">
            <div class="chart-title">Distribuição de Planos</div>
            <div class="chart-wrapper">
                <canvas id="planChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Origem de Ganhos (Market Share)</div>
            <div class="chart-wrapper">
                <canvas id="shareChart"></canvas>
            </div>
        </div>
    </div>

    <div class="section-title">
        <span>Crescimento (Novos Usuários - 15 dias)</span>
    </div>
    <div class="chart-container" style="height: 280px; margin-bottom: 30px;">
        <div class="chart-wrapper">
            <canvas id="growthChart"></canvas>
        </div>
    </div>

    <div class="section-title">
        <span>Top 5 Power Users</span>
    </div>
    <div class="ranking-list">
        {% for u in top_users %}
        <div class="ranking-item">
            <div style="display:flex; align-items:center;">
                <div class="rank-pos {{ 'gold' if loop.index == 1 else '' }}">{{ loop.index }}</div>
                <div class="rank-info">
                    <h4>{{ u.nome }}</h4>
                    <p>{{ u.email }}</p>
                </div>
            </div>
            <div style="text-align:right;">
                <div class="rank-value">R$ {{ "%.2f"|format(u.total_ganho) }}</div>
                <div style="font-size:10px; color:var(--secondary);">{{ u.dias_uso }} dias lançados</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        Chart.defaults.font.family = "'Outfit', sans-serif";
        Chart.defaults.color = '#A3AED0';
        Chart.defaults.maintainAspectRatio = false;

        // 1. Plan Distribution (NOVO)
        new Chart(document.getElementById('planChart'), {
            type: 'doughnut',
            data: {
                labels: ['Basic (R$ 9,90)', 'Premium (R$ 19,90)'],
                datasets: [{
                    data: [{{ count_basic }}, {{ count_premium }}],
                    backgroundColor: ['#94A3B8', '#4318FF'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                cutout: '65%',
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } }
            }
        });

        // 2. Growth Chart
        new Chart(document.getElementById('growthChart'), {
            type: 'line',
            data: {
                labels: {{ growth_labels|tojson }},
                datasets: [{
                    label: 'Novos Cadastros',
                    data: {{ growth_values|tojson }},
                    borderColor: '#4318FF',
                    backgroundColor: 'rgba(67, 24, 255, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#4318FF'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { borderDash: [5, 5] } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 3. Market Share
        new Chart(document.getElementById('shareChart'), {
            type: 'pie',
            data: {
                labels: ['Uber', '99', 'Particular', 'Outros'],
                datasets: [{
                    data: {{ share_data|tojson }},
                    backgroundColor: ['#000000', '#FFBB00', '#05CD99', '#4318FF'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8, font: { size: 11 } } } }
            }
        });
    </script>
</body>
</html>


