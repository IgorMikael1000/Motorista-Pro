Projeto exportado de: /data/data/com.termux/files/home/motoristaproteste
==================================================


==================== INICIO ARQUIVO: run.py ====================
from app import create_app

app = create_app()

if __name__ == '__main__':
    # Em produ√ß√£o (Render), debug deve ser False para seguran√ßa.
    # No Codespace, voc√™ pode mudar temporariamente para True se precisar.
    app.run(host='0.0.0.0', port=5000, debug=False)



==================== FIM ARQUIVO: run.py ====================

==================== INICIO ARQUIVO: requirements.txt ====================
Flask
Flask-SQLAlchemy
Flask-Login
Flask-Migrate
Flask-WTF
Flask-Limiter
gunicorn
psycopg2-binary
firebase-admin
stripe
mercadopago
email_validator
sentry-sdk[flask]
blinker
pytest

==================== FIM ARQUIVO: requirements.txt ====================

--- ESQUEMA DO BANCO DE DADOS (motorista_local.db) ---
CREATE TABLE alembic_version (
	version_num VARCHAR(32) NOT NULL, 
	CONSTRAINT alembic_version_pkc PRIMARY KEY (version_num)
);
------------------------------------------


==================== INICIO ARQUIVO: gunicorn_config.py ====================
import os

# Configura√ß√µes para Render Free Tier (512MB RAM)
# F√≥rmula segura: (2 x NUM_CORES) + 1, mas limitado pela RAM
# 2 workers √© o ideal para 512MB. Mais que isso arrisca "Out of Memory"
workers = 2 

# Threads ajudam a processar requisi√ß√µes IO-bound (banco de dados)
# sem consumir tanta mem√≥ria quanto processos separados.
threads = 4 

worker_class = 'gthread' 

# Timeout aumentado para lidar com "cold starts" do Render (hiberna√ß√£o)
timeout = 120 
keepalive = 5

# Logs direcionados para a sa√≠da padr√£o (stdout) para o painel do Render capturar
accesslog = '-'
errorlog = '-'
loglevel = 'info'

# Preload para carregar a app antes de fazer o fork dos workers (economiza RAM)
preload_app = True

def on_starting(server):
    print("üöÄ Gunicorn iniciando: Configura√ß√£o Otimizada para Render (Low RAM)")



==================== FIM ARQUIVO: gunicorn_config.py ====================

==================== INICIO ARQUIVO: CHANGELOG.md ====================
Changelog
Todas as altera√ß√µes not√°veis neste projeto ser√£o documentadas neste arquivo.
O formato baseia-se em Keep a Changelog,
e este projeto adere ao versionamento sem√¢ntico.
‚Äã‚Äã[v13.2.0-onboarding] - 19-12-2025 (CURRENT)
‚ÄãMelhorias na experi√™ncia de primeiro acesso e corre√ß√µes visuais.
‚Äãüåü Experi√™ncia do Utilizador (UX)
‚ÄãOnboarding Inteligente: Adicionados modais explicativos autom√°ticos na primeira visita a cada tela importante (Hist√≥rico, Agenda, Lucro Real, etc.), guiando o novo utilizador.
‚ÄãTela de Boas-Vindas: Redesign completo com visual moderno, √≠cone 3D e destaque dos benef√≠cios chave.
‚ÄãTour Guiado: Corre√ß√£o na biblioteca de tour para garantir que o guia passo-a-passo apare√ßa corretamente no primeiro login.
‚ÄãCookies: Banner de consentimento LGPD implementado e vis√≠vel.
‚Äã‚öôÔ∏è Ajustes e Corre√ß√µes
‚ÄãPer√≠odo de Teste: Ajustado de 6 para 7 dias completos de Trial.
‚ÄãTag Premium: O menu lateral agora diferencia visualmente quem est√° em "Teste Gr√°tis" (Tag Azul/Roxo) de quem √© "Assinante Premium" (Tag Dourada).
‚ÄãBackup: Bot√µes de Exportar/Importar dados restaurados na tela de Configura√ß√µes.
‚ÄãSemanas: Calend√°rio ajustado para considerar semanas de Domingo a S√°bado, alinhado com o padr√£o de pagamentos dos aplicativos.
[v13.1.0-launch-ready] - 19-12-2025 (VERS√ÉO DE LAN√áAMENTO)
‚ÄãVers√£o final polida e otimizada para produ√ß√£o em massa. Foco total em performance de base de dados, SEO e conformidade legal.
‚ÄãüöÄ Performance & Infraestrutura
‚Äã√çndices de Base de Dados: Adicionados √≠ndices estrat√©gicos (index=True) em todas as colunas de alta frequ√™ncia (user_id, data, email, status). Isso garante consultas instant√¢neas mesmo com milhares de registos.
‚ÄãCache Busting Autom√°tico: Implementado sistema inteligente que adiciona ?v=v13.1 a todos os ficheiros CSS e JS. Os utilizadores nunca mais ver√£o vers√µes antigas/quebradas do app ap√≥s uma atualiza√ß√£o.
‚ÄãRefatora√ß√£o de C√≥digo: Cria√ß√£o do Blueprint dashboard.py para desacoplar a l√≥gica pesada de c√°lculo financeiro das rotas de CRUD (main.py), facilitando manuten√ß√£o futura.
‚Äãüõ°Ô∏è Seguran√ßa & Conformidade
‚ÄãAviso de Cookies: Adicionado banner de consentimento (LGPD/GDPR) para conformidade legal no primeiro acesso.
‚ÄãRobots.txt: Configura√ß√£o de SEO para impedir que o Google indexe p√°ginas privadas (admin, hist√≥rico) e foque apenas na Landing Page.
‚ÄãSanitiza√ß√£o: Remo√ß√£o de scripts de depura√ß√£o (debug_urls.py, force_fix.py) da √°rvore de produ√ß√£o.
‚Äãüì± Experi√™ncia do Utilizador (UX)
‚ÄãCarregamento Otimizado: Gamifica√ß√£o agora √© calculada apenas em eventos de escrita (Salvar/Editar), removendo a lat√™ncia no carregamento do Dashboard.
‚ÄãFeedback Visual: Indicadores de carregamento refinados para opera√ß√µes ass√≠ncronas.
[v12.1.0-polish] - 19-12-2025 (CURRENT)
Refinamento final de funcionalidades e experi√™ncia do utilizador.
üõ†Ô∏è Funcionalidades e Melhorias
 * Manuten√ß√£o Completa: Agora, ao concluir uma manuten√ß√£o, o sistema solicita tamb√©m o Valor do Servi√ßo (R$), al√©m da quilometragem, permitindo um hist√≥rico financeiro exato no Livro de Revis√µes.
 * Interface (UI):
   * T√≠tulo da sec√ß√£o de configura√ß√£o alterado para "Custo Fixo" (mais direto).
   * Aviso informativo adicionado na tela de Lucro Real: "Os valores apresentados referem-se ao per√≠odo selecionado".
   * Identidade Premium: Utilizadores PRO t√™m destaque visual elegante na barra lateral (Badge PRO) sem elementos excessivos.
[v12.0.0-business-class] - 18-12-2025 (MAJOR RELEASE)
Transforma√ß√£o do app num sistema completo de gest√£o de frota pessoal.
üíº Gest√£o de Custos Fixos (Premium)
 * Controle Empresarial: Nova sec√ß√£o nas configura√ß√µes do ve√≠culo para lan√ßar custos recorrentes que n√£o dependem da rodagem:
   * Seguro (Mensal)
   * IPVA (Anual)
   * Aluguel (Semanal)
   * Financiamento (Mensal)
 * Reserva Operacional: O c√°lculo do Lucro Real agora deduz automaticamente estes custos (pro-rata dia) al√©m dos custos vari√°veis (pneus/√≥leo), oferecendo a vis√£o financeira mais precisa do mercado.
 * Toggle Inteligente: Op√ß√£o na tela de Lucro Real para ativar/desativar a dedu√ß√£o dos custos fixos na visualiza√ß√£o dos dados.
üí≤ Vendas
 * Lista de Benef√≠cios: Atualizada a tela de assinatura para destacar a gest√£o de custos fixos e o livro de revis√µes.
[v11.1.0-premium-plus] - 18-12-2025 (FEATURE PACK)
Refinamento da identidade visual e documentos.
‚ú® Novidades
 * Livro de Revis√µes Digital (PDF): Exporta√ß√£o do hist√≥rico completo de manuten√ß√£o em formato PDF profissional.
 * Marca d'√Ågua: Autenticidade garantida em todos os documentos gerados (Relat√≥rios e Recibos) com a marca oficial do app.
 * Ajuste de Quilometragem: Edi√ß√£o manual do od√≥metro ao finalizar servi√ßos de manuten√ß√£o para corrigir diverg√™ncias entre o GPS e o painel do carro.
[v11.0.0-social] - 18-12-2025 (FEATURE UPDATE)
Implementa√ß√£o de autentica√ß√£o moderna e rebranding.
üöÄ Acesso
 * Login Social (Google): Cadastro e Login com 1 clique (sem senha).
 * Gest√£o H√≠brida de Imagens: Suporte simult√¢neo a fotos do Google e uploads manuais (ImgBB).
 * Branding: √çcones gen√©ricos substitu√≠dos pela logomarca oficial em todo o fluxo de entrada e nova Landing Page focada em convers√£o mobile.
[v10.1.0-release] - 18-12-2025 (STABILITY PATCH)
Estabilidade de Infraestrutura.
üêõ Corre√ß√µes
 * PIX Dev: Supress√£o de webhook em ambiente local (localhost) para permitir testes de gera√ß√£o de QR Code sem erros do Mercado Pago.
 * Rotas: Corre√ß√£o de erro 404 na rota /assinar.
 * Stripe: Leitura din√¢mica de IDs de cup√£o via vari√°veis de ambiente.
 * Limpeza: Remo√ß√£o de ferramentas de depura√ß√£o (bot√µes de teste) da interface final.
[v10.0.0-security] - 18-12-2025 (MAJOR UPDATE)
Blindagem de seguran√ßa e precis√£o matem√°tica.
üõ°Ô∏è Seguran√ßa
 * Credenciais: Remo√ß√£o de todas as URLs de banco de dados e senhas do c√≥digo fonte.
 * Admin: Senha administrativa agora exige configura√ß√£o via Vari√°vel de Ambiente.
 * Infra: Modo Debug for√ßado para False em produ√ß√£o.
üí∞ Precis√£o Financeira
 * Core: Migra√ß√£o total de Float para Decimal em todo o sistema financeiro para precis√£o absoluta de centavos.
 * Webhooks: Convers√£o segura de valores monet√°rios na confirma√ß√£o de pagamento (Stripe/MP).
‚ö° Performance
 * Render Otimizado: Configura√ß√£o do Gunicorn ajustada com threads e 2 workers para baixo consumo de mem√≥ria (512MB).
 * BI R√°pido: Dashboard administrativo reescrito com agrega√ß√µes SQL, corrigindo problemas de lentid√£o (N+1).
[v9.2.0-hotfix] - 18-12-2025
Corrigido
 * Rotas: Restauradas as rotas /gerenciar_assinatura e /relatorios que estavam inacess√≠veis.
 * Hist√≥rico: Implementada restri√ß√£o no backend para que utilizadores Basic recebam apenas os registos dos √∫ltimos 30 dias.
Melhorado (UX)
 * Agenda: Bot√£o "Concluir" restaurado para todos os utilizadores. Gatilho de Upsell movido para a gera√ß√£o de recibo.
[v9.1.0-hotfix] - 18-12-2025
Corrigido
 * Rotas Cr√≠ticas: Corre√ß√£o de erro 404 ao salvar meta e acessar "Meu Plano".
 * Hist√≥rico de Manuten√ß√£o: A aba "Livro de Revis√µes" agora exibe corretamente a lista de manuten√ß√µes passadas.
 * Dev Tools: Adicionado bot√£o tempor√°rio para alternar planos em desenvolvimento.
[v9.0.0-hotfix] - 18-12-2025
Corrigido
 * Base de Dados: Adicionado modelo MaintenanceLog.
 * Login: Refor√ßada a valida√ß√£o do FIREBASE_CONFIG_FRONTEND.
 * Metas: L√≥gica ajustada para considerar Lucro Operacional.
Melhorado
 * Manuten√ß√£o: Alertas nativos substitu√≠dos por modais SweetAlert2.
 * Suporte: Sistema de Chat ativado.
[v8.0.0-production] - 17-12-2025 (GO LIVE)
Sistema
 * Base de Dados: Migra√ß√£o estrutural para Postgres e suporte a m√∫ltiplos planos.
 * Migra√ß√£o: Assinantes antigos migrados para Premium.
 * Pagamentos: Webhooks reais implementados.
[v7.0.0-hotfix] - 17-12-2025
Adicionado
 * BI: Painel administrativo com c√°lculo de MRR e LTV.
 * Admin: M√©tricas de contagem de assinantes.
[v6.0.0-hotfix] - 17-12-2025
Alterado
 * Metas: Reformula√ß√£o da "Meta Inteligente" com objectivo di√°rio din√¢mico.
[v5.7.0] a [v5.0.0] - 17-12-2025
Interface e Upsell
 * Agenda: Barra de pesquisa instant√¢nea.
 * UX Relat√≥rios: Modais de Upsell estilizados ("Glassmorphism").
 * Upsell Recibos: Gatilho movido para conclus√£o.
 * Upsell Lucro Real: Bloqueio duplo na sec√ß√£o "Custo Invis√≠vel".
 * Lan√ßamentos: Tela redesenhada.
 * Hist√≥rico: Pagina√ß√£o HTMX.
 * Assinatura: Redesign completo da tela de pagamento.
[v4.0.0-hotfix] - 17-12-2025
Adicionado
 * Relat√≥rios: Gerador de PDF Operacional.
 * Gr√°ficos: Gr√°fico de Rosca (Volume de Corridas).
[v3.0.0-hotfix] - 17-12-2025
Adicionado
 * Gamifica√ß√£o: Sistema de Conquistas e "Lenda Viva".
 * Suporte: Bot√£o WhatsApp VIP.
 * UX: Efeito de desfoque no bloqueio de Lucro Real.
[v2.0.0] - 17-12-2025
Crescimento
 * Indica√ß√£o: Sistema "Indique e Ganhe" com c√≥digos √∫nicos.
 * Pagamento: Rota mock para testes iniciais.
[v1.0.0-hotfix] - 17-12-2025
Lan√ßamento
 * Corre√ß√µes: Trial de 7 dias exactos, Notifica√ß√µes semanais.
 * MVP: Funcionalidades base de lan√ßamento.


==================== FIM ARQUIVO: CHANGELOG.md ====================

==================== INICIO ARQUIVO: ‚Äãupdate_site_ocr.py ====================
import os
import subprocess

# --- 1. ATUALIZAR ROTA NO BACKEND (main.py) ---
# Adiciona a l√≥gica para salvar as configura√ß√µes do OCR
main_route_path = "app/routes/main.py"

with open(main_route_path, 'r', encoding='utf-8') as f:
    main_content = f.read()

# Verifica se j√° temos a rota de salvar OCR, se n√£o, adicionamos
if "save_ocr_settings" not in main_content:
    # Procura o final do arquivo ou um bom lugar para inserir
    insert_point = main_content.rfind("@bp.route") # Insere antes da √∫ltima rota ou no fim
    
    new_route_code = """
@bp.route('/save_ocr_settings', methods=['POST'], endpoint='save_ocr_settings')
@login_required
def save_ocr_settings():
    if current_user.plan_type != 'premium': return jsonify({'error': 'Premium required'}), 403
    try:
        data = request.get_json()
        # Salva as configura√ß√µes no banco
        set_config(current_user.id, 'ocr_good_km', data.get('good_km', '2.0'))
        set_config(current_user.id, 'ocr_medium_km', data.get('medium_km', '1.5'))
        set_config(current_user.id, 'ocr_good_hour', data.get('good_hour', '60.0'))
        set_config(current_user.id, 'ocr_medium_hour', data.get('medium_hour', '40.0'))
        return jsonify({'status': 'ok'})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

"""
    # Adicionamos antes da √∫ltima rota encontrada ou no final
    if insert_point != -1:
        main_content = main_content[:insert_point] + new_route_code + main_content[insert_point:]
    else:
        main_content += new_route_code

    with open(main_route_path, 'w', encoding='utf-8') as f:
        f.write(main_content)
    print("‚úÖ Rota '/save_ocr_settings' adicionada ao main.py")

# --- 2. RECRIAR A TELA HTML (ocr_page.html) ---
html_path = "app/templates/ocr_page.html"
html_content = """{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* Estilos Gerais */
    .ocr-container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
    
    /* UPSELL (BASIC) */
    .upsell-hero {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 30px; padding: 40px 25px; text-align: center; color: white;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
        position: relative; overflow: hidden;
    }
    .upsell-icon { font-size: 50px; color: #F59E0B; margin-bottom: 20px; animation: float 3s ease-in-out infinite; }
    .btn-upgrade {
        background: linear-gradient(90deg, #F59E0B 0%, #D97706 100%);
        color: white; font-weight: 800; padding: 18px 30px; border-radius: 50px;
        text-decoration: none; display: inline-block; margin-top: 25px;
        box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
    }
    
    /* PREMIUM VIEW */
    .premium-header { text-align: center; margin-bottom: 30px; }
    .premium-header h2 { margin: 0; color: var(--text-main); font-size: 22px; font-weight: 800; }
    .premium-header p { color: var(--text-secondary); font-size: 14px; }

    .download-card {
        background: white; border-radius: 25px; padding: 30px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }
    .btn-download {
        background: var(--primary); color: white; width: 100%; padding: 18px;
        border-radius: 18px; font-weight: 800; font-size: 16px; text-decoration: none;
        display: flex; align-items: center; justify-content: center; gap: 10px;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); transition: transform 0.2s;
    }
    .btn-download:active { transform: scale(0.98); }
    
    .install-steps { text-align: left; margin-top: 20px; font-size: 13px; color: var(--text-secondary); background: #F8FAFC; padding: 15px; border-radius: 15px; }
    .install-steps ol { padding-left: 20px; margin: 0; }
    .install-steps li { margin-bottom: 8px; }

    /* CONFIGURA√á√ÉO */
    .config-toggler {
        background: white; border: 1px solid rgba(0,0,0,0.1); color: var(--text-main);
        width: 100%; padding: 15px; border-radius: 15px; font-weight: 700; cursor: pointer;
        display: flex; justify-content: space-between; align-items: center;
    }
    .config-panel { display: none; background: white; padding: 20px; border-radius: 20px; margin-top: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
    
    .range-group { margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
    .range-title { font-size: 12px; font-weight: 800; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 15px; display: block; }
    
    .input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .input-label { flex: 1; font-size: 13px; font-weight: 600; color: var(--text-main); }
    .input-field { width: 80px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; text-align: center; font-weight: 700; color: var(--primary); }
    
    .badge-good { background: #DCFCE7; color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; }
    .badge-mid { background: #FEF3C7; color: #92400E; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; }
    .badge-bad { background: #FEE2E2; color: #991B1B; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; }

    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Extens√£o</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Monitoramento Autom√°tico</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in ocr-container" style="padding-top: 20px;">

    <!-- L√ìGICA DE EXIBI√á√ÉO -->
    {% if current_user.plan_type == 'basic' %}
    
        <!-- VIS√ÉO BASIC (UPSELL) -->
        <div class="upsell-hero">
            <i class="fas fa-robot upsell-icon"></i>
            <h2 style="margin:0 0 10px 0; font-size: 24px;">Piloto Autom√°tico</h2>
            <p style="font-size: 14px; line-height: 1.6; opacity: 0.9;">
                O Monitoramento Din√¢mico l√™ a tela do seu celular e calcula instantaneamente se uma corrida vale a pena.
            </p>
            <ul style="text-align: left; margin: 25px 0; padding: 0 15px; list-style: none; font-size: 13px;">
                <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #F59E0B; margin-right: 8px;"></i> Leitura de R$/KM e R$/Hora</li>
                <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #F59E0B; margin-right: 8px;"></i> Alerta Verde/Amarelo/Vermelho</li>
                <li><i class="fas fa-check" style="color: #F59E0B; margin-right: 8px;"></i> Foco total no tr√¢nsito</li>
            </ul>
            <a href="/assinar" class="btn-upgrade">
                QUERO SER PREMIUM <i class="fas fa-arrow-right"></i>
            </a>
        </div>

    {% else %}

        <!-- VIS√ÉO PREMIUM (DOWNLOAD & CONFIG) -->
        <div class="premium-header">
            <div style="width: 60px; height: 60px; background: rgba(37,99,235,0.1); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; color: var(--primary); margin-bottom: 15px;">
                <i class="fas fa-eye"></i>
            </div>
            <h2>Monitoramento Ativo</h2>
            <p>Seu assistente virtual para Uber e 99.</p>
        </div>

        <!-- 1. DOWNLOAD -->
        <div class="download-card">
            <h3 style="margin:0 0 15px 0; font-size:16px; color:var(--text-main);">Instalar Aplicativo</h3>
            
            <a href="{{ url_for('static', filename='motoristapro-ocr.apk') }}" class="btn-download" download>
                <i class="fab fa-android"></i> BAIXAR APK
            </a>
            
            <div class="install-steps">
                <b><i class="fas fa-info-circle"></i> Como instalar:</b>
                <ol>
                    <li>Toque no bot√£o acima para baixar.</li>
                    <li>Abra o arquivo baixado na barra de notifica√ß√µes.</li>
                    <li>Se o sistema pedir, permita instalar de <b>"Fontes Desconhecidas"</b>.</li>
                    <li>Abra o app e fa√ßa login.</li>
                </ol>
            </div>
        </div>

        <!-- 2. CONFIGURA√á√ÉO -->
        <button class="config-toggler" onclick="toggleConfig()">
            <span><i class="fas fa-sliders-h" style="color:var(--primary); margin-right:10px;"></i> Configurar Par√¢metros</span>
            <i class="fas fa-chevron-down" id="arrowIcon"></i>
        </button>

        <div id="configPanel" class="config-panel">
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:20px; line-height:1.4;">
                Defina os crit√©rios para o rob√¥ classificar as corridas.
            </p>

            <!-- R$/KM -->
            <div class="range-group">
                <span class="range-title">Crit√©rio: Valor por KM</span>
                
                <div class="input-row">
                    <span class="badge-good">√ìTIMO</span>
                    <span class="input-label">Acima de:</span>
                    <div style="position:relative;">
                        <span style="position:absolute; left:8px; top:11px; font-size:10px; color:#aaa;">R$</span>
                        <input type="number" id="good_km" class="input-field" step="0.1" placeholder="2.00">
                    </div>
                </div>
                
                <div class="input-row">
                    <span class="badge-mid">M√âDIO</span>
                    <span class="input-label">Entre √ìtimo e:</span>
                    <div style="position:relative;">
                        <span style="position:absolute; left:8px; top:11px; font-size:10px; color:#aaa;">R$</span>
                        <input type="number" id="medium_km" class="input-field" step="0.1" placeholder="1.50">
                    </div>
                </div>
                
                <div class="input-row" style="opacity:0.6;">
                    <span class="badge-bad">RUIM</span>
                    <span class="input-label">Abaixo do M√©dio</span>
                </div>
            </div>

            <!-- R$/HORA -->
            <div class="range-group" style="border:none;">
                <span class="range-title">Crit√©rio: Valor por Hora</span>
                
                <div class="input-row">
                    <span class="badge-good">√ìTIMO</span>
                    <span class="input-label">Acima de:</span>
                    <div style="position:relative;">
                        <span style="position:absolute; left:8px; top:11px; font-size:10px; color:#aaa;">R$</span>
                        <input type="number" id="good_hour" class="input-field" placeholder="60">
                    </div>
                </div>
                
                <div class="input-row">
                    <span class="badge-mid">M√âDIO</span>
                    <span class="input-label">Entre √ìtimo e:</span>
                    <div style="position:relative;">
                        <span style="position:absolute; left:8px; top:11px; font-size:10px; color:#aaa;">R$</span>
                        <input type="number" id="medium_hour" class="input-field" placeholder="40">
                    </div>
                </div>
            </div>

            <button onclick="saveSettings()" id="btnSave" class="btn" style="width:100%; border-radius:15px; padding:15px; box-shadow:0 8px 20px rgba(37,99,235,0.3);">
                SALVAR CONFIGURA√á√ÉO
            </button>
        </div>

    {% endif %}

</div>

{% if current_user.plan_type == 'premium' %}
<script>
    // Carregar configura√ß√µes atuais do banco (via JS injetado no template seria ideal, mas vamos usar localStorage ou defaults como fallback visual, e depois salvar no banco)
    // O ideal seria passar essas vari√°veis pelo render_template no backend. 
    // Como estamos editando apenas o template est√°tico, vamos assumir valores padr√£o ou carregar se poss√≠vel.
    
    // Simula√ß√£o de carregamento inicial (valores padr√£o)
    document.getElementById('good_km').value = '2.00';
    document.getElementById('medium_km').value = '1.50';
    document.getElementById('good_hour').value = '60.00';
    document.getElementById('medium_hour').value = '40.00';

    function toggleConfig() {
        const panel = document.getElementById('configPanel');
        const arrow = document.getElementById('arrowIcon');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
            arrow.className = 'fas fa-chevron-down';
        } else {
            panel.style.display = 'block';
            arrow.className = 'fas fa-chevron-up';
        }
    }

    function saveSettings() {
        const btn = document.getElementById('btnSave');
        const originalText = btn.innerText;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
        
        const data = {
            good_km: document.getElementById('good_km').value,
            medium_km: document.getElementById('medium_km').value,
            good_hour: document.getElementById('good_hour').value,
            medium_hour: document.getElementById('medium_hour').value
        };

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch('/save_ocr_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if(result.status === 'ok') {
                btn.innerHTML = '<i class="fas fa-check"></i> SUCESSO!';
                btn.style.background = '#10B981';
                
                // Se estiver rodando dentro do App Android, atualiza l√° tamb√©m em tempo real
                if (window.MotoristaProAndroid) {
                    window.MotoristaProAndroid.updateConfig(parseFloat(data.good_km), parseFloat(data.good_hour));
                }
                
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = '';
                    toggleConfig(); // Fecha o painel
                }, 2000);
            } else {
                alert('Erro ao salvar: ' + (result.error || 'Desconhecido'));
                btn.innerText = originalText;
            }
        })
        .catch(err => {
            console.error(err);
            alert('Erro de conex√£o.');
            btn.innerText = originalText;
        });
    }
</script>
{% endif %}
{% endblock %}
"""

with open(html_path, 'w', encoding='utf-8') as f:
    f.write(html_content)
print("‚úÖ Tela 'Monitoramento Din√¢mico' recriada com sucesso.")

# --- 3. GIT PUSH AUTOM√ÅTICO ---
def run_git():
    try:
        print("\nüì¶ Git: Preparando envio...")
        subprocess.run("git add .", shell=True, check=True)
        subprocess.run('git commit -m "Feat: Tela de Monitoramento com Upsell e Configura√ß√£o"', shell=True, check=True)
        subprocess.run("git push", shell=True, check=True)
        print("\nüöÄ Git Push realizado com sucesso!")
    except subprocess.CalledProcessError as e:
        print(f"\n‚ùå Erro no Git: {e}")

if __name__ == "__main__":
    run_git()



==================== FIM ARQUIVO: ‚Äãupdate_site_ocr.py ====================

==================== INICIO ARQUIVO: Robots.txt ====================
User-agent: *
Allow: /
Allow: /login
Allow: /register
Allow: /termos
Disallow: /admin/
Disallow: /historico
Disallow: /agenda
Disallow: /manutencao
Disallow: /configuracoes
Disallow: /relatorios
Sitemap: https://www.google.com/search?q=https://motorista-pro-app.onrender.com/sitemap.xml


==================== FIM ARQUIVO: Robots.txt ====================

--- ESQUEMA DO BANCO DE DADOS (motorista_saas.db) ---
CREATE TABLE user (
	id INTEGER NOT NULL, 
	email VARCHAR(150) NOT NULL, 
	nome VARCHAR(150), 
	password_hash VARCHAR(200) NOT NULL, 
	validade VARCHAR(20), 
	data_cadastro VARCHAR(20), 
	last_seen_version VARCHAR(20), 
	PRIMARY KEY (id), 
	UNIQUE (email)
);
CREATE TABLE diario (
	id INTEGER NOT NULL, 
	data VARCHAR(10) NOT NULL, 
	ganho_bruto FLOAT, 
	ganho_uber FLOAT, 
	ganho_99 FLOAT, 
	ganho_part FLOAT, 
	ganho_outros FLOAT, 
	despesa_combustivel FLOAT, 
	despesa_alimentacao FLOAT, 
	despesa_manutencao FLOAT, 
	qtd_uber INTEGER, 
	qtd_99 INTEGER, 
	qtd_part INTEGER, 
	qtd_outros INTEGER, 
	km_percorrido FLOAT, 
	horas_trabalhadas FLOAT, 
	user_id INTEGER NOT NULL, 
	PRIMARY KEY (id), 
	FOREIGN KEY(user_id) REFERENCES user (id)
);
CREATE TABLE agendamentos (
	id INTEGER NOT NULL, 
	cliente VARCHAR(100) NOT NULL, 
	data_hora VARCHAR(20), 
	origem VARCHAR(200), 
	destino VARCHAR(200), 
	valor FLOAT, 
	observacao TEXT, 
	status VARCHAR(20), 
	user_id INTEGER NOT NULL, 
	PRIMARY KEY (id), 
	FOREIGN KEY(user_id) REFERENCES user (id)
);
CREATE TABLE custos_fixos (
	id INTEGER NOT NULL, 
	nome VARCHAR(100) NOT NULL, 
	valor FLOAT NOT NULL, 
	tipo VARCHAR(20), 
	user_id INTEGER NOT NULL, 
	PRIMARY KEY (id), 
	FOREIGN KEY(user_id) REFERENCES user (id)
);
CREATE TABLE manutencao (
	id INTEGER NOT NULL, 
	item VARCHAR(100) NOT NULL, 
	km_troca FLOAT, 
	km_proxima FLOAT NOT NULL, 
	status VARCHAR(20), 
	user_id INTEGER NOT NULL, 
	PRIMARY KEY (id), 
	FOREIGN KEY(user_id) REFERENCES user (id)
);
CREATE TABLE config (
	id INTEGER NOT NULL, 
	chave VARCHAR(50) NOT NULL, 
	valor TEXT, 
	user_id INTEGER NOT NULL, 
	PRIMARY KEY (id), 
	FOREIGN KEY(user_id) REFERENCES user (id)
);
CREATE TABLE alembic_version (
	version_num VARCHAR(32) NOT NULL, 
	CONSTRAINT alembic_version_pkc PRIMARY KEY (version_num)
);
------------------------------------------


==================== INICIO ARQUIVO: migrations/env.py ====================
import logging
from logging.config import fileConfig

from flask import current_app

from alembic import context

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config

# Interpret the config file for Python logging.
# This line sets up loggers basically.
fileConfig(config.config_file_name)
logger = logging.getLogger('alembic.env')


def get_engine():
    try:
        # this works with Flask-SQLAlchemy<3 and Alchemical
        return current_app.extensions['migrate'].db.get_engine()
    except (TypeError, AttributeError):
        # this works with Flask-SQLAlchemy>=3
        return current_app.extensions['migrate'].db.engine


def get_engine_url():
    try:
        return get_engine().url.render_as_string(hide_password=False).replace(
            '%', '%%')
    except AttributeError:
        return str(get_engine().url).replace('%', '%%')


# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata
config.set_main_option('sqlalchemy.url', get_engine_url())
target_db = current_app.extensions['migrate'].db

# other values from the config, defined by the needs of env.py,
# can be acquired:
# my_important_option = config.get_main_option("my_important_option")
# ... etc.


def get_metadata():
    if hasattr(target_db, 'metadatas'):
        return target_db.metadatas[None]
    return target_db.metadata


def run_migrations_offline():
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url, target_metadata=get_metadata(), literal_binds=True
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online():
    """Run migrations in 'online' mode.

    In this scenario we need to create an Engine
    and associate a connection with the context.

    """

    # this callback is used to prevent an auto-migration from being generated
    # when there are no changes to the schema
    # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
    def process_revision_directives(context, revision, directives):
        if getattr(config.cmd_opts, 'autogenerate', False):
            script = directives[0]
            if script.upgrade_ops.is_empty():
                directives[:] = []
                logger.info('No changes in schema detected.')

    conf_args = current_app.extensions['migrate'].configure_args
    if conf_args.get("process_revision_directives") is None:
        conf_args["process_revision_directives"] = process_revision_directives

    connectable = get_engine()

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=get_metadata(),
            **conf_args
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

==================== FIM ARQUIVO: migrations/env.py ====================

==================== INICIO ARQUIVO: app/extensions.py ====================
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
from flask_migrate import Migrate
from flask_wtf.csrf import CSRFProtect
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

db = SQLAlchemy()
login_manager = LoginManager()
migrate = Migrate()
csrf = CSRFProtect()

# Configura√ß√£o de Limite de Requisi√ß√µes (Rate Limit)
# Aumentado para evitar bloqueios (429) durante testes e uso do PWA
limiter = Limiter(
    key_func=get_remote_address,
    default_limits=["20000 per day", "5000 per hour"], # Limites relaxados para produ√ß√£o
    storage_uri="memory://"
)



==================== FIM ARQUIVO: app/extensions.py ====================

==================== INICIO ARQUIVO: app/utils.py ====================
import re
import logging
from functools import wraps
from flask import redirect, url_for, session
from app.extensions import db
from datetime import datetime, date, timedelta
from decimal import Decimal, ROUND_HALF_UP, InvalidOperation

# Logger
logger = logging.getLogger(__name__)

# --- TIMEZONE BRAS√çLIA ---
def get_brasilia_now():
    """Retorna datetime atual em UTC-3 (Bras√≠lia)"""
    return datetime.utcnow() - timedelta(hours=3)

def to_brasilia(dt):
    """Converte um datetime UTC para Bras√≠lia (UTC-3)"""
    if not dt: return None
    if isinstance(dt, str): return dt
    return dt - timedelta(hours=3)

def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not session.get('is_admin'): return redirect(url_for('auth.admin_login'))
        return f(*args, **kwargs)
    return decorated_function

def safe_decimal(value):
    """
    Converte valor para Decimal (Financeiro) com alta robustez.
    """
    if value is None or value == '': 
        return Decimal('0.00')
    
    if isinstance(value, Decimal):
        return value
        
    if isinstance(value, (float, int)):
        return Decimal(str(value))

    try:
        val_str = str(value).strip().replace('R$', '').strip()
        if ',' in val_str and '.' in val_str:
            val_str = val_str.replace('.', '').replace(',', '.')
        elif ',' in val_str:
            val_str = val_str.replace(',', '.')
        return Decimal(val_str)
    except (ValueError, InvalidOperation):
        return Decimal('0.00')

def safe_money(value):
    """Retorna Decimal arredondado para 2 casas decimais (Dinheiro)."""
    d = safe_decimal(value)
    return d.quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)

def safe_float(value):
    try:
        dec = safe_decimal(value)
        return float(dec)
    except:
        return 0.0

def time_to_float(h, m):
    try: return int(h or 0) + (int(m or 0) / 60.0)
    except: return 0.0

def float_to_parts(val):
    if not val: return 0, 0
    h = int(val)
    m = int(round((val - h) * 60))
    return h, m

def get_config(user_id, key, default=''):
    from app.models import Config
    try: 
        cfg = Config.query.filter_by(user_id=user_id, chave=key).first()
        return cfg.valor if cfg else default
    except: return default

def set_config(user_id, key, val):
    from app.models import Config
    try:
        cfg = Config.query.filter_by(user_id=user_id, chave=key).first()
        if cfg: cfg.valor = str(val)
        else: db.session.add(Config(chave=key, valor=str(val), user_id=user_id))
        db.session.commit()
    except: pass

def init_user_configs(user):
    from app.models import Config
    try:
        # ATUALIZADO: Inclui financiamento
        default_configs = {
            'meta_mensal': '3000.00',
            'meta_semanal': '700.00',
            'preco_km': '2.00', 
            'preco_min': '0.20', 
            'taxa_base': '5.00', 
            'km_atual_carro': '0', 
            'veiculo_marca': '', 
            'veiculo_modelo': '', 
            'autonomia_kml': '10', 
            'preco_combustivel': '5.00', 
            'seguro_mensal': '0',
            'ipva_anual': '0',
            'aluguel_semanal': '0',
            'financiamento_mensal': '0', # Novo
            'depreciacao_km': '0.20', 
            'manutencao_km': '0.15', 
            'consumo_etanol': '7.0', 
            'consumo_gasolina': '10.0'
        }
        for k, v in default_configs.items(): 
            if not Config.query.filter_by(user_id=user.id, chave=k).first(): db.session.add(Config(chave=k, valor=v, user_id=user.id))
        db.session.commit()
    except: pass

# --- FILTROS TEMPLATE ---
def clean_phone_filter(s):
    if not s: return ""
    return re.sub(r'\D', '', str(s))

def float_to_time_filter(val):
    if not val: return "00:00"
    h = int(val)
    m = int(round((val - h) * 60))
    return f"{h:02d}:{m:02d}"




==================== FIM ARQUIVO: app/utils.py ====================

==================== INICIO ARQUIVO: app/models.py ====================
from datetime import datetime, date
from flask_login import UserMixin
from werkzeug.security import generate_password_hash, check_password_hash
from app.extensions import db

class DictMixin:
    def __getitem__(self, key): return getattr(self, key)
    def get(self, key, default=None): return getattr(self, key, default)
    def to_dict(self):
        d = {}
        for c in self.__table__.columns:
            val = getattr(self, c.name)
            if isinstance(val, (datetime, date)): d[c.name] = str(val)
            else: d[c.name] = val
        return d

class User(UserMixin, db.Model, DictMixin):
    # Tabela principal 'user' com aspas para compatibilidade Postgres
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String(150), unique=True, nullable=False, index=True) # INDEX ADICIONADO
    nome = db.Column(db.String(150))
    whatsapp = db.Column(db.String(20))
    password_hash = db.Column(db.String(200), nullable=False)
    
    category = db.Column(db.String(20), default='trial', index=True) # INDEX ADICIONADO
    validade = db.Column(db.Date, index=True) # INDEX ADICIONADO
    data_cadastro = db.Column(db.Date, default=datetime.utcnow)
    
    payment_method = db.Column(db.String(20))
    is_confirmed = db.Column(db.Boolean, default=True)
    confirmed_on = db.Column(db.DateTime, nullable=True)
    last_seen_version = db.Column(db.String(5))
    is_temp_password = db.Column(db.Boolean, default=False)
    
    profile_image = db.Column(db.String(500), nullable=True)
    data_nascimento = db.Column(db.Date, nullable=True)
    endereco = db.Column(db.String(255), nullable=True)
    
    # PLAN TYPE REAL
    plan_type = db.Column(db.String(20), default='premium') 
    
    # INDICA√á√ÉO
    referral_code = db.Column(db.String(10), unique=True, index=True) 
    referred_by = db.Column(db.Integer, db.ForeignKey('user.id'), index=True) # INDEX ADICIONADO
    referral_balance = db.Column(db.Integer, default=0)
    referral_bonus_given = db.Column(db.Boolean, default=False)

    referrer = db.relationship('User', remote_side=[id], backref='referrals')

    diarios = db.relationship('Diario', backref='dono', lazy=True, cascade="all, delete-orphan")
    configs = db.relationship('Config', backref='dono', lazy=True, cascade="all, delete-orphan")
    manutencoes = db.relationship('Manutencao', backref='dono', lazy=True, cascade="all, delete-orphan")
    agendamentos = db.relationship('Agendamentos', backref='dono', lazy=True, cascade="all, delete-orphan")
    notificacoes = db.relationship('Notification', backref='recipient', lazy=True, cascade="all, delete-orphan")
    tickets = db.relationship('SupportTicket', backref='dono', lazy=True, cascade="all, delete-orphan")
    conquistas_desbloqueadas = db.relationship('UserAchievement', backref='user', lazy=True, cascade="all, delete-orphan")
    
    def set_password(self, password): self.password_hash = generate_password_hash(password)
    def check_password(self, password): return check_password_hash(self.password_hash, password)

class MaintenanceLog(db.Model, DictMixin):
    # Hist√≥rico de Manuten√ß√£o (Item 2)
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False, index=True) # INDEX ADICIONADO
    item_name = db.Column(db.String(100), nullable=False)
    service_date = db.Column(db.Date, default=datetime.utcnow, index=True) # INDEX ADICIONADO
    service_km = db.Column(db.Float, default=0.0)
    cost = db.Column(db.Numeric(10,2), default=0.00)
    notes = db.Column(db.Text, nullable=True)

class Notification(db.Model, DictMixin):
    id = db.Column(db.Integer, primary_key=True) 
    message = db.Column(db.Text, nullable=False) 
    created_at = db.Column(db.DateTime, default=datetime.now) 
    is_read = db.Column(db.Boolean, default=False, index=True) # INDEX ADICIONADO
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False, index=True) # INDEX ADICIONADO

class SupportTicket(db.Model, DictMixin):
    id = db.Column(db.Integer, primary_key=True) 
    motivo = db.Column(db.String(100), nullable=False) 
    mensagem = db.Column(db.Text, nullable=False) 
    created_at = db.Column(db.DateTime, default=datetime.now) 
    updated_at = db.Column(db.DateTime, default=datetime.now) 
    status = db.Column(db.String(30), default='Aberto', index=True) # INDEX ADICIONADO
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False, index=True) # INDEX ADICIONADO
    messages = db.relationship('TicketMessage', backref='ticket', lazy=True, cascade="all, delete-orphan")

class TicketMessage(db.Model, DictMixin):
    id = db.Column(db.Integer, primary_key=True) 
    ticket_id = db.Column(db.Integer, db.ForeignKey('support_ticket.id'), nullable=False, index=True) # INDEX ADICIONADO
    sender_type = db.Column(db.String(10), nullable=False) 
    message = db.Column(db.Text, nullable=False) 
    created_at = db.Column(db.DateTime, default=datetime.now)

class Diario(db.Model, DictMixin):
    id = db.Column(db.Integer, primary_key=True)
    data = db.Column(db.Date, nullable=False, index=True) # INDEX EXISTENTE
    ganho_bruto = db.Column(db.Numeric(10,2), default=0.00)
    ganho_uber = db.Column(db.Numeric(10,2), default=0.00)
    ganho_99 = db.Column(db.Numeric(10,2), default=0.00)
    ganho_part = db.Column(db.Numeric(10,2), default=0.00)
    ganho_outros = db.Column(db.Numeric(10,2), default=0.00)
    despesa_combustivel = db.Column(db.Numeric(10,2), default=0.00)
    despesa_alimentacao = db.Column(db.Numeric(10,2), default=0.00)
    despesa_manutencao = db.Column(db.Numeric(10,2), default=0.00)
    qtd_uber = db.Column(db.Integer, default=0)
    qtd_99 = db.Column(db.Integer, default=0)
    qtd_part = db.Column(db.Integer, default=0)
    qtd_outros = db.Column(db.Integer, default=0)
    km_percorrido = db.Column(db.Float, default=0.0)
    horas_trabalhadas = db.Column(db.Float, default=0.0)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False, index=True) # INDEX ADICIONADO

class Agendamentos(db.Model, DictMixin):
    id = db.Column(db.Integer, primary_key=True)
    cliente = db.Column(db.String(100))
    data_hora = db.Column(db.DateTime, index=True) # INDEX EXISTENTE
    origem = db.Column(db.String(200))
    parada = db.Column(db.String(200), nullable=True) 
    destino = db.Column(db.String(200))
    valor = db.Column(db.Numeric(10,2))
    observacao = db.Column(db.Text)
    status = db.Column(db.String(20), default='pendente', index=True) # INDEX ADICIONADO
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True) # INDEX ADICIONADO

class Manutencao(db.Model, DictMixin):
    id = db.Column(db.Integer, primary_key=True) 
    item = db.Column(db.String(100)) 
    km_troca = db.Column(db.Float) 
    km_proxima = db.Column(db.Float) 
    status = db.Column(db.String(20)) 
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True) # INDEX ADICIONADO

class Config(db.Model, DictMixin):
    id = db.Column(db.Integer, primary_key=True) 
    chave = db.Column(db.String(50), index=True) # INDEX ADICIONADO
    valor = db.Column(db.Text) 
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True) # INDEX ADICIONADO
    
class CustosFixos(db.Model, DictMixin):
    id = db.Column(db.Integer, primary_key=True) 
    nome = db.Column(db.String(100)) 
    valor = db.Column(db.Numeric(10,2)) 
    tipo = db.Column(db.String(20)) 
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True) # INDEX ADICIONADO

class Achievement(db.Model, DictMixin):
    __tablename__ = 'achievement'
    id = db.Column(db.String(50), primary_key=True) 
    nome = db.Column(db.String(100), nullable=False) 
    descricao = db.Column(db.String(255), nullable=False) 
    icone = db.Column(db.String(20), default='üèÜ') 
    categoria = db.Column(db.String(30), default='geral') 
    xp = db.Column(db.Integer, default=10)

class UserAchievement(db.Model, DictMixin):
    __tablename__ = 'user_achievement'
    id = db.Column(db.Integer, primary_key=True) 
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False, index=True) # INDEX ADICIONADO
    achievement_id = db.Column(db.String(50), db.ForeignKey('achievement.id'), nullable=False) 
    conquistado_em = db.Column(db.DateTime, default=datetime.utcnow) 
    visto = db.Column(db.Boolean, default=False) 
    detalhes = db.relationship('Achievement', lazy='joined')




==================== FIM ARQUIVO: app/models.py ====================

==================== INICIO ARQUIVO: app/__init__.py ====================
import os
import sys
import json
import logging
from flask import Flask, render_template, request, redirect, url_for
from app.config import Config
from app.extensions import db, login_manager, migrate, csrf, limiter
from app.models import User, Notification
from datetime import datetime
from sqlalchemy import inspect
from dotenv import load_dotenv

import firebase_admin
from firebase_admin import credentials

load_dotenv()

def create_app(config_class=None):
    app = Flask(__name__)
    
    if config_class is None:
        try:
            from app.config import Config
            config_class = Config
        except ImportError:
            class Config:
                SECRET_KEY = os.environ.get('SECRET_KEY', 'dev_key')
                SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL', 'sqlite:///local.db')
            config_class = Config

    app.config.from_object(config_class)
    
    # ATEN√á√ÉO: Vers√£o atualizada para limpar cache dos navegadores
    app.config['APP_VERSION'] = "v13.2-Onboarding"

    # --- CONFIGURA√á√ÉO DE CACHE BUSTING (AUTOM√ÅTICO) ---
    @app.url_defaults
    def hashed_url_for_static_file(endpoint, values):
        if 'static' == endpoint or endpoint.endswith('.static'):
            filename = values.get('filename')
            if filename:
                param_name = 'v'
                while param_name in values:
                    param_name = '_' + param_name
                values[param_name] = app.config['APP_VERSION']

    if not app.debug:
        handler = logging.StreamHandler(sys.stdout)
        handler.setLevel(logging.INFO)
        app.logger.addHandler(handler)

    try:
        if not firebase_admin._apps:
            creds_json = os.environ.get('FIREBASE_CREDENTIALS')
            if creds_json:
                cred_dict = json.loads(creds_json)
                cred = credentials.Certificate(cred_dict)
                firebase_admin.initialize_app(cred)
    except Exception as e:
        app.logger.error(f"Firebase Error: {e}")

    firebase_config_frontend = os.environ.get('FIREBASE_CONFIG_FRONTEND', '{}')
    
    db.init_app(app)
    login_manager.init_app(app)
    login_manager.login_view = 'auth.login'
    migrate.init_app(app, db)
    csrf.init_app(app)
    limiter.init_app(app)

    @login_manager.user_loader
    def load_user(user_id):
        return User.query.get(int(user_id))

    from app.utils import clean_phone_filter, float_to_time_filter
    app.jinja_env.filters['clean_phone'] = clean_phone_filter
    app.jinja_env.filters['float_to_time'] = float_to_time_filter

    from flask_login import current_user

    @app.context_processor
    def inject_global_vars():
        plan_info = app.config.get('PLANS', {}).get('mensal', {})
        unread = 0
        if current_user.is_authenticated:
            try:
                unread = Notification.query.filter_by(user_id=current_user.id, is_read=False).count()
            except: pass
        return dict(
            current_version=app.config['APP_VERSION'],
            unread_notifications=unread,
            plano_nome=plan_info.get('nome'),
            plano_valor=plan_info.get('valor_display'),
            FIREBASE_CONFIG_FRONTEND=firebase_config_frontend 
        )

    @app.before_request
    def check_maintenance_and_status():
        if request.endpoint and ('static' in request.endpoint or 'webhook' in request.endpoint or 'healthz' in request.endpoint):
            return

        if os.environ.get('MAINTENANCE_MODE') == 'True':
            if current_user.is_authenticated and current_user.email == 'admin@motoristapro.app': pass
            elif request.endpoint not in ['auth.login', 'auth.logout', 'auth.register', 'auth.firebase_auth', 'auth.action_handler']:
                return render_template('maintenance.html'), 503

        if current_user.is_authenticated:
            if current_user.validade:
                try:
                    hoje = datetime.now().date()
                    val = current_user.validade
                    if isinstance(val, str):
                        try: val = datetime.strptime(val, '%Y-%m-%d').date()
                        except: val = hoje
                    if val < hoje:
                        if current_user.category != 'expired':
                            current_user.category = 'expired'; db.session.commit()
                        whitelist = ['payments.', 'webhook', 'auth.', 'static', 'main.healthz']
                        if request.endpoint and not any(x in request.endpoint for x in whitelist):
                            stripe_key = os.environ.get('STRIPE_PUBLIC_KEY')
                            return render_template('bloqueio_assinatura.html', nome=current_user.nome, validade=val.strftime('%d/%m/%Y'), email=current_user.email, stripe_public_key=stripe_key)
                except Exception as e: app.logger.error(f"Erro check_status: {e}")

            if getattr(current_user, 'is_temp_password', False) and request.endpoint != 'auth.change_password_force':
                return redirect(url_for('auth.change_password_force'))

    print(">>> APP: Carregando Blueprints...")
    
    try:
        from app.routes.auth import bp as auth_bp
        from app.routes.main import bp as main_bp
        from app.routes.dashboard import bp as dashboard_bp
        from app.routes.admin import bp as admin_bp
        from app.routes.user_settings import bp as settings_bp
        from app.routes.payments import bp as payments_bp

        app.register_blueprint(auth_bp) 
        app.register_blueprint(main_bp) 
        app.register_blueprint(dashboard_bp)
        app.register_blueprint(admin_bp, url_prefix='/admin')
        app.register_blueprint(settings_bp)
        app.register_blueprint(payments_bp)
        
        print(">>> APP: Blueprints registrados com sucesso.")
    except Exception as e:
        print(f"XXX APP: Erro ao registrar Blueprints: {e}")
        raise e

    return app




==================== FIM ARQUIVO: app/__init__.py ====================

==================== INICIO ARQUIVO: app/config.py ====================
import os

class Config:
    # --- SEGURAN√áA CR√çTICA ---
    # Verifica se estamos em produ√ß√£o
    is_prod = os.environ.get('FLASK_ENV') == 'production' or os.environ.get('RENDER')

    # Chave secreta: Obrigat√≥ria em produ√ß√£o.
    # Em desenvolvimento local, usa uma chave de teste.
    SECRET_KEY = os.environ.get('SECRET_KEY')
    if not SECRET_KEY:
        if is_prod:
            # Em produ√ß√£o, n√£o podemos rodar sem chave segura
            raise ValueError("ERRO CR√çTICO: SECRET_KEY n√£o configurada no Render!")
        else:
            SECRET_KEY = 'dev_key_apenas_para_testes_locais'

    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
    # --- ESTRAT√âGIA DE PRE√áOS ---
    PLANS = {
        'basic': {
            'nome': 'Motorista Basic',
            'valor': '9.90',
            'valor_display': '9,90',
            'stripe_price_id': os.environ.get('STRIPE_PRICE_BASIC', 'price_HOLDER_BASIC'),
            'desc_diario': '0,33',
            'cor': '#64748B'
        },
        'premium': {
            'nome': 'Motorista Pro (Premium)',
            'valor': '19.90',
            'valor_display': '19,90',
            'dias': 30,
            'stripe_price_id': os.environ.get('STRIPE_PRICE_ID', 'price_HOLDER_PREMIUM'),
            # ATUALIZADO: L√™ o cup√£o do ambiente ou usa o padr√£o.
            # Crie este cup√£o na Stripe com o ID 'Ue91b9U9' ou configure STRIPE_COUPON_ID no Render.
            'stripe_coupon_id': os.environ.get('STRIPE_COUPON_ID', 'Ue91b9U9'), 
            'desc_diario': '0,66',
            'cor': '#2563EB'
        }
    }

    # --- OTIMIZA√á√ÉO DE MEM√ìRIA DO BANCO (RENDER) ---
    SQLALCHEMY_ENGINE_OPTIONS = {
        "pool_pre_ping": True,
        "pool_recycle": 300,
        "pool_size": 5,      
        "max_overflow": 2,    
        "pool_timeout": 30
    }

    @staticmethod
    def get_db_uri():
        # 1. Prioridade: Vari√°vel de Ambiente (Render / Codespaces configurado)
        env_url = os.environ.get('DATABASE_URL')
        
        # 2. SEU BANCO DE PRODU√á√ÉO (Removido do c√≥digo por seguran√ßa)
        # O sistema agora confia EXCLUSIVAMENTE na vari√°vel de ambiente.
        
        if env_url:
            clean_url = env_url.strip().replace("'", "").replace('"', "")
            if clean_url.startswith("psql "): clean_url = clean_url.replace("psql ", "")
            # Fix para Render/Heroku (postgres:// -> postgresql://)
            if clean_url.startswith("postgres://"): clean_url = clean_url.replace("postgres://", "postgresql://", 1)
            
            if 'sslmode' not in clean_url and 'localhost' not in clean_url and 'sqlite' not in clean_url:
                separator = '&' if '?' in clean_url else '?'
                clean_url = f"{clean_url}{separator}sslmode=require"
            return clean_url
        else:
            # Fallback seguro: SQLite local (apenas para testes no Termux/Codespace se n√£o houver env)
            print("AVISO: DATABASE_URL n√£o encontrada. Usando SQLite local para testes.")
            basedir = os.path.abspath(os.path.dirname(__file__))
            return 'sqlite:///' + os.path.join(basedir, 'motorista_local.db')

    SQLALCHEMY_DATABASE_URI = get_db_uri()




==================== FIM ARQUIVO: app/config.py ====================

==================== INICIO ARQUIVO: app/routes/auth.py ====================
from flask import Blueprint, render_template, request, redirect, url_for, jsonify, current_app, session
from flask_login import login_user, logout_user, login_required, current_user
from datetime import datetime, timedelta, date
from app.extensions import db, limiter, csrf
from app.models import User, Notification
from app.utils import init_user_configs
from app.services.gamification import AchievementService
from firebase_admin import auth as firebase_auth
import secrets
import string
import os

bp = Blueprint('auth', __name__)

def generate_referral_code():
    chars = string.ascii_uppercase + string.digits
    for _ in range(10): 
        code = ''.join(secrets.choice(chars) for _ in range(6))
        if not db.session.query(User.id).filter_by(referral_code=code).first():
            return code
    return secrets.token_hex(4).upper()

@bp.route('/login', methods=['GET'], endpoint='login')
def login_view():
    if current_user.is_authenticated: return redirect(url_for('dashboard.index'))
    return render_template('login.html')

@bp.route('/register', methods=['GET'], endpoint='register')
def register_view():
    if current_user.is_authenticated: return redirect(url_for('dashboard.index'))
    return render_template('register.html')

@bp.route('/auth/firebase_auth', methods=['POST'], endpoint='firebase_auth')
@csrf.exempt
@limiter.limit("20 per minute")
def firebase_auth_handler():
    try:
        data = request.get_json()
        id_token = data.get('idToken')
        nome = data.get('nome', 'Motorista')
        photo_url = data.get('photoURL') 
        whatsapp = data.get('whatsapp', '')
        referral_code_input = data.get('referralCode') 
        
        # 1. Validar Token Google
        try:
            decoded_token = firebase_auth.verify_id_token(id_token)
            email = decoded_token['email']
        except Exception as e:
            print(f"Erro Token Google: {e}")
            return jsonify({'success': False, 'message': 'Sess√£o inv√°lida. Tente novamente.'}), 400
        
        user = User.query.filter_by(email=email).first()
        
        if not user:
            # === CRIA√á√ÉO DE USU√ÅRIO (Blindada) ===
            try:
                hoje = date.today()
                # CORRE√á√ÉO: Trial de 7 dias exatos (Antes estava 6)
                validade_trial = hoje + timedelta(days=7)
                
                referrer_id = None
                if referral_code_input:
                    clean_code = referral_code_input.upper().strip()
                    referrer = db.session.query(User.id).filter_by(referral_code=clean_code).first()
                    if referrer: referrer_id = referrer.id
                
                user = User(
                    email=email, 
                    nome=nome, 
                    whatsapp=whatsapp, 
                    password_hash="FIREBASE_SOCIAL",
                    validade=validade_trial, 
                    data_cadastro=hoje, 
                    last_seen_version='0.0', 
                    is_confirmed=True, 
                    category='trial', 
                    referral_code=generate_referral_code(), 
                    referred_by=referrer_id, 
                    referral_balance=0, 
                    referral_bonus_given=False,
                    plan_type='premium',
                    profile_image=photo_url 
                )
                user.set_password(secrets.token_hex(32))
                
                db.session.add(user)
                db.session.commit() # COMMIT 1
                
            except Exception as e:
                db.session.rollback()
                print(f"Erro Fatal ao Criar User: {e}")
                return jsonify({'success': False, 'message': 'Erro ao registar conta.'}), 500

            # === P√ìS-CRIA√á√ÉO ===
            try:
                init_user_configs(user)
                
                primeiro_nome = nome.split()[0] if nome else "Motorista"
                welcome_msg = f"Ol√°, {primeiro_nome}! üöó Bem-vindo a bordo. Acesso via Google configurado com sucesso."
                db.session.add(Notification(user_id=user.id, message=welcome_msg, is_read=False))
                
                if referrer_id:
                    msg_ref = f"üéâ Seu amigo {primeiro_nome} cadastrou-se com o seu c√≥digo! Se ele assinar o Premium, ganha 50% de desconto."
                    db.session.add(Notification(user_id=referrer_id, message=msg_ref, is_read=False))
                    
                db.session.commit() # COMMIT 2
            except Exception as e:
                print(f"Erro P√≥s-Cria√ß√£o (Ignorado): {e}")
            
        else:
            # === LOGIN ===
            try:
                if photo_url and not user.profile_image: user.profile_image = photo_url
                if not user.referral_code: user.referral_code = generate_referral_code()
                if whatsapp and user.whatsapp != whatsapp: user.whatsapp = whatsapp
                db.session.commit()
            except: pass
            
        # 3. LOGIN NA SESS√ÉO FLASK
        login_user(user, remember=True)
        
        # 4. GAMIFICA√á√ÉO
        try:
            AchievementService.get_badges_with_progress(user)
        except Exception as e:
            print(f"Erro Gamifica√ß√£o no Login (Ignorado): {e}")
        
        return jsonify({'success': True, 'redirect': url_for('dashboard.index')})
        
    except Exception as e:
        print(f"Auth Critical Error: {str(e)}") 
        return jsonify({'success': False, 'message': f'Erro interno: {str(e)}'}), 500

@bp.route('/auth/action', methods=['GET'], endpoint='action_handler')
def action_handler():
    return render_template('auth_action.html', mode=request.args.get('mode'), code=request.args.get('oobCode'))

@bp.route('/logout', endpoint='logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('auth.login'))

@bp.route('/recuperar_senha', endpoint='recuperar_senha')
def recuperar_senha(): return render_template('esqueci_senha.html')

@bp.route('/change_password_force', methods=['GET', 'POST'], endpoint='change_password_force')
@login_required
def change_password_force():
    if request.method == 'POST':
        nova = request.form.get('nova_senha')
        if nova and len(nova) >= 6:
            current_user.set_password(nova)
            current_user.is_temp_password = False
            db.session.commit()
            return redirect(url_for('dashboard.index'))
        else:
            return render_template('change_password.html', erro="A senha deve ter no m√≠nimo 6 caracteres.")
    return render_template('change_password.html')

@bp.route('/admin/login', methods=['GET', 'POST'], endpoint='admin_login')
@limiter.limit("5 per minute")
def admin_login():
    erro = None
    admin_password = os.environ.get('ADMIN_PASSWORD')
    
    if not admin_password:
        if current_app.debug: 
            return "ERRO: Configure ADMIN_PASSWORD no .env ou Render.", 500
        else:
            return "Acesso administrativo desativado por seguran√ßa.", 403

    if request.method == 'POST':
        if request.form.get('senha') == admin_password: 
            session['is_admin'] = True
            return redirect(url_for('admin.dashboard'))
        else:
            erro = "Senha incorreta."
            
    return render_template('admin_login.html', erro=erro)




==================== FIM ARQUIVO: app/routes/auth.py ====================

==================== INICIO ARQUIVO: app/routes/main.py ====================
from flask import Blueprint, render_template, request, redirect, url_for, current_app, jsonify, make_response, session
from flask_login import login_required, current_user
from sqlalchemy import func, extract
from datetime import datetime, timedelta, date
from app.extensions import db
from app.models import Diario, Agendamentos, Notification, Config, Manutencao, MaintenanceLog, SupportTicket, TicketMessage
from app.utils import safe_float, safe_money, time_to_float, float_to_parts, get_config, set_config, get_brasilia_now
from app.services import get_semanas_dropdown, MESES_PT, get_maintenance_prediction, get_date_range_local, get_filter_label, generate_week_options
from app.services.gamification import AchievementService 
import calendar
from decimal import Decimal

bp = Blueprint('main', __name__)

def no_cache(view):
    from functools import wraps
    @wraps(view)
    def no_cache_view(*args, **kwargs):
        response = make_response(view(*args, **kwargs))
        response.headers["Cache-Control"] = "no-cache, no-store, must-revalidate"
        response.headers["Pragma"] = "no-cache"
        response.headers["Expires"] = "0"
        return response
    return no_cache_view

@bp.route('/healthz', methods=['GET'])
def health_check(): return jsonify({'status': 'ok'}), 200

@bp.route('/manifest.json')
def manifest(): return current_app.send_static_file('manifest.json')

@bp.route('/sw.js')
def service_worker():
    response = current_app.send_static_file('sw.js')
    response.headers.add('Service-Worker-Allowed', '/')
    return response

@bp.route('/offline.html')
def offline(): return render_template('offline.html')

@bp.route('/termos', endpoint='termos')
def termos(): return render_template('termos.html')

@bp.route('/assinatura', endpoint='assinatura')
@login_required
def assinatura():
    dias = 0
    val_str = ""
    if current_user.validade:
        v = current_user.validade
        if isinstance(v, str):
            try: v = datetime.strptime(v, '%Y-%m-%d').date()
            except: pass
        if isinstance(v, datetime): 
            v = v.date()
        if isinstance(v, date):
            dias = (v - get_brasilia_now().date()).days
            val_str = v.strftime('%Y-%m-%d')
    return render_template('assinatura.html', nome=current_user.nome, validade=val_str, dias=dias, email=current_user.email)

@bp.route('/pagamento', endpoint='pagamento')
def pagamento(): return redirect(url_for('dashboard.index'))

@bp.route('/imprimir_relatorio', endpoint='imprimir_relatorio')
@login_required
def imprimir_relatorio(): return redirect(url_for('main.relatorios'))

# --- NOVA ROTA: MONITORAMENTO DIN√ÇMICO ---
@bp.route('/monitoramento', endpoint='monitoramento')
@login_required
def monitoramento():
    # Carrega configs salvas ou usa padr√£o
    c_good_km = get_config(current_user.id, 'ocr_good_km', '2.0')
    c_bad_km = get_config(current_user.id, 'ocr_bad_km', '1.5')
    c_good_hour = get_config(current_user.id, 'ocr_good_hour', '60.0')
    c_bad_hour = get_config(current_user.id, 'ocr_bad_hour', '40.0')
    
    return render_template('ocr_page.html', 
                           good_km=c_good_km, bad_km=c_bad_km,
                           good_hour=c_good_hour, bad_hour=c_bad_hour)

@bp.route('/adicionar', methods=['GET','POST'], endpoint='adicionar')
@login_required
def adicionar():
    hoje_br = get_brasilia_now().strftime('%Y-%m-%d')
    custom_app_name = get_config(current_user.id, 'app_local_name', 'OUTROS')
    if request.method=='POST':
        try:
            data_obj = datetime.strptime(request.form['data'], '%Y-%m-%d').date()
            h = time_to_float(request.form.get('horas_qtd'), request.form.get('minutos_qtd'))
            g_uber = safe_money(request.form.get('ganho_uber'))
            g_99 = safe_money(request.form.get('ganho_99'))
            g_part = safe_money(request.form.get('ganho_part'))
            g_out = safe_money(request.form.get('ganho_out'))
            app_sum = g_uber + g_99 + g_part + g_out
            gb_input = safe_money(request.form.get('ganho_bruto'))
            final_gb = app_sum if app_sum > 0 else gb_input
            d_comb = safe_money(request.form.get('total_combustivel'))
            d_alim = safe_money(request.form.get('total_alimentacao'))
            d_manu = safe_money(request.form.get('total_manutencao'))
            novo = Diario(
                data=data_obj, ganho_bruto=final_gb, 
                ganho_uber=g_uber, ganho_99=g_99, ganho_part=g_part, ganho_outros=g_out, 
                despesa_combustivel=d_comb, despesa_alimentacao=d_alim, despesa_manutencao=d_manu, 
                qtd_uber=int(request.form.get('qtd_uber') or 0), qtd_99=int(request.form.get('qtd_99') or 0), 
                qtd_part=int(request.form.get('qtd_part') or 0), qtd_outros=int(request.form.get('qtd_outros') or 0), 
                km_percorrido=safe_float(request.form.get('km_percorrido')), horas_trabalhadas=h, user_id=current_user.id
            )
            db.session.add(novo); db.session.commit()
            unlocks = AchievementService.check_new_entries(current_user)
            unlock_str = ",".join(unlocks) if unlocks else ""
            return redirect(url_for('main.historico') + f"?msg=salvo&new_badges={unlock_str}")
        except Exception as e: db.session.rollback(); return f"Erro ao salvar: {e}"
    c_time = request.args.get('tempo_cronometro')
    hv=0; mv=0
    if c_time and ':' in c_time: 
        try: p = c_time.split(':'); hv, mv = int(p[0]), int(p[1]) 
        except: pass
    return render_template('adicionar.html', data_hoje=hoje_br, h_val=hv, m_val=mv, custom_app_name=custom_app_name)

@bp.route('/historico', endpoint='historico')
@login_required
@no_cache
def historico():
    page = request.args.get('page', 1, type=int)
    tipo = request.args.get('tipo', 'mes')
    valor = request.args.get('valor')
    if current_user.plan_type == 'basic' and tipo == 'anual': tipo = 'mes'; valor = None 
    start_date, end_date, _, valor_ajustado = get_date_range_local(tipo, valor)
    filter_label = get_filter_label(tipo, start_date, end_date)
    query = Diario.query.filter_by(user_id=current_user.id).filter(Diario.data >= start_date, Diario.data <= end_date)
    if current_user.plan_type == 'basic': 
        data_limite_basic = date.today() - timedelta(days=30)
        query = query.filter(Diario.data >= data_limite_basic)
    paginacao = query.order_by(Diario.data.desc()).paginate(page=page, per_page=15)
    week_options = generate_week_options(start_date.year)
    context = {'registros': [r.to_dict() for r in paginacao.items], 'page': page, 'has_next': paginacao.has_next, 'tipo': tipo, 'valor': valor_ajustado, 'filter_label': filter_label, 'week_options': week_options, 'total_pages': paginacao.pages}
    if request.headers.get('HX-Request'): return render_template('partials/history_list.html', **context)
    return render_template('historico.html', **context)

@bp.route('/editar/<int:id>', methods=('GET', 'POST'), endpoint='editar')
@login_required
@no_cache
def editar(id):
    r = Diario.query.get_or_404(id)
    if r.user_id != current_user.id: return redirect(url_for('dashboard.index'))
    if request.method == 'POST':
        try:
            r.data = datetime.strptime(request.form['data'], '%Y-%m-%d').date()
            r.km_percorrido = safe_float(request.form.get('km_percorrido'))
            r.horas_trabalhadas = time_to_float(request.form.get('horas_qtd'), request.form.get('minutos_qtd'))
            r.ganho_uber = safe_money(request.form.get('ganho_uber'))
            r.ganho_99 = safe_money(request.form.get('ganho_99'))
            r.ganho_part = safe_money(request.form.get('ganho_part'))
            r.ganho_outros = safe_money(request.form.get('ganho_outros'))
            app_sum = r.ganho_uber + r.ganho_99 + r.ganho_part + r.ganho_outros
            r.ganho_bruto = app_sum if app_sum > 0 else safe_money(request.form.get('ganho_bruto'))
            r.qtd_uber = int(request.form.get('qtd_uber') or 0)
            r.qtd_99 = int(request.form.get('qtd_99') or 0)
            r.qtd_part = int(request.form.get('qtd_part') or 0)
            r.qtd_outros = int(request.form.get('qtd_outros') or 0)
            r.despesa_combustivel = safe_money(request.form.get('despesa_combustivel'))
            r.despesa_alimentacao = safe_money(request.form.get('despesa_alimentacao'))
            r.despesa_manutencao = safe_money(request.form.get('despesa_manutencao'))
            db.session.commit()
            return redirect(url_for('main.historico'))
        except Exception as e: db.session.rollback(); return f"Erro ao editar: {e}"
    h,m = float_to_parts(r.horas_trabalhadas)
    return render_template('editar.html', registro=r.to_dict(), h_val=h, m_val=m)

@bp.route('/deletar/<int:id>', endpoint='deletar')
@login_required
def deletar(id):
    r = Diario.query.get_or_404(id)
    if r.user_id == current_user.id: db.session.delete(r); db.session.commit()
    return redirect(url_for('main.historico'))

@bp.route('/bem_vindo', endpoint='bem_vindo')
@login_required
def bem_vindo(): return render_template('bem_vindo.html', nome=current_user.nome)

@bp.route('/concluir_onboarding', methods=['POST'], endpoint='concluir_onboarding')
@login_required
def concluir_onboarding():
    try: current_user.last_seen_version = current_app.config.get('APP_VERSION'); db.session.commit(); return jsonify({'status': 'ok'})
    except Exception as e: db.session.rollback(); return jsonify({'status': 'error', 'message': str(e)}), 500

@bp.route('/agenda', endpoint='agenda')
@login_required
def agenda(): 
    return render_template('agenda.html', agendamentos=[x.to_dict() for x in Agendamentos.query.filter_by(user_id=current_user.id, status='pendente').order_by(Agendamentos.data_hora.asc()).all()])

@bp.route('/novo_agendamento', methods=('GET','POST'), endpoint='novo_agendamento')
@login_required
def novo_agendamento():
    if request.method == 'POST':
        try:
            dt_str = f"{request.form['data_ag']} {request.form['hora_ag']}"
            novo = Agendamentos(cliente=request.form['cliente'], data_hora=datetime.strptime(dt_str, "%Y-%m-%d %H:%M"), origem=request.form['origem'], destino=request.form['destino'], valor=safe_money(request.form['valor']), observacao=request.form['observacao'], user_id=current_user.id)
            if 'parada' in request.form: novo.parada = request.form['parada']
            db.session.add(novo); db.session.commit()
            unlocks = AchievementService.check_usage(current_user, 'agenda_add')
            return redirect(url_for('main.agenda') + f"?new_badges={','.join(unlocks) if unlocks else ''}")
        except Exception as e: db.session.rollback(); return f"Erro: {str(e)}", 500
    return render_template('novo_agendamento.html', hoje=get_brasilia_now().strftime('%Y-%m-%d'))

@bp.route('/concluir_agendamento/<int:id>', endpoint='concluir_agendamento')
@login_required
def concluir_agendamento(id):
    a = Agendamentos.query.get_or_404(id)
    if a.user_id == current_user.id:
        a.status = 'concluido'
        db.session.add(Diario(data=a.data_hora.date(), ganho_bruto=a.valor, ganho_part=a.valor, qtd_part=1, user_id=current_user.id))
        db.session.commit()
        unlocks = AchievementService.check_usage(current_user, 'agenda_concluir')
        unlock_str = ",".join(unlocks) if unlocks else ""
        if request.args.get('recibo') == '1': return redirect(url_for('settings.gerar_recibo', valor=a.valor, cliente=a.cliente, origem=a.origem, destino=a.destino, data=a.data_hora.strftime('%d/%m/%Y'), new_badges=unlock_str if unlock_str else None))
        return redirect(url_for('main.agenda') + f"?msg=concluido&new_badges={unlock_str}")
    return redirect(url_for('main.agenda') + "?msg=concluido")

@bp.route('/deletar_agendamento/<int:id>', endpoint='deletar_agendamento')
@login_required
def deletar_agendamento(id):
    a = Agendamentos.query.get_or_404(id)
    if a.user_id == current_user.id: db.session.delete(a); db.session.commit()
    return redirect(url_for('main.agenda'))

@bp.route('/update_app_name', methods=['POST'], endpoint='update_app_name')
@login_required
def update_app_name():
    if current_user.plan_type != 'premium': return jsonify({'error': 'Premium only'}), 403
    data = request.get_json()
    new_name = data.get('name', 'OUTROS').strip().upper()
    if len(new_name) > 10: new_name = new_name[:10]
    if not new_name: new_name = 'OUTROS'
    try: set_config(current_user.id, 'app_local_name', new_name); return jsonify({'status': 'ok'})
    except Exception as e: return jsonify({'error': str(e)}), 500

@bp.route('/manutencao', endpoint='manutencao')
@login_required
def manutencao():
    if not get_config(current_user.id, 'veiculo_modelo'): return redirect(url_for('settings.setup_veiculo') + "?msg=config_required")
    odo, itens = get_maintenance_prediction(current_user)
    historico_manutencao = []
    if current_user.plan_type == 'premium':
        try: historico_manutencao = MaintenanceLog.query.filter_by(user_id=current_user.id).order_by(MaintenanceLog.service_date.desc()).all()
        except: pass
    return render_template('manutencao.html', odo=odo, itens=itens, historico_manutencao=historico_manutencao)

@bp.route('/concluir_manutencao/<int:id>', endpoint='concluir_manutencao')
@login_required
def concluir_manutencao(id):
    m = Manutencao.query.get_or_404(id)
    if m.user_id == current_user.id:
        try:
            odo_sistema, _ = get_maintenance_prediction(current_user)
            km_final = odo_sistema; custo_final = Decimal('0.00')
            if current_user.plan_type == 'premium':
                km_custom = request.args.get('km_real'); custo_custom = request.args.get('custo_real')
                if km_custom: km_final = safe_float(km_custom)
                if custo_custom: custo_final = safe_money(custo_custom)
                log = MaintenanceLog(user_id=current_user.id, item_name=m.item, service_date=date.today(), service_km=km_final, cost=custo_final, notes="Conclu√≠do via Painel")
                db.session.add(log)
            db.session.delete(m); db.session.commit()
        except Exception as e: db.session.rollback(); print(f"Erro Manutencao: {e}")
    return redirect(url_for('main.manutencao'))

@bp.route('/manutencao/imprimir_historico', endpoint='imprimir_historico_manutencao')
@login_required
def imprimir_historico_manutencao():
    if current_user.plan_type != 'premium': return redirect(url_for('payments.assinar'))
    logs = MaintenanceLog.query.filter_by(user_id=current_user.id).order_by(MaintenanceLog.service_date.desc()).all()
    veiculo = {'modelo': get_config(current_user.id, 'veiculo_modelo'), 'marca': get_config(current_user.id, 'veiculo_marca'), 'ano': get_config(current_user.id, 'veiculo_ano')}
    return render_template('relatorio_manutencao_pdf.html', logs=logs, veiculo=veiculo, nome=current_user.nome, hoje=date.today().strftime('%d/%m/%Y'))

@bp.route('/adicionar_manutencao', methods=['POST'], endpoint='adicionar_manutencao')
@login_required
def adicionar_manutencao():
    try:
        kmi = safe_float(get_config(current_user.id, 'km_atual_carro'))
        total_km_all = db.session.query(db.func.sum(Diario.km_percorrido)).filter_by(user_id=current_user.id).scalar() or 0
        odo_atual = kmi + total_km_all
        intervalo = safe_float(request.form['km_proxima'])
        km_alvo = odo_atual + intervalo
        novo = Manutencao(item=request.form['item'], km_proxima=km_alvo, user_id=current_user.id)
        db.session.add(novo); db.session.commit()
        return redirect(url_for('main.manutencao'))
    except: db.session.rollback(); return redirect(url_for('main.manutencao'))

@bp.route('/editar_manutencao/<int:id>', methods=['GET', 'POST'], endpoint='editar_manutencao')
@login_required
def editar_manutencao(id):
    m = Manutencao.query.get_or_404(id)
    if m.user_id != current_user.id: return redirect(url_for('main.manutencao'))
    odo_atual, _ = get_maintenance_prediction(current_user)
    if request.method == 'POST':
        m.item = request.form['item']
        novo_alvo = safe_float(request.form['km_proxima'])
        m.km_proxima = novo_alvo
        db.session.commit()
        return redirect(url_for('main.manutencao'))
    return render_template('editar_manutencao.html', manutencao=m, odo_atual=odo_atual)

@bp.route('/editar_agendamento/<int:id>', methods=('GET', 'POST'), endpoint='editar_agendamento')
@login_required
def editar_agendamento(id):
    a = Agendamentos.query.get_or_404(id)
    if a.user_id != current_user.id: return redirect(url_for('main.agenda'))
    if request.method == 'POST':
        a.data_hora = datetime.strptime(f"{request.form['data_ag']} {request.form['hora_ag']}", "%Y-%m-%d %H:%M")
        a.cliente = request.form['cliente']; a.origem = request.form['origem']; a.destino = request.form['destino']; a.valor = safe_money(request.form['valor']); a.observacao = request.form['observacao']
        if 'parada' in request.form: a.parada = request.form['parada']
        db.session.commit(); return redirect(url_for('main.agenda'))
    return render_template('editar_agendamento.html', registro=a.to_dict(), d_val=a.data_hora.strftime('%Y-%m-%d'), h_val=a.data_hora.strftime('%H:%M'))

@bp.route('/relatorio/imprimir_pdf', endpoint='imprimir_pdf')
@login_required
def imprimir_pdf():
    if current_user.plan_type == 'basic': return redirect(url_for('payments.assinar'))
    tipo = session.get('rep_tipo', 'mes'); valor = session.get('rep_valor')
    start_date, end_date, _, titulo = get_date_range_local(tipo, valor)
    resumo = Diario.query.filter_by(user_id=current_user.id).filter(Diario.data >= start_date, Diario.data <= end_date).with_entities(func.sum(Diario.ganho_bruto), func.sum(Diario.despesa_combustivel + Diario.despesa_alimentacao + Diario.despesa_manutencao), func.sum(Diario.km_percorrido), func.sum(Diario.horas_trabalhadas), func.sum(Diario.qtd_uber + Diario.qtd_99 + Diario.qtd_part + Diario.qtd_outros), func.sum(Diario.ganho_uber), func.sum(Diario.qtd_uber), func.sum(Diario.ganho_99), func.sum(Diario.qtd_99), func.sum(Diario.ganho_part), func.sum(Diario.qtd_part), func.sum(Diario.ganho_outros), func.sum(Diario.qtd_outros)).first()
    def val(idx): return float(resumo[idx] or 0)
    ganho = val(0); despesa = val(1); km = val(2); horas = val(3); corridas = int(val(4))
    cfg = Config.query.filter_by(user_id=current_user.id).all(); c = {i.chave: i.valor for i in cfg}
    depreciacao = safe_float(c.get('depreciacao_km', 0.20)); manutencao = safe_float(c.get('manutencao_km', 0.15))
    reserva = km * (depreciacao + manutencao); lucro_real = (ganho - despesa) - reserva
    dados = {'ganho': ganho, 'despesa': despesa, 'operacional': ganho - despesa, 'lucro_real': lucro_real, 'reserva': reserva, 'km': km, 'horas': horas, 'corridas': corridas, 'media_hora': (ganho/horas) if horas > 0 else 0, 'media_km': (ganho/km) if km > 0 else 0}
    apps = {'uber_val': val(5), 'uber_qtd': int(val(6)), 'pop_val': val(7), 'pop_qtd': int(val(8)), 'part_val': val(9), 'part_qtd': int(val(10)), 'out_val': val(11), 'out_qtd': int(val(12))}
    custom_name = get_config(current_user.id, 'app_local_name', 'Outros')
    return render_template('relatorio_pdf.html', dados=dados, apps=apps, periodo=titulo, nome=current_user.nome, hoje=date.today().strftime('%d/%m/%Y'), custom_name=custom_name)

@bp.route('/relatorios', endpoint='relatorios')
@login_required
def relatorios():
    tipo = request.args.get('tipo'); valor = request.args.get('valor')
    if not tipo: tipo = session.get('rep_tipo', 'semana')
    if not valor: valor = session.get('rep_valor')
    session['rep_tipo'] = tipo; 
    if valor: session['rep_valor'] = valor
    if current_user.plan_type == 'basic' and tipo == 'anual': return redirect(url_for('main.relatorios', tipo='mes'))
    start_date, end_date, titulo, valor_ajustado = get_date_range_local(tipo, valor)
    filter_label = get_filter_label(tipo, start_date, end_date)
    registros = Diario.query.filter_by(user_id=current_user.id).filter(Diario.data >= start_date, Diario.data <= end_date).order_by(Diario.data.asc()).all()
    total_ganho = sum(r.ganho_bruto for r in registros)
    total_despesa = sum(r.despesa_combustivel + r.despesa_alimentacao + r.despesa_manutencao for r in registros)
    chart_labels = []; chart_data = []; chart_despesa = []; qtd_apps = [0, 0, 0, 0]; dados_apps = [0, 0, 0, 0]
    if tipo != 'dia':
        dados_agg = {}
        for r in registros:
            d_str = r.data.strftime('%d/%m')
            if d_str not in dados_agg: dados_agg[d_str] = {'g': 0.0, 'd': 0.0}
            dados_agg[d_str]['g'] += float(r.ganho_bruto)
            dados_agg[d_str]['d'] += float(r.despesa_combustivel + r.despesa_alimentacao + r.despesa_manutencao)
            dados_apps[0] += float(r.ganho_uber); dados_apps[1] += float(r.ganho_99); dados_apps[2] += float(r.ganho_part); dados_apps[3] += float(r.ganho_outros)
            qtd_apps[0] += int(r.qtd_uber or 0); qtd_apps[1] += int(r.qtd_99 or 0); qtd_apps[2] += int(r.qtd_part or 0); qtd_apps[3] += int(r.qtd_outros or 0)
        for k in sorted(dados_agg.keys()): chart_labels.append(k); chart_data.append(dados_agg[k]['g']); chart_despesa.append(dados_agg[k]['d'])
    best_month = {'val': 0, 'lbl': '-'}; best_week = {'val': 0, 'lbl': '-'}; best_day = {'val': 0, 'full': '-'}; best_wd = {'media': 0, 'dia': '-'}; worst_wd = {'media': 0, 'dia': '-'}
    if registros:
        rec_day = max(registros, key=lambda x: x.ganho_bruto)
        best_day = {'val': float(rec_day.ganho_bruto), 'full': rec_day.data.strftime('%d/%m/%Y')}
        wd_map = {0:'Seg', 1:'Ter', 2:'Qua', 3:'Qui', 4:'Sex', 5:'S√°b', 6:'Dom'}; wd_stats = {k: {'soma': 0, 'count': 0} for k in range(7)}
        for r in registros: wd = r.data.weekday(); wd_stats[wd]['soma'] += float(r.ganho_bruto); wd_stats[wd]['count'] += 1
        medias = [{'dia': wd_map[k], 'val': v['soma']/v['count']} for k,v in wd_stats.items() if v['count']>0]
        if medias: b_wd = max(medias, key=lambda x: x['val']); w_wd = min(medias, key=lambda x: x['val']); best_wd = {'media': b_wd['val'], 'dia': b_wd['dia']}; worst_wd = {'media': w_wd['val'], 'dia': w_wd['dia']}
        if tipo == 'anual':
            m_stats = {}
            for r in registros: m_stats[r.data.month] = m_stats.get(r.data.month, 0) + float(r.ganho_bruto)
            if m_stats: bm = max(m_stats.items(), key=lambda x: x[1]); best_month = {'val': bm[1], 'lbl': MESES_PT.get(bm[0], str(bm[0]))}
    anos = db.session.query(extract('year', Diario.data)).distinct().order_by(extract('year', Diario.data).desc()).all(); anos = [int(a[0]) for a in anos]
    custom_app_name = get_config(current_user.id, 'app_local_name', 'Outros')
    return render_template('relatorios.html', tipo=tipo, valor=valor_ajustado, titulo=titulo, chart_labels=chart_labels, chart_data=chart_data, chart_despesa=chart_despesa, total_ganho=total_ganho, total_despesa=total_despesa, best_month=best_month, best_week=best_week, best_day=best_day, best_wd=best_wd, worst_wd=worst_wd, anos=anos, semanas=[], dados_apps=dados_apps, qtd_apps=qtd_apps, filter_label=filter_label, week_options=generate_week_options(start_date.year), custom_app_name=custom_app_name)

@bp.route('/atualizar_meta', methods=['POST'], endpoint='atualizar_meta')
@login_required
def atualizar_meta():
    try: 
        set_config(current_user.id, 'meta_semanal', safe_money(request.form.get('nova_meta')))
        set_config(current_user.id, 'meta_last_update_date', get_brasilia_now().strftime('%Y-%m-%d'))
    except: pass
    return redirect(url_for('dashboard.index'))

@bp.route('/dismiss_meta', methods=['POST'], endpoint='dismiss_meta')
@login_required
def dismiss_meta():
    try: set_config(current_user.id, 'meta_last_update_date', get_brasilia_now().strftime('%Y-%m-%d'))
    except: pass
    return jsonify({'status': 'ok'})

@bp.route('/suporte', endpoint='suporte')
@login_required
def suporte(): 
    tickets = SupportTicket.query.filter_by(user_id=current_user.id).order_by(SupportTicket.updated_at.desc()).all()
    return render_template('suporte.html', tickets=tickets)

@bp.route('/suporte/novo', methods=['POST'], endpoint='suporte_novo')
@login_required
def novo_ticket():
    motivo = request.form.get('motivo'); mensagem = request.form.get('mensagem')
    if motivo and mensagem:
        ticket = SupportTicket(motivo=motivo, mensagem=mensagem, user_id=current_user.id, status='Aberto')
        db.session.add(ticket); db.session.flush() 
        db.session.add(TicketMessage(ticket_id=ticket.id, sender_type='user', message=mensagem)); db.session.commit()
    return redirect(url_for('main.suporte'))


@bp.route('/save_ocr_settings', methods=['POST'], endpoint='save_ocr_settings')
@login_required
def save_ocr_settings():
    if current_user.plan_type != 'premium': return jsonify({'error': 'Premium required'}), 403
    try:
        data = request.get_json()
        # Salva as configura√ß√µes no banco
        set_config(current_user.id, 'ocr_good_km', data.get('good_km', '2.0'))
        set_config(current_user.id, 'ocr_medium_km', data.get('medium_km', '1.5'))
        set_config(current_user.id, 'ocr_good_hour', data.get('good_hour', '60.0'))
        set_config(current_user.id, 'ocr_medium_hour', data.get('medium_hour', '40.0'))
        return jsonify({'status': 'ok'})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@bp.route('/suporte/responder/<int:ticket_id>', methods=['POST'], endpoint='suporte_reply')
@login_required
def user_reply_ticket(ticket_id):
    ticket = SupportTicket.query.get_or_404(ticket_id)
    if ticket.user_id != current_user.id: return redirect(url_for('main.suporte'))
    mensagem = request.form.get('mensagem')
    if mensagem:
        db.session.add(TicketMessage(ticket_id=ticket.id, sender_type='user', message=mensagem))
        ticket.status = 'Em Andamento'; ticket.updated_at = datetime.now(); db.session.commit()
    return redirect(url_for('main.suporte'))
==================== FIM ARQUIVO: app/routes/main.py ====================

==================== INICIO ARQUIVO: app/routes/admin.py ====================
import io
import csv
import zipfile
import secrets
import string
import os
import sys
import re
from datetime import datetime, timedelta, date
from flask import Blueprint, render_template, request, redirect, url_for, session, send_file, Response, current_app, flash
from werkzeug.datastructures import FileStorage
from app.utils import admin_required
from app.extensions import db
from app.models import User, Diario, Agendamentos, Manutencao, Config, SupportTicket, TicketMessage, Notification
from sqlalchemy import func, case, desc, distinct
import firebase_admin
from firebase_admin import auth as firebase_auth

try:
    import pytest
except ImportError:
    pytest = None

bp = Blueprint('admin', __name__, url_prefix='/admin')

@bp.route('/', endpoint='root')
def admin_root(): return redirect(url_for('admin.dashboard'))

@bp.route('/dashboard', endpoint='dashboard')
@admin_required
def admin_dashboard():
    try:
        filtro = request.args.get('filtro')
        query = User.query
        hoje = datetime.now().date()
        hoje_str = hoje.strftime('%Y-%m-%d')

        # Filtros b√°sicos de SQL
        if filtro == 'trial': 
            query = query.filter(User.category == 'trial', User.validade >= hoje_str)
        elif filtro == 'subscriber': 
            query = query.filter(User.category == 'subscriber', User.validade >= hoje_str)
        elif filtro == 'expired': 
            query = query.filter((User.validade < hoje_str) | (User.category == 'expired'))
            
        raw_users = query.order_by(User.id.desc()).limit(100).all()
        
        # Totais Gerais (Otimizados com COUNT)
        total_users = db.session.query(func.count(User.id)).scalar()
        
        total_subs = db.session.query(func.count(User.id)).filter(
            User.category == 'subscriber', 
            User.validade >= hoje_str
        ).scalar()
        
        total_trial = db.session.query(func.count(User.id)).filter(
            User.category == 'trial', 
            User.validade >= hoje_str
        ).scalar()
        
        total_expired = db.session.query(func.count(User.id)).filter(
            (User.validade < hoje_str) | (User.category == 'expired')
        ).scalar()
        
        stats = { 'total': total_users, 'ativos': total_subs, 'trial': total_trial, 'vencidos': total_expired }
        users_processed = []
        
        for u in raw_users:
            try:
                dias_rest = -999
                val = None
                if u.validade:
                    if isinstance(u.validade, str):
                        try: val = datetime.strptime(u.validade, '%Y-%m-%d').date()
                        except: val = None
                    elif isinstance(u.validade, (date, datetime)): val = u.validade
                if val:
                    d_val = val.date() if isinstance(val, datetime) else val
                    dias_rest = (d_val - hoje).days
                
                label_class = 'text-expired'
                if dias_rest >= 0:
                    if u.category == 'subscriber': label_class = 'text-subscriber'
                    elif u.category == 'trial': label_class = 'text-trial'
                
                users_processed.append({
                    'id': u.id, 
                    'nome': u.nome, 
                    'email': u.email, 
                    'whatsapp': u.whatsapp, 
                    'validade': u.validade, 
                    'category': u.category, 
                    'label_class': label_class, 
                    'dias_restantes': dias_rest, 
                    'payment_method': u.payment_method,
                    'plan_type': u.plan_type
                })
            except: 
                users_processed.append({'id': u.id, 'nome': u.nome or 'Erro', 'email': u.email, 'validade': '-', 'category': 'erro', 'label_class': 'text-expired', 'dias_restantes': 0, 'payment_method': 'erro', 'plan_type': 'unknown'})
            
        return render_template('admin.html', users=users_processed, stats=stats, filtro_atual=filtro)
    except Exception as e: return f"Erro Dashboard: {str(e)}"

# --- BUSINESS INTELLIGENCE (BI) OTIMIZADO v7.0 ---
@bp.route('/business', endpoint='business')
@admin_required
def admin_business():
    # 1. M√©tricas Gerais (Usando agregadores SQL)
    metrics = db.session.query(
        func.sum(Diario.ganho_bruto),
        func.sum(Diario.km_percorrido),
        func.sum(Diario.despesa_combustivel + Diario.despesa_manutencao)
    ).first()
    
    total_faturamento_app = metrics[0] or 0
    total_km_rodados = metrics[1] or 1
    total_despesas = metrics[2] or 0
    
    media_reais_km = float(total_faturamento_app) / float(total_km_rodados)
    custo_medio_km = float(total_despesas) / float(total_km_rodados)

    # 2. An√°lise de Assinantes (Otimizada)
    hoje = datetime.now().date()
    hoje_str = hoje.strftime('%Y-%m-%d')

    # Subquery para contar tipos de plano diretamente no banco
    subs_stats = db.session.query(
        User.plan_type,
        User.payment_method,
        User.referral_balance,
        func.count(User.id)
    ).filter(
        User.category == 'subscriber', 
        User.validade >= hoje_str
    ).group_by(User.plan_type, User.payment_method, User.referral_balance).all()
    
    count_basic = 0
    count_premium = 0
    mrr_basic_bruto = 0.0
    mrr_premium_bruto = 0.0
    subs_card = 0
    subs_pix = 0
    
    PRICE_BASIC = 9.90
    PRICE_PREMIUM = 19.90

    # Itera sobre os GRUPOS, n√£o sobre os usu√°rios individuais (Escala infinita)
    for plano, metodo, saldo_ref, qtd in subs_stats:
        # M√©todo
        if metodo == 'card': subs_card += qtd
        else: subs_pix += qtd
        
        # Valor base
        valor_base = PRICE_BASIC if plano == 'basic' else PRICE_PREMIUM
        
        # Desconto
        valor_final = (valor_base / 2) if saldo_ref > 0 else valor_base
        
        if plano == 'basic':
            count_basic += qtd
            mrr_basic_bruto += (valor_final * qtd)
        else:
            count_premium += qtd
            mrr_premium_bruto += (valor_final * qtd)

    # 3. C√°lculo de Taxas
    TAXA_MEDIA = 0.04 
    mrr_basic_liq = mrr_basic_bruto * (1 - TAXA_MEDIA)
    mrr_premium_liq = mrr_premium_bruto * (1 - TAXA_MEDIA)
    mrr_total_liquido = mrr_basic_liq + mrr_premium_liq
    arr_projetado = mrr_total_liquido * 12

    # 4. M√©tricas de Engajamento
    dau = db.session.query(func.count(distinct(Diario.user_id))).filter(Diario.data == hoje).scalar() or 0
    mau = db.session.query(func.count(distinct(Diario.user_id))).filter(Diario.data >= (hoje - timedelta(days=30))).scalar() or 1
    stickiness = (dau / mau) * 100

    # LTV
    total_active = count_basic + count_premium
    ticket_medio = (mrr_total_liquido / total_active) if total_active > 0 else 0
    ltv = ticket_medio * 6 

    # Risco de Churn (Simplificado para performance)
    data_limite_risco = hoje - timedelta(days=7)
    # Subquery para pegar √∫ltima atividade de cada usu√°rio
    last_seen = db.session.query(
        Diario.user_id, 
        func.max(Diario.data).label('max_date')
    ).group_by(Diario.user_id).subquery()
    
    # Usu√°rios ativos que n√£o t√™m di√°rio recente ou nunca tiveram
    qtd_risco = db.session.query(func.count(User.id)).outerjoin(
        last_seen, User.id == last_seen.c.user_id
    ).filter(
        User.category == 'subscriber',
        (last_seen.c.max_date < data_limite_risco) | (last_seen.c.max_date == None)
    ).scalar() or 0

    top_users = db.session.query(User.nome, User.email, func.sum(Diario.ganho_bruto).label('total_ganho'), func.count(Diario.id).label('dias_uso')).join(Diario).group_by(User.id).order_by(desc('total_ganho')).limit(5).all()

    share = db.session.query(func.sum(Diario.ganho_uber), func.sum(Diario.ganho_99), func.sum(Diario.ganho_part), func.sum(Diario.ganho_outros)).first()
    share_data = [float(x or 0) for x in share] if share else [0,0,0,0]

    # Crescimento (√∫ltimos 15 dias)
    chart_growth_data = {}
    users_last_15 = db.session.query(
        func.date(User.data_cadastro), 
        func.count(User.id)
    ).filter(User.data_cadastro >= (hoje - timedelta(days=15)))\
     .group_by(func.date(User.data_cadastro)).all()
     
    # Popula o dicion√°rio
    map_growth = {str(d): c for d, c in users_last_15}
    
    labels_growth = []
    values_growth = []
    for i in range(15, -1, -1):
        d_obj = hoje - timedelta(days=i)
        d_str = d_obj.strftime('%Y-%m-%d')
        d_lbl = d_obj.strftime('%d/%m')
        labels_growth.append(d_lbl)
        values_growth.append(map_growth.get(d_str, 0))

    return render_template('admin_business.html', 
                           mrr_liquido=mrr_total_liquido,
                           mrr_basic=mrr_basic_liq,
                           mrr_premium=mrr_premium_liq,
                           count_basic=count_basic,
                           count_premium=count_premium,
                           arr=arr_projetado, 
                           qtd_risco=qtd_risco, 
                           media_reais_km=media_reais_km, 
                           custo_medio_km=custo_medio_km, 
                           stickiness=stickiness, 
                           ltv=ltv, 
                           subs_card=subs_card, 
                           subs_pix=subs_pix,
                           share_data=share_data, 
                           top_users=top_users, 
                           growth_labels=labels_growth, 
                           growth_values=values_growth)

@bp.route('/rodar_testes', endpoint='rodar_testes')
@admin_required
def admin_run_tests():
    if not pytest: return render_template('admin_tests.html', output="Pytest n√£o instalado.", status="erro")
    buffer = io.StringIO(); old_stdout = sys.stdout; sys.stdout = buffer
    try:
        if os.getcwd() not in sys.path: sys.path.insert(0, os.getcwd())
        exit_code = pytest.main(["-v", "-p", "no:cacheprovider", "tests/"])
    except Exception as e: print(f"Erro: {e}")
    finally: sys.stdout = old_stdout
    output = buffer.getvalue()
    clean_output = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])').sub('', output)
    status = "sucesso" if "failed" not in clean_output.lower() and "error" not in clean_output.lower() else "erro"
    return render_template('admin_tests.html', output=clean_output, status=status)

@bp.route('/renovar/<int:user_id>', methods=['POST'], endpoint='renovar')
@admin_required
def admin_renovar_post(user_id):
    user = User.query.get_or_404(user_id)
    try: dias = int(request.form.get('dias', 30))
    except: dias = 30
    hoje = datetime.now().date(); base = hoje
    if user.validade:
        val_atual = user.validade
        if isinstance(val_atual, str):
            try: val_atual = datetime.strptime(val_atual, '%Y-%m-%d').date()
            except: val_atual = hoje
        elif isinstance(val_atual, datetime): val_atual = val_atual.date()
        if val_atual > hoje: base = val_atual
    if dias == 1: user.data_cadastro = (datetime.now() - timedelta(days=31)).date(); user.validade = (base + timedelta(days=1))
    else: user.validade = (base + timedelta(days=dias))
    user.category = 'subscriber'; user.payment_method = 'manual'; db.session.commit()
    return redirect(url_for('admin.dashboard'))

@bp.route('/set_category/<int:user_id>/<category>', endpoint='set_category')
@admin_required
def set_category(user_id, category):
    if category not in ['trial', 'subscriber', 'expired']: return "Invalido"
    user = User.query.get_or_404(user_id); user.category = category; db.session.commit()
    return redirect(url_for('admin.dashboard'))

@bp.route('/backup/global', endpoint='backup_global')
@admin_required
def admin_backup_global():
    try:
        memory_file = io.BytesIO()
        with zipfile.ZipFile(memory_file, 'w', zipfile.ZIP_DEFLATED) as zf:
            def add_model_to_zip(filename, model_class):
                query = model_class.query
                if hasattr(query, 'yield_per'): items = query.yield_per(1000)
                else: items = query.all()
                columns = [c.name for c in model_class.__table__.columns]
                si = io.StringIO(); cw = csv.writer(si); cw.writerow(columns)
                if items:
                    for item in items:
                        row = [str(getattr(item, c)) if getattr(item, c) is not None else '' for c in columns]
                        cw.writerow(row)
                zf.writestr(filename, si.getvalue())
            add_model_to_zip('users.csv', User); add_model_to_zip('diarios.csv', Diario); add_model_to_zip('agendamentos.csv', Agendamentos); add_model_to_zip('manutencao.csv', Manutencao); add_model_to_zip('configs.csv', Config); add_model_to_zip('tickets.csv', SupportTicket); add_model_to_zip('tickets_msg.csv', TicketMessage)
        memory_file.seek(0); timestamp = datetime.now().strftime("%Y%m%d_%H%M")
        return send_file(memory_file, download_name=f'backup_full_{timestamp}.zip', as_attachment=True, mimetype='application/zip')
    except Exception as e: return f"Erro: {e}", 500

@bp.route('/restore/global', methods=['POST'], endpoint='restore_global')
@admin_required
def admin_restore_global():
    if 'file' not in request.files: return "Erro", 400
    file = request.files['file']
    try:
        with zipfile.ZipFile(io.BytesIO(file.read())) as zf:
            map_files = [('users.csv', User), ('configs.csv', Config), ('manutencao.csv', Manutencao), ('agendamentos.csv', Agendamentos), ('diarios.csv', Diario), ('tickets.csv', SupportTicket), ('tickets_msg.csv', TicketMessage)]
            for filename, model_class in map_files:
                if filename in zf.namelist():
                    with zf.open(filename) as f:
                        reader = csv.DictReader(io.TextIOWrapper(f, encoding='utf-8'))
                        for row in reader:
                            data = {k: (None if v=='' else True if v.lower()=='true' else False if v.lower()=='false' else v) for k,v in row.items()}
                            target = model_class.query.get(data['id']) if data.get('id') else None
                            if not target:
                                if model_class==User and data.get('email'): target=User.query.filter_by(email=data['email']).first()
                                elif model_class==Config and data.get('user_id'): target=Config.query.filter_by(user_id=data['user_id'], chave=data.get('chave')).first()
                            if target:
                                for k,v in data.items(): 
                                    if hasattr(target, k) and k!='id': setattr(target, k, v)
                            else:
                                try: db.session.add(model_class(**{k:v for k,v in data.items() if hasattr(model_class, k)}))
                                except: pass
            db.session.commit()
        return redirect(url_for('admin.dashboard'))
    except Exception as e: db.session.rollback(); return f"Erro: {e}", 500

@bp.route('/zerar/<int:user_id>', methods=['POST'], endpoint='zerar')
@admin_required
def admin_zerar(user_id):
    u = User.query.get_or_404(user_id); u.validade = (datetime.now()-timedelta(days=1)).date(); u.category='expired'; db.session.commit(); return redirect(url_for('admin.dashboard'))

@bp.route('/temp_password/<int:user_id>', methods=['POST'], endpoint='temp_password')
@admin_required
def admin_temp_password(user_id):
    u = User.query.get_or_404(user_id); pw = ''.join(secrets.choice(string.ascii_letters+string.digits) for _ in range(6)); u.set_password(pw); u.is_temp_password=True; db.session.commit(); return f"Senha: {pw}"

@bp.route('/notify', methods=['POST'], endpoint='notify')
@admin_required
def admin_notify():
    msg = request.form.get('mensagem')
    target = request.form.get('user_id')
    if target and target.strip():
        u = User.query.get(int(target))
        if u: db.session.add(Notification(message=msg, user_id=u.id))
    else:
        # Otimiza√ß√£o: Bulk Insert
        users = db.session.query(User.id).all()
        bulk_notifs = [{'message': msg, 'user_id': uid[0], 'is_read': False, 'created_at': datetime.now()} for uid in users]
        db.session.bulk_insert_mappings(Notification, bulk_notifs)
    db.session.commit()
    return redirect(url_for('admin.dashboard'))

@bp.route('/deletar/<int:user_id>', endpoint='deletar')
@admin_required
def admin_delete(user_id):
    u = User.query.get_or_404(user_id)
    try: firebase_auth.delete_user(firebase_auth.get_user_by_email(u.email).uid)
    except: pass
    for m in [Config, Diario, Agendamentos, Manutencao, Notification, SupportTicket]: m.query.filter_by(user_id=u.id).delete()
    db.session.delete(u); db.session.commit(); return redirect(url_for('admin.dashboard'))

@bp.route('/logout', endpoint='logout')
def admin_logout(): session.pop('is_admin', None); return redirect(url_for('auth.login'))

@bp.route('/suporte', endpoint='suporte')
@admin_required
def admin_suporte():
    tickets = db.session.query(SupportTicket, User).join(User, SupportTicket.user_id==User.id).order_by(SupportTicket.updated_at.desc()).limit(50).all()
    return render_template('admin_suporte.html', tickets=tickets)

@bp.route('/suporte/responder/<int:ticket_id>', methods=['POST'], endpoint='suporte_reply')
@admin_required
def admin_reply_ticket(ticket_id):
    t = SupportTicket.query.get_or_404(ticket_id); msg = request.form.get('mensagem')
    if msg:
        db.session.add(TicketMessage(ticket_id=t.id, sender_type='admin', message=msg)); t.status='Respondido'; t.updated_at=datetime.now(); db.session.add(Notification(user_id=t.user_id, message=f"Resp: {t.motivo}")); db.session.commit()
    return redirect(url_for('admin.suporte'))

@bp.route('/suporte/encerrar/<int:ticket_id>', endpoint='suporte_close')
@admin_required
def admin_close_ticket(ticket_id):
    t = SupportTicket.query.get_or_404(ticket_id); t.status='Encerrado'; t.updated_at=datetime.now(); db.session.commit(); return redirect(url_for('admin.suporte'))

@bp.route('/suporte/limpar_historico', endpoint='suporte_clear')
@admin_required
def admin_clear_closed_tickets():
    try:
        tickets = SupportTicket.query.filter((SupportTicket.status=='Encerrado')|(SupportTicket.status=='Solucionado')).all()
        for t in tickets: db.session.delete(t)
        db.session.commit()
    except: db.session.rollback()
    return redirect(url_for('admin.suporte'))



==================== FIM ARQUIVO: app/routes/admin.py ====================

==================== INICIO ARQUIVO: app/routes/user_settings.py ====================
from flask import Blueprint, render_template, request, redirect, url_for, send_file, Response, flash, current_app, jsonify, session
from flask_login import login_required, current_user
from datetime import datetime, timedelta, date
import json
import calendar
import secrets
import string
from decimal import Decimal, ROUND_HALF_UP
from app.extensions import db
from app.models import Config, Manutencao, Diario, Agendamentos, SupportTicket, TicketMessage, User, Notification, Achievement, UserAchievement, CustosFixos
from app.utils import set_config, safe_float, safe_money, get_config, get_brasilia_now
from app.services import get_maintenance_prediction, get_filter_label # Importado get_filter_label
from app.services.gamification import AchievementService

bp = Blueprint('settings', __name__)

def ensure_referral_code(user):
    if not user.referral_code:
        chars = string.ascii_uppercase + string.digits
        while True:
            code = ''.join(secrets.choice(chars) for _ in range(6))
            if not User.query.filter_by(referral_code=code).first():
                user.referral_code = code; db.session.commit(); break

def get_date_range_settings(tipo, valor):
    hoje = get_brasilia_now().date(); start = end = hoje
    if tipo == 'dia':
        if not valor: valor = hoje.strftime('%Y-%m-%d')
        try: start = end = datetime.strptime(valor, '%Y-%m-%d').date()
        except: start = end = hoje
    elif tipo == 'semana':
        try:
            if valor and '|' in valor: d1, d2 = valor.split('|'); start = datetime.strptime(d1, '%Y-%m-%d').date(); end = datetime.strptime(d2, '%Y-%m-%d').date()
            else: idx = (hoje.weekday() + 1) % 7; start = hoje - timedelta(days=idx); end = start + timedelta(days=6)
        except: start = end = hoje
    elif tipo == 'mes':
        try:
            if not valor: valor = hoje.strftime('%Y-%m')
            dt = datetime.strptime(valor + '-01', '%Y-%m-%d').date(); start = dt; end = date(dt.year, dt.month, calendar.monthrange(dt.year, dt.month)[1])
        except: start = date(hoje.year, hoje.month, 1); end = date(hoje.year, hoje.month, calendar.monthrange(hoje.year, hoje.month)[1])
    return start, end

# --- ROTAS DE DESENVOLVIMENTO ---
@bp.route('/dev/switch_basic', methods=['POST'])
@login_required
def switch_basic():
    current_user.plan_type = 'basic'
    db.session.commit()
    return redirect(url_for('settings.configuracoes'))

# --- ROTAS DE CONFIGURA√á√ÉO GERAL ---
@bp.route('/configuracoes', endpoint='configuracoes')
@login_required
def configuracoes():
    is_trial=False; dias=0
    try: 
        if current_user.validade: 
            cad = current_user.data_cadastro
            if isinstance(cad, str): cad = datetime.strptime(cad, '%Y-%m-%d').date()
            val = current_user.validade
            if isinstance(val, str): val = datetime.strptime(val, '%Y-%m-%d').date()
            if (val - cad).days <= 7: is_trial=True; dias = (val - get_brasilia_now().date()).days
    except: pass
    app_version = current_app.config.get('APP_VERSION', 'v3.3-Stable')
    return render_template('configuracoes.html', version=app_version, is_trial=is_trial, dias_restantes=dias)

@bp.route('/dados_pessoais', endpoint='dados_pessoais')
@login_required
def dados_pessoais(): return render_template('user_data.html')

@bp.route('/update_user_data', methods=['POST'], endpoint='update_user_data')
@login_required
def update_user_data():
    try:
        current_user.nome = request.form.get('nome'); current_user.whatsapp = request.form.get('whatsapp'); current_user.endereco = request.form.get('endereco')
        data_nasc = request.form.get('data_nascimento')
        if data_nasc: current_user.data_nascimento = datetime.strptime(data_nasc, '%Y-%m-%d').date()
        db.session.commit(); flash('Dados atualizados com sucesso!', 'success')
    except Exception as e: db.session.rollback(); flash(f'Erro ao atualizar: {str(e)}', 'error')
    return redirect(url_for('settings.dados_pessoais'))

@bp.route('/seguranca', endpoint='seguranca')
@login_required
def seguranca(): return render_template('security_settings.html')

@bp.route('/update_email', methods=['POST'], endpoint='update_email')
@login_required
def update_email():
    new_email = request.form.get('new_email')
    if User.query.filter_by(email=new_email).first(): flash('Este e-mail j√° est√° em uso.', 'error'); return redirect(url_for('settings.seguranca'))
    try: current_user.email = new_email; db.session.commit(); flash('E-mail atualizado!', 'success')
    except: db.session.rollback(); flash('Erro ao atualizar.', 'error')
    return redirect(url_for('settings.seguranca'))

@bp.route('/update_password', methods=['POST'], endpoint='update_password')
@login_required
def update_password():
    if not current_user.check_password(request.form.get('current_password')): flash('Senha atual incorreta.', 'error'); return redirect(url_for('settings.seguranca'))
    try: current_user.set_password(request.form.get('new_password')); db.session.commit(); flash('Senha alterada!', 'success')
    except: db.session.rollback(); flash('Erro ao alterar senha.', 'error')
    return redirect(url_for('settings.seguranca'))

@bp.route('/update_avatar', methods=['POST'])
@login_required
def update_avatar():
    data = request.get_json()
    if not data or 'url' not in data: return jsonify({'error': 'URL inv√°lida'}), 400
    try: current_user.profile_image = data['url']; db.session.commit(); return jsonify({'success': True})
    except Exception as e: return jsonify({'error': str(e)}), 500

@bp.route('/indique', endpoint='indique')
@login_required
def indique():
    ensure_referral_code(current_user)
    total_indicados = User.query.filter_by(referred_by=current_user.id).count()
    total_pagos = User.query.filter_by(referred_by=current_user.id, referral_bonus_given=True).count()
    economia = total_pagos * 9.95
    ultimos = User.query.filter_by(referred_by=current_user.id).order_by(User.id.desc()).limit(10).all()
    _, unlocks = AchievementService.get_badges_with_progress(current_user)
    return render_template('indique.html', code=current_user.referral_code, total=total_indicados, ganhos=economia, ultimos=ultimos, new_badges=",".join(unlocks) if unlocks else None)

@bp.route('/conquistas', endpoint='conquistas')
@login_required
def page_conquistas():
    badges_list, new_unlocks = AchievementService.get_badges_with_progress(current_user)
    categorias = {'iniciante': [], 'habito': [], 'financeiro': [], 'ferramentas': [], 'master': []}
    for b in badges_list:
        cat = b.get('categoria', 'iniciante')
        if cat in categorias: categorias[cat].append(b)
    try:
        if new_unlocks: UserAchievement.query.filter(UserAchievement.user_id == current_user.id, UserAchievement.achievement_id.in_(new_unlocks)).update({'visto': True}, synchronize_session=False); db.session.commit()
    except: db.session.rollback()
    total_unlocked = len([b for b in badges_list if b['unlocked']])
    return render_template('conquistas.html', categorias=categorias, total_unlocked=total_unlocked, total_all=len(badges_list))

# --- IMPORTA√á√ÉO E EXPORTA√á√ÉO ---
@bp.route('/configuracoes/importar', methods=['POST'], endpoint='importar_dados')
@login_required
def importar_dados():
    if 'file' not in request.files: return redirect(url_for('settings.configuracoes') + "?msg=erro_arquivo")
    file = request.files['file']
    try:
        data = json.load(file)
        with db.session.begin_nested():
            if 'user' in data:
                u_data = data['user']
                if 'nome' in u_data: current_user.nome = u_data['nome']
                if 'whatsapp' in u_data: current_user.whatsapp = u_data['whatsapp']
            Diario.query.filter_by(user_id=current_user.id).delete(); Agendamentos.query.filter_by(user_id=current_user.id).delete(); Manutencao.query.filter_by(user_id=current_user.id).delete(); Config.query.filter_by(user_id=current_user.id).delete()
            def parse_dt(d_str):
                try: return datetime.strptime(d_str, '%Y-%m-%d').date()
                except: return None
            if 'diarios' in data:
                for d in data['diarios']:
                    d_val = parse_dt(d.get('data'))
                    db.session.add(Diario(data=d_val, ganho_bruto=safe_money(d.get('ganho_bruto')), ganho_uber=safe_money(d.get('ganho_uber')), ganho_99=safe_money(d.get('ganho_99')), ganho_part=safe_money(d.get('ganho_part')), ganho_outros=safe_money(d.get('ganho_outros')), despesa_combustivel=safe_money(d.get('despesa_combustivel')), despesa_alimentacao=safe_money(d.get('despesa_alimentacao')), despesa_manutencao=safe_money(d.get('despesa_manutencao')), qtd_uber=d.get('qtd_uber'), qtd_99=d.get('qtd_99'), qtd_part=d.get('qtd_part'), qtd_outros=d.get('qtd_outros'), km_percorrido=d.get('km_percorrido'), horas_trabalhadas=d.get('horas_trabalhadas'), user_id=current_user.id))
            if 'manutencao' in data:
                for m in data['manutencao']: db.session.add(Manutencao(item=m.get('item'), km_troca=m.get('km_troca'), km_proxima=m.get('km_proxima'), status=m.get('status'), user_id=current_user.id))
            if 'configs' in data:
                for cfg in data['configs']: db.session.add(Config(chave=cfg.get('chave'), valor=cfg.get('valor'), user_id=current_user.id))
        db.session.commit()
        return redirect(url_for('settings.configuracoes') + f"?msg=restaurado_ok")
    except: db.session.rollback(); return redirect(url_for('settings.configuracoes') + "?msg=erro_processar")

@bp.route('/exportar', endpoint='exportar_dados')
@login_required
def exportar_dados():
    data = { 'user': current_user.to_dict(), 'diarios': [d.to_dict() for d in Diario.query.filter_by(user_id=current_user.id).all()], 'manutencao': [m.to_dict() for m in Manutencao.query.filter_by(user_id=current_user.id).all()], 'configs': [c.to_dict() for c in Config.query.filter_by(user_id=current_user.id).all()] }
    if 'password_hash' in data['user']: del data['user']['password_hash']
    return Response(json.dumps(data, indent=4, ensure_ascii=False, default=str), mimetype='application/json', headers={'Content-Disposition': f'attachment;filename=backup_motoristapro_{current_user.id}.json'})

# --- NOTIFICA√á√ïES ---
@bp.route('/notifications', endpoint='notifications')
@login_required
def notifications():
    notifs = Notification.query.filter_by(user_id=current_user.id).order_by(Notification.created_at.desc()).all()
    for n in notifs: n.created_at = n.created_at - timedelta(hours=3)
    return render_template('notifications.html', notifications=notifs)

@bp.route('/mark_notification/<int:id>', endpoint='mark_notification')
@login_required
def mark_notification(id):
    n = Notification.query.get_or_404(id)
    if n.user_id == current_user.id: n.is_read = True; db.session.commit()
    return redirect(url_for('settings.notifications'))

@bp.route('/mark_all_read', endpoint='mark_all_read')
@login_required
def mark_all_read():
    try: Notification.query.filter_by(user_id=current_user.id, is_read=False).update({'is_read': True}); db.session.commit()
    except: db.session.rollback()
    return redirect(url_for('settings.notifications'))

@bp.route('/clear_notifications', endpoint='clear_notifications')
@login_required
def clear_notifications():
    try: Notification.query.filter_by(user_id=current_user.id).delete(); db.session.commit()
    except: db.session.rollback()
    return redirect(url_for('settings.notifications'))

# --- CALCULADORA E SETUP ---
@bp.route('/calculadora', methods=('GET','POST'), endpoint='calculadora')
@login_required
def calculadora():
    if request.method == 'POST':
        if 'preco_km' in request.form: 
            set_config(current_user.id, 'preco_km', request.form['preco_km']); set_config(current_user.id, 'preco_min', request.form['preco_min']); set_config(current_user.id, 'taxa_base', request.form['taxa_base'])
        if 'consumo_etanol' in request.form: 
            set_config(current_user.id, 'consumo_etanol', request.form['consumo_etanol']); set_config(current_user.id, 'consumo_gasolina', request.form['consumo_gasolina'])
        return redirect(url_for('settings.calculadora'))
    cfg_list = Config.query.filter_by(user_id=current_user.id).all(); cfg = {c.chave: c.valor for c in cfg_list}
    return render_template('calculadora.html', p_km=cfg.get('preco_km'), p_min=cfg.get('preco_min'), taxa=cfg.get('taxa_base'), c_etanol=cfg.get('consumo_etanol','7'), c_gas=cfg.get('consumo_gasolina','10'))

@bp.route('/lucro_real', endpoint='lucro_real')
@login_required
def lucro_real():
    if not get_config(current_user.id, 'veiculo_modelo'): 
        return redirect(url_for('settings.setup_veiculo') + "?msg=config_required")
    
    cfg_list = Config.query.filter_by(user_id=current_user.id).all()
    cfg = {c.chave: c.valor for c in cfg_list}
    
    # Pega os par√¢metros do Dashboard (via query params ou sess√£o)
    tipo = request.args.get('tipo', session.get('dash_tipo', 'dia'))
    valor = request.args.get('valor', session.get('dash_valor', ''))
    
    # Toggle de Custos Fixos (Default: False)
    usar_custos_fixos = request.args.get('usar_custos_fixos') == 'true'
    
    start_date, end_date = get_date_range_settings(tipo, valor)
    
    # Gera o r√≥tulo amig√°vel (ex: "Semana Atual")
    periodo_label = get_filter_label(tipo, start_date, end_date)
    
    registros = Diario.query.filter_by(user_id=current_user.id).filter(Diario.data >= start_date).filter(Diario.data <= end_date).all()
    
    # === C√ÅLCULO FINANCEIRO SEGURO (Decimal) ===
    ganho_total = sum((r.ganho_bruto or Decimal('0.00')) for r in registros)
    
    despesa_var = sum(
        (r.despesa_combustivel or Decimal('0.00')) + 
        (r.despesa_alimentacao or Decimal('0.00')) + 
        (r.despesa_manutencao or Decimal('0.00')) 
        for r in registros
    )
    
    km_total = sum((r.km_percorrido or 0.0) for r in registros)
    lucro_operacional = ganho_total - despesa_var
    
    # Configura√ß√µes Vari√°veis
    depreciacao_km = safe_money(cfg.get('depreciacao_km', '0.20'))
    manutencao_km = safe_money(cfg.get('manutencao_km', '0.15'))
    autonomia = safe_float(cfg.get('autonomia_kml', '10'))
    preco_comb = safe_money(cfg.get('preco_combustivel', '0'))
    
    custo_fuel_km_dec = (preco_comb / Decimal(str(autonomia))) if autonomia > 0 else Decimal('0.00')
    custo_km_reserva = depreciacao_km + manutencao_km
    custo_total_rodagem = custo_fuel_km_dec + custo_km_reserva
    
    # Reserva T√©cnica (Vari√°vel por KM)
    total_reserva = Decimal(str(km_total)) * custo_km_reserva
    
    # === CUSTOS FIXOS (Reserva Operacional) ===
    total_custo_fixo_periodo = Decimal('0.00')
    
    if usar_custos_fixos and current_user.plan_type == 'premium':
        seguro_mensal = safe_money(cfg.get('seguro_mensal', '0'))
        ipva_anual = safe_money(cfg.get('ipva_anual', '0'))
        aluguel_semanal = safe_money(cfg.get('aluguel_semanal', '0'))
        financiamento_mensal = safe_money(cfg.get('financiamento_mensal', '0'))
        
        # Normaliza para Custo Dia
        custo_dia_seguro = seguro_mensal / 30
        custo_dia_ipva = ipva_anual / 365
        custo_dia_aluguel = aluguel_semanal / 7
        custo_dia_financ = financiamento_mensal / 30
        
        total_fixo_dia = custo_dia_seguro + custo_dia_ipva + custo_dia_aluguel + custo_dia_financ
        
        # Calcula dias no per√≠odo
        num_dias = (end_date - start_date).days + 1
        total_custo_fixo_periodo = total_fixo_dia * num_dias

    lucro_real_val = lucro_operacional - total_reserva - total_custo_fixo_periodo
    
    return render_template('lucro_real.html', 
                           c=cfg, 
                           d={'custo_km_reserva': custo_km_reserva, 'custo_total_rodagem': custo_total_rodagem}, 
                           lucro_operacional=lucro_operacional, 
                           km_total=km_total, 
                           total_reserva=total_reserva, 
                           total_custo_fixo=total_custo_fixo_periodo,
                           usar_custos_fixos=usar_custos_fixos,
                           lucro_real=lucro_real_val,
                           tipo=tipo, valor=valor,
                           periodo_label=periodo_label)

@bp.route('/setup_veiculo', methods=('GET', 'POST'), endpoint='setup_veiculo')
@login_required
def setup_veiculo():
    if request.method == 'POST':
        if request.form.get('action') == 'delete':
            keys_to_delete = ['veiculo_marca', 'veiculo_modelo', 'veiculo_ano', 'autonomia_kml', 'preco_combustivel', 'depreciacao_km', 'manutencao_km', 'km_atual_carro', 'seguro_mensal', 'ipva_anual', 'aluguel_semanal', 'financiamento_mensal']
            for k in keys_to_delete:
                c = Config.query.filter_by(user_id=current_user.id, chave=k).first()
                if c: db.session.delete(c)
            db.session.commit(); return redirect(url_for('settings.lucro_real'))
        else:
            for campo in ['veiculo_marca', 'veiculo_modelo', 'veiculo_ano', 'autonomia_kml', 'preco_combustivel', 'depreciacao_km', 'manutencao_km', 'km_atual_carro']: 
                set_config(current_user.id, campo, request.form.get(campo, ''))
            
            if current_user.plan_type == 'premium':
                for campo in ['seguro_mensal', 'ipva_anual', 'aluguel_semanal', 'financiamento_mensal']:
                    set_config(current_user.id, campo, request.form.get(campo, '0'))
            
            return redirect(url_for('settings.lucro_real'))
            
    cfg_list = Config.query.filter_by(user_id=current_user.id).all(); c = {cfg.chave: cfg.valor for cfg in cfg_list}
    return render_template('setup_veiculo.html', c=c)

@bp.route('/gerar_recibo', methods=['GET', 'POST'], endpoint='gerar_recibo')
@login_required
def gerar_recibo():
    unlocks = AchievementService.check_usage(current_user, 'recibo'); agenda_badges = request.args.get('new_badges')
    if agenda_badges: unlocks.extend(agenda_badges.split(','))
    unlock_str = ",".join(unlocks) if unlocks else None
    data = { 'motorista': current_user.nome, 'valor': request.args.get('valor', '0.00'), 'cliente': request.args.get('cliente', 'Passageiro'), 'origem': request.args.get('origem', ''), 'destino': request.args.get('destino', ''), 'data': request.args.get('data', get_brasilia_now().strftime('%d/%m/%Y')) }
    return render_template('recibo.html', data=data, new_badges=unlock_str)

@bp.route('/adicionar_custo', methods=['POST'], endpoint='adicionar_custo')
@login_required
def adicionar_custo():
    try:
        nome = request.form.get('nome'); valor = safe_money(request.form.get('valor'))
        novo_custo = CustosFixos(nome=nome, valor=valor, tipo='mensal', user_id=current_user.id)
        db.session.add(novo_custo); db.session.commit()
        return redirect(url_for('settings.custos'))
    except: db.session.rollback(); return redirect(url_for('settings.custos'))

@bp.route('/deletar_custo/<int:id>', endpoint='deletar_custo')
@login_required
def deletar_custo(id):
    try:
        custo = CustosFixos.query.get_or_404(id)
        if custo.user_id == current_user.id: db.session.delete(custo); db.session.commit()
    except: db.session.rollback()
    return redirect(url_for('settings.custos'))

@bp.route('/custos', endpoint='custos')
@login_required
def custos():
    lista_custos = CustosFixos.query.filter_by(user_id=current_user.id).all()
    return render_template('custos.html', custos=lista_custos)



==================== FIM ARQUIVO: app/routes/user_settings.py ====================

==================== INICIO ARQUIVO: app/routes/__init__.py ====================
# Este arquivo faz a pasta 'routes' ser um pacote Python.



==================== FIM ARQUIVO: app/routes/__init__.py ====================

==================== INICIO ARQUIVO: app/routes/payments.py ====================
import os
import stripe
import mercadopago
from datetime import datetime, timedelta
from decimal import Decimal
from flask import Blueprint, render_template, request, redirect, url_for, jsonify, current_app
from flask_login import login_required, current_user
from app.extensions import db, csrf
from app.models import User, Notification

bp = Blueprint('payments', __name__)

# Configura√ß√£o das Chaves (L√™ do ambiente)
stripe.api_key = os.environ.get('STRIPE_SECRET_KEY')
STRIPE_WEBHOOK_SECRET = os.environ.get('STRIPE_WEBHOOK_SECRET')
mp_token = os.environ.get('MP_ACCESS_TOKEN')

mp = None
if mp_token:
    try: 
        mp = mercadopago.SDK(mp_token)
        print(f"Mercado Pago SDK iniciado...")
    except Exception as e: 
        print(f"Erro ao iniciar MercadoPago SDK: {e}")

def renovar_assinatura(user_id=None, email=None, method='manual', valor_pago=0.0, plan_type=None):
    u = None
    if user_id: u = User.query.get(int(user_id))
    elif email: u = User.query.filter_by(email=email).first()
    
    if u:
        hoje = datetime.now().date()
        base = hoje
        if u.validade:
            val_atual = u.validade
            if isinstance(val_atual, str):
                try: val_atual = datetime.strptime(val_atual, '%Y-%m-%d').date()
                except: val_atual = hoje
            elif isinstance(val_atual, datetime): val_atual = val_atual.date()
            if val_atual > hoje: base = val_atual
            
        u.validade = (base + timedelta(days=30))
        u.category = 'subscriber'
        u.payment_method = method
        
        if plan_type:
            u.plan_type = plan_type
        else:
            val_float = float(valor_pago)
            if val_float < 15.00 and val_float > 8.00:
                if u.referral_balance > 0: u.plan_type = 'premium'
                else: u.plan_type = 'basic'
            elif val_float >= 19.00: u.plan_type = 'premium'
            else: u.plan_type = 'premium'
        
        val_float = float(valor_pago)
        if val_float > 0 and val_float < 15.00:
            if u.referral_balance > 0: u.referral_balance -= 1
                
        if u.referred_by and not u.referral_bonus_given:
            try:
                referrer = User.query.get(u.referred_by)
                if referrer:
                    referrer.referral_balance += 1
                    msg = f"üéâ Parab√©ns! Sua indica√ß√£o ({u.nome.split()[0]}) assinou. Voc√™ ganhou 50% de desconto na pr√≥xima renova√ß√£o!"
                    db.session.add(Notification(user_id=referrer.id, message=msg))
                    u.referral_bonus_given = True
            except: pass
        
        try: db.session.commit()
        except: db.session.rollback()

@bp.route('/assinar', endpoint='assinar')
@login_required
def assinar():
    tem_desconto = current_user.referral_balance > 0
    chaves_ok = bool(os.environ.get('STRIPE_PUBLIC_KEY'))
    is_dev = current_app.debug or os.environ.get('CODESPACES') == 'true'
    show_mock = is_dev or not chaves_ok
    msg = request.args.get('msg')
    
    return render_template('pagamento_pro.html', 
                           stripe_public_key=os.environ.get('STRIPE_PUBLIC_KEY'), 
                           email=current_user.email,
                           tem_desconto=tem_desconto,
                           show_mock=show_mock,
                           msg=msg)

@bp.route('/gerenciar_assinatura', endpoint='gerenciar')
@login_required
def gerenciar_assinatura():
    if not stripe.api_key: return redirect(url_for('main.assinatura') + "?msg=erro_config")
    try:
        customers = stripe.Customer.list(email=current_user.email, limit=1)
        if customers.data:
            session = stripe.billing_portal.Session.create(
                customer=customers.data[0].id,
                return_url=url_for('main.assinatura', _external=True)
            )
            return redirect(session.url)
        else: return redirect(url_for('main.assinatura') + "?msg=sem_cartao")
    except Exception as e: return redirect(url_for('main.assinatura') + "?msg=erro_stripe")

@bp.route('/mock_success', methods=['POST'])
@login_required
def mock_success():
    is_dev = current_app.debug or os.environ.get('CODESPACES') == 'true'
    if not is_dev and os.environ.get('STRIPE_SECRET_KEY') and 'live' in os.environ.get('STRIPE_SECRET_KEY'): 
        return "Acesso negado em produ√ß√£o", 403
    renovar_assinatura(user_id=current_user.id, method='mock_test', valor_pago=19.90, plan_type='premium')
    return redirect(url_for('payments.sucesso'))

@bp.route('/create-checkout-session', methods=['POST'])
@login_required
def create_checkout_session():
    if not stripe.api_key: return jsonify({'error': 'Stripe n√£o configurado'}), 500
    try:
        data = request.get_json() or {}
        plan_key = data.get('plan', 'premium') 
        plano = current_app.config['PLANS'].get(plan_key, current_app.config['PLANS']['premium'])
        
        discounts = []
        if current_user.referral_balance > 0 and plan_key == 'premium':
            coupon_id = plano.get('stripe_coupon_id')
            if coupon_id: discounts = [{'coupon': coupon_id}]

        session = stripe.checkout.Session.create(
            customer_email=current_user.email,
            payment_method_types=['card'],
            line_items=[{'price': plano['stripe_price_id'], 'quantity': 1}],
            discounts=discounts,
            mode='subscription',
            success_url=url_for('payments.sucesso', _external=True) + '?session_id={CHECKOUT_SESSION_ID}',
            cancel_url=url_for('payments.assinar', _external=True),
            client_reference_id=str(current_user.id),
            metadata={'plan_type': plan_key}
        )
        return jsonify({'id': session.id})
    except Exception as e: return jsonify({'error': str(e)}), 403

@bp.route('/create-pix-payment', methods=['POST'])
@login_required
def create_pix_payment():
    if not mp_token:
        print("ERRO: MP_ACCESS_TOKEN ausente.")
        return jsonify({'error': 'Configura√ß√£o PIX ausente no servidor.'}), 503
        
    if not mp: 
        return jsonify({'error': 'SDK do Mercado Pago n√£o inicializou.'}), 503
        
    try:
        data = request.get_json() or {}
        plan_key = data.get('plan', 'premium')
        plano = current_app.config['PLANS'].get(plan_key, current_app.config['PLANS']['premium'])
        valor_float = float(plano['valor'])
        
        if current_user.referral_balance > 0 and plan_key == 'premium':
            valor_float = valor_float / 2.0
            description = f"MotoristaPro - {plano['nome']} (50% OFF)"
        else:
            description = f"MotoristaPro - {plano['nome']}"

        # Tratamento de email para Sandbox
        payer_email = current_user.email
        if '@' not in payer_email or 'teste' in payer_email:
            payer_email = "test_user_123@test.com"

        # CORRE√á√ÉO DO ERRO DE URL (ITEM CR√çTICO)
        # Se for localhost ou IP local, N√ÉO envia o notification_url
        notif_url = url_for('payments.mp_webhook', _external=True).replace('http://', 'https://')
        
        # Filtros de URL inv√°lida para Webhook
        if 'localhost' in notif_url or '127.0.0.1' in notif_url or '.local' in notif_url:
            notif_url = None

        payment_data = {
            "transaction_amount": valor_float,
            "description": description,
            "payment_method_id": "pix",
            "payer": {
                "email": payer_email,
                "first_name": current_user.nome.split()[0] if current_user.nome else "User",
                "last_name": "App"
            },
            "external_reference": str(current_user.id),
            "metadata": {"plan_type": plan_key}
        }
        
        # S√≥ adiciona a chave se a URL for v√°lida
        if notif_url:
            payment_data["notification_url"] = notif_url

        pref = mp.payment().create(payment_data)
        
        if pref["status"] == 201:
            r = pref["response"]
            return jsonify({
                'qr_code': r['point_of_interaction']['transaction_data']['qr_code'], 
                'qr_code_base64': r['point_of_interaction']['transaction_data']['qr_code_base64'], 
                'valor': valor_float
            })
        else:
            error_msg = pref.get("response", {}).get("message", "Erro desconhecido")
            print(f"ERRO MP PIX: {error_msg} - Dados: {payment_data}")
            return jsonify({'error': f"Mercado Pago recusou: {error_msg}"}), 500
            
    except Exception as e: 
        print(f"EXCE√á√ÉO PIX: {str(e)}")
        return jsonify({'error': f"Erro interno: {str(e)}"}), 500

@bp.route('/webhook/stripe', methods=['POST'])
@csrf.exempt
def stripe_webhook():
    payload = request.get_data(as_text=True)
    sig_header = request.headers.get('Stripe-Signature')
    try: event = stripe.Webhook.construct_event(payload, sig_header, STRIPE_WEBHOOK_SECRET)
    except: return 'Error', 400

    if event['type'] == 'checkout.session.completed':
        session = event['data']['object']
        amount_paid = Decimal(session.get('amount_total', 0)) / 100
        plan_type = session.get('metadata', {}).get('plan_type', 'premium')
        renovar_assinatura(user_id=session.get('client_reference_id'), email=session.get('customer_email'), method='card', valor_pago=amount_paid, plan_type=plan_type)

    elif event['type'] == 'invoice.payment_succeeded':
        invoice = event['data']['object']
        if invoice.get('billing_reason') == 'subscription_create': return jsonify({'status': 'ignored'})
        amount_paid = Decimal(invoice.get('amount_paid', 0)) / 100
        renovar_assinatura(email=invoice.get('customer_email'), method='card', valor_pago=amount_paid)
            
    return jsonify({'status': 'success'})

@bp.route('/webhook/mercadopago', methods=['POST'])
@csrf.exempt
def mp_webhook():
    if not mp: return jsonify({'status': 'ignored'})
    if request.args.get('type') == 'payment':
        try:
            pay = mp.payment().get(request.args.get('data.id'))['response']
            if pay['status'] == 'approved': 
                amount_paid = Decimal(str(pay.get('transaction_amount', 0)))
                plan_type = pay.get('metadata', {}).get('plan_type')
                renovar_assinatura(user_id=pay['external_reference'], method='pix', valor_pago=amount_paid, plan_type=plan_type)
        except: pass
    return jsonify({'status': 'ok'})

@bp.route('/sucesso', endpoint='sucesso')
def sucesso(): return render_template('pagamento_sucesso.html')




==================== FIM ARQUIVO: app/routes/payments.py ====================

==================== INICIO ARQUIVO: app/routes/dashboard.py ====================
from flask import Blueprint, render_template, request, redirect, url_for, session, current_app
from flask_login import login_required, current_user
from app.extensions import db
from app.models import Diario, Config, Manutencao
from app.utils import safe_float, safe_money, get_config, get_brasilia_now
from app.services import calculate_dashboard, generate_week_options, get_date_range_local, get_filter_label, calculate_smart_goal
from app.services.gamification import AchievementService
from decimal import Decimal
from datetime import datetime

# Blueprint Dedicado ao Dashboard
bp = Blueprint('dashboard', __name__)

@bp.route('/', endpoint='index')
def index():
    if not current_user.is_authenticated: 
        return render_template('landing.html')
    
    # Valida√ß√£o de Vers√£o para for√ßar refresh se necess√°rio
    app_version = current_app.config.get('APP_VERSION')
    if current_user.last_seen_version != app_version: 
        return redirect(url_for('main.bem_vindo'))

    # Filtros de Sess√£o
    tipo = request.args.get('tipo')
    valor_bruto = request.args.get('valor')
    
    if not tipo: tipo = session.get('dash_tipo', 'dia')
    if not valor_bruto: valor_bruto = session.get('dash_valor')
    
    session['dash_tipo'] = tipo
    if valor_bruto: session['dash_valor'] = valor_bruto

    start_date, end_date, titulo, valor_ajustado = get_date_range_local(tipo, valor_bruto)
    filter_label = get_filter_label(tipo, start_date, end_date)
    
    # L√≥gica de Meta Semanal (Smart Goal)
    ask_for_goal = False
    hoje_dt = get_brasilia_now()
    if hoje_dt.weekday() == 6: # Domingo
        if get_config(current_user.id, 'meta_last_update_date') != hoje_dt.strftime('%Y-%m-%d'): 
            ask_for_goal = True

    try:
        dados = calculate_dashboard(current_user, start_date, end_date)
        meta_semanal = safe_money(get_config(current_user.id, 'meta_semanal'))
        
        lucro_raw = dados.get('lucro_semanal_acumulado', 0.0)
        lucro_semanal_acumulado = Decimal(str(lucro_raw)) if isinstance(lucro_raw, float) else lucro_raw
        
        smart_goal = calculate_smart_goal(current_user, lucro_semanal_acumulado, meta_semanal, dados['metricas'])
    except Exception as e:
        print(f"Erro Dash: {e}")
        return "Erro ao carregar dashboard.", 500

    # Gamifica√ß√£o: Carrega apenas o necess√°rio para visualiza√ß√£o
    AchievementService.get_badges_with_progress(current_user)
    
    week_options = generate_week_options(start_date.year)

    context = {
        'resumo': {'ganho': dados['ganho'], 'despesa': dados['despesa_var'], 'km': dados['km'], 'horas': dados['horas'], 'corridas': dados['total_corridas']},
        'despesas': dados['despesa_var'], 'receitas': dados['ganho'], 'lucro_operacional': dados['operacional'], 'metricas': dados['metricas'],
        'dados_apps': dados['dados_apps'], 'dados_rosca': dados['dados_rosca'], 'lista_manutencao': dados['lista_manutencao'],
        'meta': meta_semanal, 'lucro_acumulado': lucro_semanal_acumulado, 'smart_goal': smart_goal,
        'tipo': tipo, 'valor': valor_ajustado, 'filter_label': filter_label, 'week_options': week_options,
        'odo_atual': dados['odo_atual'], 'lista_despesas': dados['lista_despesas'], 'ask_for_goal': ask_for_goal
    }

    if request.headers.get('HX-Request'): 
        return render_template('partials/dashboard_content.html', **context)
        
    return render_template('index.html', **context)




==================== FIM ARQUIVO: app/routes/dashboard.py ====================

==================== INICIO ARQUIVO: app/templates/adicionar.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* Estilos do Modal de Nome do App */
    #appNameModal, #upsellModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:5000; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
    .modal-input-card { background: var(--bg-body); width: 85%; max-width: 320px; padding: 25px; border-radius: 25px; text-align: center; border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popUp 0.3s; }
    .modal-input-field { width: 100%; padding: 15px; border-radius: 15px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.8); margin: 15px 0; font-size: 16px; text-align: center; font-weight: 700; color: var(--text-main); outline: none; }
    .modal-input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    
    /* Card Upsell */
    .upsell-card { width:90%; max-width:350px; text-align:center; padding:30px; background: white; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popUp 0.3s; position: relative; }
    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer; }

    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Novo Lan√ßamento</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Fechamento do Dia</p>
    </div>
    <div style="width:40px;"></div> 
</div>

<form method="post" class="container fade-in" id="formAdd" style="padding-top: 10px; padding-bottom: 100px; animation-delay: 0.1s;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div id="offlineAlert" style="display:none; background:rgba(245, 158, 11, 0.15); color:var(--warning); padding:15px; border-radius:20px; margin-bottom:20px; border:1px solid rgba(245, 158, 11, 0.3); font-size:13px; font-weight:700; text-align:center;">
        <i class="fas fa-wifi"></i> Modo Offline Ativo
    </div>

    <!-- 1. DADOS GERAIS -->
    <div class="glass-card">
        <div class="card-title"><span>Resumo</span></div>
        <div style="margin-bottom:15px;">
             <label style="font-size:11px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block; text-transform:uppercase;">Data do Trabalho</label>
             <input type="date" name="data" value="{{ data_hoje }}" required style="font-weight:700; background:rgba(255,255,255,0.6);">
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div>
                <label style="font-size:11px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block; text-transform:uppercase;">KM Total</label>
                <input type="number" step="0.1" name="km_percorrido" placeholder="0.0" inputmode="decimal" style="background:rgba(255,255,255,0.6);">
            </div>
            <div>
                <label style="font-size:11px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block; text-transform:uppercase;">Horas (H:M)</label>
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="number" name="horas_qtd" value="{{ h_val }}" placeholder="00" style="text-align:center; background:rgba(255,255,255,0.6);">
                    <span style="font-weight:bold; color:var(--text-secondary);">:</span>
                    <input type="number" name="minutos_qtd" value="{{ m_val }}" placeholder="00" style="text-align:center; background:rgba(255,255,255,0.6);">
                </div>
            </div>
        </div>
    </div>

    <!-- 2. FATURAMENTO -->
    <div class="glass-card" id="cardGanhos" style="border-left: 4px solid var(--success);">
        <div class="card-title">
            <span style="color:var(--success);">Faturamento</span>
            <span id="badgeTotal" style="background:var(--success); color:white; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:800;">R$ 0.00</span>
        </div>
        
        <div style="position:relative; margin-bottom:20px;">
            <span style="position:absolute; left:20px; top:18px; color:var(--success); font-weight:800; font-size:18px;">R$</span>
            <input type="number" step="0.01" id="ganhoTotal" name="ganho_bruto" placeholder="0.00" style="padding-left:55px; height:60px; font-weight:800; color:var(--success); font-size:28px; background:rgba(16, 185, 129, 0.08); border-color:rgba(16, 185, 129, 0.3); border-radius:18px;" inputmode="decimal">
        </div>

        <div style="background:rgba(255,255,255,0.4); border-radius:16px; padding:15px; border:1px solid rgba(0,0,0,0.05);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary);">DETALHAR GANHOS</label>
                <!-- Bot√£o Editar Nome (Oculto por padr√£o, aparece via JS) -->
                <div id="btnEditCustomName" onclick="handleEditAppName()" style="display:none; cursor:pointer; font-size:10px; color:var(--primary); font-weight:700; align-items:center; gap:5px;">
                    <i class="fas fa-pen"></i> Personalizar '{{ custom_app_name }}'
                </div>
            </div>

            <div class="expense-adder" style="display:flex; gap:10px; margin-bottom:10px; align-items:flex-end;">
                <div style="flex:1; position:relative;">
                    <input type="number" id="newEarnValue" placeholder="R$ 0.00" style="padding-left:10px; color:var(--success); font-weight:800;" inputmode="decimal">
                </div>
                <div style="flex:1.5;">
                    <select id="newEarnType" onchange="checkCustomAppVisibility()">
                        <option value="ganho_uber">Uber</option>
                        <option value="ganho_99">99 Pop</option>
                        <option value="ganho_part">Particular</option>
                        <option value="ganho_outros" id="optCustom">{{ custom_app_name }}</option>
                    </select>
                </div>
                <button type="button" onclick="addEarning()" style="background:var(--success); color:white; border:none; border-radius:14px; width:52px; height:52px; cursor:pointer; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.25); display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div id="earningList" style="display:none; border-top:1px dashed rgba(0,0,0,0.1); margin-top:10px; padding-top:10px;"></div>
        </div>

        <input type="hidden" name="ganho_uber" id="ganho_uber" value="0">
        <input type="hidden" name="ganho_99" id="ganho_99" value="0">
        <input type="hidden" name="ganho_part" id="ganho_part" value="0">
        <input type="hidden" name="ganho_out" id="ganho_out" value="0">
    </div>

    <!-- 3. CORRIDAS -->
    <div class="glass-card">
        <div class="card-title"><span>Quantidade de Viagens</span></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px;">
            <div><label style="font-size:9px; text-align:center; display:block; font-weight:700; color:var(--text-secondary); margin-bottom:2px;">UBER</label><input type="number" name="qtd_uber" placeholder="0" style="text-align:center; padding:10px; font-weight:700;"></div>
            <div><label style="font-size:9px; text-align:center; display:block; font-weight:700; color:var(--text-secondary); margin-bottom:2px;">99</label><input type="number" name="qtd_99" placeholder="0" style="text-align:center; padding:10px; font-weight:700;"></div>
            <div><label style="font-size:9px; text-align:center; display:block; font-weight:700; color:var(--text-secondary); margin-bottom:2px;">PART</label><input type="number" name="qtd_part" placeholder="0" style="text-align:center; padding:10px; font-weight:700;"></div>
            <div><label id="lblCustomQtd" style="font-size:9px; text-align:center; display:block; font-weight:700; color:var(--text-secondary); margin-bottom:2px; white-space:nowrap; overflow:hidden;">{{ custom_app_name[:3] }}</label><input type="number" name="qtd_outros" placeholder="0" style="text-align:center; padding:10px; font-weight:700;"></div>
        </div>
    </div>

    <!-- 4. DESPESAS -->
    <div class="glass-card" id="cardDespesas" style="border-left: 4px solid var(--danger);">
        <div class="card-title"><span style="color:var(--danger);">Despesas do Dia</span></div>
        
        <div class="expense-adder" style="display:flex; gap:10px; margin-bottom:15px; align-items:flex-end;">
            <div style="flex:1; position:relative;">
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">VALOR (R$)</label>
                <input type="number" id="newExpValue" placeholder="0.00" style="padding-left:15px; color:var(--danger); font-weight:800;" inputmode="decimal">
            </div>
            <div style="flex:1.5;">
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">CATEGORIA</label>
                <select id="newExpType">
                    <option value="total_combustivel">Combust√≠vel</option>
                    <option value="total_alimentacao">Alimenta√ß√£o</option>
                    <option value="total_manutencao">Manuten√ß√£o</option>
                </select>
            </div>
            <button type="button" onclick="addExpense()" style="background:var(--primary-gradient); color:white; border:none; border-radius:14px; width:52px; height:52px; cursor:pointer; box-shadow: 0 8px 20px rgba(37,99,235,0.25); display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div id="expenseList" style="display:none; background:rgba(255,255,255,0.5); padding:15px; border-radius:16px; border:1px solid rgba(0,0,0,0.05);"></div>

        <input type="hidden" name="total_combustivel" id="total_combustivel" value="0">
        <input type="hidden" name="total_alimentacao" id="total_alimentacao" value="0">
        <input type="hidden" name="total_manutencao" id="total_manutencao" value="0">
    </div>

    <button type="submit" id="btnSalvarDia" class="btn" style="margin-bottom:50px; font-size:16px; padding:18px; border-radius: 50px; background: var(--primary-gradient); color: white; border: none; width: 100%; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4); font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 10px;">
        <i class="fas fa-check"></i> SALVAR LAN√áAMENTO
    </button>
</form>

<!-- MODAL NOME APP -->
<div id="appNameModal">
    <div class="modal-input-card">
        <h3 style="margin:0 0 10px 0; color:var(--text-main);">Personalizar App</h3>
        <p style="font-size:13px; color:var(--text-secondary); margin-bottom:20px;">Digite o nome do aplicativo local que voc√™ usa:</p>
        <input type="text" id="newAppNameInput" class="modal-input-field" placeholder="Ex: Urban, 99Moto..." maxlength="10">
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('appNameModal').style.display='none'" style="flex:1; background:transparent; border:1px solid var(--text-secondary); color:var(--text-secondary); padding:12px; border-radius:15px; font-weight:700; cursor:pointer;">Cancelar</button>
            <button onclick="saveAppName()" style="flex:1; background:var(--primary); color:white; border:none; padding:12px; border-radius:15px; font-weight:700; cursor:pointer;">Salvar</button>
        </div>
    </div>
</div>

<!-- MODAL UPSELL -->
<div id="upsellModal">
    <div class="upsell-card">
        <button class="close-modal" onclick="document.getElementById('upsellModal').style.display='none'">&times;</button>
        <div style="width:70px; height:70px; background:rgba(37,99,235,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto; color:var(--primary); font-size:30px;"><i class="fas fa-crown"></i></div>
        <h3 style="margin:0 0 10px 0; color:var(--text-main); font-size:20px; font-weight:800;">Personalize seu App</h3>
        <p style="font-size:14px; color:var(--text-secondary); margin-bottom:25px; line-height:1.5;">O plano Basic usa o nome padr√£o "Outros".<br>No Premium, voc√™ pode renomear para o app da sua cidade (ex: Urban, Indrive) e organizar melhor.</p>
        <a href="/assinar" class="btn" style="border-radius:50px; background:var(--primary); box-shadow: 0 10px 30px rgba(37,99,235,0.4);">Desbloquear Edi√ß√£o</a>
    </div>
</div>

{% block extra_js %}
<script>
    function checkConnection() {
        const alert = document.getElementById('offlineAlert'); const btn = document.getElementById('btnSalvarDia');
        if (!navigator.onLine) { alert.style.display = 'block'; btn.innerHTML = '<i class="fas fa-save"></i> SALVAR OFFLINE'; btn.style.background = 'var(--warning)'; } 
        else { alert.style.display = 'none'; btn.innerHTML = '<i class="fas fa-check"></i> SALVAR LAN√áAMENTO'; btn.style.background = 'var(--primary-gradient)'; }
    }
    window.addEventListener('online', checkConnection); window.addEventListener('offline', checkConnection); checkConnection();

    document.getElementById('formAdd').addEventListener('submit', function(e) {
        if (!navigator.onLine) {
            e.preventDefault();
            const formData = new FormData(this); const data = {}; formData.forEach((value, key) => data[key] = value); data.timestamp = Date.now();
            let pending = JSON.parse(localStorage.getItem('pending_uploads') || '[]'); pending.push(data); localStorage.setItem('pending_uploads', JSON.stringify(pending));
            alert('Salvo offline!'); window.location.href = '/?msg=offline_saved';
        }
    });

    let earnings = [];
    const mainInput = document.getElementById('ganhoTotal');
    const badge = document.getElementById('badgeTotal');

    // CONTROLE VISUAL DO BOT√ÉO DE EDITAR (ITEM 1)
    function checkCustomAppVisibility() {
        const select = document.getElementById('newEarnType');
        const btn = document.getElementById('btnEditCustomName');
        if (select.value === 'ganho_outros') {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    }

    function addEarning() {
        const val = parseFloat(document.getElementById('newEarnValue').value); 
        const typeSelect = document.getElementById('newEarnType');
        
        if (val > 0) { 
            earnings.push({ val: val, type: typeSelect.value, name: typeSelect.options[typeSelect.selectedIndex].text }); 
            document.getElementById('newEarnValue').value = ''; 
            renderEarnings(); 
        }
    }

    function removeEarning(idx) { 
        earnings.splice(idx, 1); 
        renderEarnings(); 
    }

    function renderEarnings() {
        const list = document.getElementById('earningList'); 
        const sums = { ganho_uber: 0, ganho_99: 0, ganho_part: 0, ganho_outros: 0 };
        list.innerHTML = '';
        let totalSum = 0;

        if(earnings.length > 0) { 
            list.style.display = 'block'; 
            earnings.forEach((e, i) => { 
                sums[e.type] += e.val; 
                totalSum += e.val;
                list.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed rgba(0,0,0,0.1); color:var(--text-main);"><span>${e.name}</span><span style="font-weight:700; color:var(--success);">R$ ${e.val.toFixed(2)} <i class="fas fa-times" style="color:var(--text-secondary); margin-left:10px; cursor:pointer;" onclick="removeEarning(${i})"></i></span></div>`; 
            }); 
        } else { 
            list.style.display = 'none'; 
        }

        document.getElementById('ganho_uber').value = sums.ganho_uber;
        document.getElementById('ganho_99').value = sums.ganho_99;
        document.getElementById('ganho_part').value = sums.ganho_part;
        document.getElementById('ganho_out').value = sums.ganho_outros; 
        
        mainInput.value = totalSum > 0 ? totalSum.toFixed(2) : '';
        badge.innerText = "R$ " + totalSum.toFixed(2);
    }
    
    mainInput.addEventListener('input', function() {
        if(earnings.length === 0) badge.innerText = "R$ " + (parseFloat(this.value)||0).toFixed(2);
    });

    let expenses = [];
    function addExpense() {
        const val = parseFloat(document.getElementById('newExpValue').value); const typeSelect = document.getElementById('newExpType');
        if (val > 0) { expenses.push({ val: val, type: typeSelect.value, name: typeSelect.options[typeSelect.selectedIndex].text }); document.getElementById('newExpValue').value = ''; renderExpenses(); }
    }
    function removeExpense(idx) { expenses.splice(idx, 1); renderExpenses(); }
    function renderExpenses() {
        const list = document.getElementById('expenseList'); const sums = { total_combustivel: 0, total_alimentacao: 0, total_manutencao: 0 }; list.innerHTML = '';
        if(expenses.length > 0) { list.style.display = 'block'; expenses.forEach((e, i) => { sums[e.type] += e.val; list.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed rgba(0,0,0,0.1); color:var(--text-main);"><span>${e.name}</span><span style="font-weight:700; color:var(--danger);">R$ ${e.val.toFixed(2)} <i class="fas fa-times" style="color:var(--text-secondary); margin-left:10px; cursor:pointer;" onclick="removeExpense(${i})"></i></span></div>`; }); } else { list.style.display = 'none'; }
        document.getElementById('total_combustivel').value = sums.total_combustivel; document.getElementById('total_alimentacao').value = sums.total_alimentacao; document.getElementById('total_manutencao').value = sums.total_manutencao;
    }

    function handleEditAppName() {
        const plan = "{{ current_user.plan_type }}";
        if (plan === 'basic') {
            document.getElementById('upsellModal').style.display = 'flex';
        } else {
            document.getElementById('newAppNameInput').value = "{{ custom_app_name }}";
            document.getElementById('appNameModal').style.display = 'flex';
        }
    }

    function saveAppName() {
        const newName = document.getElementById('newAppNameInput').value;
        if (newName) {
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            fetch('/update_app_name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ name: newName })
            }).then(() => {
                const opt = document.getElementById('optCustom');
                if(opt) opt.text = newName.toUpperCase();
                document.getElementById('lblCustomQtd').innerText = newName.toUpperCase().substring(0,3);
                document.getElementById('appNameModal').style.display = 'none';
            });
        }
    }
</script>
{% endblock %}
{% endblock %}




==================== FIM ARQUIVO: app/templates/adicionar.html ====================

==================== INICIO ARQUIVO: app/templates/agenda.html ====================
{% extends 'base.html' %}
{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Agenda</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Corridas Futuras</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top:10px; padding-bottom: 120px; animation-delay: 0.1s;">
    
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <a href="/novo_agendamento" class="btn" style="flex:1; border-radius: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 800; box-shadow: 0 8px 25px -5px rgba(37, 99, 235, 0.3);">
            <i class="fas fa-plus"></i> Novo
        </a>
        <!-- CAMPO DE PESQUISA -->
        <div style="flex:2; position:relative;">
            <input type="text" id="searchAgenda" placeholder="Buscar passageiro..." style="width:100%; height:100%; padding:0 15px 0 40px; border-radius:16px; border:1px solid rgba(0,0,0,0.05); background:white;">
            <i class="fas fa-search" style="position:absolute; left:15px; top:50%; transform:translateY(-50%); color:var(--text-secondary);"></i>
        </div>
    </div>

    {% if not agendamentos %}
        <div style="text-align:center; padding:80px 0; color:var(--text-secondary); opacity:0.7;">
            <i class="far fa-calendar-alt" style="font-size:40px; margin-bottom:15px;"></i>
            <p>Nenhuma corrida agendada.</p>
        </div>
    {% else %}
        {% for a in agendamentos %}
        <div class="glass-card agenda-card" style="padding: 0; overflow: hidden; margin-bottom: 15px; border-radius: 20px;">
            <div style="padding: 15px 20px; background: rgba(255,255,255,0.5); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="background: var(--primary-light); color: var(--primary); padding: 5px 10px; border-radius: 8px; font-weight: 800; font-size: 12px;">
                        {{ a.data_hora[8:10] }}/{{ a.data_hora[5:7] }}
                    </div>
                    <span style="font-weight: 700; font-size: 13px; color: var(--text-main);">
                        <i class="far fa-clock" style="font-size:11px; margin-right:2px;"></i> {{ a.data_hora[11:16] }}
                    </span>
                </div>
                <div style="font-size: 16px; font-weight: 800; color: var(--success);">
                    R$ {{ "%.2f"|format(a.valor) }}
                </div>
            </div>

            <div style="padding: 20px;">
                <div class="client-name" style="font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 15px; display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-user-circle" style="color:var(--text-secondary); font-size:16px;"></i> {{ a.cliente }}
                </div>
                <div style="position: relative; padding-left: 25px; margin-bottom: 12px;">
                    <div style="position: absolute; left: 7px; top: 8px; bottom: -20px; width: 2px; background: rgba(0,0,0,0.1); z-index:0;"></div>
                    <div style="position: absolute; left: 0; top: 6px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: var(--primary); z-index:1;"></div>
                    <div style="font-size: 9px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 2px;">Origem</div>
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">{{ a.origem }}</div>
                </div>
                {% if a.parada %}
                <div style="position: relative; padding-left: 25px; margin-bottom: 12px;">
                    <div style="position: absolute; left: 7px; top: -10px; bottom: -20px; width: 2px; background: rgba(0,0,0,0.1); z-index:0;"></div>
                    <div style="position: absolute; left: 2px; top: 6px; width: 8px; height: 8px; border-radius: 50%; background: var(--text-secondary); border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index:1;"></div>
                    <div style="font-size: 9px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 2px;">Parada</div>
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">{{ a.parada }}</div>
                </div>
                {% endif %}
                <div style="position: relative; padding-left: 25px;">
                    <div style="position: absolute; left: 0; top: 6px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: var(--danger); z-index:1;"></div>
                    <div style="font-size: 9px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 2px;">Destino</div>
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">{{ a.destino }}</div>
                </div>
                {% if a.observacao %}
                <div style="margin-top:15px; background:rgba(0,0,0,0.03); padding:10px; border-radius:10px; font-size:12px; color:var(--text-secondary); font-style:italic;">
                    "{{ a.observacao }}"
                </div>
                {% endif %}
            </div>

            <div style="padding: 0 20px 20px 20px; display: grid; grid-template-columns: 1fr auto auto; gap: 10px;">
                <!-- BOT√ÉO CONCLUIR (Restaurado para todos) -->
                <button onclick="confirmarRecibo('{{ a.id }}')" class="btn" style="padding: 0; height: 42px; border-radius: 12px; font-size: 13px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);">
                    <i class="fas fa-check"></i> Concluir
                </button>
                
                <a href="/editar_agendamento/{{ a.id }}" style="width: 42px; height: 42px; border-radius: 12px; background: white; border: 1px solid rgba(0,0,0,0.05); color: var(--text-main); display: flex; align-items: center; justify-content: center; text-decoration:none;"><i class="fas fa-pen"></i></a>
                <a href="/deletar_agendamento/{{ a.id }}" onclick="return confirm('Apagar?')" style="width: 42px; height: 42px; border-radius: 12px; background: rgba(239, 68, 68, 0.1); color: var(--danger); display: flex; align-items: center; justify-content: center; text-decoration:none;"><i class="fas fa-trash"></i></a>
            </div>
        </div>
        {% endfor %}
    {% endif %}
</div>

<!-- MODAL DECIS√ÉO DE RECIBO -->
<div id="receiptModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(8px);">
    <div style="background:var(--bg-body); width:85%; max-width:320px; padding:25px; border-radius:25px; box-shadow:0 20px 60px rgba(0,0,0,0.3); text-align:center; border: 1px solid var(--glass-border);">
        <div style="width:60px; height:60px; background:rgba(16, 185, 129, 0.15); color:var(--success); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px auto; font-size:24px;"><i class="fas fa-file-invoice-dollar"></i></div>
        <h3 style="margin:0 0 10px 0; color:var(--text-main); font-size: 18px;">Finalizar Corrida?</h3>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:25px; line-height: 1.5;">Deseja gerar um <b>Recibo PDF</b> para enviar ao passageiro?</p>
        
        <div style="display:flex; flex-direction: column; gap:10px;">
            <!-- L√ìGICA DE BLOQUEIO NO MODAL -->
            {% if current_user.plan_type == 'basic' %}
                <button onclick="openUpsellReceipt()" class="btn" style="background: #E2E8F0; color: #64748B; box-shadow: none; border: 1px solid #CBD5E1;">
                    <i class="fas fa-lock" style="margin-right:5px;"></i> Sim, Gerar Recibo
                </button>
            {% else %}
                <button onclick="finalizar(1)" class="btn" style="width: 100%; border-radius:15px; padding: 15px;">Sim, Gerar Recibo</button>
            {% endif %}
            
            <button onclick="finalizar(0)" class="btn" style="background: transparent; border: 1px solid var(--primary); color: var(--primary); width: 100%; box-shadow: none; border-radius:15px; padding: 15px;">Apenas Concluir</button>
            <button onclick="document.getElementById('receiptModal').style.display='none'" style="background:transparent; border:none; color:var(--text-secondary); padding: 10px; cursor: pointer; font-size: 12px;">Cancelar</button>
        </div>
    </div>
</div>

<!-- MODAL UPSELL (RECIBOS) -->
<div id="upsellReceiptModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
    <div style="background:white; width:90%; max-width:350px; text-align:center; padding:30px; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; animation: popUp 0.3s;">
        <button onclick="document.getElementById('upsellReceiptModal').style.display='none'" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer;">&times;</button>
        <div style="width:70px; height:70px; background:rgba(37,99,235,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto; color:var(--primary); font-size:30px;">
            <i class="fas fa-file-invoice"></i>
        </div>
        <h3 style="margin:0 0 10px 0; color:var(--text-main); font-size:20px; font-weight:800;">Recibos Profissionais</h3>
        <p style="font-size:14px; color:var(--text-secondary); margin-bottom:25px; line-height:1.5;">A emiss√£o de recibos PDF √© uma ferramenta exclusiva do Plano Premium para passar mais credibilidade aos seus clientes.</p>
        <a href="/assinar" class="btn" style="border-radius:50px; background:var(--primary); box-shadow: 0 10px 30px rgba(37,99,235,0.4);">Desbloquear Recibos</a>
    </div>
</div>
<style>@keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }</style>

<script>
    let currentId = null;
    function confirmarRecibo(id) { currentId = id; document.getElementById('receiptModal').style.display = 'flex'; }
    function finalizar(recibo) { window.location.href = `/concluir_agendamento/${currentId}?recibo=${recibo}`; }
    function openUpsellReceipt() { 
        document.getElementById('receiptModal').style.display = 'none';
        document.getElementById('upsellReceiptModal').style.display = 'flex'; 
    }

    // Filtro de Pesquisa
    document.getElementById('searchAgenda').addEventListener('keyup', function() {
        const term = this.value.toLowerCase();
        document.querySelectorAll('.agenda-card').forEach(card => {
            const name = card.querySelector('.client-name').innerText.toLowerCase();
            card.style.display = name.includes(term) ? 'block' : 'none';
        });
    });
</script>
{% endblock %}




==================== FIM ARQUIVO: app/templates/agenda.html ====================

==================== INICIO ARQUIVO: app/templates/base.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Motorista Pro</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#F0F8FF">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/weekSelect/weekSelect.js"></script>
    
    {% block extra_css %}{% endblock %}
    
    <style>
        #cookie-banner { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95); color: white; padding: 20px; border-radius: 20px; z-index: 20000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .cb-content { display: flex; flex-direction: column; gap: 15px; }
        .cb-text { font-size: 13px; line-height: 1.5; opacity: 0.9; }
        .cb-actions { display: flex; gap: 10px; }
        .cb-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; font-size: 13px; cursor: pointer; }
        .cb-accept { background: var(--primary, #2563EB); color: white; }
    </style>
</head>
<body class="{{ 'dark-mode' if request.cookies.get('darkMode') == 'true' else '' }}">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div id="toast"><i class="fas fa-check-circle"></i> <span>A√ß√£o realizada</span></div>
    
    {% block content %}{% endblock %}

    {% if current_user.is_authenticated %}
    
    <div class="floating-nav">
        <a href="/" class="nav-item {{ 'active' if request.path == '/' }}"><i class="fas fa-home"></i></a>
        <a href="/historico" class="nav-item {{ 'active' if '/historico' in request.path }}"><i class="fas fa-chart-bar"></i></a>
        <a href="/adicionar" class="nav-fab-menu"><i class="fas fa-plus"></i></a>
        <a href="/agenda" class="nav-item {{ 'active' if '/agenda' in request.path }}"><i class="far fa-calendar-alt"></i></a>
        <a href="#" class="nav-item" onclick="toggleDrawer(event)"><i class="fas fa-bars"></i></a>
    </div>

    <div class="drawer-overlay" onclick="toggleDrawer(event)"></div>
    <div class="drawer-panel">
        <div class="drawer-header">
            <div class="user-row">
                <div class="user-avatar-drawer">
                    {% if current_user.profile_image %}<img src="{{ current_user.profile_image }}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">{% else %}<i class="fas fa-user"></i>{% endif %}
                </div>
                <div class="user-data-drawer">
                    <h3>{{ current_user.nome.split()[0] }}</h3>
                    <p style="margin-bottom:5px;">{{ current_user.email|truncate(20) }}</p>
                    {% if current_user.plan_type == 'premium' %}
                        {% if current_user.category == 'trial' %}
                            <span class="badge-premium-drawer" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); font-size: 10px; padding: 4px 10px; color: white;"><i class="fas fa-clock"></i> TESTE 7 DIAS</span>
                        {% else %}
                            <span class="badge-premium-drawer" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white; font-size: 10px; padding: 4px 12px; border-radius: 12px; font-weight: 800; border: 1px solid rgba(255,255,255,0.4); display: inline-flex; align-items: center; gap: 4px; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);"><i class="fas fa-crown" style="font-size: 9px;"></i> PREMIUM</span>
                        {% endif %}
                    {% else %}
                        <a href="/assinar" style="background:#F59E0B; color:#78350F; font-size:10px; padding:3px 10px; border-radius:12px; font-weight:800; text-decoration:none; display:inline-block;">B√ÅSICO (Fazer Upgrade)</a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="drawer-content">
            <div class="menu-label">Gest√£o</div>
            
            <!-- LINK NOVO: MONITORAMENTO DIN√ÇMICO -->
            <a href="/monitoramento" class="drawer-item"><div class="drawer-icon" style="color:#10B981; background:rgba(16, 185, 129, 0.1);"><i class="fas fa-robot"></i></div><span class="drawer-text">Monitoramento Din√¢mico</span><i class="fas fa-chevron-right drawer-arrow"></i></a>
            
            <a href="/relatorios" class="drawer-item"><div class="drawer-icon"><i class="fas fa-chart-pie"></i></div><span class="drawer-text">Relat√≥rios</span><i class="fas fa-chevron-right drawer-arrow"></i></a>
            <a href="/calculadora" class="drawer-item"><div class="drawer-icon"><i class="fas fa-calculator"></i></div><span class="drawer-text">Calculadora</span><i class="fas fa-chevron-right drawer-arrow"></i></a>
            <a href="/manutencao" class="drawer-item"><div class="drawer-icon"><i class="fas fa-wrench"></i></div><span class="drawer-text">Manuten√ß√£o</span><i class="fas fa-chevron-right drawer-arrow"></i></a>

            <div class="menu-label" style="margin-top: 20px;">Social</div>
            <a href="/conquistas" class="drawer-item"><div class="drawer-icon"><i class="fas fa-trophy"></i></div><span class="drawer-text">Conquistas</span><i class="fas fa-chevron-right drawer-arrow"></i></a>
            <a href="/indique" class="drawer-item"><div class="drawer-icon"><i class="fas fa-gift"></i></div><span class="drawer-text">Indique e Ganhe</span><i class="fas fa-chevron-right drawer-arrow"></i></a>

            <div class="menu-label" style="margin-top: 20px;">Conta</div>
            <a href="#" class="drawer-item" id="btnInstall" onclick="installApp(event)" style="display:none; background: rgba(37, 99, 235, 0.1); border: 1px solid var(--primary);"><div class="drawer-icon" style="background:white; color:var(--primary);"><i class="fas fa-download"></i></div><span class="drawer-text" style="color:var(--primary); font-weight:700;">Instalar App</span></a>
            <a href="/configuracoes" class="drawer-item"><div class="drawer-icon"><i class="fas fa-cog"></i></div><span class="drawer-text">Ajustes</span><i class="fas fa-chevron-right drawer-arrow"></i></a>
            <a href="/assinatura" class="drawer-item"><div class="drawer-icon"><i class="fas fa-crown"></i></div><span class="drawer-text">Meu Plano</span><i class="fas fa-chevron-right drawer-arrow"></i></a>
            <a href="/suporte" class="drawer-item"><div class="drawer-icon"><i class="fas fa-headset"></i></div><span class="drawer-text">Suporte</span><i class="fas fa-chevron-right drawer-arrow"></i></a>
        </div>
        
        <div class="drawer-footer">
            <a href="/logout" class="btn-logout-drawer"><i class="fas fa-sign-out-alt"></i> Sair da Conta</a>
        </div>
    </div>
    
    <div id="infoModal" class="global-modal-overlay" onclick="closeGlobalModal('infoModal')">
        <div class="global-modal-card" onclick="event.stopPropagation()">
            <div class="info-icon-circle"><i id="infoIcon"></i></div>
            <h3 id="infoTitle" class="info-title"></h3>
            <p id="infoText" class="info-text"></p>
            <button class="info-btn" onclick="closeGlobalModal('infoModal')">ENTENDI</button>
        </div>
    </div>
    {% endif %}

    <div id="cookie-banner">
        <div class="cb-content">
            <div class="cb-text"><b>üç™ Usamos Cookies</b><br>Utilizamos cookies essenciais para manter o seu login seguro e melhorar a sua experi√™ncia.</div>
            <div class="cb-actions"><button class="cb-btn cb-accept" onclick="acceptCookies()">Aceitar e Continuar</button></div>
        </div>
    </div>

    <script>
        document.body.addEventListener('htmx:configRequest', (event) => { event.detail.headers['X-CSRFToken'] = '{{ csrf_token() }}'; });
        const toast = document.getElementById('toast');
        window.showToast = (msg) => { toast.querySelector('span').innerText = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); };
        function toggleDrawer(e) { if(e) e.preventDefault(); const overlay = document.querySelector('.drawer-overlay'); const panel = document.querySelector('.drawer-panel'); if (panel.classList.contains('open')) { panel.classList.remove('open'); setTimeout(() => overlay.classList.remove('open'), 300); } else { overlay.classList.add('open'); requestAnimationFrame(() => panel.classList.add('open')); } }
        function closeGlobalModal(id) { const el = document.getElementById(id); if(el) { el.classList.remove('open'); setTimeout(() => el.style.display = 'none', 10); } }
        window.openGlobalModal = function(id) { const el = document.getElementById(id); if(el) { el.style.display = 'flex'; setTimeout(() => el.classList.add('open'), 10); } }
        function acceptCookies() { localStorage.setItem('cookies_accepted', 'true'); document.getElementById('cookie-banner').style.display = 'none'; }
        document.addEventListener("DOMContentLoaded", function() { if (!localStorage.getItem('cookies_accepted')) { setTimeout(() => document.getElementById('cookie-banner').style.display = 'block', 1000); } });
    </script>
    <script src="{{ url_for('static', filename='js/onboarding.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pwa.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <script src="{{ url_for('static', filename='js/tour.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
==================== FIM ARQUIVO: app/templates/base.html ====================

==================== INICIO ARQUIVO: app/templates/calculadora.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    .premium-blur-box {
        position: relative; overflow: hidden; border-radius: 20px;
    }
    .p-blur-content { filter: blur(6px); opacity: 0.5; pointer-events: none; user-select: none; }
    .p-lock-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 10;
    }
    .upsell-badge {
        background: #FFD700; color: #1E293B; font-size: 10px; font-weight: 800;
        padding: 4px 10px; border-radius: 12px; margin-bottom: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Calculadora</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Ferramentas R√°pidas</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">
    
    <div class="mode-selector">
        <button onclick="showTab('flex')" id="tab-flex" class="mode-pill active">Abastecimento</button>
        <button onclick="showTab('corrida')" id="tab-corrida" class="mode-pill">Pre√ßo Corrida</button>
    </div>
    
    <!-- ABA FLEX (GR√ÅTIS) -->
    <div id="view-flex">
        <div class="glass-card">
            <div class="card-title"><span>Qual Compensa?</span></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary); display:block; margin-bottom:5px;">GASOLINA (R$)</label><input type="number" step="0.01" id="p-gas" placeholder="5.80" style="color:var(--danger); font-weight:700;"></div>
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary); display:block; margin-bottom:5px;">ETANOL (R$)</label><input type="number" step="0.01" id="p-eta" placeholder="3.90" style="color:var(--success); font-weight:700;"></div>
            </div>
            <button class="btn" onclick="calcFlex()" style="margin-bottom:20px; padding:16px;">COMPARAR</button>
            <div id="res-flex" style="display:none; text-align:center;">
                <div style="font-size:12px; color:var(--text-secondary); margin-bottom:5px;">A melhor op√ß√£o √©:</div>
                <div id="flex-winner" style="font-size:32px; font-weight:900; margin-bottom:15px;">GASOLINA</div>
                <div style="display:flex; justify-content:center; gap:20px; font-size:11px; color:var(--text-secondary);">
                    <div>Custo KM Gas<br><b id="c-km-gas" style="font-size:14px; color:var(--text-main);">R$ 0.00</b></div>
                    <div>Custo KM Eta<br><b id="c-km-eta" style="font-size:14px; color:var(--text-main);">R$ 0.00</b></div>
                </div>
            </div>
        </div>
        <form method="post" class="glass-card">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="card-title"><span>Consumo do Carro</span></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">KM/L GASOLINA</label><input type="number" step="0.1" name="consumo_gasolina" value="{{ c_gas }}"></div>
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">KM/L ETANOL</label><input type="number" step="0.1" name="consumo_etanol" value="{{ c_etanol }}"></div>
            </div>
            <button type="submit" class="btn" style="margin-top:15px; background:var(--glass-bg); color:var(--text-main); border:1px solid rgba(0,0,0,0.05); box-shadow:none; padding:12px;">Salvar Consumo</button>
        </form>
    </div>

    <!-- ABA CORRIDA (BLOQUEIO BASIC) -->
    <div id="view-corrida" style="display:none;">
        
        {% if current_user.plan_type == 'basic' %}
        <!-- BLOQUEIO -->
        <div class="glass-card premium-blur-box">
            <div class="p-blur-content">
                <div class="card-title"><span>Or√ßamento Particular</span></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div><label>DIST√ÇNCIA</label><input type="number" value="15.5"></div>
                    <div><label>TEMPO</label><input type="number" value="25"></div>
                </div>
                <div class="result-val" style="font-size:36px; font-weight:800; color:var(--primary); text-align:center;">R$ 45,00</div>
            </div>
            
            <div class="p-lock-overlay">
                <span class="upsell-badge">PRO</span>
                <i class="fas fa-lock" style="font-size:24px; color:var(--primary); margin-bottom:10px;"></i>
                <p style="font-size:12px; font-weight:700; color:var(--text-main); text-align:center; margin:0 0 15px 0;">
                    Calcule o pre√ßo justo para<br>corridas particulares.
                </p>
                <a href="/assinar" class="btn" style="width:auto; padding:10px 25px; font-size:12px;">Desbloquear Calculadora</a>
            </div>
        </div>
        
        {% else %}
        <!-- LIBERADO (PREMIUM) -->
        <div class="glass-card">
            <div class="card-title"><span>Or√ßamento Particular</span></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">DIST√ÇNCIA (KM)</label>
                    <input type="number" id="km" placeholder="0.0" step="0.1" style="font-weight:700;">
                </div>
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">TEMPO (MIN)</label>
                    <input type="number" id="min" placeholder="0" step="1" style="font-weight:700;">
                </div>
            </div>
            
            <button class="btn" onclick="calcCorrida()" style="margin-bottom:20px; padding:16px;">
                <i class="fas fa-calculator"></i> CALCULAR
            </button>
            
            <div id="res-corrida" style="display:none; text-align:center; padding:20px; background:rgba(255,255,255,0.5); border-radius:20px; border:1px solid rgba(255,255,255,0.6);">
                <span style="font-size:11px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px; font-weight:700;">Valor Sugerido</span>
                <div class="result-val" id="val-corrida" style="font-size:36px; font-weight:800; color:var(--primary); margin:5px 0;">R$ 0,00</div>
            </div>
        </div>
        
        <form method="post" class="glass-card" style="opacity:0.9;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="card-title"><span>Tarifas Base</span></div>
            <div style="margin-bottom:15px;">
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary);">TAXA INICIAL (R$)</label>
                <input type="number" step="0.01" name="taxa_base" value="{{ taxa }}">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">PRE√áO KM</label><input type="number" step="0.01" name="preco_km" value="{{ p_km }}"></div>
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">PRE√áO MIN</label><input type="number" step="0.01" name="preco_min" value="{{ p_min }}"></div>
            </div>
            <button type="submit" class="btn" style="margin-top:15px; background:var(--glass-bg); color:var(--text-main); border:1px solid rgba(0,0,0,0.05); box-shadow:none; padding:12px;">Salvar Tarifas</button>
        </form>
        {% endif %}
    </div>
</div>

<script>
    function showTab(tab) {
        document.getElementById('view-flex').style.display = tab==='flex'?'block':'none';
        document.getElementById('view-corrida').style.display = tab==='corrida'?'block':'none';
        document.getElementById('tab-flex').className = tab==='flex'?'mode-pill active':'mode-pill';
        document.getElementById('tab-corrida').className = tab==='corrida'?'mode-pill active':'mode-pill';
    }
    
    // Fun√ß√µes de c√°lculo s√≥ precisam existir se o usu√°rio for premium para evitar erros de console,
    // mas deixamos aqui pois o JS √© est√°tico. O HTML dos inputs n√£o existir√° no Basic.
    function calcCorrida() {
        const kmIn = document.getElementById('km');
        const minIn = document.getElementById('min');
        if(!kmIn || !minIn) return; // Seguran√ßa para Basic
        
        const km = parseFloat(kmIn.value)||0;
        const min = parseFloat(minIn.value)||0;
        const res = parseFloat("{{ taxa }}") + (km * parseFloat("{{ p_km }}")) + (min * parseFloat("{{ p_min }}"));
        document.getElementById('val-corrida').innerText = "R$ " + res.toFixed(2);
        document.getElementById('res-corrida').style.display='block';
    }
    
    function calcFlex() {
        const pg = parseFloat(document.getElementById('p-gas').value);
        const pe = parseFloat(document.getElementById('p-eta').value);
        const cg = parseFloat("{{ c_gas }}");
        const ce = parseFloat("{{ c_etanol }}");
        if(!pg || !pe) return;
        const custoG = pg / cg;
        const custoE = pe / ce;
        document.getElementById('c-km-gas').innerText = "R$ " + custoG.toFixed(2);
        document.getElementById('c-km-eta').innerText = "R$ " + custoE.toFixed(2);
        const winner = document.getElementById('flex-winner');
        if(custoE < custoG) { winner.innerText = "ETANOL"; winner.style.color = "var(--success)"; } else { winner.innerText = "GASOLINA"; winner.style.color = "var(--danger)"; }
        document.getElementById('res-flex').style.display='block';
    }
</script>
{% endblock %}



==================== FIM ARQUIVO: app/templates/calculadora.html ====================

==================== INICIO ARQUIVO: app/templates/configuracoes.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    .settings-group {
        background: var(--glass-bg);
        border: var(--glass-border);
        box-shadow: var(--glass-shadow);
        backdrop-filter: var(--backdrop-blur);
        border-radius: var(--radius-card);
        padding: 5px 20px;
        margin-bottom: 25px;
        width: 100%;
    }
    
    .menu-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 18px 0; border-bottom: 1px solid rgba(0,0,0,0.05);
        text-decoration: none; cursor: pointer; transition: opacity 0.2s; width: 100%;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:active { opacity: 0.6; }
    
    .menu-left { display: flex; align-items: center; gap: 15px; }
    .menu-icon { 
        width: 38px; height: 38px; border-radius: 12px; 
        display: flex; align-items: center; justify-content: center; font-size: 18px;
    }
    .menu-text { font-size: 14px; font-weight: 700; color: var(--text-main); }
    .menu-sub { font-size: 11px; color: var(--text-secondary); display: block; margin-top: 2px; }
    
    /* Switch */
    .switch { position: relative; display: inline-block; width: 45px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(21px); }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Ajustes</h2>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">
    
    {% if request.args.get('msg') == 'erro_arquivo' %}
    <div style="background:#FEF2F2; color:#DC2626; padding:10px; border-radius:10px; font-size:12px; font-weight:600; text-align:center; margin-bottom:15px; border:1px solid #FCA5A5;">
        Erro ao importar arquivo.
    </div>
    {% endif %}
    {% if request.args.get('msg') == 'restaurado_ok' %}
    <div style="background:#ECFDF5; color:#059669; padding:10px; border-radius:10px; font-size:12px; font-weight:600; text-align:center; margin-bottom:15px; border:1px solid #6EE7B7;">
        Dados restaurados com sucesso!
    </div>
    {% endif %}

    <!-- PERFIL -->
    <div style="text-align:center; margin-bottom: 30px;">
        <div style="width:80px; height:80px; background:var(--glass-bg); border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:35px; color:var(--primary); box-shadow:var(--glass-shadow); border:var(--glass-border);">
            {% if current_user.profile_image %}
                <img src="{{ current_user.profile_image }}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
            {% else %}
                <i class="fas fa-user"></i>
            {% endif %}
        </div>
        <h3 style="margin:10px 0 5px 0; color:var(--text-main); font-weight: 800;">{{ current_user.nome }}</h3>
        <p style="margin:0; color:var(--text-secondary); font-size:13px;">{{ current_user.email }}</p>
    </div>

    <!-- MENU CONTA -->
    <div style="font-size:11px; font-weight:800; color:var(--text-secondary); margin: 0 0 10px 10px; text-transform:uppercase;">Minha Conta</div>
    <div class="settings-group">
        <a href="/dados_pessoais" class="menu-item">
            <div class="menu-left">
                <div class="menu-icon" style="background:rgba(37, 99, 235, 0.1); color:var(--primary);"><i class="fas fa-user-edit"></i></div>
                <div><div class="menu-text">Dados Pessoais</div><span class="menu-sub">Nome e WhatsApp</span></div>
            </div>
            <i class="fas fa-chevron-right" style="color:var(--text-secondary); font-size:12px;"></i>
        </a>
        <a href="/seguranca" class="menu-item">
            <div class="menu-left">
                <div class="menu-icon" style="background:rgba(100, 116, 139, 0.1); color:var(--text-secondary);"><i class="fas fa-shield-alt"></i></div>
                <div><div class="menu-text">Senha e Seguran√ßa</div><span class="menu-sub">Alterar e-mail e senha</span></div>
            </div>
            <i class="fas fa-chevron-right" style="color:var(--text-secondary); font-size:12px;"></i>
        </a>
        <a href="/assinatura" class="menu-item">
            <div class="menu-left">
                <div class="menu-icon" style="background:rgba(245, 158, 11, 0.1); color:var(--warning);"><i class="fas fa-crown"></i></div>
                <div><div class="menu-text">Meu Plano</div><span class="menu-sub">Gerenciar assinatura</span></div>
            </div>
            <i class="fas fa-chevron-right" style="color:var(--text-secondary); font-size:12px;"></i>
        </a>
    </div>

    <!-- MENU SISTEMA -->
    <div style="font-size:11px; font-weight:800; color:var(--text-secondary); margin: 0 0 10px 10px; text-transform:uppercase;">App</div>
    <div class="settings-group">
        <div class="menu-item">
            <div class="menu-left">
                <div class="menu-icon" style="background:var(--text-main); color:var(--bg-body);"><i class="fas fa-moon"></i></div>
                <div class="menu-text">Modo Escuro</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="darkModeSwitch" onclick="toggleDarkMode()">
                <span class="slider"></span>
            </label>
        </div>
        
        <a href="/suporte" class="menu-item">
            <div class="menu-left">
                <div class="menu-icon" style="background:rgba(16, 185, 129, 0.1); color:var(--success);"><i class="fas fa-headset"></i></div>
                <div class="menu-text">Suporte / Ajuda</div>
            </div>
            <i class="fas fa-chevron-right" style="color:var(--text-secondary); font-size:12px;"></i>
        </a>
    </div>

    <!-- MENU BACKUP (RESTAURADO) -->
    <div style="font-size:11px; font-weight:800; color:var(--text-secondary); margin: 0 0 10px 10px; text-transform:uppercase;">Backup e Dados</div>
    <div class="settings-group">
        <a href="/exportar" target="_blank" class="menu-item">
            <div class="menu-left">
                <div class="menu-icon" style="background:rgba(37, 99, 235, 0.1); color:var(--primary);"><i class="fas fa-download"></i></div>
                <div><div class="menu-text">Exportar Dados</div><span class="menu-sub">Baixar c√≥pia de seguran√ßa (JSON)</span></div>
            </div>
            <i class="fas fa-chevron-right" style="color:var(--text-secondary); font-size:12px;"></i>
        </a>
        
        <div class="menu-item" onclick="document.getElementById('importFile').click()">
            <div class="menu-left">
                <div class="menu-icon" style="background:rgba(16, 185, 129, 0.1); color:var(--success);"><i class="fas fa-file-import"></i></div>
                <div><div class="menu-text">Importar Backup</div><span class="menu-sub">Restaurar dados de arquivo</span></div>
            </div>
            <i class="fas fa-chevron-right" style="color:var(--text-secondary); font-size:12px;"></i>
        </div>
        
        <form action="/configuracoes/importar" method="POST" enctype="multipart/form-data" style="display:none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="file" id="importFile" name="file" accept=".json" onchange="if(confirm('Isso substituir√° seus dados atuais. Confirmar?')) this.form.submit()">
        </form>
    </div>

    <a href="/logout" style="display:flex; align-items:center; justify-content:center; gap:8px; color:var(--danger); font-weight:700; font-size:13px; margin: 0 0 20px 0; text-decoration:none; opacity:0.8; padding:15px; border-radius:16px; background:rgba(220, 38, 38, 0.05);">
        <i class="fas fa-sign-out-alt"></i> Sair da Conta
    </a>
    
    <a href="/termos" style="display:block; text-align:center; color:var(--text-secondary); font-size:11px; text-decoration:underline; opacity:0.6; margin-bottom: 20px;">
        Termos de Uso e Privacidade
    </a>
</div>

{% block extra_js %}
<script>
    const switchBtn = document.getElementById('darkModeSwitch');
    function toggleDarkMode() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDark);
        document.cookie = "darkMode=" + isDark + "; path=/; max-age=31536000";
    }
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        if(switchBtn) switchBtn.checked = true;
    }
</script>
{% endblock %}
{% endblock %}



==================== FIM ARQUIVO: app/templates/configuracoes.html ====================

==================== INICIO ARQUIVO: app/templates/editar.html ====================
{% extends 'base.html' %}

{% block content %}
<div class="header fade-in">
    <a href="/historico" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Editar</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Corrigir Lan√ßamento</p>
    </div>
    <div style="width:40px;"></div>
</div>

<form method="post" class="container fade-in" style="padding-top: 10px; padding-bottom: 100px; animation-delay: 0.1s;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- DATA E ESFOR√áO -->
    <div class="glass-card">
        <div class="card-title"><span>Dados Gerais</span></div>
        <div style="margin-bottom:15px;">
             <label style="font-size:11px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">DATA</label>
             <input type="date" name="data" value="{{ registro['data'] }}" required style="font-weight:700; background:rgba(255,255,255,0.6);">
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div>
                <label style="font-size:11px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">KM</label>
                <input type="number" step="0.1" name="km_percorrido" value="{{ registro['km_percorrido'] }}" inputmode="decimal">
            </div>
            <div>
                <label style="font-size:11px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">HORAS</label>
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="number" name="horas_qtd" value="{{ h_val }}" placeholder="00" style="text-align:center;">
                    <span style="font-weight:bold; color:var(--text-secondary);">:</span>
                    <input type="number" name="minutos_qtd" value="{{ m_val }}" placeholder="00" style="text-align:center;">
                </div>
            </div>
        </div>
    </div>

    <!-- FATURAMENTO -->
    <div class="glass-card">
        <div class="card-title"><span>Financeiro</span></div>
        
        <label style="font-size:11px; color:var(--text-secondary); margin-bottom:8px; display:block; font-weight:700;">TOTAL BRUTO</label>
        <div style="position:relative; margin-bottom:20px;">
            <span style="position:absolute; left:15px; top:16px; color:var(--success); font-weight:800;">R$</span>
            <input type="number" step="0.01" id="ganhoTotal" name="ganho_bruto" value="{{ registro['ganho_bruto'] }}" style="padding-left:45px; font-weight:800; color:var(--success); font-size:24px; background:rgba(16, 185, 129, 0.05); border-color:rgba(16, 185, 129, 0.2);" inputmode="decimal">
        </div>

        <div style="border-top:1px dashed rgba(0,0,0,0.1); padding-top:15px;">
            <p style="font-size:10px; color:var(--text-secondary); margin-bottom:15px; font-weight:700; text-transform:uppercase;">Apps (Opcional)</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">UBER</label><input type="number" step="0.01" name="ganho_uber" class="calc-input" value="{{ registro['ganho_uber'] }}" inputmode="decimal"></div>
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">99</label><input type="number" step="0.01" name="ganho_99" class="calc-input" value="{{ registro['ganho_99'] }}" inputmode="decimal"></div>
            </div>
             <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">PART</label><input type="number" step="0.01" name="ganho_part" class="calc-input" value="{{ registro['ganho_part'] }}" inputmode="decimal"></div>
                <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">OUT</label><input type="number" step="0.01" name="ganho_outros" class="calc-input" value="{{ registro['ganho_outros'] }}" inputmode="decimal"></div>
            </div>
        </div>
    </div>

    <!-- CORRIDAS -->
    <div class="glass-card">
        <div class="card-title"><span>Qtd. Corridas</span></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">
            <div><label style="font-size:10px; text-align:center; display:block; font-weight:700; color:var(--text-secondary);">UBER</label><input type="number" name="qtd_uber" value="{{ registro['qtd_uber'] }}" style="text-align:center; padding:10px;"></div>
            <div><label style="font-size:10px; text-align:center; display:block; font-weight:700; color:var(--text-secondary);">99</label><input type="number" name="qtd_99" value="{{ registro['qtd_99'] }}" style="text-align:center; padding:10px;"></div>
            <div><label style="font-size:10px; text-align:center; display:block; font-weight:700; color:var(--text-secondary);">PART</label><input type="number" name="qtd_part" value="{{ registro['qtd_part'] }}" style="text-align:center; padding:10px;"></div>
            <div><label style="font-size:10px; text-align:center; display:block; font-weight:700; color:var(--text-secondary);">OUT</label><input type="number" name="qtd_outros" value="{{ registro['qtd_outros'] }}" style="text-align:center; padding:10px;"></div>
        </div>
    </div>

    <!-- DESPESAS -->
    <div class="glass-card" style="border-left: 4px solid var(--danger);">
        <div class="card-title"><span style="color:var(--danger);">Despesas</span></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
            <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">COMBUST√çVEL</label><input type="number" step="0.01" name="despesa_combustivel" value="{{ registro['despesa_combustivel'] }}" style="color:var(--danger); font-weight:700;"></div>
            <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">ALIMENTA√á√ÉO</label><input type="number" step="0.01" name="despesa_alimentacao" value="{{ registro['despesa_alimentacao'] }}" style="color:var(--danger); font-weight:700;"></div>
        </div>
        <div><label style="font-size:10px; font-weight:700; color:var(--text-secondary);">MANUTEN√á√ÉO</label><input type="number" step="0.01" name="despesa_manutencao" value="{{ registro['despesa_manutencao'] }}" style="color:var(--danger); font-weight:700;"></div>
    </div>

    <!-- BOT√ïES ESTILIZADOS -->
    <button type="submit" class="btn" style="margin-bottom:15px; padding:18px; border-radius: 50px; background: var(--primary-gradient); color: white; border: none; width: 100%; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4); font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 10px;">
        <i class="fas fa-save"></i> SALVAR ALTERA√á√ïES
    </button>
    
    <a href="/deletar/{{ registro['id'] }}" onclick="return confirm('Tem certeza?')" style="display:flex; justify-content:center; align-items:center; color:var(--danger); font-weight:700; font-size:13px; text-decoration:none; padding:15px; background:rgba(239, 68, 68, 0.1); border-radius:50px; gap:8px;">
        <i class="fas fa-trash"></i> EXCLUIR REGISTRO
    </a>
</form>

{% block extra_js %}
<script>
    const inputs = document.querySelectorAll('.calc-input');
    const totalInput = document.getElementById('ganhoTotal');
    
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            let sum = 0; 
            inputs.forEach(i => sum += parseFloat(i.value || 0)); 
            if(sum > 0) totalInput.value = sum.toFixed(2);
        });
    });
</script>
{% endblock %}
{% endblock %}




==================== FIM ARQUIVO: app/templates/editar.html ====================

==================== INICIO ARQUIVO: app/templates/editar_agendamento.html ====================
{% extends 'base.html' %}

{% block content %}
<div class="header fade-in">
    <a href="/agenda" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Editar</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Alterar Agendamento</p>
    </div>
    <div style="width:40px;"></div>
</div>

<form method="post" class="container fade-in" style="padding-top: 10px; padding-bottom: 100px; animation-delay: 0.1s;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="glass-card">
        <div class="card-title"><span>Dados Principais</span></div>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">CLIENTE</label>
            <input type="text" name="cliente" value="{{ registro['cliente'] }}" required style="font-weight: 600;">
        </div>
        
        <div>
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">VALOR (R$)</label>
            <input type="number" step="0.01" name="valor" value="{{ registro['valor'] }}" style="font-weight: 700; color: var(--success);">
        </div>
    </div>

    <div class="glass-card">
        <div class="card-title"><span>Data e Hora</span></div>
        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px;">
            <div>
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">DIA</label>
                <input type="date" name="data_ag" value="{{ d_val }}" required style="font-weight: 600;">
            </div>
            <div>
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">HORA</label>
                <input type="time" name="hora_ag" value="{{ h_val }}" required style="font-weight: 600; text-align: center;">
            </div>
        </div>
    </div>

    <div class="glass-card">
        <div class="card-title"><span>Trajeto</span></div>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">ORIGEM</label>
            <input type="text" name="origem" value="{{ registro['origem'] }}" required>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">PARADA</label>
            <input type="text" name="parada" value="{{ registro['parada'] or '' }}" placeholder="Opcional">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">DESTINO</label>
            <input type="text" name="destino" value="{{ registro['destino'] }}" required>
        </div>
        
        <div>
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">OBSERVA√á√ïES</label>
            <textarea name="observacao" rows="2">{{ registro['observacao'] }}</textarea>
        </div>
    </div>

    <button type="submit" class="btn" style="margin-bottom:15px; padding:18px; width:100%; border-radius: 50px;">
        <i class="fas fa-save"></i> SALVAR ALTERA√á√ïES
    </button>
    
    <a href="/deletar_agendamento/{{ registro['id'] }}" onclick="return confirm('Tem certeza?')" style="display:flex; justify-content:center; align-items:center; gap:8px; color:var(--danger); font-weight:700; font-size:13px; text-decoration:none; padding:15px; background:rgba(239, 68, 68, 0.1); border-radius:50px;">
        <i class="fas fa-trash"></i> EXCLUIR AGENDAMENTO
    </a>
</form>
{% endblock %}




==================== FIM ARQUIVO: app/templates/editar_agendamento.html ====================

==================== INICIO ARQUIVO: app/templates/historico.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    .history-card { 
        background: var(--glass-bg); backdrop-filter: var(--backdrop-blur);
        border: var(--glass-border); box-shadow: var(--glass-shadow);
        border-radius: 20px; padding: 15px; margin-bottom: 12px; 
        display: grid; grid-template-columns: auto 1fr auto; gap: 15px; align-items: center;
        text-decoration: none; position: relative; overflow: hidden;
        transition: transform 0.2s;
    }
    .history-card:active { transform: scale(0.98); background: rgba(255,255,255,0.9); }
    .history-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary); }

    .h-date-group { display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; padding: 8px 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-width: 50px; }
    .h-day { font-size: 18px; font-weight: 800; color: var(--text-main); line-height: 1; }
    .h-month { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); font-weight: 700; margin-top: 2px; }

    .h-info { display: flex; flex-direction: column; gap: 2px; }
    .h-title { font-size: 13px; font-weight: 700; color: var(--text-main); }
    .h-badges { display: flex; gap: 8px; font-size: 10px; color: var(--text-secondary); }
    
    .h-values { text-align: right; display: flex; flex-direction: column; justify-content: center; }
    .h-gain { font-size: 14px; font-weight: 800; color: var(--success); }
    .h-expense { font-size: 10px; font-weight: 600; color: var(--danger); opacity: 0.8; margin-top: 2px; }
    
    /* Estilo do Bot√£o Carregar Mais */
    .btn-load-more {
        background: white; color: var(--primary); border: 1px solid var(--primary-light);
        padding: 12px 30px; border-radius: 50px; font-weight: 700; font-size: 13px;
        cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        display: inline-flex; align-items: center; gap: 8px;
        transition: 0.2s;
    }
    .btn-load-more:active { transform: scale(0.95); background: #f8fafc; }
    .htmx-indicator { display: none; margin-left: 10px; }
    .htmx-request .htmx-indicator { display: inline; }
    .htmx-request.btn-load-more { opacity: 0.7; pointer-events: none; }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:16px; color:var(--text-main); font-weight: 800;">Hist√≥rico</h2>
        <p style="margin:0; font-size:11px; color:var(--text-secondary);">Seu Livro Caixa</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom:120px; animation-delay: 0.1s;">
    
    <!-- FILTRO DE DATA -->
    <div class="filter-group">
        <div class="filter-btn {{ 'active' if tipo == 'dia' else '' }}" onclick="openPicker('dia')">
            <span class="fb-label">DIA</span>
            <span class="fb-value">{{ filter_label if tipo == 'dia' else 'Todos' }}</span>
            <input type="date" id="picker-dia" class="filter-input" onchange="submitHist(this.value, 'dia')">
        </div>
        <div class="filter-btn {{ 'active' if tipo == 'semana' else '' }}" onclick="openPicker('semana')">
            <span class="fb-label">SEMANA</span>
            <span class="fb-value">{{ filter_label|safe if tipo == 'semana' else 'Filtrar' }}</span>
            <select onchange="submitHist(this.value, 'semana')" id="picker-semana" class="filter-input">
                <option value="" disabled selected>Selecionar</option>
                {% for week in week_options %}
                    <option value="{{ week.value }}" {% if tipo == 'semana' and valor == week.value %}selected{% endif %}>{{ week.label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-btn {{ 'active' if tipo == 'mes' else '' }}" onclick="openPicker('mes')">
            <span class="fb-label">M√äS</span>
            <span class="fb-value">{{ filter_label if tipo == 'mes' else 'Filtrar' }}</span>
            <input type="month" id="picker-mes" class="filter-input" onchange="submitHist(this.value, 'mes')">
        </div>
    </div>

    <!-- LISTA DE CARDS (RENDERIZA√á√ÉO INICIAL + INJE√á√ÉO HTMX) -->
    <div id="history-list-container">
        {% if registros %}
            {% include 'partials/history_list.html' %}
        {% else %}
            <div style="text-align:center; padding:80px 0; color:var(--text-secondary); opacity:0.6;">
                <i class="far fa-calendar-times" style="font-size:40px; margin-bottom:15px;"></i>
                <p>Nenhum registo encontrado.</p>
                {% if tipo and tipo != 'dia' and tipo != 'mes' %}
                <a href="/historico" style="font-size:12px; color:var(--primary); font-weight:700;">Limpar Filtro</a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

{% block extra_js %}
<script>
    function openPicker(tipo) {
        const el = document.getElementById('picker-' + tipo);
        if(el) {
            if(el.showPicker) el.showPicker();
            else el.click();
        }
    }
    function submitHist(valor, tipo) {
        if(!valor) return;
        window.location.href = `/historico?tipo=${tipo}&valor=${valor}`;
    }
</script>
{% endblock %}
{% endblock %}




==================== FIM ARQUIVO: app/templates/historico.html ====================

==================== INICIO ARQUIVO: app/templates/imprimir.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio Mensal</title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 12px; color: #000; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        h1 { margin: 0; font-size: 18px; }
        h2 { margin: 5px 0; font-size: 14px; font-weight: normal; }
        
        .box-resumo { display: flex; justify-content: space-between; margin-bottom: 20px; border: 1px solid #000; padding: 10px; }
        .box-item { text-align: center; }
        .box-val { font-weight: bold; font-size: 14px; display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #eee; }
        .text-right { text-align: right; }
        
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
    <button class="no-print" onclick="window.print()" style="padding:10px; font-size:16px; margin-bottom:20px;">üñ®Ô∏è Imprimir / Salvar PDF</button>

    <div class="header">
        <h1>Relat√≥rio de Performance - Motorista de App</h1>
        <h2>Refer√™ncia: {{ nome_mes }}</h2>
    </div>

    <div class="box-resumo">
        <div class="box-item"><span class="box-val">R$ {{ "%.2f"|format(t_ganho) }}</span>Receita Bruta</div>
        <div class="box-item"><span class="box-val">R$ {{ "%.2f"|format(t_despesa) }}</span>Despesas Var.</div>
        <div class="box-item"><span class="box-val">R$ {{ "%.2f"|format(t_fixo) }}</span>Custos Fixos</div>
        <div class="box-item"><span class="box-val">R$ {{ "%.2f"|format(lucro_real) }}</span>LUCRO REAL</div>
    </div>

    <h3>Resumo Operacional</h3>
    <p>KM Rodados: {{ "%.1f"|format(t_km) }} | Horas Trabalhadas: {{ "%.1f"|format(t_horas) }}</p>

    <h3>Extrato Di√°rio</h3>
    <table>
        <thead><tr><th>Data</th><th>Ganho</th><th>Gasto</th><th>KM</th><th>Obs</th></tr></thead>
        <tbody>
            {% for r in registros %}
            <tr>
                <td>{{ r['data'] }}</td>
                <td class="text-right">R$ {{ "%.2f"|format(r['ganho_bruto']) }}</td>
                <td class="text-right">R$ {{ "%.2f"|format(r['despesa_combustivel']+r['despesa_alimentacao']+r['despesa_manutencao']) }}</td>
                <td class="text-right">{{ r['km_percorrido'] }}</td>
                <td>{{ r['qtd_uber']+r['qtd_99']+r['qtd_part'] }} corridas</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top:30px; font-size:10px; text-align:center;">Gerado por Motorista Pro App</div>
</body>
</html>



==================== FIM ARQUIVO: app/templates/imprimir.html ====================

==================== INICIO ARQUIVO: app/templates/index.html ====================
{% extends 'base.html' %}

{% block content %}
<div id="loading-indicator" class="htmx-indicator" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:9999; background:rgba(255,255,255,0.95); color:var(--primary); padding:15px 25px; border-radius:30px; font-weight:800; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; pointer-events: none;">
    <i class="fas fa-spinner fa-spin"></i> Atualizando...
</div>

<div class="app-shell">
    
    <!-- HEADER -->
    <div class="header fade-in">
        <div class="profile-section" style="cursor: default;">
            <!-- FOTO DO PERFIL (L√ìGICA CORRIGIDA) -->
            {% if current_user.profile_image %}
                <img src="{{ current_user.profile_image }}" style="width:42px; height:42px; border-radius:14px; object-fit:cover; border:1px solid rgba(37,99,235,0.2); box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            {% else %}
                <div class="avatar-generic"><i class="fas fa-user"></i></div>
            {% endif %}
            
            <div class="greeting">
                <p>Ol√°,</p>
                <h1>{{ current_user.nome.split()[0] }}</h1>
            </div>
        </div>
        <a href="/notifications" class="notification-btn">
            <i class="far fa-bell"></i>
            {% if unread_notifications > 0 %}<div class="badge-dot"></div>{% endif %}
        </a>
    </div>

    <!-- CONTE√öDO -->
    <div class="container">
        <div id="dashboard-content">
            {% include 'partials/dashboard_content.html' %}
        </div>
    </div>

</div>

<!-- Scripts de UX -->
<script>
    function centerActiveElement() {
        const container = document.querySelector('.date-strip-container');
        const active = document.querySelector('.date-pill.active');
        if (container && active) {
            const containerWidth = container.offsetWidth;
            const itemWidth = active.offsetWidth;
            const itemLeft = active.offsetLeft;
            const scrollPos = itemLeft - (containerWidth / 2) + (itemWidth / 2);
            container.scrollTo({ left: scrollPos, behavior: 'smooth' });
        }
    }
    
    document.addEventListener("DOMContentLoaded", centerActiveElement);
    document.body.addEventListener('htmx:afterSwap', centerActiveElement);
</script>
{% endblock %}




==================== FIM ARQUIVO: app/templates/index.html ====================

==================== INICIO ARQUIVO: app/templates/lucro_real.html ====================
{% extends 'base.html' %}
{% block extra_css %}
<style>
    /* Estilo para bloqueio de conte√∫do Premium */
    .premium-blur {
        filter: blur(4px);
        user-select: none;
        pointer-events: none;
        opacity: 0.7;
        transition: 0.3s;
    }
    
    .blur-container { position: relative; overflow: hidden; border-radius: 20px; }

    .lock-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.05); z-index: 10;
        backdrop-filter: blur(1px);
    }
    
    .btn-unlock {
        background: var(--primary); color: white; border: none; padding: 12px 24px;
        border-radius: 50px; font-weight: 800; font-size: 12px; text-decoration: none;
        box-shadow: 0 10px 25px rgba(37,99,235,0.4); display: flex; align-items: center; gap: 8px;
        transition: transform 0.2s; border: 2px solid white; cursor: pointer;
    }
    .btn-unlock:active { transform: scale(0.95); }

    /* Toggle Switch Personalizado */
    .toggle-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: rgba(0,0,0,0.03); padding: 10px 15px; border-radius: 12px; }
    .switch-link { text-decoration: none; display: inline-block; position: relative; width: 44px; height: 24px; }
    .switch-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; border-radius: 34px; transition: .4s; }
    .switch-circle { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .active .switch-bg { background-color: var(--primary); }
    .active .switch-circle { transform: translateX(20px); }
    
    /* Novo Indicador de Per√≠odo */
    .period-badge { font-size: 10px; background: var(--primary-light); color: var(--primary); padding: 3px 8px; border-radius: 8px; font-weight: 800; text-transform: uppercase; margin-left: auto; }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Lucro Real</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">An√°lise Profunda</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom:120px; animation-delay: 0.1s;">
    
    <!-- CARD VE√çCULO -->
    <div class="card" style="background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); color:white; border:none; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3); padding:25px;">
        <div style="display:flex; justify-content:space-between; align-items:start;">
            <div>
                <div style="font-size:10px; opacity:0.8; letter-spacing:1px; text-transform:uppercase; font-weight:700;">Ve√≠culo Atual</div>
                <div style="font-size:20px; font-weight:800; margin-top:2px;">{{ c['veiculo_modelo'] or 'N√£o configurado' }}</div>
                <div style="font-size:12px; opacity:0.9;">{{ c['veiculo_marca'] }} ‚Ä¢ {{ c['veiculo_ano'] }}</div>
            </div>
            <a href="/setup_veiculo" style="background:rgba(255,255,255,0.2); width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; text-decoration:none; backdrop-filter: blur(5px);">
                <i class="fas fa-pen"></i>
            </a>
        </div>
    </div>

    <!-- TOGGLE CUSTOS FIXOS -->
    {% if current_user.plan_type == 'premium' %}
    <div class="toggle-container">
        <span style="font-size:12px; font-weight:700; color:var(--text-main);">Deduzir Custo Fixo (IPVA/Seguro)</span>
        <a href="/lucro_real?tipo={{ tipo }}&valor={{ valor }}&usar_custos_fixos={{ 'false' if usar_custos_fixos else 'true' }}" class="switch-link {{ 'active' if usar_custos_fixos else '' }}">
            <div class="switch-bg"></div>
            <div class="switch-circle"></div>
        </a>
    </div>
    {% endif %}

    <!-- BALAN√áO -->
    <div class="glass-card">
        <div class="card-title">
            <span>Balan√ßo do Per√≠odo</span>
            <span class="period-badge">{{ periodo_label }}</span>
        </div>
        
        <!-- AVISO DE SINCRONIZA√á√ÉO -->
        <div style="font-size:10px; color:var(--text-secondary); text-align:center; margin-bottom:15px; background:rgba(0,0,0,0.03); padding:8px; border-radius:10px; display: flex; align-items: center; justify-content: center; gap: 6px;">
            <i class="fas fa-link"></i> Visualizando dados conforme filtro da Tela Inicial.
        </div>
        
        <!-- Lucro Operacional (Sempre Vis√≠vel) -->
        <div style="background:rgba(16, 185, 129, 0.1); padding:15px; border-radius:16px; margin-bottom:15px; border:1px solid rgba(16, 185, 129, 0.2);">
            <div style="font-size:11px; color:var(--text-main); font-weight:700; text-transform:uppercase;">Lucro Operacional</div>
            <div style="font-size:24px; font-weight:800; color:var(--success);">+ R$ {{ "%.2f"|format(lucro_operacional) }}</div>
            <div style="font-size:10px; color:var(--text-secondary);">(Faturamento - Despesas do dia)</div>
        </div>
        
        <!-- BLOQUEIO BASIC -->
        {% if current_user.plan_type == 'basic' %}
        <div class="blur-container">
            <div class="premium-blur">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:0 5px;">
                    <span style="font-size:13px; font-weight:600; color:var(--text-main);">Reserva T√©cnica</span>
                    <span style="font-size:14px; font-weight:800; color:var(--danger);">- R$ 150,00</span>
                </div>

                <div style="background:var(--success); color:white; padding:25px 20px; border-radius:20px; text-align:center; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                    <div style="font-size:11px; text-transform:uppercase; letter-spacing:1px; opacity:0.9; font-weight:700;">Lucro L√≠quido Real</div>
                    <div style="font-size:40px; font-weight:800; margin:5px 0; letter-spacing:-1.5px;">R$ 800,00</div>
                    <div style="font-size:11px; opacity:0.9;">O que sobra de verdade no bolso</div>
                </div>
            </div>
            
            <div class="lock-overlay">
                <a href="/assinar" class="btn-unlock"><i class="fas fa-lock"></i> Ver Lucro Real</a>
            </div>
        </div>
        {% else %}
        <!-- VISUAL PREMIUM (LIBERADO) -->
        <div>
            <!-- Reserva T√©cnica -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:0 5px;">
                <span style="font-size:13px; font-weight:600; color:var(--text-main);">Reserva T√©cnica</span>
                <span style="font-size:14px; font-weight:800; color:var(--danger);">- R$ {{ "%.2f"|format(total_reserva) }}</span>
            </div>

            <!-- Reserva Operacional (Custo Fixo) -->
            {% if usar_custos_fixos %}
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:0 5px;">
                <span style="font-size:13px; font-weight:600; color:var(--text-main);">Reserva Operacional <small style="font-weight:400; color:var(--text-secondary);">(Custo Fixo)</small></span>
                <span style="font-size:14px; font-weight:800; color:var(--danger);">- R$ {{ "%.2f"|format(total_custo_fixo) }}</span>
            </div>
            {% endif %}

            <div style="background:var(--success); color:white; padding:25px 20px; border-radius:20px; text-align:center; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                <div style="font-size:11px; text-transform:uppercase; letter-spacing:1px; opacity:0.9; font-weight:700;">Lucro L√≠quido Real</div>
                <div style="font-size:40px; font-weight:800; margin:5px 0; letter-spacing:-1.5px;">R$ {{ "%.2f"|format(lucro_real) }}</div>
                <div style="font-size:11px; opacity:0.9;">O que sobra de verdade no bolso</div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- DETALHES T√âCNICOS -->
    <div class="glass-card">
        <div class="card-title"><span>Custo Invis√≠vel</span></div>
        <p style="font-size:12px; color:var(--text-secondary); margin-bottom:15px; line-height:1.5;">
            Baseado nos <b>{{ "%.0f"|format(km_total) }} KM</b> rodados neste per√≠odo, este √© o custo estimado de desgaste.
        </p>
        
        {% if current_user.plan_type == 'basic' %}
        <div class="blur-container">
            <div class="premium-blur">
                <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:13px; border-bottom:1px dashed rgba(0,0,0,0.05); padding-bottom:12px;">
                    <span style="color:var(--text-secondary);">Custo Reserva (Dep+Manu)</span>
                    <b style="color:var(--text-main);">R$ 0,35/km</b>
                </div>
                
                <div style="display:flex; justify-content:space-between; font-size:13px;">
                    <span style="color:var(--text-secondary);">Custo Total Rodagem</span>
                    <b style="color:var(--danger);">R$ 0,80/km</b>
                </div>
            </div>
            <div class="lock-overlay">
                <a href="/assinar" class="btn-unlock" style="background:#F59E0B; border-color:#F59E0B;"><i class="fas fa-lock"></i> Ver Custo por KM</a>
            </div>
        </div>
        {% else %}
        <div>
            <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:13px; border-bottom:1px dashed rgba(0,0,0,0.05); padding-bottom:12px;">
                <span style="color:var(--text-secondary);">Custo Reserva (Dep+Manu)</span>
                <b style="color:var(--text-main);">R$ {{ "%.2f"|format(d['custo_km_reserva']) }}/km</b>
            </div>
            
            <div style="display:flex; justify-content:space-between; font-size:13px;">
                <span style="color:var(--text-secondary);">Custo Total Rodagem</span>
                <b style="color:var(--danger);">R$ {{ "%.2f"|format(d['custo_total_rodagem']) }}/km</b>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}



==================== FIM ARQUIVO: app/templates/lucro_real.html ====================

==================== INICIO ARQUIVO: app/templates/manutencao.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui/material-ui.min.css">
<style>
    .log-item {
        background: white; border-left: 4px solid var(--primary);
        padding: 15px; border-radius: 12px; margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .log-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
    .log-title { font-weight: 800; color: var(--text-main); font-size: 14px; }
    .log-meta { font-size: 11px; margin-top: 5px; color: var(--text-secondary); }
    
    .btn-pdf {
        background: rgba(37, 99, 235, 0.1); color: var(--primary);
        padding: 12px; border-radius: 12px; font-weight: 700;
        text-align: center; display: block; margin-bottom: 20px;
        text-decoration: none; border: 1px dashed var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Manuten√ß√£o</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Od√¥metro: {{ "%.0f"|format(odo) }} km</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">
    
    <!-- ABAS -->
    <div class="mode-selector" style="margin-bottom: 25px;">
        <button onclick="showTab('alertas')" id="tab-alertas" class="mode-pill active">Alertas</button>
        <button onclick="showTab('historico')" id="tab-historico" class="mode-pill">Livro de Revis√µes</button>
    </div>

    <!-- VIEW ALERTAS -->
    <div id="view-alertas">
        <!-- ADD FORM -->
        <div class="glass-card">
            <div class="card-title"><span>Criar Alerta</span></div>
            <form action="/adicionar_manutencao" method="POST" style="display:flex; gap:10px; align-items:flex-end;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div style="flex:2;">
                    <label style="font-size:10px; color:var(--text-secondary); font-weight:700;">ITEM</label>
                    <input type="text" name="item" placeholder="Ex: √ìleo" required style="padding:12px;">
                </div>
                <div style="flex:1.5;">
                    <label style="font-size:10px; color:var(--text-secondary); font-weight:700;">INTERVALO (KM)</label>
                    <input type="number" name="km_proxima" placeholder="5000" required style="padding:12px;">
                </div>
                <button type="submit" class="btn" style="width:48px; height:48px; padding:0; border-radius:14px; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);">
                    <i class="fas fa-plus"></i>
                </button>
            </form>
            <p style="font-size:10px; color:var(--text-secondary); margin-top:8px; opacity:0.7;">* A contagem come√ßa a partir do KM atual.</p>
        </div>

        <!-- LISTA -->
        <div style="font-size:12px; font-weight:800; color:var(--text-secondary); text-transform:uppercase; margin-bottom:15px; margin-left:5px;">Pr√≥ximas Trocas</div>
        
        {% if itens %}
            {% for i in itens %}
            <div class="glass-card" style="padding: 15px; margin-bottom: 10px; border-left: 4px solid {{ 'var(--danger)' if i.urgencia == 'critica' or i.urgencia == 'alta' else 'var(--warning)' if i.urgencia == 'media' else 'var(--success)' }};">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-weight:700; font-size:14px; color:var(--text-main);">{{ i.item }}</span>
                    <span style="font-size:11px; background:rgba(0,0,0,0.05); padding:2px 8px; border-radius:8px; font-weight:600;">Meta: {{ "%.0f"|format(i.km_proxima) }}</span>
                </div>
                
                <div style="font-size:12px; color:var(--text-secondary); margin-bottom:10px; display:flex; gap:5px; align-items:center;">
                    <i class="far fa-calendar-alt"></i> Previs√£o: 
                    {% if current_user.plan_type == 'basic' %}
                        <b style="color:var(--text-secondary); filter: blur(3px); user-select: none;">25/10/2025</b>
                        <span style="font-size:9px; background:var(--primary); color:white; padding:2px 6px; border-radius:4px; margin-left:5px;">PREMIUM</span>
                    {% else %}
                        <b style="color:var(--primary);">{{ i.previsao_txt }}</b>
                    {% endif %}
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px dashed rgba(0,0,0,0.05); padding-top:10px;">
                    <span style="font-size:12px; font-weight:700; color:{{ 'var(--danger)' if i.falta_km < 0 else 'var(--text-main)' }};">
                        {% if i.falta_km < 0 %}Venceu h√° {{ "%.0f"|format(i.falta_km * -1) }} km{% else %}Faltam {{ "%.0f"|format(i.falta_km) }} km{% endif %}
                    </span>
                    <div style="display:flex; gap:8px;">
                        <a href="/editar_manutencao/{{ i.id }}" style="color:var(--text-secondary); font-size:14px;"><i class="fas fa-pen"></i></a>
                        <!-- Bot√£o Concluir com SweetAlert e Input KM -->
                        <div style="cursor:pointer; color:var(--success); font-size:14px;" 
                             onclick="confirmarConclusao('{{ i.id }}', '{{ i.item }}', '{{ current_user.plan_type }}', {{ odo }})">
                           <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align:center; padding:30px; opacity:0.5;">
                <i class="fas fa-check-circle" style="font-size:40px; color:var(--success); margin-bottom:10px;"></i>
                <p style="font-size:13px;">Tudo em dia!</p>
            </div>
        {% endif %}
    </div>

    <!-- VIEW HIST√ìRICO -->
    <div id="view-historico" style="display:none;">
        {% if current_user.plan_type == 'basic' %}
            <div class="glass-card" style="text-align:center; padding:40px 20px;">
                <div style="width:70px; height:70px; background:rgba(37,99,235,0.1); border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-bottom:20px; font-size:28px; color:var(--primary);">
                    <i class="fas fa-history"></i>
                </div>
                <h3 style="margin:0 0 10px 0; color:var(--text-main); font-weight:800;">Valorize seu Carro</h3>
                <p style="font-size:13px; color:var(--text-secondary); line-height:1.5; margin-bottom:25px;">
                    Carros com hist√≥rico de manuten√ß√£o comprovado valem at√© <strong>20% a mais</strong> na revenda.
                    <br><br>
                    O Plano Basic n√£o armazena o hist√≥rico. Desbloqueie o Premium para criar seu <b>Livro de Revis√µes Digital</b> automaticamente.
                </p>
                <a href="/assinar" class="btn" style="border-radius:50px; background:var(--primary); box-shadow: 0 10px 25px rgba(37,99,235,0.3);">
                    Quero valorizar meu carro
                </a>
            </div>
        {% else %}
            
            <!-- BOT√ÉO PDF (PREMIUM ONLY) -->
            <a href="/manutencao/imprimir_historico" target="_blank" class="btn-pdf">
                <i class="fas fa-file-pdf"></i> BAIXAR LIVRO DE REVIS√ïES (PDF)
            </a>

            <!-- LISTA REAL (PREMIUM) -->
            {% if historico_manutencao %}
                {% for log in historico_manutencao %}
                <div class="log-item fade-in">
                    <div class="log-header">
                        <span>{{ log.service_date.strftime('%d/%m/%Y') }}</span>
                        <span><i class="fas fa-check-circle" style="color:var(--success);"></i> Conclu√≠do</span>
                    </div>
                    <div class="log-title">{{ log.item_name }}</div>
                    <div class="log-meta">
                        Realizado com {{ "%.0f"|format(log.service_km) }} km - R$ {{ "%.2f"|format(log.cost or 0) }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="glass-card" style="text-align:center; padding:40px 20px; opacity:0.7;">
                    <i class="fas fa-book-open" style="font-size:40px; color:var(--secondary); margin-bottom:15px;"></i>
                    <p style="font-size:13px; color:var(--text-secondary);">
                        Seu hist√≥rico est√° vazio.<br>
                        Conclua uma manuten√ß√£o na aba "Alertas" para come√ßar o registo.
                    </p>
                </div>
            {% endif %}
        {% endif %}
    </div>

</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function showTab(tab) {
        document.getElementById('view-alertas').style.display = tab==='alertas'?'block':'none';
        document.getElementById('view-historico').style.display = tab==='historico'?'block':'none';
        document.getElementById('tab-alertas').className = tab==='alertas'?'mode-pill active':'mode-pill';
        document.getElementById('tab-historico').className = tab==='historico'?'mode-pill active':'mode-pill';
    }

    function confirmarConclusao(id, item, plan, currentOdo) {
        if (plan === 'basic') {
            Swal.fire({
                title: 'Concluir manuten√ß√£o?',
                html: '<span style="font-size:13px">O contador ser√° reiniciado usando o KM estimado atual.<br><br><b style="color:#d33">Aten√ß√£o:</b> No plano Basic, o hist√≥rico n√£o √© salvo e voc√™ n√£o pode ajustar o KM exato.</span>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#2563EB',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Concluir mesmo assim',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/concluir_manutencao/${id}`;
                }
            });
        } else {
            // L√≥gica Premium com Input de KM e CUSTO (Modal HTML)
            Swal.fire({
                title: 'Registrar Manuten√ß√£o',
                html: `
                    <div style="text-align:left; font-size:13px; margin-bottom:15px;">
                        Confirme os dados para o Livro de Revis√µes de <b>${item}</b>:
                    </div>
                    <label style="display:block; text-align:left; font-size:11px; font-weight:700; margin-bottom:5px;">KM NO MOMENTO DA TROCA</label>
                    <input id="swal-km" type="number" class="swal2-input" value="${Math.round(currentOdo)}" style="margin:0 0 15px 0;">
                    
                    <label style="display:block; text-align:left; font-size:11px; font-weight:700; margin-bottom:5px;">CUSTO TOTAL (R$)</label>
                    <input id="swal-cost" type="number" step="0.01" class="swal2-input" placeholder="0.00" style="margin:0;">
                `,
                showCancelButton: true,
                confirmButtonText: 'Salvar no Hist√≥rico',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#2563EB',
                preConfirm: () => {
                    const km = document.getElementById('swal-km').value;
                    const cost = document.getElementById('swal-cost').value;
                    if (!km) {
                        Swal.showValidationMessage('Informe a quilometragem');
                        return false;
                    }
                    if (!cost) {
                        // Opcional: Se n√£o preencher custo, assume 0.
                        // Mas pode for√ßar se quiser. Aqui vou deixar passar vazio como 0.
                    }
                    return { km: km, cost: cost || '0' };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const km = result.value.km;
                    const cost = result.value.cost;
                    // Envia KM e Custo na URL
                    window.location.href = `/concluir_manutencao/${id}?km_real=${km}&custo_real=${cost}`;
                }
            });
        }
    }
</script>
{% endblock %}
{% endblock %}




==================== FIM ARQUIVO: app/templates/manutencao.html ====================

==================== INICIO ARQUIVO: app/templates/novo_agendamento.html ====================
{% extends 'base.html' %}

{% block content %}
<div class="header fade-in">
    <a href="/agenda" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Novo Agendamento</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Detalhes da Corrida</p>
    </div>
    <div style="width:40px;"></div>
</div>

<form method="post" class="container fade-in" style="padding-top: 10px; padding-bottom: 100px; animation-delay: 0.1s;" onsubmit="showLoading()">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- CLIENTE E VALOR -->
    <div class="glass-card">
        <div class="card-title"><span>Informa√ß√µes B√°sicas</span></div>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">NOME DO PASSAGEIRO</label>
            <input type="text" name="cliente" required placeholder="Ex: Ana Maria" style="font-weight: 600;">
        </div>
        
        <div>
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">VALOR COMBINADO</label>
            <div style="position: relative;">
                <span style="position: absolute; left: 15px; top: 16px; color: var(--success); font-weight: 800;">R$</span>
                <input type="number" step="0.01" name="valor" placeholder="0.00" inputmode="decimal" style="padding-left: 40px; font-weight: 700; color: var(--success);">
            </div>
        </div>
    </div>

    <!-- DATA E HORA -->
    <div class="glass-card">
        <div class="card-title"><span>Quando?</span></div>
        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px;">
            <div>
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">DATA</label>
                <input type="date" name="data_ag" value="{{ hoje }}" required style="font-weight: 600;">
            </div>
            <div>
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">HOR√ÅRIO</label>
                <input type="time" name="hora_ag" required style="font-weight: 600; text-align: center;">
            </div>
        </div>
    </div>

    <!-- TRAJETO (COM PARADA) -->
    <div class="glass-card">
        <div class="card-title"><span>Trajeto</span></div>
        
        <div style="margin-bottom: 15px; position:relative;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">EMBARQUE (ORIGEM)</label>
            <i class="fas fa-circle" style="position: absolute; left: 15px; top: 38px; font-size: 8px; color: var(--primary);"></i>
            <input type="text" name="origem" required placeholder="Rua..." style="padding-left: 35px;">
            
            <!-- Linha conectora visual -->
            <div style="position:absolute; left:18px; top:55px; height:35px; width:2px; background:rgba(0,0,0,0.1);"></div>
        </div>
        
        <div style="margin-bottom: 15px; position:relative;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">PARADA (OPCIONAL)</label>
            <i class="fas fa-stop-circle" style="position: absolute; left: 15px; top: 38px; font-size: 10px; color: var(--text-secondary);"></i>
            <input type="text" name="parada" placeholder="Adicionar parada..." style="padding-left: 35px; border-style:dashed;">
            
            <div style="position:absolute; left:18px; top:55px; height:35px; width:2px; background:rgba(0,0,0,0.1);"></div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">DESEMBARQUE (DESTINO)</label>
            <div style="position: relative;">
                <i class="fas fa-map-marker-alt" style="position: absolute; left: 15px; top: 18px; font-size: 12px; color: var(--danger);"></i>
                <input type="text" name="destino" required placeholder="Av..." style="padding-left: 35px;">
            </div>
        </div>
        
        <div>
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">OBSERVA√á√ïES (OPCIONAL)</label>
            <textarea name="observacao" rows="2" placeholder="Ex: Levar cadeirinha..." style="resize: none;"></textarea>
        </div>
    </div>

    <button type="submit" id="btnSalvar" class="btn" style="margin-bottom:20px; padding:18px; width:100%; border-radius: 50px; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);">
        <i class="fas fa-check"></i> AGENDAR CORRIDA
    </button>
</form>

<script>
    function showLoading() {
        const btn = document.getElementById('btnSalvar');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
        btn.style.opacity = '0.8';
    }
</script>
{% endblock %}




==================== FIM ARQUIVO: app/templates/novo_agendamento.html ====================

==================== INICIO ARQUIVO: app/templates/relatorios.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* Estilo Espec√≠fico para garantir renderiza√ß√£o dos gr√°ficos */
    .chart-box { position: relative; height: 220px; width: 100%; }
    .chart-box-small { position: relative; height: 150px; width: 100%; }

    /* Novo Bot√£o PDF Largo */
    .btn-pdf-full { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 15px; border-radius: 16px; background: rgba(37, 99, 235, 0.1); color: var(--primary); font-weight: 800; text-decoration: none; border: 1px solid rgba(37, 99, 235, 0.2); margin-bottom: 20px; transition: 0.2s; cursor: pointer; }
    .btn-pdf-full:active { background: rgba(37, 99, 235, 0.2); transform: scale(0.98); }
    .btn-pdf-locked { background: #F1F5F9; color: var(--text-secondary); border-color: transparent; opacity: 0.9; }

    /* Modal Upsell */
    #upsellModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
    .upsell-card { width:90%; max-width:350px; text-align:center; padding:30px; background: white; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; animation: popUp 0.3s; }
    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer; }
    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Relat√≥rios</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">An√°lise de Performance</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">
    
    {% if current_user.plan_type == 'premium' %}
        <a href="/relatorio/imprimir_pdf" target="_blank" class="btn-pdf-full"><i class="fas fa-file-pdf"></i> BAIXAR RELAT√ìRIO PDF</a>
    {% else %}
        <div class="btn-pdf-full btn-pdf-locked" onclick="openUpsell('pdf')"><i class="fas fa-lock"></i> BAIXAR RELAT√ìRIO PDF (PREMIUM)</div>
    {% endif %}

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-bottom: 20px;">
        <div class="filter-btn {{ 'active' if tipo == 'dia' else '' }}"><span class="fb-label">DIA</span><span class="fb-value">{{ filter_label if tipo == 'dia' else 'Filtrar' }}</span><input type="date" onchange="submitRel(this.value, 'dia')" class="filter-input"></div>
        <div class="filter-btn {{ 'active' if tipo == 'semana' else '' }}"><span class="fb-label">SEM</span><span class="fb-value">{{ filter_label|safe if tipo == 'semana' else 'Filtrar' }}</span><select onchange="submitRel(this.value, 'semana')" class="filter-input"><option value="" disabled selected>Selecione...</option>{% for week in week_options %}<option value="{{ week.value }}" {% if tipo == 'semana' and valor == week.value %}selected{% endif %}>{{ week.label }}</option>{% endfor %}</select></div>
        <div class="filter-btn {{ 'active' if tipo == 'mes' else '' }}"><span class="fb-label">M√äS</span><span class="fb-value">{{ filter_label if tipo == 'mes' else 'Filtrar' }}</span><input type="month" onchange="submitRel(this.value, 'mes')" class="filter-input"></div>
        
        <!-- BOT√ÉO ANO BLOQUEADO -->
        {% if current_user.plan_type == 'basic' %}
        <div class="filter-btn" style="opacity: 0.8; background: #f1f5f9; border-color: transparent;" onclick="openUpsell('anual')">
            <span class="fb-label" style="color:var(--text-secondary);">ANO</span>
            <span class="fb-value" style="color:var(--text-secondary);"><i class="fas fa-lock" style="font-size:10px;"></i> PRO</span>
        </div>
        {% else %}
        <div class="filter-btn {{ 'active' if tipo == 'anual' else '' }}"><span class="fb-label">ANO</span><span class="fb-value">{{ filter_label if tipo == 'anual' else 'Filtrar' }}</span><select onchange="submitRel(this.value, 'anual')" class="filter-input"><option value="" disabled selected>Selecione...</option>{% for a in anos %}<option value="{{ a }}" {% if tipo == 'anual' and valor == a|string %}selected{% endif %}>{{ a }}</option>{% endfor %}</select></div>
        {% endif %}
    </div>
    
    <div class="glass-card">
        <div class="card-title"><span>Resumo Financeiro</span></div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="text-align:center; flex:1;"><span style="font-size:10px; color:var(--text-secondary); font-weight:700; text-transform:uppercase;">Faturamento</span><div style="font-size:18px; font-weight:800; color:var(--success); margin-top:5px;">R$ {{ "%.2f"|format(total_ganho) }}</div></div>
            <div style="width:1px; height:30px; background:rgba(0,0,0,0.1);"></div>
            <div style="text-align:center; flex:1;"><span style="font-size:10px; color:var(--text-secondary); font-weight:700; text-transform:uppercase;">Lucro Op.</span><div style="font-size:18px; font-weight:800; color:var(--primary); margin-top:5px;">R$ {{ "%.2f"|format(total_ganho - total_despesa) }}</div></div>
        </div>
    </div>

    {% if tipo != 'dia' %}
    <div class="glass-card"><div class="card-title"><span>Evolu√ß√£o</span></div><div class="chart-box"><canvas id="mainChart"></canvas></div></div>
    {% endif %}

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
        <div class="glass-card" style="padding:15px; margin:0;"><div class="card-title" style="margin-bottom:10px; font-size:10px;">Faturamento (R$)</div><div class="chart-box-small"><canvas id="chartAppsRelatorio"></canvas></div></div>
        <div class="glass-card" style="padding:15px; margin:0;"><div class="card-title" style="margin-bottom:10px; font-size:10px;">Volume Corridas</div><div class="chart-box-small"><canvas id="chartQtdApps"></canvas></div></div>
    </div>

    <div class="glass-card" style="display:flex; align-items:center; gap:15px; padding:15px;">
        <div style="width:45px; height:45px; background:rgba(245, 158, 11, 0.1); color:var(--warning); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px;"><i class="fas fa-trophy"></i></div>
        <div><div style="font-size:12px; color:var(--text-secondary); font-weight:600;">Melhor Dia (Recorde)</div><div style="font-size:18px; font-weight:800; color:var(--text-main);">R$ {{ "%.2f"|format(best_day.val) }}</div><div style="font-size:11px; color:var(--primary); font-weight:700;">{{ best_day.full }}</div></div>
    </div>
</div>

<!-- MODAL UPSELL DIN√ÇMICO -->
<div id="upsellModal">
    <div class="upsell-card">
        <button class="close-modal" onclick="closeUpsell()">&times;</button>
        <div style="width:70px; height:70px; background:rgba(37,99,235,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto; color:var(--primary); font-size:30px;">
            <i class="fas fa-crown"></i>
        </div>
        <h3 id="upsellTitle" style="margin:0 0 10px 0; color:var(--text-main); font-size:20px; font-weight:800;">Recurso Premium</h3>
        <p id="upsellText" style="font-size:14px; color:var(--text-secondary); margin-bottom:25px; line-height:1.5;">
            Esta funcionalidade √© exclusiva para membros Premium.
        </p>
        <a href="/assinar" class="btn" style="border-radius:50px; background:var(--primary); box-shadow: 0 10px 30px rgba(37,99,235,0.4); text-decoration:none; display:flex; justify-content:center; align-items:center; padding:15px; color:white; font-weight:800;">
            Desbloquear Agora
        </a>
    </div>
</div>

{% block extra_js %}
<script>
    function submitRel(valor, tipo) { if(!valor) return; window.location.href = `/relatorios?tipo=${tipo}&valor=${valor}`; }

    // L√ìGICA DO MODAL
    function openUpsell(feature) {
        const title = document.getElementById('upsellTitle');
        const text = document.getElementById('upsellText');
        
        if(feature === 'pdf') {
            title.innerText = "Relat√≥rios em PDF";
            text.innerHTML = "Gere documentos profissionais com todos os detalhes operacionais e financeiros. <br>Exclusivo do plano Premium.";
        } else if (feature === 'anual') {
            title.innerText = "Vis√£o Anual";
            text.innerHTML = "Analise a sua evolu√ß√£o m√™s a m√™s e compare o desempenho anual. <br>Exclusivo do plano Premium.";
        }
        
        document.getElementById('upsellModal').style.display = 'flex';
    }
    
    function closeUpsell() {
        document.getElementById('upsellModal').style.display = 'none';
    }

    document.addEventListener("DOMContentLoaded", function() {
        const colors = { primary: '#2563EB', danger: '#EF4444', bgPrimary: 'rgba(37, 99, 235, 0.1)', apps: ['#1E293B', '#F59E0B', '#10B981', '#2563EB'] };
        const formatMoney = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        // ... (Charts mantidos iguais ao anterior) ...
        const ctxMain = document.getElementById('mainChart');
        if(ctxMain) {
            new Chart(ctxMain, {
                type: 'line',
                data: {
                    labels: {{ chart_labels|tojson }},
                    datasets: [
                        { label: 'Ganho', data: {{ chart_data|tojson }}, borderColor: colors.primary, backgroundColor: colors.bgPrimary, fill: true, tension: 0.3, pointRadius: 2 },
                        { label: 'Despesa', data: {{ chart_despesa|tojson }}, borderColor: colors.danger, borderDash: [5, 5], tension: 0.3, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { font: { size: 10 } } }, y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false } } } }
            });
        }
        
        const rawAppsVal = {{ dados_apps|tojson }};
        const rawAppsQtd = {{ qtd_apps|tojson }};
        const baseLabels = ['Uber', '99', 'Part', '{{ custom_app_name }}'];
        const labelsWithVal = baseLabels.map((l, i) => `${l} (${formatMoney(rawAppsVal[i])})`);
        const labelsWithQtd = baseLabels.map((l, i) => `${l} (${rawAppsQtd[i]})`);

        const ctxBar = document.getElementById('chartAppsRelatorio');
        if(ctxBar) { 
            new Chart(ctxBar, { 
                type: 'bar', 
                data: { labels: labelsWithVal, datasets: [{ label: 'R$', data: rawAppsVal, backgroundColor: colors.apps, borderRadius: 4 }] }, 
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 8 } } } } } 
            }); 
        }

        const ctxPie = document.getElementById('chartQtdApps');
        if(ctxPie) {
            new Chart(ctxPie, {
                type: 'doughnut',
                data: { labels: labelsWithQtd, datasets: [{ data: rawAppsQtd, backgroundColor: colors.apps, borderWidth: 0, hoverOffset: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 8, font: { size: 9 } } } } }
            });
        }
    });
</script>
{% endblock %}
{% endblock %}




==================== FIM ARQUIVO: app/templates/relatorios.html ====================

==================== INICIO ARQUIVO: app/templates/setup_veiculo.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    .locked-section { position: relative; overflow: hidden; border-radius: 16px; margin-top: 20px; }
    .blur-content { filter: blur(5px); opacity: 0.6; pointer-events: none; user-select: none; }
    .lock-overlay { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.4); z-index: 10;
        text-align: center; padding: 20px;
    }
    .lock-icon { font-size: 30px; color: var(--primary); margin-bottom: 10px; }
    .lock-title { font-weight: 800; color: var(--text-main); font-size: 14px; margin-bottom: 5px; }
    .lock-desc { font-size: 11px; color: var(--text-secondary); margin-bottom: 15px; line-height: 1.4; max-width: 200px; }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/configuracoes" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Meu Carro</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Configura√ß√£o</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">
    
    {% if request.args.get('msg') == 'config_required' %}
    <div style="background:rgba(245, 158, 11, 0.15); color:var(--warning); padding:15px; border-radius:20px; margin-bottom:20px; border:1px solid rgba(245, 158, 11, 0.3); font-size:13px; line-height:1.4; text-align:center;">
        <i class="fas fa-exclamation-triangle"></i><br>
        <b>Configura√ß√£o Necess√°ria</b><br>Preencha os dados para calcular seu Lucro Real.
    </div>
    {% endif %}

    <form method="post" id="formSetupVeiculo">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="save">
        
        <!-- DADOS B√ÅSICOS -->
        <div class="glass-card">
            <div class="card-title"><span>Identifica√ß√£o</span></div>
            
            <div style="margin-bottom:15px;">
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">MARCA</label>
                <input type="text" name="veiculo_marca" value="{{ c['veiculo_marca'] }}" placeholder="Ex: Chevrolet" required style="font-weight:700;">
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">MODELO</label>
                    <input type="text" name="veiculo_modelo" value="{{ c['veiculo_modelo'] }}" placeholder="Ex: Onix" required style="font-weight:700;">
                </div>
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">ANO</label>
                    <input type="number" name="veiculo_ano" value="{{ c['veiculo_ano'] }}" placeholder="2020" style="font-weight:700;">
                </div>
            </div>
            
            <div>
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">KM ATUAL (OD√îMETRO)</label>
                <input type="number" name="km_atual_carro" value="{{ c['km_atual_carro'] }}" placeholder="0" style="font-weight:700; background:rgba(37, 99, 235, 0.05); border-color:rgba(37, 99, 235, 0.2); color:var(--primary);">
            </div>
        </div>

        <!-- CUSTOS VARI√ÅVEIS -->
        <div class="glass-card">
            <div class="card-title"><span>Par√¢metros de Rodagem</span></div>
            <p style="font-size:11px; color:var(--text-secondary); margin-bottom:20px; line-height:1.4;">
                Base para c√°lculo de combust√≠vel e deprecia√ß√£o.
            </p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">AUTONOMIA (KM/L)</label>
                    <input type="number" step="0.1" name="autonomia_kml" value="{{ c['autonomia_kml'] }}" required placeholder="10" style="font-weight:700;">
                </div>
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">PRE√áO COMBUST√çVEL</label>
                    <input type="number" step="0.01" name="preco_combustivel" value="{{ c['preco_combustivel'] }}" required placeholder="5.59" style="font-weight:700;">
                </div>
            </div>
            
            <div style="background:rgba(255,255,255,0.4); padding:15px; border-radius:16px; border:1px solid rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; gap:15px;">
                    <div style="flex:1;">
                        <label style="font-size:9px; font-weight:700; color:var(--text-secondary); display:block; margin-bottom:4px;">DEPRECIA√á√ÉO (R$/KM)</label>
                        <input type="number" step="0.01" name="depreciacao_km" value="{{ c['depreciacao_km'] }}" style="padding:10px;">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:9px; font-weight:700; color:var(--text-secondary); display:block; margin-bottom:4px;">MANUTEN√á√ÉO (R$/KM)</label>
                        <input type="number" step="0.01" name="manutencao_km" value="{{ c['manutencao_km'] }}" style="padding:10px;">
                    </div>
                </div>
                <small style="font-size:10px; color:var(--text-secondary); opacity:0.8;">* Valores sugeridos: 0.20 e 0.15</small>
            </div>
        </div>

        <!-- CUSTOS FIXOS (ATUALIZADO) -->
        {% if current_user.plan_type == 'basic' %}
        <div class="locked-section">
            <div class="glass-card blur-content" style="margin:0;">
                <div class="card-title"><span>Custo Fixo</span></div>
                <div style="margin-bottom:15px;">
                    <label style="font-size:10px;">SEGURO (MENSAL)</label>
                    <input type="text" value="R$ 300,00">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div><label style="font-size:10px;">IPVA (ANUAL)</label><input type="text" value="R$ 2000"></div>
                    <div><label style="font-size:10px;">ALUGUEL (SEMANAL)</label><input type="text" value="R$ 600"></div>
                </div>
            </div>
            
            <div class="lock-overlay">
                <i class="fas fa-lock lock-icon"></i>
                <div class="lock-title">Gest√£o Profissional</div>
                <div class="lock-desc">Motoristas de elite calculam IPVA, Seguro e Aluguel automaticamente. Desbloqueie o Lucro Real Completo.</div>
                <a href="/assinar" class="btn" style="width:auto; padding:12px 25px; font-size:12px; box-shadow:0 10px 20px rgba(37,99,235,0.3);">
                    Desbloquear Agora
                </a>
            </div>
        </div>
        {% else %}
        <div class="glass-card" style="border-left: 4px solid var(--primary);">
            <div class="card-title"><span>Custo Fixo</span></div>
            <p style="font-size:11px; color:var(--text-secondary); margin-bottom:15px;">
                Preencha para descontar automaticamente do seu lucro di√°rio. Se n√£o tiver algum custo, deixe zerado.
            </p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">SEGURO (MENSAL)</label>
                    <div style="position:relative;">
                        <span style="position:absolute; left:10px; top:16px; font-weight:800; color:var(--text-secondary); font-size:10px;">R$</span>
                        <input type="number" step="0.01" name="seguro_mensal" value="{{ c['seguro_mensal'] }}" placeholder="0.00" style="padding-left:25px; font-weight:700;">
                    </div>
                </div>
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">FINANCIAMENTO (M√äS)</label>
                    <div style="position:relative;">
                        <span style="position:absolute; left:10px; top:16px; font-weight:800; color:var(--text-secondary); font-size:10px;">R$</span>
                        <input type="number" step="0.01" name="financiamento_mensal" value="{{ c['financiamento_mensal'] }}" placeholder="0.00" style="padding-left:25px; font-weight:700;">
                    </div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">IPVA (ANUAL)</label>
                    <div style="position:relative;">
                        <span style="position:absolute; left:10px; top:16px; font-weight:800; color:var(--text-secondary); font-size:10px;">R$</span>
                        <input type="number" step="0.01" name="ipva_anual" value="{{ c['ipva_anual'] }}" placeholder="0.00" style="padding-left:25px; font-weight:700;">
                    </div>
                </div>
                <div>
                    <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">ALUGUEL (SEMANAL)</label>
                    <div style="position:relative;">
                        <span style="position:absolute; left:10px; top:16px; font-weight:800; color:var(--text-secondary); font-size:10px;">R$</span>
                        <input type="number" step="0.01" name="aluguel_semanal" value="{{ c['aluguel_semanal'] }}" placeholder="0.00" style="padding-left:25px; font-weight:700;">
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <button type="submit" class="btn" style="margin-bottom:20px; margin-top:20px; padding:18px; width:100%; border-radius:16px; background:var(--primary-gradient); color:white; border:none; font-weight:800; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);">
            <i class="fas fa-save"></i> SALVAR CONFIGURA√á√ÉO
        </button>
    </form>
    
    <form method="post" onsubmit="return confirm('Tem certeza? Isso apagar√° a configura√ß√£o do ve√≠culo.');" style="text-align:center; margin-bottom:50px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="delete">
        <button type="submit" style="background:transparent; border:none; color:var(--danger); font-size:12px; font-weight:700; cursor:pointer; padding:10px;">
            <i class="fas fa-trash"></i> Resetar Dados
        </button>
    </form>
</div>
{% endblock %}




==================== FIM ARQUIVO: app/templates/setup_veiculo.html ====================

==================== INICIO ARQUIVO: app/templates/login.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrar - Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body { background-color: #F0F4F8; min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; padding: 20px; font-family: 'Plus Jakarta Sans', sans-serif; }
        .auth-card { background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.9); box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-radius: 30px; padding: 40px 30px; width: 100%; max-width: 380px; text-align: center; }
        .input-group { position: relative; margin-bottom: 15px; text-align: left; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #64748B; }
        .auth-input { width: 100%; padding: 16px 15px 16px 45px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); color: #0F172A; font-family: inherit; font-size: 14px; outline: none; box-sizing: border-box; }
        .auth-input:focus { background: white; border-color: #2563EB; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        
        .btn-auth { background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); border: none; width: 100%; padding: 18px; border-radius: 16px; color: white; font-weight: 800; font-size: 15px; cursor: pointer; margin-top: 10px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); transition: transform 0.2s; }
        .btn-auth:active { transform: scale(0.97); }
        
        /* BOT√ÉO GOOGLE */
        .btn-google {
            background: white; border: 1px solid #e2e8f0; width: 100%; padding: 15px; border-radius: 16px;
            color: #1e293b; font-weight: 700; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 20px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-google:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-google:active { transform: scale(0.98); }
        .google-icon { width: 20px; height: 20px; }

        .divider { display: flex; align-items: center; margin: 20px 0; color: #94a3b8; font-size: 12px; font-weight: 600; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }
        .divider span { padding: 0 10px; }

        .pass-eye { right: 15px; left: auto !important; cursor: pointer; }
        .app-logo-img { width: 80px; height: 80px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(37,99,235,0.25); object-fit: cover; }
    </style>
</head>
<body>
    <div style="position:fixed; top:-10%; left:-20%; width:400px; height:400px; background:#BFDBFE; filter:blur(90px); border-radius:50%; z-index:-1; opacity:0.5;"></div>
    <div style="position:fixed; bottom:10%; right:-10%; width:350px; height:350px; background:#C7D2FE; filter:blur(90px); border-radius:50%; z-index:-1; opacity:0.5;"></div>

    <div class="auth-card">
        <img src="/static/icons/icon-192.png" alt="Motorista Pro" class="app-logo-img">
        
        <h2 style="margin:0 0 5px 0; font-size:24px; font-weight:800; color:#0F172A;">Bem-vindo</h2>
        <p style="margin:0 0 20px 0; font-size:14px; color:#64748B;">Fa√ßa login para gerir os seus ganhos.</p>
        
        <div id="errorBox" style="background:#FEF2F2; color:#DC2626; padding:12px; border-radius:12px; font-size:13px; font-weight:600; margin-bottom:20px; display:none; border:1px solid #FCA5A5; word-wrap: break-word;"></div>
        
        <!-- BOT√ÉO GOOGLE -->
        <button type="button" class="btn-google" id="btnGoogle">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon">
            Continuar com Google
        </button>

        <div class="divider"><span>OU</span></div>

        <form id="loginForm">
            <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="email" class="auth-input" placeholder="Seu E-mail" required></div>
            <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="senha" class="auth-input" placeholder="Sua Senha" required><i class="fas fa-eye pass-eye" onclick="togglePass()"></i></div>
            <button type="submit" class="btn-auth" id="btnLogin">ENTRAR</button>
            <div id="loader" style="display:none; margin:10px auto; border:3px solid rgba(37,99,235,0.2); border-radius:50%; border-top:3px solid #2563EB; width:24px; height:24px; animation:spin 1s linear infinite;"></div>
            <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
        </form>
        
        <div style="margin-top:25px; display:flex; justify-content:space-between; font-size:13px; font-weight:600;">
            <a href="/recuperar_senha" style="color:#64748B; text-decoration:none;">Esqueci a senha</a>
            <a href="/register" style="color:#2563EB; text-decoration:none;">Criar Conta</a>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      
      const errorBox = document.getElementById('errorBox');
      const loader = document.getElementById('loader');
      const btnLogin = document.getElementById('btnLogin');
      const btnGoogle = document.getElementById('btnGoogle');

      function setLoading(isLoading) {
          loader.style.display = isLoading ? 'block' : 'none';
          btnLogin.style.display = isLoading ? 'none' : 'block';
          btnGoogle.style.opacity = isLoading ? '0.5' : '1';
          btnGoogle.style.pointerEvents = isLoading ? 'none' : 'auto';
      }

      try {
          const configRaw = '{{ FIREBASE_CONFIG_FRONTEND | safe }}';
          let firebaseConfig = JSON.parse(configRaw);
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);
          const googleProvider = new GoogleAuthProvider();

          // LOGIN EMAIL/SENHA
          document.getElementById('loginForm').addEventListener('submit', async (e) => {
              e.preventDefault();
              errorBox.style.display = 'none'; setLoading(true);
              
              const email = document.getElementById('email').value;
              const password = document.getElementById('senha').value;
              
              try {
                  const userCredential = await signInWithEmailAndPassword(auth, email, password);
                  await sendTokenToBackend(userCredential.user);
              } catch (error) {
                  handleAuthError(error);
              }
          });

          // LOGIN GOOGLE
          btnGoogle.addEventListener('click', async () => {
              errorBox.style.display = 'none';
              try {
                  const result = await signInWithPopup(auth, googleProvider);
                  // Aqui pegamos a foto do Google!
                  await sendTokenToBackend(result.user);
              } catch (error) {
                  handleAuthError(error);
              }
          });

          async function sendTokenToBackend(user) {
              setLoading(true);
              const idToken = await user.getIdToken(true);
              
              const response = await fetch('/auth/firebase_auth', { 
                  method: 'POST', 
                  headers: {'Content-Type': 'application/json'}, 
                  body: JSON.stringify({ 
                      idToken: idToken, 
                      nome: user.displayName, 
                      email: user.email,
                      photoURL: user.photoURL, // Enviando a foto
                      mode: 'login' 
                  }) 
              });
              
              const result = await response.json();
              if (result.success) { 
                  window.location.href = result.redirect; 
              } else { 
                  await signOut(auth); 
                  throw new Error(result.message); 
              }
          }

          function handleAuthError(error) {
              setLoading(false);
              let msg = error.message;
              if (error.code === 'auth/invalid-login-credentials' || error.code === 'auth/wrong-password') msg = "E-mail ou senha incorretos.";
              else if (error.code === 'auth/popup-closed-by-user') msg = "Login cancelado.";
              else if (error.code === 'auth/user-not-found') msg = "Usu√°rio n√£o encontrado.";
              
              errorBox.innerText = msg; 
              errorBox.style.display = 'block';
          }

          window.togglePass = function() { const i = document.getElementById('senha'); i.type = i.type === 'password' ? 'text' : 'password'; }
      } catch(err) { 
          console.error("Config Error:", err);
          errorBox.innerText = "Erro de configura√ß√£o."; errorBox.style.display='block'; 
      }
    </script>
</body>
</html>




==================== FIM ARQUIVO: app/templates/login.html ====================

==================== INICIO ARQUIVO: app/templates/register.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Conta - Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #F0F4F8; --text-main: #0F172A; --text-secondary: #64748B;
            --primary-gradient: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
            --glass-bg: rgba(255, 255, 255, 0.85); --glass-border: 1px solid rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(30, 58, 138, 0.08); --danger: #DC2626;
        }
        body { margin: 0; padding: 20px; font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .blob { position: fixed; border-radius: 50%; filter: blur(90px); z-index: -1; opacity: 0.5; }
        .blob-1 { top: -10%; right: -20%; width: 400px; height: 400px; background: #BFDBFE; animation: float 8s infinite alternate; }
        .blob-2 { bottom: 10%; left: -10%; width: 350px; height: 350px; background: #C7D2FE; animation: float 10s infinite alternate-reverse; }
        @keyframes float { from { transform: translate(0,0); } to { transform: translate(20px, 40px); } }

        .card { background: var(--glass-bg); backdrop-filter: blur(20px); border: var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 30px; padding: 40px 30px; width: 100%; max-width: 380px; text-align: center; }
        
        .app-logo-img { width: 70px; height: 70px; border-radius: 18px; margin-bottom: 15px; box-shadow: 0 8px 20px rgba(37,99,235,0.25); object-fit: cover; }
        
        h2 { margin: 0 0 5px 0; font-size: 24px; font-weight: 800; }
        p { margin: 0 0 20px 0; font-size: 14px; color: var(--text-secondary); }

        .input-group { position: relative; margin-bottom: 12px; text-align: left; }
        .input-group i.icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .pass-eye { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); cursor: pointer; }
        input { width: 100%; padding: 16px 15px 16px 45px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); color: var(--text-main); font-family: inherit; font-size: 14px; box-sizing: border-box; outline: none; transition: 0.2s; }
        input:focus { background: white; border-color: #2563EB; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        
        .btn-main { background: var(--primary-gradient); border: none; width: 100%; padding: 18px; border-radius: 16px; color: white; font-weight: 800; font-size: 15px; cursor: pointer; margin-top: 15px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); transition: transform 0.2s; }
        .btn-main:active { transform: scale(0.97); }
        
        /* BOT√ÉO GOOGLE */
        .btn-google {
            background: white; border: 1px solid #e2e8f0; width: 100%; padding: 15px; border-radius: 16px;
            color: #1e293b; font-weight: 700; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 20px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-google:hover { background: #f8fafc; border-color: #cbd5e1; }
        .google-icon { width: 20px; height: 20px; }
        
        .divider { display: flex; align-items: center; margin: 20px 0; color: #94a3b8; font-size: 12px; font-weight: 600; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }
        .divider span { padding: 0 10px; }

        .loader { display: none; margin: 10px auto; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #2563EB; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #errorBox { background: #FEF2F2; color: var(--danger); padding: 12px; border-radius: 12px; font-size: 13px; font-weight: 600; margin-bottom: 20px; display: none; border: 1px solid #FCA5A5; }
        .back-link { display: block; margin-top: 25px; color: var(--text-secondary); text-decoration: none; font-size: 13px; font-weight: 600; }
    </style>
</head>
<body>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="card">
        <img src="/static/icons/icon-192.png" alt="Motorista Pro" class="app-logo-img">
        
        <h2>Criar Conta</h2>
        <p>Comece a controlar o seu lucro hoje.</p>

        <div id="errorBox"></div>

        <!-- BOT√ÉO GOOGLE -->
        <button type="button" class="btn-google" id="btnGoogle">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon">
            Criar com Google
        </button>

        <div class="divider"><span>OU E-MAIL</span></div>

        <form id="regForm">
            <div class="input-group"><i class="fas fa-user icon"></i><input type="text" id="nome" placeholder="Seu Nome Completo" required></div>
            <div class="input-group"><i class="fab fa-whatsapp icon"></i><input type="tel" id="whatsapp" placeholder="WhatsApp (DDD + N√∫mero)" required></div>
            <div class="input-group"><i class="fas fa-envelope icon"></i><input type="email" id="email" placeholder="Seu E-mail" required></div>
            <div class="input-group"><i class="fas fa-check-circle icon"></i><input type="email" id="email_confirm" placeholder="Confirme seu E-mail" required></div>
            <div class="input-group"><i class="fas fa-lock icon"></i><input type="password" id="senha" placeholder="Crie uma Senha" required minlength="6"><i class="fas fa-eye pass-eye" onclick="togglePass()"></i></div>
            
            <div class="input-group">
                <i class="fas fa-gift icon" style="color:#D97706;"></i>
                <input type="text" id="referralCode" placeholder="C√≥digo de Indica√ß√£o (Opcional)" style="border: 1px dashed #D97706; background: rgba(251, 191, 36, 0.05);">
            </div>
            
            <button type="submit" class="btn-main" id="btnSubmit">CADASTRAR</button>
            <div class="loader" id="loader"></div>
        </form>
        
        <a href="/login" class="back-link">J√° tem conta? Entrar</a>
    </div>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, updateProfile, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      
      const firebaseConfig = JSON.parse('{{ FIREBASE_CONFIG_FRONTEND | safe }}');

      try {
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);
          const googleProvider = new GoogleAuthProvider();
          
          function getReferralCode() {
              const urlParams = new URLSearchParams(window.location.search);
              const ref = urlParams.get('ref');
              const inputRef = document.getElementById('referralCode').value;
              if (inputRef) return inputRef; 
              if (ref) return ref; 
              return localStorage.getItem('referral_code') || null;
          }
          
          const urlRef = new URLSearchParams(window.location.search).get('ref');
          if (urlRef) { localStorage.setItem('referral_code', urlRef); document.getElementById('referralCode').value = urlRef; }

          const form = document.getElementById('regForm');
          const btn = document.getElementById('btnSubmit');
          const loader = document.getElementById('loader');
          const errorBox = document.getElementById('errorBox');
          const btnGoogle = document.getElementById('btnGoogle');

          // GOOGLE SIGN-IN
          btnGoogle.addEventListener('click', async () => {
              errorBox.style.display = 'none';
              try {
                  const result = await signInWithPopup(auth, googleProvider);
                  
                  // Envia para o backend (que cria o usu√°rio se n√£o existir)
                  const response = await fetch('/auth/firebase_auth', { 
                      method: 'POST', 
                      headers: {'Content-Type': 'application/json'}, 
                      body: JSON.stringify({ 
                          idToken: await result.user.getIdToken(), 
                          nome: result.user.displayName, 
                          email: result.user.email,
                          photoURL: result.user.photoURL,
                          referralCode: getReferralCode(),
                          mode: 'register' // Backend trata cria√ß√£o inteligente
                      }) 
                  });
                  
                  const json = await response.json();
                  if(json.success) window.location.href = json.redirect;
                  else throw new Error(json.message);

              } catch (error) {
                  if (error.code === 'auth/popup-closed-by-user') return;
                  errorBox.innerText = "Erro no Google: " + error.message;
                  errorBox.style.display = 'block';
              }
          });

          // EMAIL/SENHA (Mantido)
          form.addEventListener('submit', async (e) => {
              e.preventDefault();
              errorBox.style.display = 'none';
              const nome = document.getElementById('nome').value;
              const whatsapp = document.getElementById('whatsapp').value;
              const email = document.getElementById('email').value;
              const emailConfirm = document.getElementById('email_confirm').value;
              const password = document.getElementById('senha').value;

              if (email !== emailConfirm) { errorBox.innerText = "Os e-mails n√£o conferem."; errorBox.style.display = 'block'; return; }

              btn.style.display = 'none'; loader.style.display = 'block';

              try {
                  const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                  const user = userCredential.user;
                  await updateProfile(user, { displayName: nome });
                  
                  const response = await fetch('/auth/firebase_auth', { 
                      method: 'POST', 
                      headers: {'Content-Type': 'application/json'}, 
                      body: JSON.stringify({ 
                          idToken: await user.getIdToken(), 
                          nome: nome, 
                          whatsapp: whatsapp, 
                          mode: 'register', 
                          referralCode: getReferralCode() 
                      }) 
                  });
                  
                  const result = await response.json();
                  if(!result.success) throw new Error(result.message);
                  
                  await sendEmailVerification(user);
                  await signOut(auth);
                  
                  alert('Conta criada! Verifique seu e-mail para ativar.');
                  window.location.href = "/login";
              } catch (error) {
                  let msg = error.message;
                  if(error.code === 'auth/email-already-in-use') msg = 'Este e-mail j√° est√° cadastrado.';
                  if(error.code === 'auth/weak-password') msg = 'A senha deve ter pelo menos 6 caracteres.';
                  errorBox.innerText = "Erro: " + msg; errorBox.style.display = 'block'; btn.style.display = 'block'; loader.style.display = 'none';
              }
          });
          
          window.togglePass = function() { const i = document.getElementById('senha'); i.type = i.type === 'password' ? 'text' : 'password'; }
      } catch (err) {
          console.error(err);
          document.getElementById('errorBox').innerText = "Erro cr√≠tico de inicializa√ß√£o.";
          document.getElementById('errorBox').style.display = 'block';
      }
    </script>
</body>
</html>




==================== FIM ARQUIVO: app/templates/register.html ====================

==================== INICIO ARQUIVO: app/templates/pagamento.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assinatura Vencida - Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: #F4F7FE; padding: 20px; text-align: center; color: #2B3674; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card { background: white; padding: 40px 30px; border-radius: 25px; box-shadow: 0 20px 40px rgba(112, 144, 176, 0.15); max-width: 400px; width: 100%; }
        h2 { margin: 15px 0 10px 0; color: #EE5D50; font-weight: 800; }
        p { color: #707EAE; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        .price { color: #4318FF; font-size: 36px; font-weight: 800; margin: 20px 0 5px 0; }
        .pix-box { background: #F9F9FC; padding: 15px; border-radius: 15px; font-family: monospace; font-weight: bold; border: 1px dashed #A3AED0; word-break: break-all; margin-bottom: 20px; color: #2B3674; }
        .btn { background: #05CD99; color: white; padding: 18px; border-radius: 18px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 700; box-shadow: 0 10px 20px -5px rgba(5, 205, 153, 0.4); transition: transform 0.2s; }
        .btn:active { transform: scale(0.98); }
        .logout { margin-top: 20px; display: inline-block; color: #A3AED0; text-decoration: none; font-size: 13px; }
        .impact-text { color: #05CD99; font-weight: bold; font-size: 14px; margin-bottom: 20px; display: block; }
    </style>
</head>
<body>
    <div class="card">
        <div style="background: rgba(238, 93, 80, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
            <i class="fas fa-lock" style="font-size: 35px; color: #EE5D50;"></i>
        </div>
        
        <h2>Acesso Bloqueado</h2>
        <p>Ol√° <b>{{ nome }}</b>, seus 7 dias de teste gratuito acabaram em <b>{{ validade }}</b>.</p>
        <p>N√£o perca o controle do seu lucro real! Continue gerenciando suas finan√ßas.</p>
        
        <div class="price">R$ 19,90 <small style="font-size:14px; color:#A3AED0; font-weight:600;">/m√™s</small></div>
        <span class="impact-text">Isso √© apenas R$ 0,66 por dia! ‚òï</span>
        
        <p style="font-size: 12px; margin-bottom: 5px; font-weight: 600;">Minha Chave PIX:</p>
        
        <div class="pix-box">
            appmotoristapro@gmail.com
        </div>
        
        <a href="https://wa.me/5511991167709?text=Ola,%20paguei%20o%20MotoristaPRO.%20Meu%20email%20de%20cadastro%20eh:%20{{ current_user.email }}" class="btn" target="_blank">
            <i class="fab fa-whatsapp" style="font-size: 20px;"></i> Enviar Comprovante
        </a>
        
        <a href="/logout" class="logout"><i class="fas fa-sign-out-alt"></i> Sair da conta</a>
    </div>
</body>
</html>



==================== FIM ARQUIVO: app/templates/pagamento.html ====================

==================== INICIO ARQUIVO: app/templates/bem_vindo.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Bem-vindo ao Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2563EB; --primary-dark: #1D4ED8; --bg-body: #F0F4F8; --text: #0F172A; --text-secondary: #64748B; --glass-white: rgba(255,255,255,0.95); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        
        /* Fundo Animado */
        .blob { position: fixed; border-radius: 50%; filter: blur(80px); z-index: -1; opacity: 0.6; }
        .blob-1 { top: -10%; left: -20%; width: 400px; height: 400px; background: #BFDBFE; animation: float 8s infinite alternate; }
        .blob-2 { bottom: -10%; right: -20%; width: 350px; height: 350px; background: #C7D2FE; animation: float 10s infinite alternate-reverse; }
        @keyframes float { from { transform: translate(0,0); } to { transform: translate(20px, 40px); } }

        .welcome-card { 
            background: var(--glass-white); border-radius: 40px; padding: 50px 30px; 
            box-shadow: 0 30px 70px rgba(37, 99, 235, 0.15); text-align: center; 
            width: 100%; max-width: 400px; position: relative; 
            border: 1px solid rgba(255,255,255,0.8); backdrop-filter: blur(20px);
            animation: popUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes popUp { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        /* √çcone Melhorado */
        .icon-container {
            width: 90px; height: 90px; margin: 0 auto 25px auto;
            background: white; border-radius: 22px; padding: 10px;
            box-shadow: 0 15px 35px rgba(37, 99, 235, 0.2);
            display: flex; align-items: center; justify-content: center;
            transform: rotate(-5deg); transition: transform 0.3s;
        }
        .icon-container:hover { transform: rotate(0deg) scale(1.05); }
        .app-icon { width: 100%; height: 100%; object-fit: cover; border-radius: 14px; }

        h1 { margin: 0 0 10px 0; font-size: 26px; font-weight: 800; color: var(--text); letter-spacing: -0.5px; }
        p.subtitle { margin: 0 auto; font-size: 15px; color: var(--text-secondary); line-height: 1.6; max-width: 280px; font-weight: 500; }

        .divider { width: 40px; height: 4px; background: #E2E8F0; margin: 25px auto; border-radius: 2px; }

        .features-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-bottom: 40px; }
        .f-card { background: #F8FAFC; border-radius: 20px; padding: 15px; border: 1px solid rgba(0,0,0,0.03); transition: transform 0.2s; }
        .f-card:hover { transform: translateY(-3px); }
        .f-icon { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; margin-bottom: 10px; }
        .f-title { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 2px; display: block; }
        .f-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.2; display: block; }

        .ic-profit { background: rgba(16, 185, 129, 0.1); color: #10B981; }
        .ic-maint { background: rgba(245, 158, 11, 0.1); color: #F59E0B; }
        .ic-doc { background: rgba(37, 99, 235, 0.1); color: #2563EB; }
        .ic-goal { background: rgba(139, 92, 246, 0.1); color: #8B5CF6; }

        .btn-start { 
            background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); 
            color: white; width: 100%; padding: 20px; border-radius: 20px; 
            font-weight: 800; font-size: 16px; border: none; cursor: pointer; 
            box-shadow: 0 15px 40px rgba(37, 99, 235, 0.4); 
            display: flex; align-items: center; justify-content: center; gap: 10px; 
            transition: transform 0.1s;
        }
        .btn-start:active { transform: scale(0.97); }
        
        .version { margin-top: 20px; font-size: 11px; color: #CBD5E1; font-weight: 600; }
    </style>
</head>
<body>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="welcome-card">
        <div class="icon-container">
            <img src="/static/icons/icon-192.png" class="app-icon" alt="Motorista Pro" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1048/1048314.png'">
        </div>
        
        <h1>Ol√°, {{ nome.split()[0] }}!</h1>
        <p class="subtitle">O seu copiloto financeiro foi atualizado. Assuma o controle total dos seus ganhos.</p>
        
        <div class="divider"></div>
        
        <div class="features-grid">
            <div class="f-card">
                <div class="f-icon ic-profit"><i class="fas fa-chart-pie"></i></div>
                <span class="f-title">Lucro Real</span>
                <span class="f-desc">Descontos de desgaste.</span>
            </div>
            <div class="f-card">
                <div class="f-icon ic-maint"><i class="fas fa-wrench"></i></div>
                <span class="f-title">Manuten√ß√£o</span>
                <span class="f-desc">Alertas de troca.</span>
            </div>
            <div class="f-card">
                <div class="f-icon ic-doc"><i class="fas fa-file-invoice"></i></div>
                <span class="f-title">Recibos PDF</span>
                <span class="f-desc">Para particulares.</span>
            </div>
            <div class="f-card">
                <div class="f-icon ic-goal"><i class="fas fa-bullseye"></i></div>
                <span class="f-title">Metas</span>
                <span class="f-desc">Objetivo di√°rio.</span>
            </div>
        </div>

        <button onclick="startApp()" class="btn-start" id="btnStart">
            COME√áAR AGORA <i class="fas fa-arrow-right"></i>
        </button>
        
        <div class="version">Vers√£o {{ current_version if current_version else '13.1' }}</div>
    </div>

    <script>
        function startApp() {
            const btn = document.getElementById('btnStart');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparando motor...'; btn.style.opacity = '0.9';
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Timeout de seguran√ßa caso o fetch falhe
            setTimeout(() => { window.location.href = '/?start_tour=true'; }, 3000);
            
            fetch('/concluir_onboarding', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken } 
            })
            .then(() => { window.location.href = '/?start_tour=true'; })
            .catch(() => { window.location.href = '/?start_tour=true'; });
        }
    </script>
</body>
</html>




==================== FIM ARQUIVO: app/templates/bem_vindo.html ====================

==================== INICIO ARQUIVO: app/templates/admin_login.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso Restrito - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #111C44; color: white; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { background: #1B254B; padding: 30px; border-radius: 15px; width: 300px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 15px 0; border: none; border-radius: 5px; box-sizing: border-box; }
        button { background: #4318FF; color: white; width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .error { color: #EE5D50; margin-bottom: 10px; font-size: 13px; background: rgba(238, 93, 80, 0.1); padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>√Årea Administrativa</h2>
        {% if erro %}<div class="error">{{ erro }}</div>{% endif %}
        
        <form method="POST">
            <!-- TOKEN CSRF VITAL -->
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <input type="password" name="senha" placeholder="Senha Mestra" required>
            <button type="submit">ACESSAR SISTEMA</button>
        </form>
    </div>
</body>
</html>



==================== FIM ARQUIVO: app/templates/admin_login.html ====================

==================== INICIO ARQUIVO: app/templates/admin.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Operacional</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4318FF; --primary-dark: #2B0EBF; --secondary: #A3AED0; --success: #05CD99; --warning: #FFB547; --danger: #EE5D50; --bg-body: #F4F7FE; --card-white: #FFFFFF; --text-dark: #2B3674; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-body); color: var(--text-dark); margin: 0; padding: 20px; padding-bottom: 80px; }
        
        .text-trial { color: var(--primary) !important; }
        .text-subscriber { color: var(--success) !important; }
        .text-expired { color: var(--danger) !important; }

        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-left h1 { margin: 0; font-size: 24px; font-weight: 700; background: linear-gradient(90deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-left p { margin: 0; font-size: 12px; color: var(--secondary); }
        .btn-exit { background: rgba(238, 93, 80, 0.1); color: var(--danger); border: none; padding: 10px 15px; border-radius: 12px; font-weight: 600; font-size: 13px; text-decoration: none; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card-white); padding: 15px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .stat-info h3 { margin: 0; font-size: 20px; font-weight: 700; }
        .stat-info span { font-size: 11px; color: var(--secondary); font-weight: 500; }

        .filter-nav { display: flex; background: white; padding: 5px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); overflow-x: auto; }
        .filter-btn { flex: 1; text-align: center; padding: 10px; border-radius: 10px; text-decoration: none; font-size: 12px; font-weight: 700; color: var(--secondary); transition: 0.2s; white-space: nowrap; }
        .filter-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(67, 24, 255, 0.3); }

        .tools-section { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 25px; scrollbar-width: none; }
        .tool-btn { background: var(--card-white); padding: 12px 20px; border-radius: 15px; font-size: 13px; font-weight: 600; color: var(--primary); text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.02); display: flex; align-items: center; gap: 8px; border: 1px solid transparent; white-space: nowrap; cursor: pointer; }
        
        .search-container { position: relative; margin-bottom: 25px; }
        .search-container input { width: 100%; padding: 16px 20px 16px 50px; border-radius: 20px; border: none; background: var(--card-white); box-shadow: 0 5px 20px rgba(0,0,0,0.03); font-family: inherit; font-size: 14px; outline: none; }
        .search-container i { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: var(--primary); }

        .section-title { font-size: 14px; font-weight: 700; color: var(--secondary); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        
        .user-card { background: var(--card-white); border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); overflow: hidden; }
        summary { list-style: none; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        summary::-webkit-details-marker { display: none; }
        
        .u-profile { display: flex; align-items: center; gap: 15px; }
        .u-avatar { width: 45px; height: 45px; background: #E9EDF7; color: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; }
        .u-meta h4 { margin: 0; font-size: 15px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .u-meta p { margin: 2px 0 0 0; font-size: 12px; color: var(--secondary); }
        
        /* BADGES */
        .u-status-badge { font-size: 10px; font-weight: 700; padding: 5px 12px; border-radius: 20px; text-transform: uppercase; }
        .badge-premium { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .badge-basic { background: #94A3B8; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        
        .u-expanded { padding: 0 20px 20px 20px; border-top: 1px dashed #F0F3F9; background: #FAFCFE; }
        .action-group { margin-top: 15px; }
        .action-label { font-size: 11px; font-weight: 700; color: var(--secondary); display: block; margin-bottom: 8px; }
        .renewal-grid { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-renov { flex: 1; min-width: 60px; border: 1px solid var(--primary); background: transparent; color: var(--primary); padding: 8px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-renov:hover { background: var(--primary); color: white; }
        
        .tools-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .btn-action { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; border-radius: 12px; border: none; color: white; font-size: 11px; font-weight: 600; text-decoration: none; gap: 5px; cursor: pointer; }
        
        .danger-zone { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #e0e0e0; }
        
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-card { background: white; width: 90%; max-width: 350px; padding: 30px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="admin-header">
        <div class="header-left"><h1>Controle Master</h1><p>Gest√£o de Usu√°rios</p></div>
        <a href="/admin/logout" class="btn-exit"><i class="fas fa-sign-out-alt"></i> Sair</a>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon" style="background: rgba(5, 205, 153, 0.1); color: var(--success);"><i class="fas fa-user-check"></i></div><div class="stat-info"><h3>{{ stats.ativos }}</h3><span>Assinantes</span></div></div>
        <div class="stat-card"><div class="stat-icon" style="background: rgba(238, 93, 80, 0.1); color: var(--danger);"><i class="fas fa-user-times"></i></div><div class="stat-info"><h3>{{ stats.vencidos }}</h3><span>Vencidos</span></div></div>
        <div class="stat-card"><div class="stat-icon" style="background: rgba(67, 24, 255, 0.1); color: var(--primary);"><i class="fas fa-clock"></i></div><div class="stat-info"><h3>{{ stats.trial }}</h3><span>Trial</span></div></div>
        <div class="stat-card"><div class="stat-icon" style="background: #F4F7FE; color: var(--secondary);"><i class="fas fa-users"></i></div><div class="stat-info"><h3>{{ stats.total }}</h3><span>Total</span></div></div>
    </div>

    <div class="filter-nav">
        <a href="/admin/dashboard" class="filter-btn {{ 'active' if not filtro_atual }}">Todos</a>
        <a href="/admin/dashboard?filtro=subscriber" class="filter-btn {{ 'active' if filtro_atual == 'subscriber' }}">Assinantes</a>
        <a href="/admin/dashboard?filtro=trial" class="filter-btn {{ 'active' if filtro_atual == 'trial' }}">Trial</a>
        <a href="/admin/dashboard?filtro=expired" class="filter-btn {{ 'active' if filtro_atual == 'expired' }}">Vencidos</a>
    </div>

    <div class="tools-section">
        <a href="/admin/business" class="tool-btn" style="color:var(--text-dark); border-color:var(--secondary);">
            <i class="fas fa-chart-pie"></i> Business Intelligence
        </a>
        <a href="/admin/rodar_testes" class="tool-btn" style="color:var(--success); border-color:var(--success);">
            <i class="fas fa-stethoscope"></i> Executar Diagn√≥stico
        </a>
        <a href="#" onclick="openNotifyAll()" class="tool-btn" style="background:var(--primary); color:white;"><i class="fas fa-bullhorn"></i> Notificar</a>
        <a href="/admin/suporte" class="tool-btn"><i class="fas fa-headset"></i> Suporte</a>
        <a href="/admin/backup/global" class="tool-btn"><i class="fas fa-cloud-download-alt"></i> Backup</a>
        
        <form action="/admin/restore/global" method="POST" enctype="multipart/form-data" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <label class="tool-btn" style="cursor:pointer; color:var(--warning); border-color:var(--warning);">
                <i class="fas fa-upload"></i> Restaurar ZIP
                <input type="file" name="file" accept=".zip" style="display:none;" onchange="if(confirm('Substituir dados?')) this.form.submit()">
            </label>
        </form>
    </div>

    <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Pesquisar motorista...">
    </div>

    <div class="section-title">Resultados ({{ users|length }})</div>

    <div id="userList">
        {% for u in users %}
        <details class="user-card user-item">
            <summary>
                <div class="u-profile">
                    <div class="u-avatar">{{ u.nome[:1] }}</div>
                    <div class="u-meta">
                        <h4 class="{{ u.label_class }}">
                            {{ u.nome }}
                            <!-- BADGE DE PLANO -->
                            {% if u.plan_type == 'premium' %}
                                <span class="badge-premium">PRO</span>
                            {% elif u.plan_type == 'basic' %}
                                <span class="badge-basic">BASIC</span>
                            {% endif %}
                        </h4>
                        <p>{{ u.email }}</p>
                    </div>
                </div>
                <div class="u-status-badge" style="background:#eee; color:#555;">{% if u.dias_restantes >= 0 %}{{ u.dias_restantes }} dias{% else %}Venceu{% endif %}</div>
            </summary>
            <div class="u-expanded">
                <div class="action-group">
                    <span class="action-label">Renova√ß√£o</span>
                    <form action="/admin/renovar/{{ u.id }}" method="POST" class="renewal-grid">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" name="dias" value="30" class="btn-renov">+30d</button>
                        <button type="submit" name="dias" value="15" class="btn-renov">+15d</button>
                        <button type="submit" name="dias" value="7" class="btn-renov">+7d</button>
                        <button type="submit" name="dias" value="1" class="btn-renov" style="border-color:var(--warning); color:var(--warning); border-style: dashed;">+1d</button>
                    </form>
                </div>
                
                <div class="action-group">
                    <span class="action-label">Classifica√ß√£o</span>
                    <div style="display:flex; gap:5px;">
                        <a href="/admin/set_category/{{ u.id }}/trial" class="btn-renov" style="text-align:center; text-decoration:none; {{ 'background:#E6E6FA' if u.category == 'trial' }}">Trial</a>
                        <a href="/admin/set_category/{{ u.id }}/subscriber" class="btn-renov" style="text-align:center; text-decoration:none; {{ 'background:#E6E6FA' if u.category == 'subscriber' }}">Assinante</a>
                    </div>
                </div>
                
                <div class="action-group">
                    <div class="tools-grid">
                        {% if u.whatsapp %}<a href="https://wa.me/55{{ u.whatsapp | clean_phone }}" target="_blank" class="btn-action" style="background:#25D366"><i class="fab fa-whatsapp"></i></a>{% endif %}
                        <a href="#" onclick="notificar('{{ u.id }}', '{{ u.nome }}')" class="btn-action" style="background:var(--primary)"><i class="fas fa-envelope"></i></a>
                        <a href="#" onclick="gerarSenha('{{ u.id }}')" class="btn-action" style="background:var(--warning); color:black;"><i class="fas fa-key"></i></a>
                    </div>
                </div>
                
                <div class="danger-zone" style="margin-top:10px; border-top:1px dashed #eee; padding-top:10px; display:flex; gap:10px;">
                    <button onclick="zerar('{{ u.id }}')" style="flex:1; background:transparent; border:1px solid #ddd; color:#555; padding:5px; border-radius:5px;">Bloquear</button>
                    <a href="/admin/deletar/{{ u.id }}" onclick="return confirm('Excluir?')" style="flex:1; text-align:center; background:rgba(238,93,80,0.1); color:var(--danger); padding:5px; border-radius:5px; text-decoration:none;">Excluir</a>
                </div>
            </div>
        </details>
        {% endfor %}
    </div>

    <!-- MODAL -->
    <div id="notifyModal" class="modal">
        <div class="modal-card">
            <h3>Notificar</h3>
            <p id="targetName" style="color:#aaa; font-size:12px;">...</p>
            <form action="/admin/notify" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="user_id" id="targetId">
                <textarea name="mensagem" rows="3" style="width:100%; margin:10px 0; border:1px solid #ddd; padding:10px; border-radius:10px;" required></textarea>
                <div style="display:flex; gap:10px;">
                    <button type="button" onclick="document.getElementById('notifyModal').style.display='none'" style="flex:1; padding:12px; border-radius:12px; border:none; background:#f0f0f0; cursor:pointer;">Cancelar</button>
                    <button type="submit" style="flex:1; padding:12px; border-radius:12px; border:none; background:var(--primary); color:white; font-weight:bold; cursor:pointer;">Enviar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.getElementById('searchInput').addEventListener('keyup', function() { let filter = this.value.toLowerCase(); document.querySelectorAll('.user-item').forEach(item => { item.style.display = item.innerText.toLowerCase().includes(filter) ? 'block' : 'none'; }); });
        function openNotifyAll() { document.getElementById('targetId').value = ''; document.getElementById('targetName').innerText = 'TODOS'; document.getElementById('notifyModal').style.display = 'flex'; }
        function notificar(id, nome) { document.getElementById('targetId').value = id; document.getElementById('targetName').innerText = nome; document.getElementById('notifyModal').style.display = 'flex'; }
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        function zerar(id) { if(confirm("Bloquear?")) fetch('/admin/zerar/'+id, { method:'POST', headers: { 'X-CSRFToken': csrfToken } }).then(() => window.location.reload()); }
        function gerarSenha(id) { if(confirm("Senha tempor√°ria?")) fetch('/admin/temp_password/'+id, { method:'POST', headers: { 'X-CSRFToken': csrfToken } }).then(r => r.text()).then(t => prompt("Senha:", t)); }
    </script>
</body>
</html>



==================== FIM ARQUIVO: app/templates/admin.html ====================

==================== INICIO ARQUIVO: app/templates/assinatura.html ====================
{% extends 'base.html' %}

{% block content %}
<div class="header fade-in">
    <a href="/configuracoes" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Meu Plano</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Status da Conta</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">

    <!-- CARD STATUS -->
    <div class="glass-card" style="text-align:center; padding:35px 20px;">
        <div style="width:80px; height:80px; background:{{ 'rgba(16, 185, 129, 0.1)' if dias > 0 else 'rgba(239, 68, 68, 0.1)' }}; color:{{ 'var(--success)' if dias > 0 else 'var(--danger)' }}; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:35px; margin-bottom:20px; box-shadow:var(--glass-shadow);">
            <i class="fas {{ 'fa-check-circle' if dias > 0 else 'fa-times-circle' }}"></i>
        </div>
        
        <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:24px; font-weight:800;">
            {{ 'Premium Ativo' if dias > 0 else 'Plano Expirado' }}
        </h3>
        
        <p style="margin:0; font-size:14px; color:var(--text-secondary); line-height:1.5; max-width:250px; margin:0 auto;">
            {% if dias > 0 %}
                Voc√™ √© um motorista de elite.
            {% else %}
                Renove para recuperar o controle.
            {% endif %}
        </p>
    </div>

    <!-- LISTA DE BENEF√çCIOS (STATUS) -->
    <div class="glass-card">
        <div class="card-title"><span>Recursos do Plano</span></div>
        
        <!-- MONITORAMENTO DIN√ÇMICO (DESTAQUE) -->
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px dashed rgba(0,0,0,0.05);">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:30px; height:30px; background:rgba(37,99,235,0.1); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--primary);"><i class="fas fa-robot"></i></div>
                <span style="font-size:13px; font-weight:700; color:var(--text-main);">Monitoramento Din√¢mico</span>
            </div>
            {% if current_user.plan_type == 'premium' and dias > 0 %}
                <span style="font-size:10px; font-weight:800; color:#10B981; background:rgba(16,185,129,0.1); padding:4px 8px; border-radius:6px;">ATIVO</span>
            {% else %}
                <span style="font-size:10px; font-weight:800; color:#F59E0B; background:rgba(245,158,11,0.1); padding:4px 8px; border-radius:6px;"><i class="fas fa-lock"></i> PREMIUM</span>
            {% endif %}
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px dashed rgba(0,0,0,0.05);">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:30px; height:30px; background:rgba(37,99,235,0.1); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--primary);"><i class="fas fa-chart-line"></i></div>
                <span style="font-size:13px; font-weight:600; color:var(--text-main);">Lucro Real (+ Custos)</span>
            </div>
            {% if current_user.plan_type == 'premium' and dias > 0 %}
                <i class="fas fa-check" style="color:#10B981; font-size:12px;"></i>
            {% else %}
                <i class="fas fa-lock" style="color:#ccc; font-size:12px;"></i>
            {% endif %}
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 0;">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:30px; height:30px; background:rgba(37,99,235,0.1); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--primary);"><i class="fas fa-file-pdf"></i></div>
                <span style="font-size:13px; font-weight:600; color:var(--text-main);">Recibos & Relat√≥rios PDF</span>
            </div>
            {% if current_user.plan_type == 'premium' and dias > 0 %}
                <i class="fas fa-check" style="color:#10B981; font-size:12px;"></i>
            {% else %}
                <i class="fas fa-lock" style="color:#ccc; font-size:12px;"></i>
            {% endif %}
        </div>
    </div>

    <div class="glass-card">
        <div class="card-title"><span>Detalhes</span></div>
        <div style="display:flex; justify-content:space-between; padding:10px 0; font-size:13px;">
            <span style="color:var(--text-secondary);">Vencimento</span>
            <span style="font-weight:700; color:var(--text-main);">{{ validade if validade else '--/--/----' }}</span>
        </div>
        <div style="display:flex; justify-content:space-between; padding:10px 0; font-size:13px;">
            <span style="color:var(--text-secondary);">Dias Restantes</span>
            <span style="font-weight:700; color:{{ 'var(--success)' if dias > 5 else 'var(--danger)' }};">{{ dias }} dias</span>
        </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:15px;">
        <a href="{{ url_for('payments.assinar') }}" class="btn" style="border-radius: 50px; padding: 18px; font-size: 16px; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);">
            <i class="fas fa-sync-alt"></i> Renovar Assinatura
        </a>
        
        <button onclick="manageSubscription()" class="btn" style="background:var(--glass-bg); color:var(--text-main); border:1px solid rgba(0,0,0,0.05); box-shadow:var(--glass-shadow); border-radius: 50px;">
            <i class="fas fa-credit-card"></i> Gerenciar Pagamento
        </button>
    </div>

</div>

<script>
    function manageSubscription() {
        const method = "{{ current_user.payment_method }}";
        if (method === 'pix' || method === 'manual') {
            alert("Assinaturas PIX n√£o possuem renova√ß√£o autom√°tica. Basta fazer um novo pagamento quando vencer.");
        } else {
            window.location.href = "{{ url_for('payments.gerenciar') }}";
        }
    }
</script>
{% endblock %}

==================== FIM ARQUIVO: app/templates/assinatura.html ====================

==================== INICIO ARQUIVO: app/templates/recibo.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recibo - Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root { --bg-body: #F0F4F8; --primary: #2563EB; --text-main: #0F172A; --text-secondary: #64748B; --glass-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; justify-content: center; }
        
        /* CARD PRINCIPAL */
        .receipt-card { 
            background: white; width: 100%; max-width: 340px; padding: 30px 25px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); position: relative; 
            border-radius: 20px; margin-bottom: 30px; 
            /* Fundo decorativo sutil nas bordas */
            background-image: radial-gradient(circle at top left, transparent 15px, white 15px), radial-gradient(circle at top right, transparent 15px, white 15px); 
            background-size: 51% 100%; background-repeat: no-repeat; background-position: left top, right top; 
            padding-top: 40px; overflow: hidden; /* Garante que a marca d'√°gua n√£o saia */
        }

        /* --- MARCA D'√ÅGUA --- */
        .watermark {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            opacity: 0.05; /* Bem sutil para n√£o atrapalhar leitura */
            z-index: 0;
            text-align: center;
            width: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .wm-logo { width: 180px; height: 180px; margin-bottom: 10px; filter: grayscale(100%); }
        .wm-text { font-size: 26px; font-weight: 900; color: #000; text-transform: uppercase; letter-spacing: 2px; white-space: nowrap; }

        /* CONTE√öDO (Z-INDEX PARA FICAR ACIMA DA MARCA) */
        .receipt-header, .receipt-row, .divider, .footer-msg { position: relative; z-index: 10; }

        .receipt-header { text-align: center; margin-bottom: 30px; border-bottom: 2px dashed #eee; padding-bottom: 20px; }
        .receipt-logo { font-size: 30px; color: var(--primary); margin-bottom: 10px; }
        .receipt-title { font-size: 12px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 2px; }
        .receipt-val { font-size: 48px; font-weight: 800; color: var(--text-main); margin: 10px 0; letter-spacing: -2px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; }
        .receipt-label { color: var(--text-secondary); font-weight: 600; font-size: 11px; text-transform: uppercase; }
        .receipt-data { font-weight: 700; color: var(--text-main); text-align: right; }
        .divider { border-top: 2px dashed #eee; margin: 20px 0; }
        .footer-msg { text-align: center; margin-top: 30px; font-size: 10px; color: #ccc; font-weight: 500; }
        
        .btn-share { background: #10B981; color: white; padding: 18px 40px; border-radius: 50px; text-decoration: none; font-weight: 800; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4); display: flex; align-items: center; gap: 10px; cursor: pointer; border: none; font-size: 16px; transition: transform 0.2s; }
        .btn-share:active { transform: scale(0.95); }
        .btn-locked { background: #64748B; color: white; padding: 18px 40px; border-radius: 50px; font-weight: 800; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; cursor: pointer; border: none; font-size: 16px; }
        .btn-back { position: absolute; top: 20px; left: 20px; width: 40px; height: 40px; border-radius: 12px; background: white; display: flex; align-items: center; justify-content: center; color: var(--text-main); text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        #loadingOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:200; justify-content:center; align-items:center; flex-direction:column; }
        #upsellModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .upsell-card { width:90%; max-width:350px; text-align:center; padding:30px; background: white; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popUp 0.3s; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <a href="/agenda" class="btn-back"><i class="fas fa-arrow-left"></i></a>

    <div id="loadingOverlay">
        <div style="font-size:30px; margin-bottom:10px; color:var(--primary);"><i class="fas fa-spinner fa-spin"></i></div>
        <div style="font-weight:800; color:var(--text-main);">Gerando Imagem...</div>
    </div>
    
    <div id="upsellModal">
        <div class="upsell-card">
            <button class="close-modal" onclick="closeUpsell()">&times;</button>
            <div style="width:70px; height:70px; background:rgba(37,99,235,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto; color:var(--primary); font-size:30px;"><i class="fas fa-crown"></i></div>
            <h3 style="margin:0 0 10px 0; color:var(--text-main); font-size:20px; font-weight:800;">Envie Recibos Profissionais</h3>
            <p style="font-size:14px; color:var(--text-secondary); margin-bottom:25px; line-height:1.5;">O recibo foi gerado, mas o envio profissional √© exclusivo do plano Premium. Passe confian√ßa aos seus passageiros!</p>
            <a href="/assinar" class="btn-share" style="background:var(--primary); box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4); justify-content:center;">Quero ser Profissional</a>
        </div>
    </div>
    
    <div class="receipt-card" id="receiptArea">
        <!-- MARCA D'√ÅGUA -->
        <div class="watermark">
            <img src="/static/icons/icon-512.png" alt="Logo" class="wm-logo">
            <div class="wm-text">MOTORISTA PRO</div>
        </div>

        <div class="receipt-header">
            <div class="receipt-logo"><i class="fas fa-check-circle"></i></div>
            <div class="receipt-title">Comprovante de Pagamento</div>
            <div class="receipt-val">R$ {{ data.valor }}</div>
            <div style="font-size:11px; background:#F0FDF4; color:#15803D; padding:4px 10px; border-radius:20px; display:inline-block; font-weight:700;">PAGAMENTO CONFIRMADO</div>
        </div>
        <div class="receipt-row"><span class="receipt-label">Passageiro</span><span class="receipt-data">{{ data.cliente }}</span></div>
        <div class="receipt-row"><span class="receipt-label">Motorista</span><span class="receipt-data">{{ data.motorista }}</span></div>
        <div class="receipt-row"><span class="receipt-label">Data</span><span class="receipt-data">{{ data.data }}</span></div>
        {% if data.origem %}
        <div class="divider"></div>
        <div class="receipt-row" style="align-items:center;">
            <div style="display:flex; flex-direction:column; gap:2px;"><span class="receipt-label">Origem</span><span style="font-weight:700; font-size:12px;">{{ data.origem }}</span></div>
            <i class="fas fa-arrow-right" style="color:#ccc; font-size:10px;"></i>
            <div style="display:flex; flex-direction:column; gap:2px; text-align:right;"><span class="receipt-label">Destino</span><span style="font-weight:700; font-size:12px;">{{ data.destino }}</span></div>
        </div>
        {% endif %}
        <div class="footer-msg">Emitido via Motorista Pro App</div>
    </div>

    {% if current_user.plan_type == 'basic' %}
        <button onclick="openUpsell()" class="btn-locked"><i class="fas fa-lock"></i> Partilhar Imagem</button>
    {% else %}
        <button onclick="shareImage()" class="btn-share"><i class="fas fa-share-alt"></i> Partilhar Imagem</button>
    {% endif %}
    
    <script>
        function openUpsell() { document.getElementById('upsellModal').style.display = 'flex'; }
        function closeUpsell() { document.getElementById('upsellModal').style.display = 'none'; }
        function shareImage() {
            const element = document.getElementById('receiptArea');
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';
            html2canvas(element, { scale: 3, useCORS: true, backgroundColor: null }).then(canvas => {
                canvas.toBlob(async blob => {
                    overlay.style.display = 'none';
                    if (navigator.share) {
                        const file = new File([blob], "recibo_corrida.png", { type: "image/png" });
                        try { await navigator.share({ files: [file], title: 'Recibo de Corrida', text: 'Aqui est√° o comprovante da sua viagem.' }); } catch (err) { console.log(err); }
                    } else {
                        const link = document.createElement('a'); link.download = 'recibo.png'; link.href = canvas.toDataURL(); link.click();
                    }
                });
            });
        }
    </script>
</body>
</html>



==================== FIM ARQUIVO: app/templates/recibo.html ====================

==================== INICIO ARQUIVO: app/templates/esqueci_senha.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Senha</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style> 
        :root { --bg-body: #F0F4F8; --text-main: #0F172A; --text-secondary: #64748B; --primary-gradient: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); --glass-bg: rgba(255, 255, 255, 0.85); --glass-border: 1px solid rgba(255, 255, 255, 0.9); --glass-shadow: 0 8px 32px 0 rgba(30, 58, 138, 0.08); }
        body { margin: 0; padding: 20px; font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .blob { position: fixed; border-radius: 50%; filter: blur(90px); z-index: -1; opacity: 0.5; }
        .blob-1 { top: -10%; left: -20%; width: 400px; height: 400px; background: #BFDBFE; }
        
        .card { background: var(--glass-bg); backdrop-filter: blur(20px); border: var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 30px; padding: 40px 30px; width: 100%; max-width: 380px; text-align: center; }
        
        .icon-circle { width: 60px; height: 60px; background: rgba(37, 99, 235, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto; color: #2563EB; font-size: 24px; }
        
        h2 { margin: 0 0 10px 0; font-size: 22px; font-weight: 800; }
        p { color: var(--text-secondary); font-size: 13px; margin-bottom: 30px; line-height: 1.5; }
        
        .input-group { position: relative; margin-bottom: 15px; text-align: left; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        input { width: 100%; padding: 16px 15px 16px 45px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); color: var(--text-main); font-family: inherit; font-size: 14px; box-sizing: border-box; outline: none; }
        
        .btn-main { background: var(--primary-gradient); border: none; width: 100%; padding: 16px; border-radius: 16px; color: white; font-weight: 800; font-size: 15px; cursor: pointer; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); transition: transform 0.2s; }
        .btn-main:active { transform: scale(0.97); }
        
        #msgBox { padding:12px; border-radius:12px; font-size:13px; margin-bottom:15px; font-weight:600; display:none; }
        .loader { display: none; margin: 10px auto; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #2563EB; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .back-link { display: block; margin-top: 25px; color: var(--text-secondary); text-decoration: none; font-size: 13px; font-weight: 600; }
    </style>
</head>
<body>
    <div class="blob blob-1"></div>

    <div class="card">
        <div class="icon-circle"><i class="fas fa-unlock-alt"></i></div>
        <h2>Recuperar Acesso</h2>
        <p>Informe o seu e-mail. Enviaremos um link para voc√™ redefinir sua senha.</p>
        
        <div id="msgBox"></div>

        <form id="resetForm">
            <div class="input-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="emailInput" placeholder="Seu E-mail" required>
            </div>
            
            <button type="submit" class="btn-main" id="btnSubmit">ENVIAR LINK</button>
            <div class="loader" id="loader"></div>
        </form>

        <a href="/login" class="back-link">Voltar para Login</a>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      const firebaseConfig = { apiKey: "AIzaSyAn_FPF2jSH2jFR9MAG6Xo9mXmodTsQCpA", authDomain: "motoristapro-f9beb.firebaseapp.com", projectId: "motoristapro-f9beb", storageBucket: "motoristapro-f9beb.firebasestorage.app", messagingSenderId: "990151984574", appId: "1:990151984574:web:82bd63cc391c372ea9a5ef" };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const form = document.getElementById('resetForm');
      const btn = document.getElementById('btnSubmit');
      const loader = document.getElementById('loader');
      const msgBox = document.getElementById('msgBox');

      form.addEventListener('submit', async (e) => {
          e.preventDefault();
          msgBox.style.display = 'none'; btn.style.display = 'none'; loader.style.display = 'block';
          const email = document.getElementById('emailInput').value;
          try {
              await sendPasswordResetEmail(auth, email);
              msgBox.innerText = "Sucesso! Verifique seu e-mail.";
              msgBox.style.background = "rgba(16, 185, 129, 0.1)"; msgBox.style.color = "#059669"; msgBox.style.border = "1px solid #10B981"; msgBox.style.display = "block";
              document.getElementById('emailInput').value = "";
          } catch (error) {
              let msg = "Erro ao enviar e-mail.";
              if(error.code === 'auth/user-not-found') msg = "E-mail n√£o encontrado.";
              msgBox.innerText = msg;
              msgBox.style.background = "#FEF2F2"; msgBox.style.color = "#DC2626"; msgBox.style.border = "1px solid #FCA5A5"; msgBox.style.display = "block";
          } finally { btn.style.display = 'block'; loader.style.display = 'none'; }
      });
    </script>
</body>
</html>



==================== FIM ARQUIVO: app/templates/esqueci_senha.html ====================

==================== INICIO ARQUIVO: app/templates/termos.html ====================
{% extends 'base.html' %}

{% block content %}
<div class="header fade-in">
    {% if current_user.is_authenticated %}
        <a href="/configuracoes" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    {% else %}
        <a href="/" class="back-btn"><i class="fas fa-home"></i></a>
    {% endif %}
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Termos de Uso</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">& Pol√≠tica de Privacidade</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 50px; animation-delay: 0.1s;">
    
    <div class="glass-card" style="text-align: left;">
        <p style="font-size:11px; color:var(--text-secondary); margin-bottom:20px; text-align:center;">√öltima atualiza√ß√£o: Dezembro de 2025</p>

        <h3 style="color:var(--primary); font-size:15px; margin-top:20px;">1. O Servi√ßo</h3>
        <p style="font-size:13px; color:var(--text-main); line-height:1.6; opacity:0.8;">
            O <strong>Motorista Pro</strong> √© uma ferramenta de gest√£o financeira destinada exclusivamente a motoristas de aplicativos. O servi√ßo √© fornecido "no estado em que se encontra", com o objetivo de auxiliar no c√°lculo de lucros e despesas.
        </p>

        <h3 style="color:var(--primary); font-size:15px; margin-top:20px;">2. Assinatura e Renova√ß√£o</h3>
        <p style="font-size:13px; color:var(--text-main); line-height:1.6; opacity:0.8;">
            <strong>Cart√£o de Cr√©dito:</strong> A assinatura funciona em modelo de recorr√™ncia mensal. A cobran√ßa √© autom√°tica a cada 30 dias. O cancelamento pode ser feito a qualquer momento nas configura√ß√µes, interrompendo cobran√ßas futuras.<br><br>
            <strong>PIX:</strong> O acesso via PIX √© pr√©-pago e concede 30 dias de uso. N√£o h√° renova√ß√£o autom√°tica; ao fim do per√≠odo, o acesso √© bloqueado at√© novo pagamento.
        </p>

        <h3 style="color:var(--primary); font-size:15px; margin-top:20px;">3. Isen√ß√£o de Responsabilidade</h3>
        <p style="font-size:13px; color:var(--text-main); line-height:1.6; opacity:0.8;">
            Os c√°lculos de "Lucro Real" s√£o estimativas baseadas nos dados inseridos pelo utilizador (consumo, pre√ßo do combust√≠vel, custos de manuten√ß√£o). O Motorista Pro n√£o garante precis√£o cont√°bil e n√£o se responsabiliza por preju√≠zos financeiros decorrentes de decis√µes baseadas no app. <strong>Nunca utilize o aplicativo enquanto o ve√≠culo estiver em movimento.</strong>
        </p>

        <h3 style="color:var(--primary); font-size:15px; margin-top:20px;">4. Pol√≠tica de Reembolso</h3>
        <p style="font-size:13px; color:var(--text-main); line-height:1.6; opacity:0.8;">
            Em conformidade com o Art. 49 do CDC, garantimos o direito de arrependimento e reembolso integral se solicitado em at√© <strong>7 dias corridos ap√≥s a primeira assinatura</strong>. Renova√ß√µes autom√°ticas subsequentes n√£o s√£o reembols√°veis.
        </p>

        <h3 style="color:var(--primary); font-size:15px; margin-top:20px;">5. Privacidade de Dados (LGPD)</h3>
        <p style="font-size:13px; color:var(--text-main); line-height:1.6; opacity:0.8;">
            Respeitamos a sua privacidade. Coletamos apenas dados essenciais para o funcionamento (Nome, E-mail, Telefone). Seus dados financeiros s√£o privados e n√£o s√£o vendidos a terceiros. As transa√ß√µes de pagamento s√£o processadas externamente (Stripe/Mercado Pago) e n√£o armazenamos dados do seu cart√£o.
        </p>

        <h3 style="color:var(--primary); font-size:15px; margin-top:20px;">6. Uso de Captura de Tela (Android)</h3>
        <div style="background:rgba(37, 99, 235, 0.05); border-left: 3px solid var(--primary); padding:10px; border-radius:5px; margin-top:10px;">
            <p style="font-size:13px; color:var(--text-main); line-height:1.6; opacity:0.9; margin:0;">
                O aplicativo Android utiliza a permiss√£o de <strong>Media Projection (Captura de Tela)</strong> exclusivamente para ler informa√ß√µes de corridas (pre√ßo, dist√¢ncia e tempo) exibidas na tela do seu dispositivo. 
                <br><br>
                <strong>Como funciona:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>Utilizamos tecnologia OCR (Reconhecimento √ìptico de Caracteres) para extrair apenas os n√∫meros relevantes.</li>
                    <li>Todo o processamento √© feito <strong>localmente no seu dispositivo</strong>.</li>
                    <li>Nenhuma imagem, v√≠deo ou conte√∫do da sua tela √© enviado para servidores externos, armazenado em nuvem ou compartilhado com terceiros.</li>
                </ul>
                Esta funcionalidade √© ativada somente quando voc√™ clica explicitamente no bot√£o "Iniciar Rob√¥" e pode ser interrompida a qualquer momento pela barra de notifica√ß√µes.
            </p>
        </div>

        <div style="background:rgba(37, 99, 235, 0.05); border:1px solid rgba(37, 99, 235, 0.2); padding:15px; border-radius:15px; margin-top:30px; font-size:12px; text-align:center;">
            D√∫vidas ou solicita√ß√µes de exclus√£o de dados?<br>
            <a href="mailto:appmotoristapro@gmail.com" style="color:var(--primary); font-weight:700;">appmotoristapro@gmail.com</a>
        </div>
    </div>

</div>
{% endblock %}

==================== FIM ARQUIVO: app/templates/termos.html ====================

==================== INICIO ARQUIVO: app/templates/notifications.html ====================
{% extends 'base.html' %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Notifica√ß√µes</h2>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">

    {% if notifications %}
        <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
            <a href="/mark_all_read" style="font-size:11px; font-weight:700; color:var(--primary); text-decoration:none;">Marcar todas como lidas</a>
        </div>

        {% for n in notifications %}
        <div class="glass-card" style="padding:15px; border-left:4px solid {{ 'var(--primary)' if not n.is_read else 'transparent' }}; opacity: {{ '1' if not n.is_read else '0.7' }};">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:10px; font-weight:700; color:var(--text-secondary); text-transform:uppercase;">
                    {{ n.created_at.strftime('%d/%m √†s %H:%M') }}
                </span>
                {% if not n.is_read %}
                <span style="background:var(--primary); color:white; font-size:9px; padding:2px 6px; border-radius:10px; font-weight:700;">NOVA</span>
                {% endif %}
            </div>
            
            <p style="margin:0; font-size:13px; line-height:1.4; color:var(--text-main);">
                {{ n.message }}
            </p>
            
            {% if not n.is_read %}
            <div style="text-align:right; margin-top:10px;">
                <a href="/mark_notification/{{ n.id }}" style="font-size:11px; color:var(--primary); font-weight:700; text-decoration:none;">
                    <i class="fas fa-check"></i> Ler
                </a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        
        <div style="text-align:center; margin-top:30px;">
            <a href="/clear_notifications" onclick="return confirm('Apagar tudo?')" style="color:var(--danger); font-size:12px; font-weight:700; text-decoration:none; display:inline-flex; align-items:center; gap:5px; padding:10px 20px; background:rgba(239, 68, 68, 0.05); border-radius:20px;">
                <i class="fas fa-trash"></i> Limpar Hist√≥rico
            </a>
        </div>

    {% else %}
        <div style="text-align:center; padding:100px 0; color:var(--text-secondary); opacity:0.6;">
            <i class="far fa-bell-slash" style="font-size:40px; margin-bottom:15px;"></i>
            <p>Nenhuma notifica√ß√£o.</p>
        </div>
    {% endif %}

</div>
{% endblock %}



==================== FIM ARQUIVO: app/templates/notifications.html ====================

==================== INICIO ARQUIVO: app/templates/change_password.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguran√ßa da Conta</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style> 
        :root { --bg-body: #F0F4F8; --text-main: #0F172A; --text-secondary: #64748B; --primary-gradient: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); --glass-bg: rgba(255, 255, 255, 0.85); --glass-border: 1px solid rgba(255, 255, 255, 0.9); --glass-shadow: 0 8px 32px 0 rgba(30, 58, 138, 0.08); }
        body { margin: 0; padding: 20px; font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .blob { position: fixed; border-radius: 50%; filter: blur(90px); z-index: -1; opacity: 0.5; }
        .blob-1 { top: -10%; left: -20%; width: 400px; height: 400px; background: #BFDBFE; }
        
        .card { background: var(--glass-bg); backdrop-filter: blur(20px); border: var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 30px; padding: 40px 30px; width: 100%; max-width: 380px; text-align: center; }
        
        .icon-box { width: 70px; height: 70px; background: rgba(37, 99, 235, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto; color: #2563EB; font-size: 28px; }
        
        h2 { margin: 0 0 10px 0; font-size: 22px; font-weight: 800; }
        p { color: var(--text-secondary); font-size: 13px; margin-bottom: 30px; line-height: 1.5; }
        
        .pass-wrapper { position: relative; width: 100%; margin-bottom: 20px; text-align: left; }
        .pass-wrapper i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); cursor: pointer; }
        
        input { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); color: var(--text-main); font-family: inherit; font-size: 14px; box-sizing: border-box; outline: none; }
        input:focus { background: white; border-color: #2563EB; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }

        .btn-main { background: var(--primary-gradient); border: none; width: 100%; padding: 18px; border-radius: 16px; color: white; font-weight: 800; font-size: 15px; cursor: pointer; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); transition: transform 0.2s; }
        .btn-main:active { transform: scale(0.97); }
        
        .error-msg { background: #FEF2F2; color: #DC2626; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 600; margin-bottom: 15px; border: 1px solid #FCA5A5; }
    </style>
</head>
<body>
    <div class="blob blob-1"></div>

    <div class="card">
        <div class="icon-box"><i class="fas fa-shield-alt"></i></div>
        <h2>Definir Senha</h2>
        <p>Por seguran√ßa, voc√™ precisa definir uma nova senha pessoal para continuar acessando o sistema.</p>
        
        {% if erro %}
        <div class="error-msg">{{ erro }}</div>
        {% endif %}

        <form method="POST">
            <div class="pass-wrapper">
                <input type="password" name="nova_senha" id="novaSenha" placeholder="Nova Senha (m√≠n. 6 caracteres)" required minlength="6">
                <i class="fas fa-eye" onclick="togglePass()"></i>
            </div>
            <button type="submit" class="btn-main">SALVAR E CONTINUAR</button>
        </form>
    </div>

    <script>
        function togglePass() {
            const input = document.getElementById('novaSenha');
            const icon = document.querySelector('.fa-eye');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }
    </script>
</body>
</html>



==================== FIM ARQUIVO: app/templates/change_password.html ====================

==================== INICIO ARQUIVO: app/templates/suporte.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* Estilos originais mantidos */
    .support-card { background: var(--glass-bg); backdrop-filter: var(--backdrop-blur); border: var(--glass-border); border-radius: 24px; padding: 25px; margin-bottom: 20px; box-shadow: var(--glass-shadow); text-align: center; }
    .support-icon { width: 60px; height: 60px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: inline-flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px; }
    .contact-btn { display: flex; align-items: center; gap: 15px; background: white; padding: 16px; border-radius: 16px; margin-bottom: 12px; text-decoration: none; color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: transform 0.2s; border: 1px solid transparent; cursor: pointer; }
    .contact-btn:active { transform: scale(0.98); }
    .contact-btn.locked { background: #F1F5F9; color: var(--text-secondary); opacity: 0.8; border-color: rgba(0,0,0,0.05); }
    .contact-icon { font-size: 22px; width: 30px; text-align: center; }
    .wa-color { color: #25D366; } .email-color { color: #EA4335; }
    .locked .contact-icon { color: var(--text-secondary); filter: grayscale(1); }
    .contact-info h4 { margin: 0; font-size: 15px; font-weight: 700; }
    .contact-info p { margin: 2px 0 0 0; font-size: 12px; color: var(--text-secondary); }

    /* Lista de Tickets */
    .ticket-list { margin-top: 30px; }
    .ticket-item { background: rgba(255,255,255,0.5); padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
    .ticket-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
    .status-badge { padding: 2px 8px; border-radius: 10px; font-weight: 700; font-size: 10px; text-transform: uppercase; }
    .st-aberto { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .st-fechado { background: rgba(0,0,0,0.05); color: var(--text-secondary); }

    /* Modal de Chat */
    #chatModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
    .chat-card { background: var(--bg-body); width: 90%; max-width: 400px; height: 80vh; display: flex; flex-direction: column; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid var(--glass-border); overflow: hidden; }
    
    .chat-header { padding: 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    
    .msg-bubble { padding: 12px 16px; border-radius: 16px; max-width: 80%; font-size: 13px; line-height: 1.4; position: relative; }
    .msg-user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .msg-admin { align-self: flex-start; background: white; color: var(--text-main); border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    
    .chat-footer { padding: 15px; background: white; border-top: 1px solid #eee; }
    .chat-input-group { display: flex; gap: 10px; }
    .chat-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-family: inherit; font-size: 13px; background: #f9f9f9; }
    .chat-send { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    /* Modal Novo Ticket e Upsell (Mantidos) */
    #newTicketModal, #upsellModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
    .modal-card { background:var(--bg-body); width:90%; max-width:350px; padding:25px; border-radius:25px; }
    .upsell-card { width:90%; max-width:350px; text-align:center; padding:30px; background: white; border-radius: 25px; position: relative; }
    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/configuracoes" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Suporte</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">Central de Ajuda</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">
    
    <div class="support-card">
        <div class="support-icon"><i class="fas fa-headset"></i></div>
        <h3 style="margin:0 0 10px 0; color:var(--text-main); font-size:18px;">Precisa de ajuda?</h3>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:25px; line-height:1.5;">
            Escolha o canal de atendimento. Membros Premium t√™m prioridade via WhatsApp.
        </p>
        
        {% if current_user.plan_type == 'basic' %}
            <div onclick="openUpsell()" class="contact-btn locked">
                <i class="fab fa-whatsapp contact-icon"></i>
                <div class="contact-info"><h4>WhatsApp Business</h4><p>Exclusivo para Premium <i class="fas fa-lock" style="font-size:10px; margin-left:5px;"></i></p></div>
            </div>
        {% else %}
            <a href="https://wa.me/5511991167709" target="_blank" class="contact-btn">
                <i class="fab fa-whatsapp contact-icon wa-color"></i>
                <div class="contact-info"><h4>WhatsApp Business</h4><p>Resposta r√°pida (Priorit√°rio)</p></div>
                <i class="fas fa-chevron-right" style="margin-left:auto; color:var(--text-secondary); font-size:12px;"></i>
            </a>
        {% endif %}
        
        <a href="mailto:appmotoristapro@gmail.com" class="contact-btn">
            <i class="far fa-envelope contact-icon email-color"></i>
            <div class="contact-info"><h4>E-mail</h4><p>appmotoristapro@gmail.com</p></div>
            <i class="fas fa-chevron-right" style="margin-left:auto; color:var(--text-secondary); font-size:12px;"></i>
        </a>
    </div>

    <button onclick="openNewTicketModal()" class="btn" style="width:100%; border-radius:50px; padding:16px; background:var(--glass-bg); color:var(--primary); border:1px solid var(--primary);">
        <i class="fas fa-ticket-alt"></i> Abrir Chamado no App
    </button>

    <div class="ticket-list">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; padding:0 5px;">
            <span style="font-size:12px; font-weight:700; color:var(--text-secondary); text-transform:uppercase;">Seus Chamados</span>
        </div>
        
        {% if tickets %}
            {% for t in tickets %}
            <!-- CORRE√á√ÉO ITEM 4: Chama openChat com ID e Dados -->
            <div class="ticket-item" onclick="openChat('{{ t.id }}', '{{ t.motivo }}', '{{ t.status }}')">
                <div class="ticket-header">
                    <span style="font-weight:700;">#{{ t.id }} - {{ t.motivo }}</span>
                    <span class="status-badge {{ 'st-aberto' if t.status == 'Aberto' else 'st-fechado' }}">{{ t.status }}</span>
                </div>
                <p style="margin:0; font-size:12px; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ t.messages[-1].message if t.messages else t.mensagem }}
                </p>
                <!-- Armazena mensagens ocultas para o JS carregar no modal -->
                <div id="msgs-{{ t.id }}" style="display:none;">
                    <div class="msg-bubble msg-user">{{ t.mensagem }}</div>
                    {% for m in t.messages %}
                        <div class="msg-bubble {{ 'msg-user' if m.sender_type == 'user' else 'msg-admin' }}">
                            {{ m.message }}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align:center; color:var(--text-secondary); font-size:12px; opacity:0.6; margin-top:20px;">Nenhum chamado aberto.</div>
        {% endif %}
    </div>

</div>

<!-- MODAL CHAT (FUNCIONAL) -->
<div id="chatModal">
    <div class="chat-card">
        <div class="chat-header">
            <div>
                <h4 style="margin:0; font-size:14px; color:var(--text-main);" id="chatTitle">Chamado</h4>
                <span id="chatStatus" style="font-size:10px; color:var(--text-secondary);"></span>
            </div>
            <button onclick="document.getElementById('chatModal').style.display='none'" style="background:none; border:none; font-size:24px; color:var(--text-secondary); cursor:pointer;">&times;</button>
        </div>
        <div class="chat-body" id="chatBody"></div>
        
        <div class="chat-footer" id="chatFooter">
            <form id="replyForm" method="POST" class="chat-input-group">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="text" name="mensagem" class="chat-input" placeholder="Escreva uma resposta..." required>
                <button type="submit" class="chat-send"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
</div>

<!-- MODAL NOVO TICKET -->
<div id="newTicketModal">
    <div class="modal-card" style="box-shadow:0 20px 60px rgba(0,0,0,0.3); border:1px solid var(--glass-border);">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3 style="margin:0; font-size:18px; color:var(--text-main);">Novo Chamado</h3>
            <button onclick="document.getElementById('newTicketModal').style.display='none'" style="background:none; border:none; font-size:24px; color:var(--text-secondary); cursor:pointer;">&times;</button>
        </div>
        <form action="/suporte/novo" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">ASSUNTO</label>
            <select name="motivo" required style="width:100%; padding:12px; border-radius:12px; border:none; background:rgba(0,0,0,0.05); margin-bottom:15px; color:var(--text-main); font-weight:600;">
                <option value="D√∫vida Financeira">Financeiro</option>
                <option value="Problema T√©cnico">Erro no App</option>
                <option value="Sugest√£o">Sugest√£o</option>
            </select>
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">MENSAGEM</label>
            <textarea name="mensagem" rows="4" placeholder="Descreva aqui..." required style="width:100%; padding:15px; border-radius:15px; border:none; background:rgba(0,0,0,0.05); color:var(--text-main); resize:none; margin-bottom:20px;"></textarea>
            <button type="submit" class="btn" style="width:100%; border-radius:50px; padding:15px;">Enviar</button>
        </form>
    </div>
</div>

<!-- MODAL UPSELL -->
<div id="upsellModal">
    <div class="upsell-card">
        <button class="close-modal" onclick="document.getElementById('upsellModal').style.display='none'">&times;</button>
        <div style="width:70px; height:70px; background:rgba(37, 211, 102, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto; color:#25D366; font-size:30px;">
            <i class="fab fa-whatsapp"></i>
        </div>
        <h3 style="margin:0 0 10px 0; color:var(--text-main); font-size:20px; font-weight:800;">Suporte VIP</h3>
        <p style="font-size:14px; color:var(--text-secondary); margin-bottom:25px; line-height:1.5;">O atendimento via WhatsApp √© exclusivo para membros Premium. Garanta prioridade na fila.</p>
        <a href="/assinar?plan=premium" class="btn" style="border-radius:50px; background:var(--primary); box-shadow: 0 10px 30px rgba(37,99,235,0.4);">Quero ser VIP</a>
    </div>
</div>

<script>
    function openNewTicketModal() { document.getElementById('newTicketModal').style.display = 'flex'; }
    function openUpsell() { document.getElementById('upsellModal').style.display = 'flex'; }
    
    // Fun√ß√£o para abrir o chat real
    function openChat(id, motivo, status) {
        document.getElementById('chatTitle').innerText = motivo;
        document.getElementById('chatStatus').innerText = status;
        
        // Pega mensagens escondidas no HTML
        const msgs = document.getElementById('msgs-' + id).innerHTML;
        const body = document.getElementById('chatBody');
        body.innerHTML = msgs;
        
        // Scroll para o fim
        body.scrollTop = body.scrollHeight;
        
        // Configura form
        const form = document.getElementById('replyForm');
        const footer = document.getElementById('chatFooter');
        
        if (status === 'Encerrado' || status === 'Solucionado') {
            footer.style.display = 'none'; // N√£o responde a tickets fechados
        } else {
            footer.style.display = 'block';
            form.action = `/suporte/responder/${id}`;
        }
        
        document.getElementById('chatModal').style.display = 'flex';
    }
</script>
{% endblock %}




==================== FIM ARQUIVO: app/templates/suporte.html ====================

==================== INICIO ARQUIVO: app/templates/admin_suporte.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suporte Admin</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Mesmas vari√°veis do Dashboard */
        :root { --primary: #4318FF; --primary-dark: #2B0EBF; --secondary: #A3AED0; --success: #05CD99; --warning: #FFB547; --danger: #EE5D50; --bg-body: #F4F7FE; --card-white: #FFFFFF; --text-dark: #2B3674; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-body); color: var(--text-dark); margin: 0; padding: 20px; padding-bottom: 80px; }
        
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-left h1 { margin: 0; font-size: 24px; font-weight: 700; background: linear-gradient(90deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-left p { margin: 0; font-size: 12px; color: var(--secondary); }
        .btn-back { background: var(--card-white); color: var(--text-dark); border: none; padding: 10px 15px; border-radius: 12px; font-weight: 600; font-size: 13px; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; align-items: center; gap: 5px; }

        .ticket-card { background: var(--card-white); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .ticket-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
        .ticket-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: var(--secondary); }
        .ticket-card.st-aberto::before { background: var(--warning); }
        .ticket-card.st-respondido::before { background: var(--success); }
        .ticket-card.st-encerrado::before { background: var(--text-dark); opacity: 0.3; }

        .t-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .u-name { font-weight: 700; font-size: 16px; color: var(--text-dark); }
        .u-email { font-size: 12px; color: var(--secondary); }
        
        .t-badge { font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; }
        .bg-aberto { background: #FFF7E6; color: #FFB547; }
        .bg-respondido { background: #E6FFFA; color: #05CD99; }
        .bg-encerrado { background: #F4F7FE; color: #A3AED0; }

        .t-subject { font-size: 14px; font-weight: 600; margin-bottom: 5px; color: var(--primary); }
        .t-preview { font-size: 13px; color: var(--secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .t-date { font-size: 11px; color: var(--secondary); margin-top: 10px; text-align: right; font-weight: 500; }

        /* Modal */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-card { background: var(--card-white); width: 90%; max-width: 400px; padding: 25px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 80vh; }
        
        .chat-container { flex: 1; overflow-y: auto; background: var(--bg-body); padding: 15px; border-radius: 15px; margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        .msg-bubble { padding: 12px; border-radius: 15px; max-width: 85%; font-size: 13px; line-height: 1.4; }
        .msg-admin { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-user { align-self: flex-start; background: white; color: var(--text-dark); border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .action-area textarea { width: 100%; padding: 15px; border-radius: 15px; border: 1px solid #E0E5F2; background: #F9F9FC; font-family: inherit; font-size: 13px; margin-bottom: 10px; box-sizing: border-box; outline: none; }
        .action-area textarea:focus { border-color: var(--primary); background: white; }
        
        .btn-send { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-close-ticket { display: block; text-align: center; margin-top: 15px; color: var(--danger); font-size: 12px; font-weight: 600; text-decoration: none; }
    </style>
</head>
<body>

    <div class="admin-header">
        <div class="header-left">
            <a href="/admin/dashboard" class="btn-back"><i class="fas fa-arrow-left"></i> Voltar</a>
        </div>
        <div style="text-align:right;">
            <h1 style="margin:0; font-size: 20px;">Central de Suporte</h1>
            <a href="/admin/suporte/limpar_historico" onclick="return confirm('Limpar tickets encerrados?')" style="font-size:11px; color:var(--danger); text-decoration:none;">Limpar Hist√≥rico</a>
        </div>
    </div>

    {% if tickets %}
        {% for t in tickets %}
        <div class="ticket-card {{ 'st-aberto' if t[0].status == 'Aberto' else 'st-respondido' if t[0].status == 'Respondido' else 'st-encerrado' }}" 
             onclick="openAdminModal('{{ t[0].id }}', '{{ t[1].nome }}', '{{ t[0].motivo }}', '{{ t[0].status }}')">
            
            <div class="t-header">
                <div>
                    <div class="u-name">{{ t[1].nome }}</div>
                    <div class="u-email">{{ t[1].email }}</div>
                </div>
                <span class="t-badge {{ 'bg-aberto' if t[0].status == 'Aberto' else 'bg-respondido' if t[0].status == 'Respondido' else 'bg-encerrado' }}">
                    {{ t[0].status }}
                </span>
            </div>
            
            <div class="t-subject">{{ t[0].motivo }}</div>
            <div class="t-preview">{{ t[0].messages[-1].message if t[0].messages else t[0].mensagem }}</div>
            
            <div class="t-date">
                <i class="far fa-clock"></i> 
                {% if t[0].updated_at %}{{ t[0].updated_at.strftime('%d/%m %H:%M') }}{% else %}{{ t[0].created_at.strftime('%d/%m %H:%M') }}{% endif %}
            </div>

            <!-- Armazena mensagens ocultas para o modal -->
            <div id="msgs-{{ t[0].id }}" style="display:none;">
                {% for m in t[0].messages %}
                    <div class="msg-bubble {{ 'msg-admin' if m.sender_type == 'admin' else 'msg-user' }}">
                        <b style="font-size:10px; opacity:0.7; display:block; margin-bottom:2px;">{{ 'Suporte' if m.sender_type == 'admin' else t[1].nome }}</b>
                        {{ m.message }}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align:center; padding:50px; color:var(--secondary);">
            <i class="fas fa-check-circle" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i>
            <p>Nenhum chamado pendente.</p>
        </div>
    {% endif %}

    <!-- MODAL -->
    <div id="adminModal" class="modal">
        <div class="modal-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:18px;" id="modalTitle">Ticket</h3>
                <button onclick="document.getElementById('adminModal').style.display='none'" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--secondary);">&times;</button>
            </div>
            
            <div class="chat-container" id="modalChat"></div>
            
            <div id="adminActions" class="action-area">
                <form id="replyForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <textarea name="mensagem" rows="3" placeholder="Escreva sua resposta..." required></textarea>
                    <button type="submit" class="btn-send"><i class="fas fa-paper-plane"></i> Enviar Resposta</button>
                </form>
                <a id="closeLink" href="#" onclick="return confirm('Encerrar este ticket?')" class="btn-close-ticket">
                    <i class="fas fa-check"></i> Marcar como Resolvido / Encerrar
                </a>
            </div>

            <div id="adminClosedMsg" style="display:none; text-align:center; color:var(--secondary); margin-top:20px; font-weight:500;">
                <i class="fas fa-lock"></i> Este ticket est√° encerrado.
            </div>
        </div>
    </div>

    <script>
        function openAdminModal(id, nome, motivo, status) {
            document.getElementById('modalTitle').innerText = nome;
            document.getElementById('modalChat').innerHTML = document.getElementById('msgs-'+id).innerHTML;
            
            // Scroll para o fim do chat
            const chat = document.getElementById('modalChat');
            chat.scrollTop = chat.scrollHeight;
            
            const replyForm = document.getElementById('replyForm');
            const closeLink = document.getElementById('closeLink');
            const actions = document.getElementById('adminActions');
            const msgClosed = document.getElementById('adminClosedMsg');

            replyForm.action = `/admin/suporte/responder/${id}`;
            closeLink.href = `/admin/suporte/encerrar/${id}`;

            if (status === 'Encerrado' || status === 'Solucionado') {
                actions.style.display = 'none';
                msgClosed.style.display = 'block';
            } else {
                actions.style.display = 'block';
                msgClosed.style.display = 'none';
            }
            document.getElementById('adminModal').style.display = 'flex';
        }
    </script>
</body>
</html>



==================== FIM ARQUIVO: app/templates/admin_suporte.html ====================

==================== INICIO ARQUIVO: app/templates/bloqueio_trial.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teste Finalizado</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0F172A; color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; }
        
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; padding: 40px 30px; width: 100%; max-width: 400px; }
        
        .icon-box { width: 70px; height: 70px; background: rgba(59, 130, 246, 0.2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 30px; color: #60A5FA; margin-bottom: 20px; }
        
        h1 { margin: 0 0 10px 0; font-size: 22px; font-weight: 800; }
        p { font-size: 14px; opacity: 0.8; margin-bottom: 30px; line-height: 1.5; }
        
        /* CARDS DE OP√á√ÉO */
        .option-card {
            background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px;
            margin-bottom: 15px; text-align: left; position: relative; border: 1px solid transparent;
            transition: 0.2s; cursor: pointer; text-decoration: none; display: block; color: white;
        }
        .option-card:hover { background: rgba(255,255,255,0.1); }
        
        .opt-premium { border-color: #2563EB; background: linear-gradient(135deg, rgba(37, 99, 235, 0.2) 0%, rgba(37, 99, 235, 0.05) 100%); }
        
        .badge-rec { position: absolute; top: -10px; right: 15px; background: #10B981; color: white; font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 10px; }
        
        .opt-title { font-size: 16px; font-weight: 800; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .opt-price { font-size: 14px; opacity: 0.9; }
        .opt-desc { font-size: 12px; opacity: 0.6; margin-top: 8px; line-height: 1.4; }
        
        .loss-alert { color: #F87171; font-weight: 700; font-size: 11px; margin-top: 5px; display: block; }
        
        .logout-link { color: rgba(255,255,255,0.4); text-decoration: none; font-size: 12px; margin-top: 25px; display: block; }
    </style>
</head>
<body>
    <div class="card">
        <div class="icon-box"><i class="fas fa-hourglass-end"></i></div>
        <h1>Per√≠odo de Teste Finalizado</h1>
        <p>Ol√° <b>{{ nome.split()[0] }}</b>! Seus 7 dias de acesso total acabaram. Escolha como deseja continuar:</p>
        
        <!-- OP√á√ÉO PREMIUM (MANT√âM TUDO) -->
        <a href="/assinar?plan=premium" class="option-card opt-premium">
            <div class="badge-rec">RECOMENDADO</div>
            <div class="opt-title">
                <span>Motorista Pro</span>
                <span class="opt-price">R$ 19,90</span>
            </div>
            <div class="opt-desc">
                ‚úÖ Mantenha o <b>Lucro Real</b><br>
                ‚úÖ Mantenha os <b>Recibos PDF</b><br>
                ‚úÖ Hist√≥rico e Manuten√ß√£o Inteligente
            </div>
        </a>

        <!-- OP√á√ÉO BASIC (PERDA) -->
        <a href="/assinar?plan=basic" class="option-card">
            <div class="opt-title">
                <span>Plano B√°sico</span>
                <span class="opt-price">R$ 9,90</span>
            </div>
            <div class="opt-desc">
                Apenas Livro Caixa simples.
                <span class="loss-alert"><i class="fas fa-exclamation-triangle"></i> Voc√™ perder√° o acesso √†s ferramentas profissionais.</span>
            </div>
        </a>
        
        <a href="/logout" class="logout-link">Sair da conta</a>
    </div>
</body>
</html>



==================== FIM ARQUIVO: app/templates/bloqueio_trial.html ====================

==================== INICIO ARQUIVO: app/templates/bloqueio_assinatura.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renova√ß√£o Necess√°ria</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0F172A; color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; }
        
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; padding: 40px 30px; width: 100%; max-width: 380px; }
        
        .icon-box { width: 70px; height: 70px; background: rgba(239, 68, 68, 0.2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 30px; color: #EF4444; margin-bottom: 20px; }
        
        h1 { margin: 0 0 10px 0; font-size: 22px; font-weight: 800; }
        p { font-size: 14px; opacity: 0.7; margin-bottom: 25px; line-height: 1.5; }
        
        .btn-renew { background: #2563EB; color: white; width: 100%; padding: 16px; border-radius: 16px; font-weight: 800; font-size: 15px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; transition: 0.2s; text-decoration: none; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3); }
        .btn-renew:active { transform: scale(0.97); }
        
        .discount-alert { background: rgba(16, 185, 129, 0.2); color: #34D399; padding: 10px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-bottom: 20px; border: 1px dashed #34D399; }
        
        .link-downgrade { font-size: 12px; color: rgba(255,255,255,0.5); text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>
    <div class="card">
        <div class="icon-box"><i class="fas fa-exclamation-triangle"></i></div>
        <h1>Assinatura Expirada</h1>
        <p>Seus dados est√£o seguros. Renove seu acesso para continuar gerenciando seu lucro.</p>
        
        {% if current_user.referral_balance > 0 %}
        <div class="discount-alert"><i class="fas fa-gift"></i> Voc√™ tem 50% de desconto dispon√≠vel!</div>
        {% endif %}
        
        <a href="/assinar?plan=premium" class="btn-renew">
            <i class="fas fa-sync-alt"></i> Renovar Premium
        </a>
        
        <div style="margin-top: 15px;">
            <a href="/assinar?plan=basic" class="link-downgrade">Ou mude para o plano Basic (R$ 9,90)</a>
        </div>
        
        <a href="/logout" style="color:rgba(255,255,255,0.3); text-decoration:none; font-size:12px; margin-top:25px; display:block;">Sair</a>
    </div>
</body>
</html>



==================== FIM ARQUIVO: app/templates/bloqueio_assinatura.html ====================

==================== INICIO ARQUIVO: app/templates/reset_token.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Senha</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style> 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F0F4F8; color: #0F172A; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
        .card { background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); border-radius: 30px; padding: 40px 30px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.9); }
        h2 { margin: 0 0 20px 0; color: #2563EB; font-weight: 800; }
        input { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); margin-bottom: 15px; box-sizing: border-box; outline:none; }
        input:focus { background: white; border-color: #2563EB; }
        .btn { background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); color: white; width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); }
    </style>
</head>
<body>
    <div class="card">
        <h2>Criar Nova Senha</h2>
        <form method="POST">
            <input type="password" name="password" placeholder="Digite a nova senha" required>
            <button type="submit" class="btn">SALVAR</button>
        </form>
    </div>
</body>
</html>



==================== FIM ARQUIVO: app/templates/reset_token.html ====================

==================== INICIO ARQUIVO: app/templates/auth_action.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A√ß√£o Necess√°ria - Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-body: #F0F4F8; --text-main: #0F172A; --text-secondary: #64748B; --primary: #2563EB; --primary-gradient: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); --glass-bg: rgba(255, 255, 255, 0.85); --glass-border: 1px solid rgba(255, 255, 255, 0.9); --glass-shadow: 0 8px 32px 0 rgba(30, 58, 138, 0.08); }
        body { margin: 0; padding: 20px; font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .blob { position: fixed; border-radius: 50%; filter: blur(90px); z-index: -1; opacity: 0.5; }
        .blob-1 { top: -10%; right: -20%; width: 400px; height: 400px; background: #BFDBFE; }
        
        .card { background: var(--glass-bg); backdrop-filter: blur(20px); border: var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 30px; padding: 40px 30px; width: 100%; max-width: 350px; text-align: center; }
        
        .action-icon { font-size: 50px; margin-bottom: 20px; display: block; }
        .success-icon { color: #10B981; }
        .error-icon { color: #DC2626; }
        .key-icon { color: #2563EB; background: rgba(37, 99, 235, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto; font-size: 32px; }
        
        h3 { font-size: 20px; font-weight: 800; margin: 0 0 10px 0; color: var(--text-main); }
        p { color: var(--text-secondary); font-size: 14px; margin-bottom: 25px; line-height: 1.5; }
        
        .loader { display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(37, 99, 235, 0.2); border-left-color: #2563EB; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .btn-main { background: var(--primary-gradient); border: none; width: 100%; padding: 16px; border-radius: 16px; color: white; font-weight: 800; font-size: 15px; cursor: pointer; text-decoration: none; display: inline-block; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); transition: transform 0.2s; box-sizing: border-box; }
        .btn-main:active { transform: scale(0.97); }
        .btn-outline { background: white; border: 1px solid rgba(0,0,0,0.1); color: var(--text-main); padding: 12px 25px; border-radius: 16px; text-decoration: none; font-weight: 700; font-size: 13px; display: inline-block; }
        
        input { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); color: var(--text-main); font-family: inherit; font-size: 14px; box-sizing: border-box; outline: none; margin-bottom: 15px; }
        input:focus { background: white; border-color: #2563EB; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }

        #view-loading, #view-success, #view-error, #view-reset-password { display: none; }
    </style>
</head>
<body>
    <div class="blob blob-1"></div>

    <div class="card">
        <!-- 1. LOADING -->
        <div id="view-loading" style="display:block;">
            <div class="loader"></div>
            <h3>Aguarde...</h3>
            <p>Estamos validando suas informa√ß√µes.</p>
        </div>

        <!-- 2. SUCESSO -->
        <div id="view-success">
            <i class="fas fa-check-circle action-icon success-icon"></i>
            <h3>Tudo Pronto!</h3>
            <p id="success-msg">Opera√ß√£o realizada com sucesso.</p>
            <a href="/login" class="btn-main">ENTRAR AGORA</a>
        </div>

        <!-- 3. ERRO -->
        <div id="view-error">
            <i class="fas fa-times-circle action-icon error-icon"></i>
            <h3>Algo deu errado</h3>
            <p id="error-msg">O link √© inv√°lido ou expirou.</p>
            <a href="/login" class="btn-outline">Voltar para Login</a>
        </div>

        <!-- 4. REDEFINIR SENHA -->
        <div id="view-reset-password">
            <div class="key-icon"><i class="fas fa-key"></i></div>
            <h3>Nova Senha</h3>
            <p>Crie uma senha segura para acessar sua conta.</p>
            
            <form id="newPassForm">
                <input type="password" id="newPassword" placeholder="Nova Senha (m√≠n. 6 d√≠gitos)" required minlength="6">
                <button type="submit" class="btn-main">DEFINIR SENHA</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, applyActionCode, verifyPasswordResetCode, confirmPasswordReset } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        // Configura√ß√£o mantida do original
        const firebaseConfig = { apiKey: "AIzaSyAn_FPF2jSH2jFR9MAG6Xo9mXmodTsQCpA", authDomain: "motoristapro-f9beb.firebaseapp.com", projectId: "motoristapro-f9beb", storageBucket: "motoristapro-f9beb.firebasestorage.app", messagingSenderId: "990151984574", appId: "1:990151984574:web:82bd63cc391c372ea9a5ef" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const mode = "{{ mode }}";
        const actionCode = "{{ code }}";

        const views = { loading: document.getElementById('view-loading'), success: document.getElementById('view-success'), error: document.getElementById('view-error'), reset: document.getElementById('view-reset-password') };
        function showView(name) { Object.values(views).forEach(el => el.style.display = 'none'); views[name].style.display = 'block'; }

        async function handleAction() {
            try {
                if (mode === 'verifyEmail') {
                    await applyActionCode(auth, actionCode);
                    document.getElementById('success-msg').innerText = "E-mail verificado! Sua conta est√° ativa.";
                    showView('success');
                } 
                else if (mode === 'resetPassword') {
                    await verifyPasswordResetCode(auth, actionCode);
                    showView('reset');
                    document.getElementById('newPassForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const newPass = document.getElementById('newPassword').value;
                        showView('loading');
                        try {
                            await confirmPasswordReset(auth, actionCode, newPass);
                            document.getElementById('success-msg').innerText = "Senha alterada com sucesso!";
                            showView('success');
                        } catch (err) {
                            document.getElementById('error-msg').innerText = "Erro ao salvar: " + err.message;
                            showView('error');
                        }
                    });
                } 
                else { throw new Error("Modo desconhecido."); }
            } catch (error) {
                let msg = "Link inv√°lido ou expirado.";
                if(error.code === 'auth/expired-action-code') msg = "Este link j√° expirou.";
                if(error.code === 'auth/invalid-action-code') msg = "Link inv√°lido.";
                document.getElementById('error-msg').innerText = msg;
                showView('error');
            }
        }
        handleAction();
    </script>
</body>
</html>



==================== FIM ARQUIVO: app/templates/auth_action.html ====================

==================== INICIO ARQUIVO: app/templates/pagamento_pro.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escolha seu Plano</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        :root { --bg-body: #F0F4F8; --primary: #2563EB; --text-main: #0F172A; --text-secondary: #64748B; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .header { width: 100%; max-width: 450px; display: flex; align-items: center; margin-bottom: 20px; }
        .back-link { width: 40px; height: 40px; border-radius: 12px; background: white; display: flex; align-items: center; justify-content: center; color: var(--text-main); text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* CARD DO PLANO */
        .plan-container { width: 100%; max-width: 360px; background: white; border-radius: 24px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .plan-tabs { display: flex; background: #F1F5F9; border-radius: 14px; padding: 4px; margin-bottom: 25px; }
        .tab-btn { flex: 1; text-align: center; padding: 10px; border-radius: 10px; font-size: 13px; font-weight: 700; color: var(--text-secondary); cursor: pointer; transition: 0.2s; position: relative; }
        .tab-btn.active { background: white; color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-btn.active.premium-tab { color: var(--primary); }
        
        /* PRE√áO */
        .price-display { text-align: center; margin-bottom: 25px; animation: fadeIn 0.3s; }
        .big-price { font-size: 36px; font-weight: 800; color: var(--text-main); letter-spacing: -1px; }
        .period { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .badge-discount { display: inline-block; background: #ECFDF5; color: #059669; font-size: 11px; font-weight: 800; padding: 4px 10px; border-radius: 20px; margin-top: 5px; }

        /* LISTA BENEF√çCIOS */
        .features-list { margin-bottom: 25px; text-align: left; }
        .f-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; font-size: 13px; color: var(--text-main); line-height: 1.4; }
        .f-icon { color: #10B981; font-size: 14px; width: 18px; text-align: center; flex-shrink: 0; margin-top: 2px; }
        .premium-header { font-weight: 800; color: var(--primary); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: block; border-bottom: 1px dashed rgba(37,99,235,0.2); padding-bottom: 5px; }

        /* PAGAMENTO */
        .payment-section { width: 100%; text-align: center; }
        .payment-title { font-size: 11px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; }
        
        .btn-pay {
            width: 100%; padding: 14px 20px; border-radius: 16px; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            font-weight: 700; font-size: 14px; margin-bottom: 10px; cursor: pointer;
            transition: 0.2s; border: none; text-decoration: none;
            max-width: 320px; margin-left: auto; margin-right: auto;
        }
        .btn-pay:active { transform: scale(0.98); }

        .pay-card { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3); }
        .pay-pix { background: #10B981; color: white; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }

        /* MODAL PIX */
        #pixArea { display: none; background: white; padding: 25px; border-radius: 24px; text-align: center; margin-top: 10px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); width: 100%; max-width: 360px; }
        .pix-code { background: #F1F5F9; padding: 12px; border-radius: 12px; font-family: monospace; font-size: 12px; color: var(--text-main); word-break: break-all; margin: 15px 0; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="back-link"><i class="fas fa-times"></i></a>
        <div style="flex:1; text-align:center; font-weight:700; color:var(--text-main);">Assinatura</div>
        <div style="width:40px;"></div>
    </div>

    <!-- CARD SELETOR -->
    <div class="plan-container">
        <div class="plan-tabs">
            <div class="tab-btn" id="tab-basic" onclick="selectPlan('basic')">B√ÅSICO</div>
            <div class="tab-btn active premium-tab" id="tab-premium" onclick="selectPlan('premium')">PREMIUM</div>
        </div>

        <div id="plan-content">
            <div class="price-display">
                {% if tem_desconto %}
                    <span class="badge-discount" id="badge-disc" style="display:none;">50% OFF (Indica√ß√£o)</span>
                {% endif %}
                <div class="big-price" id="price-val">R$ 19,90</div>
                <div class="period">por m√™s</div>
            </div>

            <div class="features-list" id="feat-list"></div>
        </div>
    </div>

    <div class="payment-section">
        <div class="payment-title">Escolha como pagar</div>
        
        <button class="btn-pay pay-card" onclick="payCard()">
            <i class="far fa-credit-card"></i> Cart√£o de Cr√©dito
        </button>

        <button class="btn-pay pay-pix" onclick="payPix()">
            <i class="fas fa-qrcode"></i> PIX
        </button>
    </div>

    <!-- PIX MODAL -->
    <div id="pixArea">
        <h3 style="margin:0; font-size:18px; color:#10B981;">Pagamento PIX</h3>
        <p style="font-size:13px; color:#64748B;">Escaneie ou copie o c√≥digo abaixo.</p>
        <img id="qrImg" src="" style="width:150px; height:150px; margin:10px 0; mix-blend-mode:multiply;">
        <div class="pix-code" id="pixCode">Gerando...</div>
        <button onclick="copyPix()" style="background:#10B981; color:white; border:none; padding:12px 25px; border-radius:12px; font-weight:700; width:100%;">Copiar C√≥digo</button>
    </div>

    <script>
        const stripeKey = '{{ stripe_public_key }}';
        let stripe = null;
        if(stripeKey && stripeKey !== 'None') stripe = Stripe(stripeKey);
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        let selectedPlan = 'premium';
        const hasDiscount = {{ 'true' if tem_desconto else 'false' }};

        // LISTA B√ÅSICA
        const listBasic = [
            'Livro Caixa Digital',
            'Lan√ßamentos Ilimitados',
            'Calculadora Flex',
            'Hist√≥rico (√öltimos 30 dias)',
            'Suporte via E-mail',
            'Gest√£o de Manuten√ß√£o (Avisos)'
        ];

        // LISTA PREMIUM (ATUALIZADA)
        const listPremium = [
            'Lucro Real (+ Custos Fixos)',
            'Livro de Revis√µes em PDF',
            'Gest√£o de IPVA, Seguro e Aluguel',
            'Recibos Profissionais',
            'Suporte VIP WhatsApp',
            'Meta Semanal Inteligente',
            'Relat√≥rios Avan√ßados (PDF)'
        ];

        function renderFeatures(plan) {
            const list = document.getElementById('feat-list');
            list.innerHTML = '';

            if (plan === 'basic') {
                document.getElementById('price-val').innerText = 'R$ 9,90';
                if(document.getElementById('badge-disc')) document.getElementById('badge-disc').style.display = 'none';
                
                listBasic.forEach(txt => {
                    list.innerHTML += `<div class="f-item"><i class="fas fa-check f-icon"></i> ${txt}</div>`;
                });
            } else {
                let price = 'R$ 19,90';
                if (hasDiscount) {
                    price = 'R$ 9,95';
                    if(document.getElementById('badge-disc')) document.getElementById('badge-disc').style.display = 'inline-block';
                }
                document.getElementById('price-val').innerText = price;
                
                list.innerHTML += `<span class="premium-header"><i class="fas fa-plus-circle"></i> TODOS OS ITENS DO PLANO BASIC</span>`;
                
                listPremium.forEach(txt => {
                    list.innerHTML += `<div class="f-item"><i class="fas fa-check-circle f-icon" style="color:var(--primary);"></i> ${txt}</div>`;
                });
            }
        }

        function selectPlan(plan) {
            selectedPlan = plan;
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + plan).classList.add('active');
            renderFeatures(plan);
        }

        function payCard() {
            fetch('/create-checkout-session', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ plan: selectedPlan })
            })
            .then(r => r.json())
            .then(s => {
                if(s.error) alert(s.error); else stripe.redirectToCheckout({ sessionId: s.id });
            });
        }

        function payPix() {
            document.getElementById('pixArea').style.display = 'block';
            fetch('/create-pix-payment', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ plan: selectedPlan })
            })
            .then(r => r.json())
            .then(d => {
                if(d.error) alert(d.error); else {
                    document.getElementById('pixCode').innerText = d.qr_code;
                    document.getElementById('qrImg').src = 'data:image/png;base64,' + d.qr_code_base64;
                }
            });
        }

        function copyPix() {
            navigator.clipboard.writeText(document.getElementById('pixCode').innerText).then(() => alert('Copiado!'));
        }

        // Init
        renderFeatures('premium');
    </script>
</body>
</html>




==================== FIM ARQUIVO: app/templates/pagamento_pro.html ====================

==================== INICIO ARQUIVO: app/templates/pagamento_sucesso.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento Confirmado!</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: white; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; text-align: center;
        }
        .icon-box {
            width: 100px; height: 100px; background: rgba(255,255,255,0.2);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 50px; margin-bottom: 30px; backdrop-filter: blur(10px);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        h1 { font-size: 32px; font-weight: 800; margin: 0 0 15px 0; }
        p { font-size: 16px; opacity: 0.9; margin-bottom: 40px; max-width: 300px; line-height: 1.5; }
        
        .btn {
            background: white; color: #059669; font-weight: 800;
            padding: 18px 40px; border-radius: 50px; text-decoration: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div class="icon-box"><i class="fas fa-check"></i></div>
    <h1>Tudo Certo!</h1>
    <p>Sua assinatura foi renovada com sucesso. Voc√™ j√° pode voltar a usar o Motorista Pro.</p>
    
    <a href="/" class="btn">ACESSAR O APP</a>

    <script>
        // Chuva de confetes
        var duration = 3000;
        var end = Date.now() + duration;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    </script>
</body>
</html>



==================== FIM ARQUIVO: app/templates/pagamento_sucesso.html ====================

==================== INICIO ARQUIVO: app/templates/landing.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="O App definitivo para motoristas de Uber e 99. Monitoramento de tela em tempo real, c√°lculo de lucro real e gest√£o de frota.">
    <title>Motorista Pro - O Copiloto do Seu Lucro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563EB; --dark: #020617; --light: #F8FAFC; 
            --accent: #10B981; --gold: #F59E0B; --text-dim: #94A3B8;
            --gradient: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--dark); color: var(--light); overflow-x: hidden; }

        /* HEADER */
        nav { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; max-width: 1100px; margin: 0 auto; }
        .logo { font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .logo img { width: 32px; border-radius: 8px; }
        .btn-login { border: 1px solid rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 50px; color: white; text-decoration: none; font-weight: 700; font-size: 13px; transition:0.3s; }
        .btn-login:hover { background: white; color: var(--dark); }

        /* HERO */
        .hero { text-align: center; padding: 60px 20px 80px 20px; position: relative; overflow: hidden; }
        .hero::before { content:''; position: absolute; top:-50%; left:50%; transform:translateX(-50%); width: 100%; max-width:600px; height:600px; background:radial-gradient(circle, rgba(37,99,235,0.3) 0%, transparent 70%); z-index:-1; pointer-events:none; }
        
        h1 { font-size: 42px; font-weight: 800; line-height: 1.1; margin-bottom: 20px; letter-spacing: -1px; }
        h1 span { background: linear-gradient(to right, #60A5FA, #3B82F6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero p { font-size: 18px; color: var(--text-dim); max-width: 500px; margin: 0 auto 40px auto; line-height: 1.6; }
        
        .cta-btn { background: var(--gradient); color: white; padding: 18px 40px; border-radius: 50px; font-weight: 800; font-size: 16px; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 10px 40px rgba(37, 99, 235, 0.4); transition: transform 0.2s; }
        .cta-btn:hover { transform: scale(1.05); }

        /* FEATURE SPOTLIGHT (ROB√î) */
        .spotlight { background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 100%); border-top: 1px solid rgba(255,255,255,0.1); padding: 60px 20px; text-align: center; }
        .robot-badge { background: rgba(16, 185, 129, 0.15); color: #34D399; padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: 800; text-transform: uppercase; margin-bottom: 20px; display: inline-block; border: 1px solid rgba(16, 185, 129, 0.3); }
        .spot-img { width: 100%; max-width: 300px; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.5)); margin: 30px 0; animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%{transform:translateY(0px)} 50%{transform:translateY(-20px)} 100%{transform:translateY(0px)} }

        /* GRID DE FUN√á√ïES */
        .grid-section { max-width: 1100px; margin: 0 auto; padding: 60px 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; }
        .feature-card { background: rgba(30, 41, 59, 0.5); padding: 30px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .feature-card:hover { transform: translateY(-5px); background: rgba(30, 41, 59, 0.8); border-color: rgba(37,99,235,0.3); }
        .f-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 20px; }
        
        .ic-profit { background: rgba(37,99,235,0.1); color: #3B82F6; }
        .ic-maint { background: rgba(245,158,11,0.1); color: #F59E0B; }
        .ic-doc { background: rgba(16,185,129,0.1); color: #10B981; }
        
        .f-title { font-size: 18px; font-weight: 800; margin-bottom: 10px; }
        .f-desc { color: var(--text-dim); font-size: 14px; line-height: 1.6; }

        /* PLANOS */
        .plans-section { padding: 80px 20px; text-align: center; }
        .plan-container { display: flex; flex-direction: column; gap: 30px; max-width: 900px; margin: 40px auto 0 auto; }
        
        .plan-card { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; padding: 40px 30px; text-align: left; position: relative; }
        .plan-card.premium { background: linear-gradient(145deg, rgba(37,99,235,0.1) 0%, rgba(15,23,42,0.9) 100%); border-color: var(--primary); transform: scale(1.02); box-shadow: 0 20px 60px rgba(37,99,235,0.15); }
        
        .plan-name { font-size: 14px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .plan-price { font-size: 42px; font-weight: 800; margin: 10px 0; color: white; }
        .plan-price small { font-size: 16px; color: var(--text-dim); font-weight: 500; }
        
        .feature-list { list-style: none; padding: 0; margin: 30px 0; }
        .feature-list li { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: #E2E8F0; font-size: 14px; }
        .feature-list i { color: var(--accent); }
        .feature-list .fa-times { color: var(--text-dim); opacity: 0.5; }
        .disabled { opacity: 0.5; }

        .btn-plan { display: block; text-align: center; padding: 18px; border-radius: 15px; font-weight: 800; text-decoration: none; margin-top: 20px; transition: 0.2s; }
        .btn-basic { background: rgba(255,255,255,0.1); color: white; }
        .btn-premium { background: var(--primary); color: white; box-shadow: 0 10px 30px rgba(37,99,235,0.3); }

        /* DESKTOP */
        @media (min-width: 800px) {
            h1 { font-size: 64px; }
            .plan-container { flex-direction: row; align-items: center; }
            .plan-card { flex: 1; }
        }
    </style>
</head>
<body>

    <nav>
        <div class="logo"><img src="/static/icons/icon-192.png" alt="Logo"> Motorista Pro</div>
        <a href="/login" class="btn-login">Entrar</a>
    </nav>

    <header class="hero">
        <div style="font-size: 12px; font-weight: 700; color: #F59E0B; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px;">Gest√£o de Frota Pessoal</div>
        <h1>Voc√™ dirige.<br>N√≥s cuidamos do <span>Lucro</span>.</h1>
        <p>Pare de perder dinheiro com "custos invis√≠veis". O √∫nico app com monitoramento de tela em tempo real e c√°lculo autom√°tico de deprecia√ß√£o.</p>
        <a href="/register" class="cta-btn">COME√áAR AGORA <i class="fas fa-arrow-right"></i></a>
        <div style="margin-top: 20px; font-size: 12px; color: var(--text-dim); opacity: 0.7;">Teste Gr√°tis por 7 dias ‚Ä¢ Sem cart√£o de cr√©dito</div>
    </header>

    <section class="spotlight">
        <div class="robot-badge"><i class="fas fa-robot"></i> Tecnologia Exclusiva</div>
        <h2 style="font-size: 28px; margin: 0 auto 10px auto; max-width: 600px;">Monitoramento Din√¢mico</h2>
        <p style="color: var(--text-dim); max-width: 500px; margin: 0 auto;">
            Nosso rob√¥ l√™ a tela do Uber e 99 enquanto voc√™ dirige. Ele identifica o valor, a dist√¢ncia e o tempo, e te diz instantaneamente se √© lucro ou preju√≠zo.
        </p>
        
        <!-- Representa√ß√£o Visual do Rob√¥ -->
        <div style="position: relative; width: 280px; height: 160px; background: #1E293B; margin: 40px auto; border-radius: 20px; border: 4px solid #334155; display: flex; align-items: center; justify-content: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #94A3B8; margin-bottom: 5px;">AN√ÅLISE EM TEMPO REAL</div>
                <div style="font-size: 32px; font-weight: 800; color: #4ADE80;">R$ 2.45 <span style="font-size: 14px;">/km</span></div>
                <div style="background: #166534; color: #DCFCE7; font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 10px; display: inline-block; margin-top: 5px;">CORRIDA EXCELENTE</div>
            </div>
            <!-- Bolha flutuante simulada -->
            <div style="position: absolute; top: -15px; right: -15px; width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.3);">
                <img src="/static/icons/icon-192.png" style="width: 30px; border-radius: 8px;">
            </div>
        </div>
    </section>

    <div class="grid-section">
        <div class="feature-card">
            <div class="f-icon ic-profit"><i class="fas fa-chart-line"></i></div>
            <h3 class="f-title">Lucro Real</h3>
            <p class="f-desc">Voc√™ sabe quanto gastou de pneu hoje? O app desconta automaticamente o desgaste do carro e mostra o que realmente sobrou no bolso.</p>
        </div>
        <div class="feature-card">
            <div class="f-icon ic-maint"><i class="fas fa-wrench"></i></div>
            <h3 class="f-title">Manuten√ß√£o Inteligente</h3>
            <p class="f-desc">Adeus, papelzinho de √≥leo. Registre suas manuten√ß√µes e o sistema avisa exatamente quando fazer a pr√≥xima troca baseado na sua rodagem.</p>
        </div>
        <div class="feature-card">
            <div class="f-icon ic-doc"><i class="fas fa-file-invoice"></i></div>
            <h3 class="f-title">Recibos Profissionais</h3>
            <p class="f-desc">Fa√ßa corridas particulares e envie um recibo em PDF com a sua marca para o cliente via WhatsApp em segundos.</p>
        </div>
        <div class="feature-card">
            <div class="f-icon" style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6;"><i class="fas fa-bullseye"></i></div>
            <h3 class="f-title">Meta Inteligente</h3>
            <p class="f-desc">Defina quanto quer ganhar na semana e o app quebra isso em metas di√°rias ajust√°veis conforme o seu progresso.</p>
        </div>
    </div>

    <section class="plans-section">
        <h2 style="font-size: 32px; margin-bottom: 10px;">Escolha seu Plano</h2>
        <p style="color: var(--text-dim);">Comece hoje e profissionalize sua carreira.</p>

        <div class="plan-container">
            <!-- BASIC -->
            <div class="plan-card">
                <div class="plan-name">Basic</div>
                <div class="plan-price">R$ 9,90 <small>/m√™s</small></div>
                <ul class="feature-list">
                    <li><i class="fas fa-check"></i> Livro Caixa Digital</li>
                    <li><i class="fas fa-check"></i> Lan√ßamentos Ilimitados</li>
                    <li><i class="fas fa-check"></i> Calculadora Flex</li>
                    <li><i class="fas fa-check"></i> Hist√≥rico (30 dias)</li>
                    <li class="disabled"><i class="fas fa-times"></i> Sem Rob√¥ de Monitoramento</li>
                    <li class="disabled"><i class="fas fa-times"></i> Sem Gest√£o de Custo Fixo</li>
                </ul>
                <a href="/register" class="btn-plan btn-basic">CRIAR CONTA</a>
            </div>

            <!-- PREMIUM -->
            <div class="plan-card premium">
                <div style="position: absolute; top: 0; right: 0; background: #F59E0B; color: black; font-size: 10px; font-weight: 800; padding: 5px 15px; border-bottom-left-radius: 20px; border-top-right-radius: 25px;">RECOMENDADO</div>
                <div class="plan-name" style="color: #60A5FA;">Premium</div>
                <div class="plan-price">R$ 19,90 <small>/m√™s</small></div>
                <ul class="feature-list">
                    <li style="color: #4ADE80; font-weight: 800; background: rgba(74, 222, 128, 0.1); padding: 8px; border-radius: 8px; border: 1px solid rgba(74, 222, 128, 0.2);"><i class="fas fa-robot"></i> Monitoramento Din√¢mico (Rob√¥)</li>
                    <li><i class="fas fa-check"></i> <b>Tudo do plano Basic</b></li>
                    <li><i class="fas fa-check"></i> Lucro Real (+ Custos Fixos)</li>
                    <li><i class="fas fa-check"></i> Livro de Revis√µes em PDF</li>
                    <li><i class="fas fa-check"></i> Gest√£o de IPVA, Seguro e Aluguel</li>
                    <li><i class="fas fa-check"></i> Recibos Profissionais</li>
                    <li><i class="fas fa-check"></i> Suporte VIP WhatsApp</li>
                    <li><i class="fas fa-check"></i> Meta Semanal Inteligente</li>
                    <li><i class="fas fa-check"></i> Relat√≥rios Avan√ßados (PDF)</li>
                </ul>
                <a href="/register" class="btn-plan btn-premium">TESTAR GR√ÅTIS</a>
            </div>
        </div>
    </section>

    <footer style="text-align: center; padding: 40px; color: var(--text-dim); font-size: 12px; border-top: 1px solid rgba(255,255,255,0.05);">
        <p>&copy; 2025 Motorista Pro. Todos os direitos reservados.</p>
        <a href="/termos" style="color: inherit; text-decoration: none;">Termos de Uso</a>
    </footer>

</body>
</html>

==================== FIM ARQUIVO: app/templates/landing.html ====================

==================== INICIO ARQUIVO: app/templates/offline.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sem Conex√£o</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; text-align: center; padding: 20px;
            background: var(--bg-body); color: var(--text-main);
        }
        .icon-box {
            font-size: 50px; color: var(--text-secondary); margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        h2 { margin: 0 0 10px 0; font-weight: 800; }
        p { margin: 0 0 30px 0; font-size: 14px; color: var(--text-secondary); max-width: 300px; }
    </style>
</head>
<body>
    <div class="icon-box">üì°</div>
    <h2>Voc√™ est√° offline</h2>
    <p>Verifique sua conex√£o com a internet para acessar os dados mais recentes.</p>
    
    <button onclick="window.location.reload()" class="btn" style="width: auto; padding: 12px 30px; border-radius: 50px;">
        Tentar Novamente
    </button>
</body>
</html>



==================== FIM ARQUIVO: app/templates/offline.html ====================

==================== INICIO ARQUIVO: app/templates/editar_manutencao.html ====================
{% extends 'base.html' %}

{% block content %}
<div class="header">
    <a href="/manutencao" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <h2 style="margin:0;">Editar Manuten√ß√£o</h2>
</div>

<form method="post" class="container" style="padding-top:20px;">
    <div class="card">
        <div class="card-title">Detalhes</div>
        
        <label>Item</label>
        <input type="text" name="item" value="{{ manutencao.item }}" required>
        
        <label>Od√¥metro Alvo (KM)</label>
        <input type="number" step="0.1" name="km_proxima" value="{{ manutencao.km_proxima }}" required>
        <small style="color:var(--text-muted); display:block; margin-top:5px;">
            Od√¥metro Atual: {{ "%.0f"|format(odo_atual) }} km.<br>
            Faltam: {{ "%.0f"|format(manutencao.km_proxima - odo_atual) }} km.
        </small>
    </div>

    <button type="submit" class="btn btn-primary">SALVAR ALTERA√á√ïES</button>
</form>
{% endblock %}



==================== FIM ARQUIVO: app/templates/editar_manutencao.html ====================

==================== INICIO ARQUIVO: app/templates/admin_tests.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultado dos Testes</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background: #1B254B; color: white; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 24px; }
        .btn-back { background: rgba(255,255,255,0.1); color: white; text-decoration: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; }
        pre { background: black; color: #00FF00; padding: 20px; border-radius: 10px; overflow-x: auto; font-family: monospace; line-height: 1.5; white-space: pre-wrap; font-size: 12px; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-weight: bold; text-transform: uppercase; font-size: 14px; }
        .bg-sucesso { background: #05CD99; color: black; }
        .bg-erro { background: #EE5D50; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>Diagn√≥stico</h1>
                <p style="opacity: 0.7;">Resultado dos testes automatizados.</p>
            </div>
            <a href="/admin/dashboard" class="btn-back">Voltar</a>
        </div>

        <div style="margin-bottom: 15px;">
            Status: 
            <span class="status-badge bg-{{ status }}">
                {{ "APROVADO" if status == "sucesso" else "FALHOU" }}
            </span>
        </div>

        <pre>{{ output }}</pre>
    </div>
</body>
</html>




==================== FIM ARQUIVO: app/templates/admin_tests.html ====================

==================== INICIO ARQUIVO: app/templates/macros.html ====================
<!-- 1. HERO CARD -->
{% macro card_hero(lucro, ganho, despesa, tipo, valor) %}
<div class="glass-card fade-in hero-clickable" onclick="window.location.href='/lucro_real?tipo={{ tipo }}&valor={{ valor }}'" style="animation-delay: 0.1s; padding-bottom: 20px; cursor: pointer; position: relative; overflow: hidden;">
    
    <div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary);"></div>

    <div class="hero-val-container">
        <div class="hero-label">Lucro Operacional</div>
        <div class="hero-value">
            <span class="hero-currency">R$</span>{{ "%.2f"|format(lucro) }}
        </div>
        
        <div class="hero-hint">
            {% if current_user.plan_type == 'basic' %}
                <i class="fas fa-lock" style="font-size: 10px;"></i> Ver Lucro Real (Descontos)
            {% else %}
                Ver An√°lise de Lucro Real <i class="fas fa-chevron-right" style="font-size: 9px;"></i>
            {% endif %}
        </div>
    </div>
    <div class="hero-footer-sutil">
        <div class="hf-item">
            <span class="hf-lbl">Faturamento</span>
            <span class="hf-val val-green">R$ {{ "%.0f"|format(ganho) }}</span>
        </div>
        <div class="hf-item">
            <span class="hf-lbl">Despesas</span>
            <span class="hf-val val-red">R$ {{ "%.0f"|format(despesa) }}</span>
        </div>
    </div>
</div>
{% endmacro %}

<!-- 2. TIMER -->
{% macro card_timer_glass() %}
<div class="timer-glass fade-in" style="animation-delay: 0.15s;">
    <div class="tm-left">
        <div class="tm-icon"><i class="fas fa-stopwatch"></i></div>
        <div>
            <div class="tm-label">Tempo em Rota</div>
            <div id="displayTimer" class="tm-display">00:00:00</div>
        </div>
    </div>
    <div style="display:flex; align-items:center;">
        <button id="btnMain" class="btn-tm-play" onclick="toggleTimer()"><i class="fas fa-play"></i></button>
        <button id="btnStop" class="btn-tm-stop" onclick="stopTimer()" style="display:none;"><i class="fas fa-stop"></i></button>
    </div>
</div>
{% endmacro %}

<!-- 3. WIDGETS -->
{% macro card_tri_widgets(km, horas, corridas) %}
<div class="widget-grid fade-in" style="animation-delay: 0.2s;">
    <div class="widget-card">
        <div class="wc-icon"><i class="fas fa-clock"></i></div>
        <span class="wc-val">{{ horas|float_to_time }}h</span>
        <span class="wc-lbl">Horas</span>
    </div>
    <div class="widget-card">
        <div class="wc-icon"><i class="fas fa-car"></i></div>
        <span class="wc-val">{{ corridas }}</span>
        <span class="wc-lbl">Corridas</span>
    </div>
    <div class="widget-card">
        <div class="wc-icon"><i class="fas fa-road"></i></div>
        <span class="wc-val">{{ "%.0f"|format(km) }}</span>
        <span class="wc-lbl">KM</span>
    </div>
</div>
{% endmacro %}

<!-- 4. META (SMART GOAL V2) -->
{% macro card_meta_full(acumulado, meta, smart) %}
<div class="glass-card fade-in" id="cardMeta" style="animation-delay: 0.25s;">
    <div class="card-title" onclick="toggleMeta()" style="cursor:pointer;">
        <span>Meta Semanal <i class="fas fa-pen" style="font-size:10px; opacity:0.5;"></i></span>
        <span style="color:var(--primary);">{{ "%.0f"|format(acumulado/meta*100) if meta > 0 else 0 }}%</span>
    </div>
    <div id="metaEdit" style="display:none; margin-bottom:10px;">
        <form action="/atualizar_meta" method="POST" style="display:flex; gap:10px;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
            <input type="number" step="0.01" name="nova_meta" value="{{ meta }}" placeholder="Nova meta">
            <button type="submit" class="btn-tm-play" style="width:auto; padding:0 15px; border-radius:10px;"><i class="fas fa-check"></i></button>
        </form>
    </div>
    <div style="height:10px; background:rgba(0,0,0,0.05); border-radius:10px; overflow:hidden; margin-bottom:8px;">
        <div style="height:100%; background:var(--primary-gradient); width: {{ (acumulado / meta * 100) if meta > 0 and acumulado < meta else 100 }}%"></div>
    </div>
    <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:700; color:var(--text-main);">
        <span>R$ {{ "%.0f"|format(acumulado) }}</span>
        <span style="opacity:0.6;">Alvo: R$ {{ "%.0f"|format(meta) }}</span>
    </div>
    
    <!-- L√ìGICA INTELIGENTE v2 -->
    {% if smart %}
        <div style="margin-top:15px; font-size:11px; color:var(--text-secondary); background:rgba(255,255,255,0.5); padding:10px; border-radius:12px; display:flex; align-items:center; gap:8px; line-height: 1.4;">
            {% if smart.status == 'concluido' or smart.status == 'superavit' %}
                <i class="fas fa-check-circle" style="color:var(--success); font-size: 14px;"></i>
            {% elif smart.status == 'sem_meta' %}
                <i class="fas fa-info-circle" style="color:var(--warning); font-size: 14px;"></i>
            {% else %}
                <i class="fas fa-bullseye" style="color:var(--primary); font-size: 14px;"></i>
            {% endif %}

            {% if current_user.plan_type == 'basic' %}
                <span style="opacity:0.8;">Feedback Di√°rio Inteligente: <b style="color:var(--text-main);">Premium</b></span>
                <i class="fas fa-lock" style="font-size:10px; margin-left:auto; color:var(--primary);"></i>
            {% else %}
                <span>{{ smart.msg }}</span>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endmacro %}

<!-- 5. PERFORMANCE -->
{% macro card_performance_avg(m) %}
<div class="glass-card fade-in" style="animation-delay: 0.3s;">
    <div class="card-title"><span>Performance M√©dia</span></div>
    <table class="perf-table">
        <thead><tr><th>M√©trica</th><th>Faturamento</th><th>Lucro</th></tr></thead>
        <tbody>
            <tr><td>Por Dia</td><td>R$ {{ "%.2f"|format(m.ganho_dia) }}</td><td class="val-profit">R$ {{ "%.2f"|format(m.lucro_dia) }}</td></tr>
            <tr><td>Por KM</td><td>R$ {{ "%.2f"|format(m.ganho_km) }}</td><td class="val-profit">R$ {{ "%.2f"|format(m.lucro_km) }}</td></tr>
            <tr><td>Por Hora</td><td>R$ {{ "%.2f"|format(m.ganho_h) }}</td><td class="val-profit">R$ {{ "%.2f"|format(m.lucro_h) }}</td></tr>
            <tr><td>Por Corrida</td><td>R$ {{ "%.2f"|format(m.ganho_corr) }}</td><td class="val-profit">R$ {{ "%.2f"|format(m.lucro_corr) }}</td></tr>
        </tbody>
    </table>
</div>
{% endmacro %}

<!-- 6. GR√ÅFICO DESPESAS -->
{% macro card_despesas_chart(dados_rosca) %}
{% if dados_rosca and (dados_rosca[0] > 0 or dados_rosca[1] > 0 or dados_rosca[2] > 0) %}
<div class="glass-card fade-in" style="animation-delay: 0.35s;">
    <div class="card-title"><span>Gastos do Per√≠odo</span></div>
    
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div class="chart-container" style="height: 110px; width: 110px; margin: 0;">
            <canvas id="chartDespesas"></canvas>
        </div>
        
        <div style="flex: 1; padding-left: 20px;">
            <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:8px; align-items: center;">
                <span><i class="fas fa-circle" style="font-size:8px; color:#F59E0B; margin-right:5px;"></i> Combust√≠vel</span>
                <b>R$ {{ "%.0f"|format(dados_rosca[0]) }}</b>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:8px; align-items: center;">
                <span><i class="fas fa-circle" style="font-size:8px; color:#EF4444; margin-right:5px;"></i> Alimenta√ß√£o</span>
                <b>R$ {{ "%.0f"|format(dados_rosca[1]) }}</b>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:11px; align-items: center;">
                <span><i class="fas fa-circle" style="font-size:8px; color:#64748B; margin-right:5px;"></i> Manuten√ß√£o</span>
                <b>R$ {{ "%.0f"|format(dados_rosca[2]) }}</b>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endmacro %}

<!-- 7. MANUTEN√á√ÉO DASHBOARD -->
{% macro card_manutencao_glass(lista) %}
<div class="glass-card fade-in" style="animation-delay: 0.4s;">
    <div class="card-title"><span>Manuten√ß√£o</span><a href="/manutencao" style="font-size:11px; color:var(--primary); text-decoration:none; font-weight:700;">VER TUDO</a></div>
    {% if lista %}
        {% for item in lista %}
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed rgba(0,0,0,0.05);">
            <div style="display:flex; align-items:center; gap:12px;">
                <div style="width:35px; height:35px; border-radius:10px; background:{{ 'rgba(239,68,68,0.1)' if item.urgencia == 'critica' else 'rgba(245,158,11,0.1)' }}; color:{{ 'var(--danger)' if item.urgencia == 'critica' else 'var(--warning)' }}; display:flex; align-items:center; justify-content:center; font-size:14px;"><i class="fas fa-wrench"></i></div>
                <div>
                    <div style="font-weight:700; font-size:13px; color:var(--text-main);">{{ item.item }}</div>
                    <div style="font-size:11px; color:var(--text-secondary);">
                        {% if current_user.plan_type == 'basic' %}
                            <span style="filter: blur(2px);">25/10</span> <i class="fas fa-lock" style="font-size:8px;"></i>
                        {% else %}
                            {{ item.previsao_txt }}
                        {% endif %}
                    </div>
                </div>
            </div>
            <div style="text-align:right;"><span style="font-size:10px; color:var(--text-secondary); display:block;">Faltam</span><span style="font-weight:800; font-size:13px; color:var(--text-main);">{{ "%.0f"|format(item.falta_km) }} km</span></div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align:center; padding:15px; color:var(--text-secondary); font-size:13px;"><i class="fas fa-check-circle" style="color:var(--success); font-size:24px; margin-bottom:5px;"></i><p style="margin:0;">Tudo em dia!</p></div>
    {% endif %}
</div>
{% endmacro %}




==================== FIM ARQUIVO: app/templates/macros.html ====================

==================== INICIO ARQUIVO: app/templates/admin_business.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEO Dashboard - Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4318FF; --secondary: #A3AED0; --success: #05CD99; --warning: #FFB547; --danger: #EE5D50; --bg: #F4F7FE; --card: #FFFFFF; --text: #2B3674; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { margin: 0; font-size: 24px; font-weight: 700; }
        .btn-back { background: var(--card); color: var(--text); padding: 10px 20px; border-radius: 12px; text-decoration: none; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; align-items: center; gap: 5px; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .kpi-title { font-size: 12px; color: var(--secondary); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .kpi-val { font-size: 28px; font-weight: 800; color: var(--text); }
        .kpi-sub { font-size: 11px; color: var(--secondary); margin-top: 5px; font-weight: 500; }
        .kpi-icon { position: absolute; right: 20px; top: 20px; font-size: 35px; opacity: 0.1; }

        .card-mrr { border-left: 5px solid var(--success); }
        .card-risk { border-left: 5px solid var(--danger); }
        
        .breakdown-row { display: flex; gap: 15px; font-size: 11px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
        .bd-item { display: flex; align-items: center; gap: 5px; font-weight: 600; }
        
        .section-title { font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 15px; margin-top: 30px; display:flex; justify-content:space-between; align-items:center; }

        .chart-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); height: 350px; display: flex; flex-direction: column; }
        .chart-title { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 20px; flex-shrink: 0; }
        .chart-wrapper { flex: 1; position: relative; min-height: 0; width: 100%; }

        .ranking-list { background: var(--card); border-radius: 20px; padding: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .ranking-item:last-child { border-bottom: none; }
        .rank-pos { width: 30px; height: 30px; background: #E9EDF7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); margin-right: 15px; }
        .rank-pos.gold { background: #FFD700; color: white; }
        .rank-info h4 { margin: 0; font-size: 14px; font-weight: 700; }
        .rank-info p { margin: 2px 0 0 0; font-size: 11px; color: var(--secondary); }
        .rank-value { font-weight: 800; color: var(--success); }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Painel Executivo</h1>
            <p style="margin:0; font-size:12px; color:var(--secondary);">M√©tricas de Neg√≥cio em Tempo Real</p>
        </div>
        <a href="/admin/dashboard" class="btn-back"><i class="fas fa-arrow-left"></i> Gest√£o Operacional</a>
    </div>

    <!-- ROW 1: RECEITA -->
    <div class="kpi-grid">
        <div class="kpi-card card-mrr">
            <div class="kpi-title">MRR L√≠quido (Mensal)</div>
            <div class="kpi-val">R$ {{ "%.2f"|format(mrr_liquido) }}</div>
            <div class="breakdown-row">
                <span class="bd-item" style="color: #64748B;"><i class="fas fa-user"></i> Basic: R$ {{ "%.2f"|format(mrr_basic) }}</span>
                <span class="bd-item" style="color: var(--primary);"><i class="fas fa-crown"></i> Pro: R$ {{ "%.2f"|format(mrr_premium) }}</span>
            </div>
            <i class="fas fa-chart-line kpi-icon" style="color:var(--success);"></i>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-title">Assinantes Ativos</div>
            <div class="kpi-val">{{ count_basic + count_premium }}</div>
            <div class="breakdown-row">
                <span class="bd-item">{{ count_basic }} Basic</span>
                <span class="bd-item">{{ count_premium }} Premium</span>
            </div>
            <i class="fas fa-users kpi-icon" style="color:var(--primary);"></i>
        </div>

        <div class="kpi-card">
            <div class="kpi-title">ARR Projetado (Anual)</div>
            <div class="kpi-val">R$ {{ "%.2f"|format(arr) }}</div>
            <div class="kpi-sub">Baseado no MRR atual</div>
            <i class="fas fa-globe kpi-icon" style="color:#9C27B0;"></i>
        </div>
        
        <div class="kpi-card card-risk">
            <div class="kpi-title">Risco de Churn</div>
            <div class="kpi-val" style="color:var(--danger);">{{ qtd_risco }}</div>
            <div class="kpi-sub">Assinantes inativos > 7 dias</div>
            <i class="fas fa-exclamation-triangle kpi-icon" style="color:var(--danger);"></i>
        </div>
    </div>

    <!-- ROW 2: OPERACIONAL -->
    <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr;">
        <div class="kpi-card">
            <div class="kpi-title">LTV (Valor Vital√≠cio)</div>
            <div class="kpi-val">R$ {{ "%.2f"|format(ltv) }}</div>
            <i class="fas fa-gem kpi-icon" style="color:#E91E63;"></i>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Stickiness (Engajamento)</div>
            <div class="kpi-val">{{ "%.1f"|format(stickiness) }}%</div>
            <i class="fas fa-magnet kpi-icon" style="color:var(--warning);"></i>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Ganho M√©dio/KM (Plataforma)</div>
            <div class="kpi-val">R$ {{ "%.2f"|format(media_reais_km) }}</div>
            <i class="fas fa-tachometer-alt kpi-icon" style="color:#607D8B;"></i>
        </div>
    </div>

    <!-- ROW 3: GR√ÅFICOS -->
    <div class="chart-row">
        <div class="chart-container">
            <div class="chart-title">Distribui√ß√£o de Planos</div>
            <div class="chart-wrapper">
                <canvas id="planChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Origem de Ganhos (Market Share)</div>
            <div class="chart-wrapper">
                <canvas id="shareChart"></canvas>
            </div>
        </div>
    </div>

    <div class="section-title">
        <span>Crescimento (Novos Usu√°rios - 15 dias)</span>
    </div>
    <div class="chart-container" style="height: 280px; margin-bottom: 30px;">
        <div class="chart-wrapper">
            <canvas id="growthChart"></canvas>
        </div>
    </div>

    <div class="section-title">
        <span>Top 5 Power Users</span>
    </div>
    <div class="ranking-list">
        {% for u in top_users %}
        <div class="ranking-item">
            <div style="display:flex; align-items:center;">
                <div class="rank-pos {{ 'gold' if loop.index == 1 else '' }}">{{ loop.index }}</div>
                <div class="rank-info">
                    <h4>{{ u.nome }}</h4>
                    <p>{{ u.email }}</p>
                </div>
            </div>
            <div style="text-align:right;">
                <div class="rank-value">R$ {{ "%.2f"|format(u.total_ganho) }}</div>
                <div style="font-size:10px; color:var(--secondary);">{{ u.dias_uso }} dias lan√ßados</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        Chart.defaults.font.family = "'Outfit', sans-serif";
        Chart.defaults.color = '#A3AED0';
        Chart.defaults.maintainAspectRatio = false;

        // 1. Plan Distribution (NOVO)
        new Chart(document.getElementById('planChart'), {
            type: 'doughnut',
            data: {
                labels: ['Basic (R$ 9,90)', 'Premium (R$ 19,90)'],
                datasets: [{
                    data: [{{ count_basic }}, {{ count_premium }}],
                    backgroundColor: ['#94A3B8', '#4318FF'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                cutout: '65%',
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } }
            }
        });

        // 2. Growth Chart
        new Chart(document.getElementById('growthChart'), {
            type: 'line',
            data: {
                labels: {{ growth_labels|tojson }},
                datasets: [{
                    label: 'Novos Cadastros',
                    data: {{ growth_values|tojson }},
                    borderColor: '#4318FF',
                    backgroundColor: 'rgba(67, 24, 255, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#4318FF'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { borderDash: [5, 5] } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 3. Market Share
        new Chart(document.getElementById('shareChart'), {
            type: 'pie',
            data: {
                labels: ['Uber', '99', 'Particular', 'Outros'],
                datasets: [{
                    data: {{ share_data|tojson }},
                    backgroundColor: ['#000000', '#FFBB00', '#05CD99', '#4318FF'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8, font: { size: 11 } } } }
            }
        });
    </script>
</body>
</html>



==================== FIM ARQUIVO: app/templates/admin_business.html ====================

==================== INICIO ARQUIVO: app/templates/maintenance.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Em Manuten√ß√£o - Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4318FF; --dark: #0B1437; }
        body {
            margin: 0; padding: 20px; font-family: 'Outfit', sans-serif;
            background-color: var(--dark); color: white;
            height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .icon-box {
            width: 100px; height: 100px; background: rgba(255,255,255,0.1);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: #FFB547; margin-bottom: 30px;
            animation: pulse 2s infinite;
        }
        h1 { font-size: 28px; margin: 0 0 10px 0; }
        p { opacity: 0.7; font-size: 16px; line-height: 1.5; max-width: 400px; margin: 0 auto 30px auto; }
        .loader {
            width: 48px; height: 48px; border: 5px solid #FFF;
            border-bottom-color: var(--primary); border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 181, 71, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255, 181, 71, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 181, 71, 0); } }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-refresh {
            background: var(--primary); color: white; border: none; padding: 12px 30px;
            border-radius: 20px; font-weight: bold; cursor: pointer; text-decoration: none;
            margin-top: 20px; display: inline-block;
        }
    </style>
</head>
<body>
    <div class="icon-box"><i class="fas fa-tools"></i></div>
    <h1>Estamos Melhorando!</h1>
    <p>O Motorista Pro est√° passando por uma atualiza√ß√£o r√°pida para trazer novidades. Voltaremos em alguns instantes.</p>
    <span class="loader"></span>
    <br>
    <a href="/" class="btn-refresh" onclick="window.location.reload(); return false;">Tentar Novamente</a>
</body>
</html>



==================== FIM ARQUIVO: app/templates/maintenance.html ====================

==================== INICIO ARQUIVO: app/templates/conquistas.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    .ach-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    
    .badge-card {
        background: var(--glass-bg); border: var(--glass-border);
        border-radius: 16px; padding: 15px 5px; text-align: center;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        min-height: 100px; transition: transform 0.2s; position: relative;
    }
    .badge-card:active { transform: scale(0.95); }
    .badge-card.locked { opacity: 0.5; background: rgba(0,0,0,0.03); filter: grayscale(1); }
    
    .badge-icon { font-size: 32px; margin-bottom: 8px; }
    .badge-name { font-size: 10px; font-weight: 700; line-height: 1.2; color: var(--text-main); height: 24px; display: flex; align-items: center; justify-content: center; }
    
    .mini-prog { width: 80%; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; margin-top: 5px; overflow: hidden; }
    .mini-fill { height: 100%; background: var(--success); }

    #detailModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
    .detail-card { width:85%; max-width:300px; background:white; border-radius:25px; padding:30px; text-align:center; position:relative; animation: popIn 0.3s; }
    @keyframes popIn { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Conquistas</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary); font-weight: 500;">
            {{ total_unlocked }} / {{ total_all }} Desbloqueadas
        </p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 50px; animation-delay: 0.1s;">

    {% macro render_grid(lista, titulo) %}
    {% if lista %}
        <div style="font-size:12px; font-weight:800; color:var(--text-secondary); text-transform:uppercase; margin: 20px 0 10px 5px;">{{ titulo }}</div>
        <div class="ach-grid">
            {% for b in lista %}
            <div class="badge-card {{ 'unlocked' if b.unlocked else 'locked' }}" 
                 onclick="openDetail('{{ b.nome }}', '{{ b.descricao }}', '{{ b.icone }}', {{ 'true' if b.unlocked else 'false' }}, '{{ b.current }}', '{{ b.target }}')">
                <div class="badge-icon">{{ b.icone }}</div>
                <div class="badge-name">{{ b.nome }}</div>
                {% if not b.unlocked and b.target > 1 %}
                    <div class="mini-prog"><div class="mini-fill" style="width: {{ b.progress }}%"></div></div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    {% endif %}
    {% endmacro %}

    {{ render_grid(categorias['iniciante'], 'Iniciante') }}
    {{ render_grid(categorias['habito'], 'H√°bitos') }}
    {{ render_grid(categorias['financeiro'], 'Alta Performance') }}
    {{ render_grid(categorias['ferramentas'], 'Explorador') }}
    {{ render_grid(categorias['master'], 'Elite') }}

</div>

<div id="detailModal" onclick="this.style.display='none'">
    <div class="detail-card" onclick="event.stopPropagation()">
        <div id="dtIcon" style="font-size:60px; margin-bottom:15px;"></div>
        <h3 id="dtName" style="margin:0 0 10px 0; color:var(--text-main); font-size:18px;"></h3>
        <p id="dtDesc" style="color:var(--text-secondary); font-size:13px; margin-bottom:20px; line-height:1.5;"></p>
        
        <div id="dtProgress" style="display:none; background:var(--bg-body); padding:15px; border-radius:15px;">
            <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:bold; margin-bottom:5px;"><span>Progresso</span><span id="dtProgText"></span></div>
            <div style="height:8px; background:#ddd; border-radius:4px; overflow:hidden;"><div id="dtBar" style="height:100%; background:var(--success); width:0%;"></div></div>
        </div>
        
        <div id="dtStatus" style="margin-top:20px; font-weight:800; color:var(--success); display:none;"><i class="fas fa-check-circle"></i> CONQUISTADO</div>
    </div>
</div>

{% block extra_js %}
<script>
    function openDetail(name, desc, icon, unlocked, cur, tgt) {
        document.getElementById('dtIcon').innerText = icon;
        document.getElementById('dtName').innerText = name;
        document.getElementById('dtDesc').innerText = desc;
        
        const progArea = document.getElementById('dtProgress');
        const statusArea = document.getElementById('dtStatus');
        
        if (unlocked) {
            progArea.style.display = 'none'; statusArea.style.display = 'block';
            document.getElementById('dtIcon').style.filter = 'none'; document.getElementById('dtIcon').style.opacity = '1';
        } else {
            statusArea.style.display = 'none';
            document.getElementById('dtIcon').style.filter = 'grayscale(1)'; document.getElementById('dtIcon').style.opacity = '0.5';
            
            if (tgt && tgt > 1) {
                progArea.style.display = 'block';
                const pct = Math.min(100, (cur / tgt) * 100);
                document.getElementById('dtBar').style.width = pct + '%';
                document.getElementById('dtProgText').innerText = `${cur} / ${tgt}`;
            } else { progArea.style.display = 'none'; }
        }
        document.getElementById('detailModal').style.display = 'flex';
    }
</script>
{% endblock %}
{% endblock %}



==================== FIM ARQUIVO: app/templates/conquistas.html ====================

==================== INICIO ARQUIVO: app/templates/indique.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    .golden-ticket {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 20px; position: relative; overflow: hidden;
        color: white; text-align: center; padding: 30px 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 25px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .golden-ticket::before, .golden-ticket::after {
        content: ''; position: absolute; top: 50%; width: 20px; height: 20px;
        background: var(--bg-body); border-radius: 50%; transform: translateY(-50%);
    }
    .golden-ticket::before { left: -10px; }
    .golden-ticket::after { right: -10px; }
    .ticket-dashed-line {
        position: absolute; top: 50%; left: 20px; right: 20px; height: 1px;
        border-top: 2px dashed rgba(255,255,255,0.1); transform: translateY(-50%); z-index: 0;
    }
    .ticket-top { position: relative; z-index: 1; margin-bottom: 30px; }
    .ticket-bottom { position: relative; z-index: 1; }
    .discount-val { font-size: 42px; font-weight: 800; color: #fbbf24; text-shadow: 0 2px 10px rgba(251, 191, 36, 0.3); line-height: 1; margin-bottom: 5px; }
    .discount-label { font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.6); font-weight: 700; }
    .code-box {
        background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3);
        padding: 12px; border-radius: 12px; display: inline-flex;
        align-items: center; gap: 15px; margin-top: 10px; cursor: pointer; transition: 0.2s;
    }
    .code-box:active { transform: scale(0.98); background: rgba(255,255,255,0.15); }
    .my-code { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 700; letter-spacing: 1px; color: white; }
    
    .btn-rules-discrete {
        font-size: 11px; color: rgba(255,255,255,0.5); text-decoration: underline;
        margin-top: 15px; cursor: pointer; display: block; transition: 0.2s;
    }
    .btn-rules-discrete:hover { color: rgba(255,255,255,0.8); }

    .share-grid { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-bottom: 30px; }
    .btn-whatsapp { background: #25D366; color: white; border: none; border-radius: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; box-shadow: 0 8px 20px rgba(37, 211, 102, 0.25); font-size: 14px; padding: 15px; }
    .btn-copy { background: white; color: var(--text-main); border: 1px solid rgba(0,0,0,0.05); border-radius: 16px; width: 50px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

    .referral-list { margin-top: 20px; }
    .ref-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border-radius: 16px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .ref-avatar { width: 35px; height: 35px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--text-secondary); font-size: 14px; margin-right: 10px; }
    .ref-info h4 { margin: 0; font-size: 13px; font-weight: 700; color: var(--text-main); }
    .ref-info p { margin: 0; font-size: 11px; color: var(--text-secondary); }
    .ref-status { font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 6px; }
    .st-ok { background: #dcfce7; color: #166534; }
    .st-wait { background: #fff7ed; color: #9a3412; }

    .sheet-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4999; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(2px); }
    .sheet-overlay.open { display: block; opacity: 1; }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-body); border-radius: 25px 25px 0 0; padding: 25px; box-shadow: 0 -10px 40px rgba(0,0,0,0.3); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 5000; max-height: 80vh; overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.5); }
    .bottom-sheet.open { transform: translateY(0); }
    .sheet-handle { width: 40px; height: 5px; background: #cbd5e1; border-radius: 10px; margin: 0 auto 20px auto; opacity: 0.5; }
    .rule-item { display: flex; gap: 15px; margin-bottom: 20px; }
    .rule-num { width: 28px; height: 28px; background: var(--primary-light); color: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; flex-shrink: 0; }
    .rule-content h4 { margin: 0 0 3px 0; font-size: 13px; color: var(--text-main); font-weight: 700; }
    .rule-content p { margin: 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4; }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Convites</h2>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 120px; animation-delay: 0.1s;">
    
    <div class="golden-ticket">
        <div class="ticket-dashed-line"></div>
        <div class="ticket-top">
            <div class="discount-val">50% OFF</div>
            <div class="discount-label">Na sua mensalidade</div>
        </div>
        <div class="ticket-bottom">
            <p style="font-size:12px; color:rgba(255,255,255,0.7); margin-bottom:10px;">Para cada amigo que assinar o Premium</p>
            <div class="code-box" onclick="copyCode()">
                <span class="my-code" id="myCode">{{ code }}</span>
                <i class="far fa-copy" style="font-size:14px; opacity:0.7;"></i>
            </div>
            <span class="btn-rules-discrete" onclick="openRules()">Ver regras detalhadas</span>
        </div>
    </div>

    <div class="share-grid">
        <a href="https://wa.me/?text=Fala!%20To%20usando%20o%20Motorista%20Pro%20pra%20controlar%20o%20lucro%20real.%20Usa%20meu%20codigo%20{{ code }}%20pra%20ganhar%20moral:%20https://motorista-pro-app.onrender.com/register?ref={{ code }}" target="_blank" class="btn-whatsapp">
            <i class="fab fa-whatsapp"></i> Enviar no WhatsApp
        </a>
        <button class="btn-copy" onclick="copyCode()">
            <i class="fas fa-link"></i>
        </button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:30px;">
        <div class="glass-card" style="padding:15px; margin:0; text-align:center;">
            <span style="font-size:10px; font-weight:700; color:var(--text-secondary); text-transform:uppercase;">Indica√ß√µes</span>
            <div style="font-size:20px; font-weight:800; color:var(--text-main);">{{ total }}</div>
        </div>
        <div class="glass-card" style="padding:15px; margin:0; text-align:center;">
            <span style="font-size:10px; font-weight:700; color:var(--text-secondary); text-transform:uppercase;">Economia</span>
            <div style="font-size:20px; font-weight:800; color:var(--success);">R$ {{ "%.0f"|format(ganhos) }}</div>
        </div>
    </div>

    <div class="referral-list">
        <h4 style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; margin-bottom:10px; margin-left:5px;">Hist√≥rico</h4>
        {% if ultimos %}
            {% for u in ultimos %}
            <div class="ref-item">
                <div style="display:flex; align-items:center;">
                    <div class="ref-avatar">{{ u.nome[:1] }}</div>
                    <div class="ref-info">
                        <h4>{{ u.nome.split()[0] }}</h4>
                        <p>{{ u.data_cadastro.strftime('%d/%m/%Y') }}</p>
                    </div>
                </div>
                {% if u.referral_bonus_given %}
                    <span class="ref-status st-ok">ATIVO</span>
                {% else %}
                    <span class="ref-status st-wait">PENDENTE</span>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align:center; padding:30px; opacity:0.5; font-size:13px; color:var(--text-secondary);">
                Nenhuma indica√ß√£o ainda.
            </div>
        {% endif %}
    </div>
</div>

<div class="sheet-overlay" id="sheetOverlay" onclick="closeRules()"></div>
<div class="bottom-sheet" id="rulesSheet">
    <div class="sheet-handle"></div>
    <h3 style="text-align:center; margin:0 0 25px 0; font-size:18px; color:var(--text-main);">Como Funciona</h3>
    <div class="rule-item"><div class="rule-num">1</div><div class="rule-content"><h4>Envie o C√≥digo</h4><p>Seu amigo precisa digitar seu c√≥digo no momento do cadastro.</p></div></div>
    <div class="rule-item"><div class="rule-num">2</div><div class="rule-content"><h4>Amigo Assina</h4><p>O b√¥nus √© ativado quando ele faz o primeiro pagamento.</p></div></div>
    <div class="rule-item"><div class="rule-num">3</div><div class="rule-content"><h4>Voc√™ Ganha</h4><p>50% de desconto √© aplicado automaticamente na sua pr√≥xima renova√ß√£o.</p></div></div>
    <div style="background:var(--primary-light); padding:15px; border-radius:15px; font-size:11px; color:var(--primary); line-height:1.5; margin-top:10px;"><b>Dica Pro:</b> Acumule indica√ß√µes! Se 2 amigos assinarem, voc√™ garante 2 meses com desconto.</div>
    <button onclick="closeRules()" class="btn" style="width:100%; margin-top:25px; border-radius:50px;">Entendi</button>
</div>

<script>
    function copyCode() {
        const code = document.getElementById('myCode').innerText;
        navigator.clipboard.writeText(code).then(() => { window.showToast("C√≥digo copiado!"); });
    }
    function openRules() { document.getElementById('sheetOverlay').classList.add('open'); document.getElementById('rulesSheet').classList.add('open'); }
    function closeRules() { document.getElementById('sheetOverlay').classList.remove('open'); document.getElementById('rulesSheet').classList.remove('open'); }
</script>
{% endblock %}




==================== FIM ARQUIVO: app/templates/indique.html ====================

==================== INICIO ARQUIVO: app/templates/user_data.html ====================
{% extends 'base.html' %}

{% block content %}
<div class="header fade-in">
    <a href="/configuracoes" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Dados Pessoais</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary);">Mantenha seu perfil atualizado</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 100px; animation-delay: 0.1s;">
    
    <!-- CARD DE PERFIL -->
    <div class="glass-card" style="text-align:center; padding:30px 20px;">
        <div style="position:relative; width:80px; height:80px; margin:0 auto 15px auto;">
            <div style="width:100%; height:100%; border-radius:50%; overflow:hidden; background:var(--glass-bg); border:var(--glass-border); box-shadow:var(--glass-shadow); display:flex; align-items:center; justify-content:center;">
                {% if current_user.profile_image %}
                    <img id="avatarPreview" src="{{ current_user.profile_image }}" style="width:100%; height:100%; object-fit:cover;">
                {% else %}
                    <i class="fas fa-user" style="font-size:35px; color:var(--primary);"></i>
                    <img id="avatarPreview" src="" style="display:none; width:100%; height:100%; object-fit:cover;">
                {% endif %}
            </div>
            
            <!-- Bot√£o C√¢mera -->
            <button onclick="document.getElementById('fileAvatar').click()" style="position:absolute; bottom:0; right:0; background:var(--primary); color:white; border:2px solid white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                <i class="fas fa-camera" style="font-size:12px;"></i>
            </button>
            <input type="file" id="fileAvatar" accept="image/*" style="display:none;">
        </div>
        
        <p style="font-size:12px; color:var(--text-secondary);">Toque na c√¢mera para alterar a foto.</p>
        <div id="avatarLoader" style="display:none; font-size:12px; color:var(--primary); margin-top:5px;"><i class="fas fa-spinner fa-spin"></i> Enviando...</div>
    </div>

    <!-- FORMUL√ÅRIO -->
    <form action="/update_user_data" method="POST" class="glass-card">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div style="margin-bottom:20px;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">NOME COMPLETO</label>
            <input type="text" name="nome" value="{{ current_user.nome }}" required placeholder="Seu nome">
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
            <div>
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">NASCIMENTO</label>
                <!-- Formata a data para o input value (YYYY-MM-DD) -->
                <input type="date" name="data_nascimento" value="{{ current_user.data_nascimento.strftime('%Y-%m-%d') if current_user.data_nascimento else '' }}" style="font-weight:700;">
            </div>
            <div>
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">WHATSAPP</label>
                <input type="tel" name="whatsapp" value="{{ current_user.whatsapp or '' }}" placeholder="(00) 00000-0000">
            </div>
        </div>

        <div style="margin-bottom:10px;">
            <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">ENDERE√áO</label>
            <input type="text" name="endereco" value="{{ current_user.endereco or '' }}" placeholder="Rua, N√∫mero, Bairro">
        </div>
    </form>
    
    <button type="submit" form="0" onclick="document.querySelector('form').submit()" class="btn" style="border-radius:50px; padding:18px; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);">
        <i class="fas fa-check"></i> Salvar Altera√ß√µes
    </button>

</div>

{% block extra_js %}
<script src="{{ url_for('static', filename='js/profile_upload.js') }}"></script>
{% endblock %}
{% endblock %}




==================== FIM ARQUIVO: app/templates/user_data.html ====================

==================== INICIO ARQUIVO: app/templates/security_settings.html ====================
{% extends 'base.html' %}

{% block content %}
<div class="header fade-in">
    <a href="/configuracoes" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Seguran√ßa</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary);">Prote√ß√£o da Conta</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in" style="padding-top: 10px; padding-bottom: 100px; animation-delay: 0.1s;">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div style="padding:15px; border-radius:15px; margin-bottom:20px; font-size:13px; font-weight:600; text-align:center; 
                    background: {{ 'rgba(16, 185, 129, 0.15)' if category == 'success' else 'rgba(239, 68, 68, 0.15)' }};
                    color: {{ 'var(--success)' if category == 'success' else 'var(--danger)' }};
                    border: 1px solid {{ 'var(--success)' if category == 'success' else 'var(--danger)' }};">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ALTERAR E-MAIL -->
    <div class="glass-card">
        <div class="card-title"><span>E-mail de Acesso</span></div>
        <form action="/update_email" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div style="margin-bottom:15px;">
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">E-MAIL ATUAL</label>
                <input type="text" value="{{ current_user.email }}" disabled style="opacity:0.6; background:rgba(0,0,0,0.05);">
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">NOVO E-MAIL</label>
                <input type="email" name="new_email" required placeholder="exemplo@email.com">
            </div>
            
            <button type="submit" class="btn" style="padding:14px; font-size:13px; background:var(--glass-bg); color:var(--text-main); border:1px solid rgba(0,0,0,0.1); box-shadow:none;">Atualizar E-mail</button>
        </form>
    </div>

    <!-- ALTERAR SENHA -->
    <div class="glass-card">
        <div class="card-title"><span>Alterar Senha</span></div>
        <form action="/update_password" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div style="margin-bottom:15px;">
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">SENHA ATUAL</label>
                <input type="password" name="current_password" required placeholder="Digite sua senha atual">
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="font-size:10px; font-weight:700; color:var(--text-secondary); margin-bottom:5px; display:block;">NOVA SENHA</label>
                <input type="password" name="new_password" required minlength="6" placeholder="M√≠nimo 6 caracteres">
            </div>
            
            <button type="submit" class="btn" style="padding:14px; font-size:13px;">Definir Nova Senha</button>
        </form>
    </div>
    
    <div style="text-align:center; margin-top:30px;">
        <p style="font-size:11px; color:var(--text-secondary);">
            <i class="fas fa-lock"></i> Seus dados est√£o protegidos por criptografia de ponta.
        </p>
    </div>

</div>
{% endblock %}



==================== FIM ARQUIVO: app/templates/security_settings.html ====================

==================== INICIO ARQUIVO: app/templates/relatorio_pdf.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio Operacional - Motorista Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; padding: 40px; color: #0F172A; max-width: 800px; margin: 0 auto; position: relative; }
        
        /* Layout A4 */
        @page { size: A4; margin: 2cm; }
        @media print { 
            body { padding: 0; -webkit-print-color-adjust: exact; } 
            .no-print { display: none; } 
        }

        /* --- MARCA D'√ÅGUA --- */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            opacity: 0.06; /* Transpar√™ncia bem sutil */
            z-index: -1;
            text-align: center;
            width: 100%;
            pointer-events: none;
        }
        .wm-logo { width: 250px; height: 250px; margin-bottom: 20px; filter: grayscale(100%); }
        .wm-text { font-size: 60px; font-weight: 800; color: #000; text-transform: uppercase; letter-spacing: 5px; margin: 0; }

        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #E2E8F0; padding-bottom: 20px; position: relative; z-index: 10; }
        .logo { font-size: 24px; font-weight: 800; color: #2563EB; margin-bottom: 5px; }
        .meta { font-size: 12px; color: #64748B; }

        .section-title { font-size: 14px; font-weight: 700; text-transform: uppercase; color: #64748B; margin: 30px 0 15px 0; border-bottom: 1px solid #E2E8F0; padding-bottom: 5px; }

        .grid-kpi { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; position: relative; z-index: 10; }
        .kpi-box { background: rgba(248, 250, 252, 0.9); padding: 15px; border-radius: 10px; border: 1px solid #E2E8F0; }
        .kpi-label { font-size: 11px; font-weight: 700; color: #64748B; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .kpi-val { font-size: 20px; font-weight: 800; color: #0F172A; }
        .val-green { color: #16A34A; }
        .val-red { color: #DC2626; }
        .val-blue { color: #2563EB; }

        .table-clean { width: 100%; border-collapse: collapse; font-size: 12px; position: relative; z-index: 10; }
        .table-clean th { padding: 8px 0; border-bottom: 1px solid #CBD5E1; color: #64748B; }
        .table-clean td { padding: 10px 0; border-bottom: 1px dashed #E2E8F0; }
        
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        .footer { margin-top: 50px; text-align: center; font-size: 10px; color: #94A3B8; border-top: 1px solid #E2E8F0; padding-top: 20px; position: relative; z-index: 10; }
        
        .btn-print { 
            position: fixed; top: 20px; right: 20px; 
            background: #2563EB; color: white; border: none; 
            padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100;
        }
    </style>
</head>
<body>
    <button onclick="window.print()" class="no-print btn-print">üñ®Ô∏è Imprimir / Salvar PDF</button>

    <!-- MARCA D'√ÅGUA -->
    <div class="watermark">
        <img src="/static/icons/icon-512.png" alt="Logo" class="wm-logo">
        <h1 class="wm-text">MOTORISTA PRO</h1>
    </div>

    <div class="header">
        <div class="logo">Motorista Pro</div>
        <div class="meta">Relat√≥rio Operacional Anal√≠tico</div>
        <div class="meta">Per√≠odo: {{ periodo }} | Gerado em: {{ hoje }}</div>
        <div class="meta">Motorista: {{ nome }}</div>
    </div>

    <!-- RESUMO FINANCEIRO -->
    <div class="section-title">Performance Financeira</div>
    <div class="grid-kpi">
        <div class="kpi-box">
            <span class="kpi-label">Faturamento Bruto</span>
            <span class="kpi-val val-green">R$ {{ "%.2f"|format(dados.ganho) }}</span>
        </div>
        <div class="kpi-box">
            <span class="kpi-label">Despesas Operacionais</span>
            <span class="kpi-val val-red">R$ {{ "%.2f"|format(dados.despesa) }}</span>
        </div>
        <div class="kpi-box">
            <span class="kpi-label">Lucro Operacional</span>
            <span class="kpi-val val-blue">R$ {{ "%.2f"|format(dados.operacional) }}</span>
        </div>
        <div class="kpi-box">
            <span class="kpi-label">Lucro L√≠quido Real</span>
            <span class="kpi-val">R$ {{ "%.2f"|format(dados.lucro_real) }}</span>
            <div style="font-size:9px; color:#64748B; margin-top:2px;">(Ap√≥s Reserva T√©cnica sugerida de R$ {{ "%.2f"|format(dados.reserva) }})</div>
        </div>
    </div>

    <!-- PRODUTIVIDADE -->
    <div class="section-title">Produtividade</div>
    <table class="table-clean" style="margin-bottom: 30px;">
        <tr>
            <td>Quilometragem Total</td>
            <td class="text-right"><b>{{ "%.1f"|format(dados.km) }} km</b></td>
        </tr>
        <tr>
            <td>Horas Trabalhadas</td>
            <td class="text-right"><b>{{ "%.1f"|format(dados.horas) }}h</b></td>
        </tr>
        <tr>
            <td>Total de Corridas</td>
            <td class="text-right"><b>{{ dados.corridas }}</b></td>
        </tr>
        <tr>
            <td>M√©dia por Hora</td>
            <td class="text-right">R$ {{ "%.2f"|format(dados.media_hora) }} / h</td>
        </tr>
        <tr>
            <td>M√©dia por KM</td>
            <td class="text-right">R$ {{ "%.2f"|format(dados.media_km) }} / km</td>
        </tr>
    </table>

    <!-- DETALHAMENTO POR APP -->
    <div class="section-title">Detalhamento por Plataforma</div>
    <table class="table-clean">
        <thead>
            <tr>
                <th class="text-left">Plataforma</th>
                <th class="text-center">Faturamento</th>
                <th class="text-center">Corridas</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Uber</td>
                <td class="text-center">R$ {{ "%.2f"|format(apps.uber_val) }}</td>
                <td class="text-center">{{ apps.uber_qtd }}</td>
            </tr>
            <tr>
                <td>99 Pop</td>
                <td class="text-center">R$ {{ "%.2f"|format(apps.pop_val) }}</td>
                <td class="text-center">{{ apps.pop_qtd }}</td>
            </tr>
            <tr>
                <td>Particular</td>
                <td class="text-center">R$ {{ "%.2f"|format(apps.part_val) }}</td>
                <td class="text-center">{{ apps.part_qtd }}</td>
            </tr>
            <tr>
                <td>{{ custom_name }}</td>
                <td class="text-center">R$ {{ "%.2f"|format(apps.out_val) }}</td>
                <td class="text-center">{{ apps.out_qtd }}</td>
            </tr>
        </tbody>
    </table>

    <div class="footer">
        Documento gerado automaticamente pela plataforma Motorista Pro.<br>
        motoristapro.app
    </div>

    <script>
        window.onload = function() { window.print(); }
    </script>
</body>
</html>



==================== FIM ARQUIVO: app/templates/relatorio_pdf.html ====================

==================== INICIO ARQUIVO: app/templates/relatorio_manutencao_pdf.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Livro de Revis√µes - Motorista Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; padding: 40px; color: #0F172A; max-width: 800px; margin: 0 auto; position: relative; }
        @page { size: A4; margin: 2cm; }
        @media print { 
            body { padding: 0; -webkit-print-color-adjust: exact; } 
            .no-print { display: none; } 
        }

        /* --- MARCA D'√ÅGUA --- */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            opacity: 0.06;
            z-index: -1;
            text-align: center;
            width: 100%;
            pointer-events: none;
        }
        .wm-logo { width: 250px; height: 250px; margin-bottom: 20px; filter: grayscale(100%); }
        .wm-text { font-size: 60px; font-weight: 800; color: #000; text-transform: uppercase; letter-spacing: 5px; margin: 0; }

        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #E2E8F0; padding-bottom: 20px; position: relative; z-index: 10; }
        .logo { font-size: 24px; font-weight: 800; color: #2563EB; margin-bottom: 5px; }
        .meta { font-size: 12px; color: #64748B; }

        .vehicle-info { background: rgba(248, 250, 252, 0.9); padding: 20px; border-radius: 10px; border: 1px solid #E2E8F0; margin-bottom: 30px; text-align: center; position: relative; z-index: 10; }
        .v-title { font-size: 11px; text-transform: uppercase; font-weight: 700; color: #64748B; display: block; margin-bottom: 5px; }
        .v-car { font-size: 18px; font-weight: 800; }

        .section-title { font-size: 14px; font-weight: 700; text-transform: uppercase; color: #64748B; margin: 30px 0 15px 0; border-bottom: 1px solid #E2E8F0; padding-bottom: 5px; }

        .table-clean { width: 100%; border-collapse: collapse; font-size: 12px; position: relative; z-index: 10; }
        .table-clean th { padding: 10px 5px; border-bottom: 2px solid #CBD5E1; color: #64748B; text-align: left; }
        .table-clean td { padding: 12px 5px; border-bottom: 1px dashed #E2E8F0; }
        
        .footer { margin-top: 50px; text-align: center; font-size: 10px; color: #94A3B8; border-top: 1px solid #E2E8F0; padding-top: 20px; position: relative; z-index: 10; }
        
        .btn-print { 
            position: fixed; top: 20px; right: 20px; 
            background: #2563EB; color: white; border: none; 
            padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100;
        }
    </style>
</head>
<body>
    <button onclick="window.print()" class="no-print btn-print">üñ®Ô∏è Imprimir / Salvar PDF</button>

    <!-- MARCA D'√ÅGUA -->
    <div class="watermark">
        <img src="/static/icons/icon-512.png" alt="Logo" class="wm-logo">
        <h1 class="wm-text">MOTORISTA PRO</h1>
    </div>

    <div class="header">
        <div class="logo">Motorista Pro</div>
        <div class="meta">Livro Digital de Manuten√ß√£o</div>
        <div class="meta">Gerado em: {{ hoje }}</div>
        <div class="meta">Propriet√°rio: {{ nome }}</div>
    </div>

    <div class="vehicle-info">
        <span class="v-title">Ve√≠culo Registrado</span>
        <div class="v-car">{{ veiculo.marca }} {{ veiculo.modelo }} ({{ veiculo.ano }})</div>
    </div>

    <div class="section-title">Hist√≥rico de Servi√ßos</div>
    
    {% if logs %}
    <table class="table-clean">
        <thead>
            <tr>
                <th width="25%">Data</th>
                <th width="40%">Item / Servi√ßo</th>
                <th width="20%">KM no Ato</th>
                <th width="15%">Custo</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.service_date.strftime('%d/%m/%Y') }}</td>
                <td><b>{{ log.item_name }}</b></td>
                <td>{{ "%.0f"|format(log.service_km) }} km</td>
                <td>R$ {{ "%.2f"|format(log.cost or 0) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p style="text-align:center; color:#94A3B8; margin-top:30px;">Nenhum registro de manuten√ß√£o encontrado.</p>
    {% endif %}

    <div class="footer">
        Documento gerado automaticamente pela plataforma Motorista Pro.<br>
        motoristapro.app
    </div>

    <script>
        window.onload = function() { window.print(); }
    </script>
</body>
</html>




==================== FIM ARQUIVO: app/templates/relatorio_manutencao_pdf.html ====================

==================== INICIO ARQUIVO: app/templates/ocr_page.html ====================
{% extends 'base.html' %}

{% block extra_css %}
<style>
    .ocr-container { max-width: 600px; margin: 0 auto; padding-bottom: 120px; }
    
    /* ANIMA√á√ïES */
    @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* BOT√ÉO INICIAR MONITORAMENTO (DESTAQUE TOTAL) */
    .btn-start-robot {
        background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
        color: white; width: 100%; padding: 30px 20px; border-radius: 25px;
        font-weight: 900; font-size: 18px; border: none; cursor: pointer;
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        box-shadow: 0 15px 40px rgba(37, 99, 235, 0.3); margin-bottom: 30px;
        position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 1px;
        animation: pulse-glow 2s infinite; text-decoration: none;
    }
    .btn-start-robot i { font-size: 32px; margin-bottom: 5px; }
    .btn-start-robot small { font-size: 11px; font-weight: 600; opacity: 0.8; text-transform: none; letter-spacing: 0; }
    .btn-start-robot:active { transform: scale(0.98); animation: none; }

    /* CARD CONFIGURA√á√ÉO */
    .config-card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05); }
    .config-header { font-size: 13px; font-weight: 800; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
    
    .range-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .input-box label { font-size: 10px; font-weight: 700; color: var(--text-secondary); display: block; margin-bottom: 5px; text-transform: uppercase; }
    .input-box input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; font-weight: 700; color: var(--text-main); font-size: 16px; outline: none; transition: 0.2s; }
    .input-box input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    
    .input-box.good input { border-color: #86efac; color: #166534; background: #f0fdf4; }
    .input-box.bad input { border-color: #fca5a5; color: #991b1b; background: #fef2f2; }

    .mid-range-alert { text-align: center; font-size: 11px; color: #D97706; background: #FFFBEB; padding: 10px; border-radius: 12px; margin-top: 10px; border: 1px dashed #FCD34D; }

    /* RODAP√â E NAVEGA√á√ÉO */
    .footer-nav { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); animation: slideUp 0.5s ease-out; }
    .footer-q { font-size: 13px; color: var(--text-secondary); margin-bottom: 15px; font-weight: 600; }
    .btn-link { background: white; color: var(--text-main); border: 1px solid #e2e8f0; padding: 12px 25px; border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 12px; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
    .btn-link:hover { background: #f8fafc; border-color: #cbd5e1; }

    /* DOWNLOAD PAGE */
    .download-hero { text-align: center; padding: 40px 25px; background: white; border-radius: 25px; margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
    .btn-download { background: #10B981; color: white; width: 100%; padding: 20px; border-radius: 18px; font-weight: 800; font-size: 16px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 15px 40px rgba(16, 185, 129, 0.3); margin: 25px 0; transition: transform 0.2s; }
    .btn-download:active { transform: scale(0.97); }
    
    .install-steps { background: #F8FAFC; border-radius: 20px; padding: 25px; text-align: left; border: 1px solid #e2e8f0; }
    .step { display: flex; gap: 15px; margin-bottom: 25px; position: relative; }
    .step:last-child { margin-bottom: 0; }
    .step::after { content: ''; position: absolute; left: 15px; top: 35px; bottom: -20px; width: 2px; background: #e2e8f0; z-index: 0; }
    .step:last-child::after { display: none; }
    .step-num { width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; flex-shrink: 0; position: relative; z-index: 1; box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
    .step-content h4 { margin: 0 0 5px 0; font-size: 14px; font-weight: 700; color: var(--text-main); }
    .step-content p { margin: 0; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }

    /* ABAS */
    .view-section { display: none; }
    .view-section.active { display: block; animation: slideUp 0.3s ease-out; }

    /* BASIC UPSELL */
    .upsell-box { text-align: center; padding: 50px 20px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 30px; color: white; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .btn-upgrade { background: linear-gradient(90deg, #F59E0B 0%, #D97706 100%); color: white; padding: 18px 35px; border-radius: 50px; text-decoration: none; font-weight: 800; display: inline-block; margin-top: 25px; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4); }
</style>
{% endblock %}

{% block content %}
<div class="header fade-in">
    <a href="/" class="back-btn"><i class="fas fa-chevron-left"></i></a>
    <div style="flex-grow: 1; text-align: center;">
        <h2 style="margin:0; font-size:18px; color:var(--text-main); font-weight: 800;">Rob√¥</h2>
        <p style="margin:0; font-size:12px; color:var(--text-secondary);">Monitoramento Din√¢mico</p>
    </div>
    <div style="width:40px;"></div>
</div>

<div class="container fade-in ocr-container" style="padding-top: 20px;">

    <!-- ================= BASIC PLAN (BLOQUEADO) ================= -->
    {% if current_user.plan_type == 'basic' %}
    <div class="upsell-box">
        <div style="width:80px; height:80px; background:rgba(255,255,255,0.1); border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-bottom:20px;">
            <i class="fas fa-lock" style="font-size: 40px; color: #F59E0B;"></i>
        </div>
        <h2 style="margin:0 0 10px 0;">Recurso Profissional</h2>
        <p style="opacity: 0.8; margin-bottom: 10px; line-height: 1.6; font-size: 14px;">
            O Monitoramento Din√¢mico l√™ a tela do seu celular e calcula o lucro real (R$/KM e R$/Hora) instantaneamente.
        </p>
        <p style="font-size:12px; opacity:0.6;">Dispon√≠vel apenas no plano Premium.</p>
        <a href="/assinar" class="btn-upgrade">QUERO VIRAR PREMIUM</a>
    </div>
    
    <!-- ================= PREMIUM PLAN (LIBERADO) ================= -->
    {% else %}

    <!-- VIEW 1: PAINEL DE CONTROLE (START + CONFIG) -->
    <div id="viewConfig" class="view-section active">
        
        <!-- BOT√ÉO GIGANTE DE INICIAR -->
        <button onclick="startRobot()" class="btn-start-robot">
            <i class="fas fa-power-off"></i> 
            <span>INICIAR MONITORAMENTO</span>
            <small>Toque para abrir a bolha flutuante</small>
        </button>

        <!-- CONFIG R$/KM -->
        <div class="config-card">
            <div class="config-header"><i class="fas fa-road" style="color:var(--primary);"></i> Par√¢metros de Dist√¢ncia</div>
            <div class="range-inputs">
                <div class="input-box good">
                    <label>Corrida Boa (Acima)</label>
                    <div style="position:relative;">
                        <span style="position:absolute; left:10px; top:12px; font-size:12px; opacity:0.5;">R$</span>
                        <input type="number" id="good_km" step="0.1" value="2.0">
                    </div>
                </div>
                <div class="input-box bad">
                    <label>Corrida Ruim (Abaixo)</label>
                    <div style="position:relative;">
                        <span style="position:absolute; left:10px; top:12px; font-size:12px; opacity:0.5;">R$</span>
                        <input type="number" id="bad_km" step="0.1" value="1.5">
                    </div>
                </div>
            </div>
            <div class="mid-range-alert">
                Corridas entre <b>R$ <span id="lbl_bad_km">1.5</span></b> e <b>R$ <span id="lbl_good_km">2.0</span></b> ser√£o marcadas como <b>M√âDIAS</b> (Amarelo).
            </div>
        </div>

        <!-- CONFIG R$/HORA -->
        <div class="config-card">
            <div class="config-header"><i class="fas fa-clock" style="color:var(--primary);"></i> Par√¢metros de Tempo</div>
            <div class="range-inputs">
                <div class="input-box good">
                    <label>Hora Boa (Acima)</label>
                    <div style="position:relative;">
                        <span style="position:absolute; left:10px; top:12px; font-size:12px; opacity:0.5;">R$</span>
                        <input type="number" id="good_hour" step="1" value="60">
                    </div>
                </div>
                <div class="input-box bad">
                    <label>Hora Ruim (Abaixo)</label>
                    <div style="position:relative;">
                        <span style="position:absolute; left:10px; top:12px; font-size:12px; opacity:0.5;">R$</span>
                        <input type="number" id="bad_hour" step="1" value="40">
                    </div>
                </div>
            </div>
        </div>

        <button onclick="saveSettings()" id="btnSave" class="btn" style="width:100%; border-radius:50px; background:var(--text-main); color:white; font-weight:800; padding: 18px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
            <i class="fas fa-save"></i> SALVAR CONFIGURA√á√ïES
        </button>

        <!-- RODAP√â DE NAVEGA√á√ÉO -->
        <div class="footer-nav">
            <div class="footer-q">Ainda n√£o tem o App instalado?</div>
            <div onclick="switchView('download')" class="btn-link">
                <i class="fab fa-android" style="color:#10B981; font-size:16px;"></i>
                BAIXAR E INSTALAR AGORA
            </div>
        </div>
    </div>

    <!-- VIEW 2: DOWNLOAD E INSTALA√á√ÉO -->
    <div id="viewDownload" class="view-section">
        <div class="download-hero">
            <div style="width:70px; height:70px; background:rgba(16,185,129,0.1); border-radius:50%; display:inline-flex; align-items:center; justify-content:center; color:#10B981; font-size:30px; margin-bottom:20px;">
                <i class="fas fa-robot"></i>
            </div>
            <h3 style="margin:0 0 10px 0; color:var(--text-main); font-weight:800;">App Motorista Pro</h3>
            <p style="font-size:13px; color:var(--text-secondary); line-height:1.6; margin-bottom:20px;">
                Esta √© a vers√£o especial instalada no seu celular que permite o <b>Monitoramento Din√¢mico</b>. Ela cria uma bolha inteligente sobre os apps de corrida.
            </p>

            <a href="{{ url_for('static', filename='motoristapro-v1766578470.apk') }}" class="btn-download" download>
                <i class="fas fa-download"></i> INICIAR DOWNLOAD
            </a>
            
            <p style="font-size:11px; color:#94A3B8;">Vers√£o 2.0 ‚Ä¢ Android 8+</p>
        </div>

        <div class="install-steps">
            <div style="font-weight:800; color:var(--text-main); margin-bottom:25px; font-size:16px;">Passo a Passo de Instala√ß√£o:</div>
            
            <div class="step">
                <div class="step-num">1</div>
                <div class="step-content">
                    <h4>Baixe o Arquivo</h4>
                    <p>Toque no bot√£o verde "INICIAR DOWNLOAD" acima. Aguarde o arquivo baixar no seu celular.</p>
                </div>
            </div>
            <div class="step">
                <div class="step-num">2</div>
                <div class="step-content">
                    <h4>Abra o APK</h4>
                    <p>Quando terminar, toque na notifica√ß√£o "Download conclu√≠do" ou v√° at√© a pasta "Downloads" e toque em <b>motoristapro-ocr.apk</b>.</p>
                </div>
            </div>
            <div class="step">
                <div class="step-num">3</div>
                <div class="step-content">
                    <h4>Autorize a Instala√ß√£o</h4>
                    <p>Se o Android mostrar um aviso de seguran√ßa, toque em <b>Configura√ß√µes</b> e ative a op√ß√£o <b>"Permitir desta fonte"</b>.</p>
                </div>
            </div>
            <div class="step">
                <div class="step-num">4</div>
                <div class="step-content">
                    <h4>Entre na sua Conta</h4>
                    <p>Abra o app instalado (√≠cone azul) e fa√ßa login com seu e-mail e senha.</p>
                </div>
            </div>
        </div>

        <div class="footer-nav">
            <div class="footer-q">J√° fez a instala√ß√£o?</div>
            <div onclick="switchView('config')" class="btn-link">
                <i class="fas fa-sliders-h"></i> VOLTAR PARA CONFIGURA√á√ïES
            </div>
        </div>
    </div>

    {% endif %}
</div>

{% if current_user.plan_type == 'premium' %}
<script>
    // Atualiza labels visuais quando digita
    const inBad = document.getElementById('bad_km');
    const inGood = document.getElementById('good_km');
    const lblBad = document.getElementById('lbl_bad_km');
    const lblGood = document.getElementById('lbl_good_km');

    if(inBad && inGood) {
        inBad.addEventListener('input', () => lblBad.innerText = inBad.value);
        inGood.addEventListener('input', () => lblGood.innerText = inGood.value);
    }

    function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        if(viewName === 'download') document.getElementById('viewDownload').classList.add('active');
        else document.getElementById('viewConfig').classList.add('active');
        window.scrollTo(0,0);
    }

    function startRobot() {
        // Verifica se est√° rodando dentro do WebView do Android
        if (window.MotoristaProAndroid) {
            window.MotoristaProAndroid.requestPermission();
        } else {
            // Se estiver no Chrome/Browser comum
            const go = confirm("Para iniciar o rob√¥, voc√™ precisa estar dentro do App Android instalado.\n\nDeseja ir para a tela de download?");
            if(go) switchView('download');
        }
    }

    function saveSettings() {
        const btn = document.getElementById('btnSave');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
        
        const data = {
            good_km: document.getElementById('good_km').value,
            bad_km: document.getElementById('bad_km').value,
            good_hour: document.getElementById('good_hour').value,
            bad_hour: document.getElementById('bad_hour').value
        };

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch('/save_ocr_settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(data)
        }).then(r => r.json()).then(res => {
            if(res.status === 'ok') {
                btn.innerHTML = '<i class="fas fa-check"></i> SUCESSO!';
                btn.style.background = "#10B981";
                
                // Sincronia em tempo real com Android
                if (window.MotoristaProAndroid) {
                    window.MotoristaProAndroid.updateConfig(
                        parseFloat(data.good_km), parseFloat(data.bad_km),
                        parseFloat(data.good_hour), parseFloat(data.bad_hour)
                    );
                }
                
                setTimeout(() => { 
                    btn.innerHTML = oldText; 
                    btn.style.background = "var(--text-main)"; 
                }, 2000);
            } else {
                alert("Erro ao salvar.");
                btn.innerHTML = oldText;
            }
        });
    }
</script>
{% endif %}

<script>
    // Sincroniza√ß√£o Autom√°tica ao Carregar a P√°gina
    document.addEventListener("DOMContentLoaded", function() {
        // Pega valores injetados pelo Backend (Jinja2)
        const gKm = parseFloat("{{ good_km }}");
        const bKm = parseFloat("{{ bad_km }}");
        const gHr = parseFloat("{{ good_hour }}");
        const bHr = parseFloat("{{ bad_hour }}");

        // Preenche os inputs visuais
        const iGKm = document.getElementById('good_km');
        if(iGKm) {
            iGKm.value = gKm;
            document.getElementById('bad_km').value = bKm;
            document.getElementById('good_hour').value = gHr;
            document.getElementById('bad_hour').value = bHr;
        }

        // ENVIA PARA O ANDROID IMEDIATAMENTE
        if (window.MotoristaProAndroid) {
            console.log("Sincronizando configs com Android...");
            window.MotoristaProAndroid.updateConfig(gKm, bKm, gHr, bHr);
        }
    });
</script>

{% endblock %}

==================== FIM ARQUIVO: app/templates/ocr_page.html ====================

==================== INICIO ARQUIVO: app/templates/email/activate.html ====================
<!DOCTYPE html>
<html>
<body style="font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px;">
    <div style="max-width: 600px; margin: 0 auto; background: #ffffff; padding: 30px; border-radius: 10px; text-align: center;">
        <h2 style="color: #4318FF;">Bem-vindo ao Motorista Pro!</h2>
        <p>Ol√°, {{ nome }}.</p>
        <p>Para ativar sua conta e come√ßar a usar o sistema, clique no bot√£o abaixo:</p>
        <a href="{{ confirm_url }}" style="background-color: #05CD99; color: white; padding: 15px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block; margin: 20px 0;">ATIVAR MINHA CONTA</a>
        <p style="font-size: 12px; color: #999;">Ou cole este link no navegador: {{ confirm_url }}</p>
    </div>
</body>
</html>



==================== FIM ARQUIVO: app/templates/email/activate.html ====================

==================== INICIO ARQUIVO: app/templates/email/reset_instructions.html ====================
<!DOCTYPE html>
<html>
<body style="font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px;">
    <div style="max-width: 600px; margin: 0 auto; background: #ffffff; padding: 30px; border-radius: 10px; text-align: center;">
        <h2 style="color: #4318FF;">Recupera√ß√£o de Senha</h2>
        <p>Ol√°, {{ nome }}.</p>
        <p>Recebemos um pedido para alterar sua senha. Clique abaixo para criar uma nova:</p>
        <a href="{{ reset_url }}" style="background-color: #4318FF; color: white; padding: 15px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block; margin: 20px 0;">CRIAR NOVA SENHA</a>
        <p style="font-size: 12px; color: #999;">Se n√£o foi voc√™, ignore este e-mail.</p>
    </div>
</body>
</html>



==================== FIM ARQUIVO: app/templates/email/reset_instructions.html ====================

==================== INICIO ARQUIVO: app/templates/errors/404.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota n√£o encontrada</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; background: var(--bg-body); }
        .glass-card { max-width: 350px; padding: 40px 30px; border-top: 4px solid var(--warning); }
        .icon-box { font-size: 60px; color: var(--warning); margin-bottom: 20px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
    </style>
</head>
<body>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="glass-card">
        <div class="icon-box"><i class="fas fa-map-signs"></i></div>
        
        <h1 style="margin:0 0 10px 0; color:var(--text-main); font-size:28px; font-weight:800;">Eita, GPS perdido!</h1>
        
        <p style="margin:0 0 30px 0; font-size:14px; color:var(--text-secondary); line-height:1.5;">
            Parece que voc√™ pegou uma entrada errada. Essa p√°gina (404) n√£o existe no nosso mapa.
        </p>
        
        <a href="/" class="btn" style="border-radius:50px; background: var(--primary-gradient);">
            <i class="fas fa-route"></i> Recalcular Rota (In√≠cio)
        </a>
    </div>
</body>
</html>




==================== FIM ARQUIVO: app/templates/errors/404.html ====================

==================== INICIO ARQUIVO: app/templates/errors/500.html ====================
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pane no Motor</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; background: var(--bg-body); }
        .glass-card { max-width: 350px; padding: 40px 30px; border-top: 4px solid var(--danger); }
        .icon-box { font-size: 60px; color: var(--danger); margin-bottom: 20px; animation: shake 0.5s; animation-iteration-count: 3; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
    </style>
</head>
<body>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="glass-card">
        <div class="icon-box"><i class="fas fa-car-crash"></i></div>
        
        <h1 style="margin:0 0 10px 0; color:var(--text-main); font-size:28px; font-weight:800;">O motor pifou!</h1>
        
        <p style="margin:0 0 30px 0; font-size:14px; color:var(--text-secondary); line-height:1.5;">
            Tivemos uma falha interna no servidor (Erro 500). Nossos mec√¢nicos de TI j√° foram acionados para consertar o problema.
        </p>
        
        <a href="/" class="btn" style="border-radius:50px; background: var(--text-main);">
            <i class="fas fa-sync-alt"></i> Tentar dar a partida
        </a>
    </div>
</body>
</html>




==================== FIM ARQUIVO: app/templates/errors/500.html ====================

==================== INICIO ARQUIVO: app/templates/partials/dashboard_content.html ====================
{% import 'macros.html' as m with context %}

<!-- FILTRO DE DATA (3 BOT√ïES) -->
<div class="filter-group fade-in">
    
    <!-- DIA -->
    <div class="filter-btn {{ 'active' if tipo == 'dia' else '' }}" id="btn-dia">
        <span class="fb-label">DIA</span>
        <span class="fb-value">{{ filter_label if tipo == 'dia' else 'Filtrar' }}</span>
        <input type="date" class="filter-input" onchange="submitDate(this.value, 'dia')">
    </div>

    <!-- SEMANA (AGORA √â SELECT LISTA DE SEMANAS) -->
    <div class="filter-btn {{ 'active' if tipo == 'semana' else '' }}" id="btn-semana">
        <span class="fb-label">SEMANA</span>
        <span class="fb-value">{{ filter_label|safe if tipo == 'semana' else 'Filtrar' }}</span>
        
        <!-- SELECT COM LISTA DE SEMANAS FORMATADAS -->
        <select onchange="submitDate(this.value, 'semana')" class="filter-input">
            <option value="" disabled selected>{{ filter_label if tipo == 'semana' else 'Selecione a Semana' }}</option>
            {% for week in week_options %}
                <option value="{{ week.value }}" {% if tipo == 'semana' and valor == week.value %}selected{% endif %}>
                    {{ week.label }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- M√äS -->
    <div class="filter-btn {{ 'active' if tipo == 'mes' else '' }}" id="btn-mes">
        <span class="fb-label">M√äS</span>
        <span class="fb-value">{{ filter_label if tipo == 'mes' else 'Filtrar' }}</span>
        <input type="month" class="filter-input" onchange="submitDate(this.value, 'mes')">
    </div>

</div>

<!-- C√ÅLCULO META COM CORRE√á√ÉO DE TIPO -->
{% set meta_pct = 0 %}
{% if meta > 0 %}
    {% set meta_pct = (lucro_acumulado|float / meta|float * 100)|round|int %}
{% endif %}

{% if meta_pct > 100 %}{% set meta_pct = 100 %}{% endif %}

<!-- CARDS -->
{{ m.card_hero(lucro_operacional, resumo.ganho, resumo.despesa, tipo, valor) }}
{{ m.card_timer_glass() }}

<!-- WIDGETS HORIZONTAIS -->
<div class="widget-grid fade-in" style="animation-delay: 0.2s;">
    <div class="widget-card">
        <div class="wc-icon"><i class="fas fa-clock"></i></div>
        <span class="wc-val">{{ resumo.horas|float_to_time }}h</span>
        <span class="wc-lbl">Horas</span>
    </div>
    <div class="widget-card">
        <div class="wc-icon"><i class="fas fa-car"></i></div>
        <span class="wc-val">{{ resumo.corridas }}</span>
        <span class="wc-lbl">Corridas</span>
    </div>
    <div class="widget-card">
        <div class="wc-icon"><i class="fas fa-road"></i></div>
        <span class="wc-val">{{ "%.0f"|format(resumo.km) }}</span>
        <span class="wc-lbl">KM</span>
    </div>
</div>

{{ m.card_meta_full(lucro_acumulado, meta, smart_goal) }}
{{ m.card_performance_avg(metricas) }}
{{ m.card_despesas_chart(dados_rosca) }}
{{ m.card_manutencao_glass(lista_manutencao) }}

<!-- SCRIPTS -->
<script>
    function toggleMeta() { const e = document.getElementById('metaEdit'); if(e) e.style.display = e.style.display==='block'?'none':'block'; }

    function submitDate(valor, tipo) {
        if(!valor) return;
        window.location.href = `/?tipo=${tipo}&valor=${valor}`;
    }
    
    function openPicker(tipo) {
        if(tipo === 'semana') return; 
        const el = document.querySelector(`.filter-btn.active input[type=${tipo === 'dia' ? 'date' : 'month'}]`);
        if(el && el.showPicker) el.showPicker();
        else if(el) el.click();
    }

    (function initCharts() {
        try {
            Chart.helpers.each(Chart.instances, function(i){ if(i.canvas.id==="chartDespesas"){i.destroy();} });
            const ctxPie = document.getElementById('chartDespesas');
            if(ctxPie && {{ dados_rosca|tojson }}.some(x => x > 0)) { 
                new Chart(ctxPie, { 
                    type: 'doughnut', 
                    data: { labels: ['Comb','Alim','Manu'], datasets: [{ data: {{ dados_rosca|tojson }}, backgroundColor: ['#F59E0B','#EF4444','#64748B'], borderWidth: 0, hoverOffset: 4 }] }, 
                    options: { cutout: '70%', plugins: { legend: { display: false } }, maintainAspectRatio: false, responsive: true } 
                }); 
            }
        } catch(e) { console.error(e); }
    })();

    (function initTimer() {
        const display=document.getElementById('displayTimer');const btnMain=document.getElementById('btnMain');const btnStop=document.getElementById('btnStop');
        if(!window.currentUserId) window.currentUserId="{{ current_user.id }}";
        const timerKeyState='timerState_'+window.currentUserId;
        const timerKeyStart='startTime_'+window.currentUserId;
        const timerKeyPaused='elapsedPaused_'+window.currentUserId;
        
        if(window.timerInterval) clearInterval(window.timerInterval);
        
        function fmt(ms){ const s=Math.floor(ms/1000);const h=Math.floor(s/3600);const m=Math.floor((s%3600)/60);const sec=Math.floor(s%60); return`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}` }
        
        window.upd=function(){
            const st=localStorage.getItem(timerKeyState)||'stopped';
            if(st==='running'){ display.innerText=fmt(Date.now()-parseInt(localStorage.getItem(timerKeyStart))); btnMain.innerHTML='<i class="fas fa-pause"></i>'; if(btnStop) btnStop.style.display='flex'; }
            else if(st==='paused'){ display.innerText=fmt(parseInt(localStorage.getItem(timerKeyPaused))); btnMain.innerHTML='<i class="fas fa-play"></i>'; if(btnStop) btnStop.style.display='flex'; }
            else{ display.innerText="00:00:00"; btnMain.innerHTML='<i class="fas fa-play"></i>'; if(btnStop) btnStop.style.display='none'; }
        };
        window.toggleTimer=function(){
            const st=localStorage.getItem(timerKeyState)||'stopped';
            if(st==='stopped'){ localStorage.setItem(timerKeyState,'running'); localStorage.setItem(timerKeyStart,Date.now()); window.timerInterval=setInterval(window.upd,1000); }
            else if(st==='running'){ clearInterval(window.timerInterval); localStorage.setItem(timerKeyState,'paused'); localStorage.setItem(timerKeyPaused,Date.now()-parseInt(localStorage.getItem(timerKeyStart))); }
            else if(st==='paused'){ localStorage.setItem(timerKeyState,'running'); localStorage.setItem(timerKeyStart,Date.now()-parseInt(localStorage.getItem(timerKeyPaused))); window.timerInterval=setInterval(window.upd,1000); }
            window.upd();
        };
        window.stopTimer=function(){
            clearInterval(window.timerInterval); const st=localStorage.getItem(timerKeyState); let ms=0;
            if(st==='running') ms=Date.now()-parseInt(localStorage.getItem(timerKeyStart)); else if(st==='paused') ms=parseInt(localStorage.getItem(timerKeyPaused));
            const totalSec = Math.floor(ms/1000); const h = Math.floor(totalSec/3600); const m = Math.floor((totalSec%3600)/60);
            localStorage.setItem(timerKeyState,'stopped'); localStorage.removeItem(timerKeyStart); localStorage.removeItem(timerKeyPaused);
            window.location.href=`/adicionar?tempo_cronometro=${h}:${m}`;
        };
        if(localStorage.getItem(timerKeyState)==='running') window.timerInterval=setInterval(window.upd,1000);
        window.upd();
    })();
</script>



==================== FIM ARQUIVO: app/templates/partials/dashboard_content.html ====================

==================== INICIO ARQUIVO: app/templates/partials/history_list.html ====================
{% for r in registros %}
<a href="/editar/{{ r['id'] }}" class="history-card fade-in">
    <div class="h-date-group">
        <span class="h-day">{{ r['data'][-2:] }}</span>
        <span class="h-month">{{ r['data'][5:7] }}/{{ r['data'][2:4] }}</span>
    </div>
    <div class="h-info">
        <div class="h-title">{{ r['qtd_uber'] + r['qtd_99'] + r['qtd_part'] }} Viagens</div>
        <div class="h-badges">
            <span><i class="fas fa-clock"></i> {{ r['horas_trabalhadas']|float_to_time }}h</span>
            <span><i class="fas fa-road"></i> {{ "%.0f"|format(r['km_percorrido']) }}km</span>
        </div>
    </div>
    <div class="h-values">
        <div class="h-gain">+ R$ {{ "%.2f"|format(r['ganho_bruto']) }}</div>
        <div class="h-expense">- R$ {{ "%.2f"|format(r['despesa_combustivel'] + r['despesa_alimentacao'] + r['despesa_manutencao']) }}</div>
    </div>
</a>
{% endfor %}

{% if has_next %}
    <div id="load-more-container" class="text-center" style="margin-top: 20px; padding-bottom: 20px;">
        <button hx-get="{{ url_for('main.historico', page=page+1, tipo=tipo, valor=valor) }}"
                hx-target="#load-more-container" 
                hx-swap="outerHTML"
                class="btn-load-more">
            Carregar Mais <i class="fas fa-chevron-down"></i>
        </button>
        
        <!-- Indicador de Loading HTMX -->
        <span class="htmx-indicator" style="font-size:12px; color:#64748B;">
            <i class="fas fa-spinner fa-spin"></i> Buscando...
        </span>
    </div>
{% endif %}



==================== FIM ARQUIVO: app/templates/partials/history_list.html ====================

==================== INICIO ARQUIVO: app/static/style.css ====================
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&display=swap');

:root {
    --bg-body: #F0F4F8;
    --text-main: #0F172A;
    --text-secondary: #64748B;
    --primary: #2563EB; 
    --primary-gradient: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    --primary-light: rgba(37, 99, 235, 0.1);
    --success: #059669;
    --warning: #D97706;
    --danger: #DC2626;
    --gold: #F59E0B;
    --gold-gradient: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-border: 1px solid rgba(255, 255, 255, 0.9);
    --glass-highlight: rgba(255, 255, 255, 0.95);
    --glass-shadow: 0 4px 20px -5px rgba(30, 58, 138, 0.08);
    --backdrop-blur: blur(20px);
    --radius-card: 22px;
    --radius-btn: 18px;
    --nav-bg: rgba(255, 255, 255, 0.95);
}

body.dark-mode {
    --bg-body: #0B1120;
    --text-main: #F8FAFC;
    --text-secondary: #94A3B8;
    --glass-bg: rgba(30, 41, 59, 0.75);
    --glass-border: 1px solid rgba(255, 255, 255, 0.08);
    --glass-highlight: rgba(255, 255, 255, 0.15);
    --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    --nav-bg: rgba(15, 23, 42, 0.95);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; padding: 0;
    font-family: 'Plus Jakarta Sans', sans-serif;
    background-color: var(--bg-body);
    color: var(--text-main);
    min-height: 100vh;
    padding-bottom: 140px;
    overflow-x: hidden;
    display: flex; flex-direction: column; align-items: center;
}

/* LAYOUT E CARDS */
.app-shell { width: 100%; max-width: 480px; min-height: 100vh; position: relative; z-index: 10; margin: 0 auto; }
.container { padding: 0 20px; width: 100%; }

.header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; margin-top: 5px; width: 100%; max-width: 480px; }
.profile-section { display: flex; align-items: center; gap: 12px; cursor: default; }
.avatar-generic { width: 42px; height: 42px; border-radius: 14px; background: var(--glass-bg); border: var(--glass-border); backdrop-filter: var(--backdrop-blur); display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--primary); box-shadow: var(--glass-shadow); }
.greeting h1 { font-size: 16px; font-weight: 700; margin: 0; color: var(--text-main); }
.greeting p { font-size: 12px; color: var(--text-secondary); margin: 0; }
.btn-icon, .notification-btn, .back-btn { width: 40px; height: 40px; border-radius: 12px; background: var(--glass-bg); border: var(--glass-border); backdrop-filter: var(--backdrop-blur); display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--text-main); text-decoration: none; position: relative; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
.btn-icon:active, .notification-btn:active, .back-btn:active { transform: scale(0.95); }
.badge-dot { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 2px solid white; }

.mode-selector { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.03); padding: 4px; border-radius: 25px; width: fit-content; margin-left: auto; margin-right: auto; }
.mode-pill { background: transparent; border: none; font-size: 13px; font-weight: 600; color: var(--text-secondary); padding: 8px 24px; border-radius: 20px; transition: 0.2s; cursor: pointer; }
.mode-pill.active { background: var(--glass-bg); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: var(--glass-border); }

.date-strip-container { display: flex; gap: 8px; overflow-x: auto; padding: 5px 5px 20px 5px; scrollbar-width: none; margin: 0 -5px; scroll-behavior: smooth; scroll-snap-type: x mandatory; }
.date-strip-container::-webkit-scrollbar { display: none; }
.date-pill { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 58px; min-height: 75px; padding: 10px 5px; border-radius: 18px; background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.4); cursor: pointer; transition: all 0.3s; color: var(--text-secondary); flex-shrink: 0; scroll-snap-align: center; backdrop-filter: blur(5px); }
.date-pill span:first-child { font-size: 10px; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
.date-pill span:last-child { font-size: 14px; font-weight: 800; color: var(--text-main); text-align: center; line-height: 1.2; display: block; }
.date-pill.active { background: var(--glass-bg); border: var(--glass-border); border-top-color: var(--glass-highlight); box-shadow: 0 10px 25px rgba(37, 99, 235, 0.15); backdrop-filter: blur(12px); transform: translateY(-3px) scale(1.05); }
.date-pill.active span { color: var(--primary) !important; }
.date-pill.picker { background: var(--primary-light); border: 1px dashed var(--primary); color: var(--primary); }
.date-pill.picker i { font-size: 20px; margin-bottom: 5px; }

.glass-card, .card { background: var(--glass-bg); backdrop-filter: var(--backdrop-blur); border: var(--glass-border); border-top: 1px solid var(--glass-highlight); box-shadow: var(--glass-shadow); border-radius: var(--radius-card); padding: 20px; margin-bottom: 15px; position: relative; overflow: hidden; width: 100%; }
.card-title { font-size: 12px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

.filter-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
.filter-btn { background: var(--glass-bg); border: var(--glass-border); border-radius: 16px; padding: 12px 5px; text-align: center; position: relative; cursor: pointer; transition: 0.2s; box-shadow: var(--glass-shadow); }
.filter-btn.active { background: white; border-color: var(--primary); box-shadow: 0 4px 15px rgba(37, 99, 235, 0.15); }
.fb-label { font-size: 9px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; display: block; margin-bottom: 4px; }
.fb-value { font-size: 10px; font-weight: 800; color: var(--text-main); display: block; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.filter-btn.active .fb-value { color: var(--primary); }
.filter-input { position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0; cursor: pointer; }

/* ELEMENTOS HERO, TIMER, WIDGETS */
.hero-clickable { cursor: pointer; }
.hero-val-container { text-align: center; padding: 5px 0 20px 0; }
.hero-label { font-size: 11px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 5px; opacity: 0.8; }
.hero-value { font-size: 46px; font-weight: 800; color: var(--text-main); letter-spacing: -2px; line-height: 1; text-shadow: 0 2px 10px rgba(37,99,235,0.1); }
.hero-currency { font-size: 20px; color: var(--text-secondary); font-weight: 600; vertical-align: top; margin-right: 2px; }
.hero-hint { font-size: 10px; color: var(--primary); font-weight: 600; margin-top: 5px; opacity: 0.8; display: flex; align-items: center; justify-content: center; gap: 4px; }
.hero-footer-sutil { display: flex; justify-content: center; gap: 30px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px; margin-top: 5px; }
.hf-item { text-align: center; }
.hf-lbl { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; display: block; margin-bottom: 4px; }
.hf-val { font-size: 13px; font-weight: 700; color: var(--text-main); }
.val-green { color: var(--success); }
.val-red { color: var(--danger); }

.timer-glass { display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 100%); border: 1px solid rgba(255,255,255,0.6); padding: 12px 18px; border-radius: 18px; margin-bottom: 20px; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
.tm-left { display: flex; align-items: center; gap: 12px; }
.tm-icon { width: 34px; height: 34px; background: var(--primary-light); color: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
.tm-display { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; }
.tm-label { font-size: 9px; text-transform: uppercase; font-weight: 700; color: var(--text-secondary); margin-bottom: 2px; }
.btn-tm-play { background: var(--primary-gradient); color: white; border: none; width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3); transition: 0.2s; font-size: 13px; }
.btn-tm-stop { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: none; width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; margin-left: 10px; }

.widget-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.widget-card { background: var(--glass-bg); padding: 15px 10px; border-radius: 20px; text-align: center; box-shadow: var(--glass-shadow); border: var(--glass-border); display: flex; flex-direction: column; align-items: center; justify-content: center; }
.wc-icon { font-size: 18px; margin-bottom: 5px; color: var(--primary); }
.wc-val { font-size: 15px; font-weight: 800; color: var(--text-main); display: block; line-height: 1.2; }
.wc-lbl { font-size: 10px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; }

.perf-table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
.perf-table th { text-align: center; color: var(--text-secondary); font-weight: 600; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 9px; text-transform: uppercase; }
.perf-table td { padding: 10px 0; border-bottom: 1px dashed rgba(0,0,0,0.05); color: var(--text-main); font-weight: 600; font-size: 11px; text-align: center; }
.perf-table tr:last-child td { border-bottom: none; }
.val-profit { color: var(--primary); font-weight: 800; }

/* NAV FLUTUANTE */
.floating-nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--nav-bg); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 20px 50px rgba(0,0,0,0.15); padding: 8px 20px; border-radius: 35px; display: flex; align-items: center; justify-content: space-between; gap: 5px; z-index: 1000; width: 90%; max-width: 380px; }
.nav-item { width: 50px; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; cursor: pointer; transition: transform 0.1s, color 0.2s; text-decoration: none; color: var(--text-secondary); font-size: 20px; }
.nav-item:active { transform: scale(0.85); }
.nav-item.active { color: var(--primary); background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.nav-fab-menu { background: var(--primary-gradient); color: white; border-radius: 24px; width: 65px; height: 65px; font-size: 26px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4); transform: translateY(-35px); display: flex; align-items: center; justify-content: center; border: 4px solid var(--bg-body); text-decoration: none; transition: transform 0.1s; }
.nav-fab-menu:active { transform: translateY(-35px) scale(0.9); }

/* --- PREMIUM STYLES (NOVO) --- */
.premium-border { border: 2px solid var(--gold) !important; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4) !important; }
.text-gold { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900 !important; }
.crown-badge { position: absolute; top: -10px; right: -5px; font-size: 16px; color: var(--gold); transform: rotate(15deg); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
.badge-premium-drawer { background: var(--gold-gradient); color: white; font-size: 10px; padding: 3px 10px; border-radius: 12px; font-weight: 800; border: 1px solid rgba(255,255,255,0.4); display: inline-block; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3); }

/* --- MODAIS GLOBAIS --- */
.global-modal-overlay {
    display: none !important; 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); z-index: 10000;
    justify-content: center; align-items: center; backdrop-filter: blur(8px);
}
.global-modal-overlay.open { display: flex !important; }

.global-modal-card {
    background: var(--bg-body); width: 85%; max-width: 320px; padding: 30px;
    border-radius: 30px; text-align: center; position: relative;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
    animation: popUpModal 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.info-icon-circle { width: 70px; height: 70px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 30px; margin-bottom: 20px; }
.info-title { font-size: 20px; font-weight: 800; color: var(--text-main); margin-bottom: 10px; }
.info-text { font-size: 13px; color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6; }
.info-btn { background: var(--text-main); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: 700; width: 100%; cursor: pointer; }

/* DRAWER */
.drawer-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 9998; opacity: 0; transition: 0.3s; backdrop-filter: blur(4px); }
.drawer-overlay.open { opacity: 1; display: block; }
.drawer-panel { position: fixed; top: 0; left: 0; bottom: 0; width: 85%; max-width: 320px; height: 100vh; background: var(--bg-body); z-index: 9999; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 10px 0 40px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
.drawer-panel.open { transform: translateX(0); }
.drawer-header { background: var(--primary-gradient); padding: 50px 25px 30px 25px; color: white; border-bottom-right-radius: 40px; }
.user-row { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
.user-avatar-drawer { width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 24px; border: 4px solid rgba(255,255,255,0.2); position: relative; }
.user-data-drawer h3 { margin: 0; font-size: 18px; font-weight: 800; }
.user-data-drawer p { margin: 0; font-size: 12px; opacity: 0.8; }
.drawer-content { padding: 30px 20px; overflow-y: auto; flex: 1; }
.menu-label { font-size: 11px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin: 0 0 10px 10px; letter-spacing: 1px; }
.drawer-item { display: flex; align-items: center; gap: 15px; padding: 16px; border-radius: 16px; color: var(--text-main); text-decoration: none; transition: 0.2s; margin-bottom: 5px; }
.drawer-item:active { background: rgba(0,0,0,0.05); transform: scale(0.98); }
.drawer-icon { width: 36px; height: 36px; border-radius: 10px; background: var(--glass-bg); color: var(--primary); border: var(--glass-border); display: flex; align-items: center; justify-content: center; font-size: 16px; }
.drawer-text { font-size: 14px; font-weight: 600; }
.drawer-footer { padding: 25px; border-top: 1px solid rgba(0,0,0,0.05); text-align: center; }
.btn-logout-drawer { color: var(--danger); font-weight: 700; text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }

.fade-in { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(15px); }
@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
@keyframes popUpModal { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
input, select, textarea { width: 100%; padding: 16px; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.05); border-radius: 15px; font-family: inherit; font-size: 14px; color: var(--text-main); outline: none; }
input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
.btn { background: var(--primary-gradient); color: white; border: none; padding: 16px; border-radius: var(--radius-btn); font-weight: 700; width: 100%; cursor: pointer; box-shadow: 0 8px 25px -5px rgba(37, 99, 235, 0.3); transition: transform 0.1s; display: flex; justify-content: center; align-items: center; gap: 8px; text-decoration: none; }
.btn:active { transform: scale(0.97); }

/* UTIL: TOAST */
#toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-200%); background: #1E293B; color: white; padding: 12px 24px; border-radius: 50px; font-weight: 600; font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 99999; opacity: 0; transition: all 0.4s; pointer-events: none; }
#toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.blob { position: fixed; border-radius: 50%; filter: blur(90px); z-index: -1; opacity: 0.4; pointer-events: none; }



==================== FIM ARQUIVO: app/static/style.css ====================

==================== INICIO ARQUIVO: app/static/sw.js ====================
const CACHE_NAME = 'motoristapro-v1-glass-fix-pwa';
const ASSETS_TO_CACHE = [
  '/',
  '/offline.html',
  '/static/style.css',
  '/static/js/pwa.js',
  '/static/js/onboarding.js',
  '/static/js/tour.js',
  '/manifest.json',
  '/static/icons/icon-192.png',
  '/static/icons/icon-512.png',
  'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
  'https://cdn.jsdelivr.net/npm/chart.js',
  'https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap',
  'https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&display=swap',
  'https://unpkg.com/htmx.org@1.9.10',
  'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js',
  'https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css',
  'https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css',
  'https://cdn.jsdelivr.net/npm/flatpickr',
  'https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js',
  'https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/weekSelect/weekSelect.js'
];

self.addEventListener('install', (event) => {
  self.skipWaiting();
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      console.log('[SW] Cache aberto');
      return cache.addAll(ASSETS_TO_CACHE);
    })
  );
});

self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((keyList) => {
      return Promise.all(
        keyList.map((key) => {
          if (key !== CACHE_NAME) {
            console.log('[SW] Removendo cache antigo:', key);
            return caches.delete(key);
          }
        })
      );
    })
  );
  self.clients.claim();
});

self.addEventListener('fetch', (event) => {
  if (event.request.method !== 'GET') return;

  const url = new URL(event.request.url);

  // Cache First para Est√°ticos
  if (
    url.pathname.startsWith('/static') ||
    url.href.includes('cdnjs') ||
    url.href.includes('fonts.') ||
    url.href.includes('unpkg') ||
    url.href.includes('cdn.jsdelivr')
  ) {
    event.respondWith(
      caches.match(event.request).then((cachedResponse) => {
        if (cachedResponse) return cachedResponse;
        return fetch(event.request).then((networkResponse) => {
          return caches.open(CACHE_NAME).then((cache) => {
            cache.put(event.request, networkResponse.clone());
            return networkResponse;
          });
        });
      })
    );
    return;
  }

  // Network First para HTML
  if (event.request.mode === 'navigate') {
    event.respondWith(
      fetch(event.request).catch(() => caches.match('/offline.html'))
    );
  }
});




==================== FIM ARQUIVO: app/static/sw.js ====================

==================== INICIO ARQUIVO: app/static/manifest.json ====================
{
  "name": "Motorista Pro",
  "short_name": "MotoristaPro",
  "description": "Gest√£o financeira inteligente para motoristas de aplicativo.",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#F0F4F8",
  "theme_color": "#2563EB",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/static/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/static/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "screenshots": [],
  "categories": ["finance", "productivity", "utilities"],
  "lang": "pt-BR"
}



==================== FIM ARQUIVO: app/static/manifest.json ====================

==================== INICIO ARQUIVO: app/static/js/tour.js ====================
document.addEventListener('DOMContentLoaded', () => {
    // Atualizei a chave para for√ßar o tour a aparecer nesta nova vers√£o
    const tourKey = 'motorista_pro_tour_v14_final';
    const urlParams = new URLSearchParams(window.location.search);
    
    // Verifica se deve rodar o tour:
    // 1. Se vier do onboarding (?start_tour=true)
    // 2. OU se a chave n√£o existir no localStorage
    const shouldRun = urlParams.get('start_tour') === 'true' || !localStorage.getItem(tourKey);

    if (shouldRun) {
        // Limpa a URL
        if(urlParams.get('start_tour')) {
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({path:newUrl},'',newUrl);
        }

        // Aguarda a biblioteca carregar
        const checkDriver = setInterval(() => {
            if (window.driver && window.driver.driver) {
                clearInterval(checkDriver);
                initTour();
            }
        }, 200);
        
        setTimeout(() => clearInterval(checkDriver), 5000);
    }

    function initTour() {
        const driver = window.driver.driver;
        
        const driverObj = driver({
            showProgress: true,
            nextBtnText: 'Pr√≥ximo',
            prevBtnText: 'Voltar',
            doneBtnText: 'Come√ßar!',
            steps: [
                { 
                    element: '.header', 
                    popover: { 
                        title: 'Seu Painel de Comando', 
                        description: 'Aqui v√™ o seu perfil e as notifica√ß√µes importantes.' 
                    } 
                },
                { 
                    element: '.filter-group', 
                    popover: { 
                        title: 'Filtros de Tempo', 
                        description: 'Alterne entre Dia, Semana e M√™s para ver os seus ganhos.' 
                    } 
                },
                { 
                    element: '.hero-clickable', 
                    popover: { 
                        title: 'Lucro Real', 
                        description: 'O valor que realmente sobra no bolso ap√≥s descontar a manuten√ß√£o.' 
                    } 
                },
                { 
                    element: '.nav-fab-menu', 
                    popover: { 
                        title: 'Adicionar Dia', 
                        description: 'Toque no bot√£o + para lan√ßar os seus ganhos e despesas di√°rios.' 
                    } 
                },
                { 
                    element: '.floating-nav', 
                    popover: { 
                        title: 'Menu Principal', 
                        description: 'Aceda a Relat√≥rios, Calculadora, Manuten√ß√£o e Agenda por aqui.' 
                    } 
                }
            ],
            onDestroyed: () => {
                localStorage.setItem(tourKey, 'true');
            }
        });

        // Pequeno delay para garantir que o DOM renderizou
        setTimeout(() => driverObj.drive(), 800);
    }
});




==================== FIM ARQUIVO: app/static/js/tour.js ====================

==================== INICIO ARQUIVO: app/static/js/onboarding.js ====================
document.addEventListener('DOMContentLoaded', () => {
    
    // Configura√ß√£o das Dicas por P√°gina
    const ONBOARDING_STEPS = [
        {
            path: '/historico',
            key: 'seen_historico',
            icon: 'fas fa-book-open',
            title: 'Livro Caixa',
            text: 'Aqui fica o registo de todos os seus dias de trabalho. Pode tocar em qualquer cart√£o para <b>editar</b> ou <b>apagar</b> um lan√ßamento.'
        },
        {
            path: '/agenda',
            key: 'seen_agenda',
            icon: 'far fa-calendar-alt',
            title: 'Agenda de Corridas',
            text: 'Organize corridas particulares. Defina hor√°rio, valor e endere√ßo. Ao concluir, pode gerar um <b>Recibo Profissional (PDF)</b> para o passageiro.'
        },
        {
            path: '/adicionar',
            key: 'seen_adicionar',
            icon: 'fas fa-plus-circle',
            title: 'Fechar o Dia',
            text: 'Use esta tela ao final do turno. Lance o total ganho nos apps, a quilometragem e os gastos. O app calcula o lucro l√≠quido automaticamente.'
        },
        {
            path: '/relatorios',
            key: 'seen_relatorios',
            icon: 'fas fa-chart-pie',
            title: 'Relat√≥rios de Performance',
            text: 'Vis√£o de √°guia. Analise gr√°ficos de faturamento, compare o desempenho semanal ou mensal e exporte tudo para PDF (Premium).'
        },
        {
            path: '/manutencao',
            key: 'seen_manutencao',
            icon: 'fas fa-wrench',
            title: 'Manuten√ß√£o Inteligente',
            text: 'Cadastre itens como √ìleo ou Pneus. O app monitoriza a sua rodagem di√°ria e avisa a data prevista da pr√≥xima troca automaticamente.'
        },
        {
            path: '/calculadora',
            key: 'seen_calculadora',
            icon: 'fas fa-calculator',
            title: 'Ferramentas R√°pidas',
            text: '<b>Flex:</b> Saiba qual combust√≠vel compensa no posto.<br><b>Corrida:</b> Calcule o pre√ßo justo para cobrar em viagens particulares.'
        },
        {
            path: '/lucro_real',
            key: 'seen_lucro_real',
            icon: 'fas fa-chart-line',
            title: 'Lucro Real',
            text: 'A vis√£o mais importante. Aqui descontamos o desgaste invis√≠vel do carro (pneus, √≥leo, mec√¢nica) e custos fixos (IPVA/Seguro) para mostrar o <b>lucro verdadeiro</b>.'
        }
    ];

    const currentPath = window.location.pathname;

    // Procura se a p√°gina atual tem uma dica configurada
    const step = ONBOARDING_STEPS.find(s => currentPath.includes(s.path));

    if (step) {
        // Verifica se o usu√°rio j√° viu esta dica no navegador
        const hasSeen = localStorage.getItem(step.key);

        if (!hasSeen) {
            // Pequeno delay para a interface carregar antes do modal aparecer
            setTimeout(() => {
                // Fun√ß√£o global definida no base.html
                if (window.openGlobalModal) {
                    const iconEl = document.getElementById('infoIcon');
                    const titleEl = document.getElementById('infoTitle');
                    const textEl = document.getElementById('infoText');

                    if (iconEl && titleEl && textEl) {
                        iconEl.className = step.icon;
                        titleEl.innerHTML = step.title;
                        textEl.innerHTML = step.text;
                        
                        // Abre o modal
                        window.openGlobalModal('infoModal');
                        
                        // Marca como visto para n√£o incomodar novamente
                        localStorage.setItem(step.key, 'true');
                    }
                }
            }, 800);
        }
    }
});



==================== FIM ARQUIVO: app/static/js/onboarding.js ====================

==================== INICIO ARQUIVO: app/static/js/pwa.js ====================
// Vari√°veis Globais
let deferredPrompt;
const btnInstallId = 'btnInstall';

// 1. Captura o evento de instala√ß√£o (Android/Chrome)
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    console.log('PWA: Evento de instala√ß√£o capturado!');
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', showInstallButton);
    } else {
        showInstallButton();
    }
});

// 2. Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('SW Registado'))
            .catch(err => console.error('Erro SW:', err));
    }

    checkInstallState();
});

function checkInstallState() {
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    
    // Se j√° estiver instalado, esconde o bot√£o
    if (isStandalone) {
        const btn = document.getElementById(btnInstallId);
        if(btn) btn.style.display = 'none';
        return;
    }
    
    // Se o evento foi capturado antes do DOM carregar
    if (deferredPrompt) {
        showInstallButton();
    }
}

function showInstallButton() {
    const btn = document.getElementById(btnInstallId);
    if (btn) {
        // Exibe como flex para alinhar √≠cone e texto
        btn.style.display = 'flex'; 
    }
}

// 3. A√ß√£o do Bot√£o
function installApp(e) {
    if (e) e.preventDefault();
    
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('PWA: Instala√ß√£o aceita');
                const btn = document.getElementById(btnInstallId);
                if(btn) btn.style.display = 'none';
            } else {
                console.log('PWA: Instala√ß√£o recusada');
            }
            deferredPrompt = null;
        });
    } else {
        console.log('PWA: Instala√ß√£o n√£o dispon√≠vel neste navegador/dispositivo.');
    }
}




==================== FIM ARQUIVO: app/static/js/pwa.js ====================

==================== INICIO ARQUIVO: app/static/js/profile_upload.js ====================
const IMGBB_API_KEY = '94e16d456f7d01e647d473dde2674677'; // <--- INSIRA SUA CHAVE AQUI

document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileAvatar');
    const avatarImg = document.getElementById('avatarImg');
    const loadingSpinner = document.getElementById('avatarLoader');
    const avatarIcon = document.getElementById('avatarIcon');

    if (!fileInput) return;

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if(avatarImg) avatarImg.style.opacity = '0.5';
        if(avatarIcon) avatarIcon.style.opacity = '0.5';
        if(loadingSpinner) loadingSpinner.style.display = 'block';

        try {
            // 1. Comprimir
            const compressedFile = await compressImage(file);
            
            // 2. Upload para ImgBB
            const formData = new FormData();
            formData.append('image', compressedFile);

            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                const imageUrl = result.data.url;
                
                // 3. Salvar no Backend
                await saveToBackend(imageUrl);
                
                alert('Foto atualizada com sucesso!');
                // 4. Recarregar para atualizar em todo o app
                window.location.reload();
            } else {
                throw new Error('Falha no ImgBB: ' + (result.error ? result.error.message : 'Erro desconhecido'));
            }

        } catch (error) {
            console.error(error);
            alert('Erro ao enviar foto. Tente novamente.');
            if(avatarImg) avatarImg.style.opacity = '1';
            if(avatarIcon) avatarIcon.style.opacity = '1';
        } finally {
            if(loadingSpinner) loadingSpinner.style.display = 'none';
        }
    });
});

function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = event => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_SIZE = 300;
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                } else {
                    if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob(blob => { resolve(blob); }, 'image/jpeg', 0.8);
            };
            img.onerror = error => reject(error);
        };
        reader.onerror = error => reject(error);
    });
}

async function saveToBackend(url) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    await fetch('/update_avatar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({ url: url })
    });
}




==================== FIM ARQUIVO: app/static/js/profile_upload.js ====================

==================== INICIO ARQUIVO: app/services/gamification.py ====================
from app.models import Achievement, UserAchievement, Diario, Agendamentos
from app.extensions import db
from sqlalchemy import func

class AchievementService:
    @staticmethod
    def calculate_level(user):
        return "Motorista Pro", 100

    @staticmethod
    def get_badges_with_progress(user):
        try:
            # OTIMIZA√á√ÉO: Busca todas as conquistas do usu√°rio de uma vez s√≥ em mem√≥ria
            all_badges = Achievement.query.all()
            
            # Se n√£o houver conquistas cadastradas no sistema, retorna vazio sem erro
            if not all_badges:
                return [], []
            
            user_badges_query = UserAchievement.query.filter_by(user_id=user.id).all()
            user_badges = {ua.achievement_id: ua for ua in user_badges_query}
            
            badges_list = []
            new_unlocks = []
            
            stats = db.session.query(
                func.count(Diario.id),
                func.coalesce(func.sum(Diario.km_percorrido), 0),
                func.coalesce(func.sum(Diario.ganho_bruto), 0)
            ).filter_by(user_id=user.id).first()
            
            total_dias = stats[0] or 0
            total_km = stats[1]
            total_faturamento = stats[2]
            
            total_agendamentos = Agendamentos.query.filter_by(user_id=user.id, status='concluido').count()
            
            filtered_badges = []
            palavras_proibidas = ['bronze', 'prata', 'ouro', 'n√≠vel', 'investidor']
            for badge in all_badges:
                nome_lower = badge.nome.lower()
                id_lower = badge.id.lower()
                if any(p in nome_lower for p in palavras_proibidas) or any(p in id_lower for p in palavras_proibidas):
                    continue
                filtered_badges.append(badge)

            for badge in filtered_badges:
                if badge.id == 'lenda_viva': continue

                unlocked = badge.id in user_badges
                current = 0; target = 1
                
                if badge.id == 'primeira_marcha': current, target = total_dias, 1
                elif badge.id == 'maratonista': current, target = total_dias, 30
                elif badge.id == 'veterano': current, target = total_dias, 365
                elif badge.id == 'viajante': current, target = int(total_km), 1000
                elif badge.id == 'estradeiro': current, target = int(total_km), 10000
                elif badge.id == 'rei_da_pista': current, target = int(total_km), 50000
                elif badge.id == 'agenda_lotada': current, target = total_agendamentos, 5
                elif badge.id == 'executivo': current, target = total_agendamentos, 50
                elif badge.id == 'primeiro_k': current, target = int(total_faturamento), 1000
                elif badge.id == 'faturou_10k': current, target = int(total_faturamento), 10000
                elif badge.id == 'magnata': current, target = int(total_faturamento), 100000
                elif badge.id == 'empreendedor': current = 1 if unlocked else 0 
                elif badge.id == 'expert_manutencao': current = 1 if unlocked else 0
                
                progress = min(100, int((current / target) * 100)) if target > 0 else 0
                
                badges_list.append({
                    'id': badge.id,
                    'nome': badge.nome,
                    'descricao': badge.descricao,
                    'icone': badge.icone,
                    'categoria': badge.categoria,
                    'unlocked': unlocked,
                    'progress': progress if not unlocked else 100,
                    'current': current,
                    'target': target
                })
                
                if unlocked and not user_badges[badge.id].visto: new_unlocks.append(badge.id)

            total_possiveis = len(filtered_badges) - 1
            total_ganhos = len([b for b in badges_list if b['unlocked']])
            
            lenda_unlocked = 'lenda_viva' in user_badges
            if total_ganhos >= total_possiveis and not lenda_unlocked and total_possiveis > 0:
                 db.session.add(UserAchievement(user_id=user.id, achievement_id='lenda_viva'))
                 db.session.commit()
                 lenda_unlocked = True
                 new_unlocks.append('lenda_viva')

            badges_list.append({
                'id': 'lenda_viva',
                'nome': 'Lenda Viva',
                'descricao': 'Zere o jogo completando todas as conquistas.',
                'icone': 'üëë',
                'categoria': 'master',
                'unlocked': lenda_unlocked,
                'progress': int((total_ganhos / total_possiveis) * 100) if total_possiveis > 0 else 0,
                'current': total_ganhos,
                'target': total_possiveis
            })

            return badges_list, new_unlocks
        except Exception as e:
            print(f"Erro Gamification Service: {e}")
            # Em caso de erro, retorna listas vazias para n√£o travar a aplica√ß√£o
            return [], []

    @staticmethod
    def check_new_entries(user):
        try:
            unlocks = []
            stats = db.session.query(
                func.count(Diario.id),
                func.coalesce(func.sum(Diario.km_percorrido), 0),
                func.coalesce(func.sum(Diario.ganho_bruto), 0)
            ).filter_by(user_id=user.id).first()
            
            total_dias = stats[0] or 0
            total_km = stats[1]
            total_fat = stats[2]
            
            existing_ids = {ua.achievement_id for ua in UserAchievement.query.filter_by(user_id=user.id).all()}
            
            def give(bid):
                if bid not in existing_ids:
                    # Verifica se o achievement existe antes de dar
                    if db.session.query(Achievement.id).filter_by(id=bid).first():
                        db.session.add(UserAchievement(user_id=user.id, achievement_id=bid))
                        unlocks.append(bid)
                        existing_ids.add(bid)

            if total_dias >= 1: give('primeira_marcha')
            if total_dias >= 30: give('maratonista')
            if total_dias >= 365: give('veterano')
            
            if total_km >= 1000: give('viajante')
            if total_km >= 10000: give('estradeiro')
            if total_km >= 50000: give('rei_da_pista')
            
            if total_fat >= 1000: give('primeiro_k')
            if total_fat >= 10000: give('faturou_10k')
            if total_fat >= 100000: give('magnata')

            if unlocks:
                db.session.commit()
            return unlocks
        except:
            return []

    @staticmethod
    def check_usage(user, action_type):
        try:
            unlocks = []
            existing_ids = {ua.achievement_id for ua in UserAchievement.query.filter_by(user_id=user.id).all()}
            
            if action_type == 'agenda_concluir':
                total = Agendamentos.query.filter_by(user_id=user.id, status='concluido').count()
                if total >= 5 and 'agenda_lotada' not in existing_ids:
                    if db.session.query(Achievement.id).filter_by(id='agenda_lotada').first():
                        db.session.add(UserAchievement(user_id=user.id, achievement_id='agenda_lotada'))
                        unlocks.append('agenda_lotada')
                if total >= 50 and 'executivo' not in existing_ids:
                    if db.session.query(Achievement.id).filter_by(id='executivo').first():
                        db.session.add(UserAchievement(user_id=user.id, achievement_id='executivo'))
                        unlocks.append('executivo')
            
            elif action_type == 'recibo':
                 if 'empreendedor' not in existing_ids:
                    if db.session.query(Achievement.id).filter_by(id='empreendedor').first():
                        db.session.add(UserAchievement(user_id=user.id, achievement_id='empreendedor'))
                        unlocks.append('empreendedor')

            if unlocks:
                db.session.commit()
            return unlocks
        except:
            return []
        
    @staticmethod
    def check_meta(user): return []
    @staticmethod
    def check_setup(user): return []



==================== FIM ARQUIVO: app/services/gamification.py ====================

==================== INICIO ARQUIVO: app/services/__init__.py ====================
from sqlalchemy import func, extract, and_
from datetime import datetime, date, timedelta
from dateutil.relativedelta import relativedelta
from app.extensions import db
from app.models import Diario, Config, Manutencao, MaintenanceLog, CustosFixos
from app.utils import safe_float, safe_money, get_config, get_brasilia_now
from decimal import Decimal
import calendar

# Mapeamento de meses para gr√°ficos
MESES_PT = {1: 'Jan', 2: 'Fev', 3: 'Mar', 4: 'Abr', 5: 'Mai', 6: 'Jun', 7: 'Jul', 8: 'Ago', 9: 'Set', 10: 'Out', 11: 'Nov', 12: 'Dez'}

def get_current_week_range():
    """Retorna start_date (Domingo) e end_date (S√°bado) da semana atual."""
    hoje = get_brasilia_now().date()
    # Ajuste para Domingo=0: (weekday + 1) % 7
    idx_domingo = (hoje.weekday() + 1) % 7
    start = hoje - timedelta(days=idx_domingo) # Domingo
    end = start + timedelta(days=6)            # S√°bado
    return start, end

def generate_week_options(year):
    """Gera lista de semanas para o dropdown (Domingo a S√°bado)."""
    hoje = get_brasilia_now().date()
    try:
        d = date(year, 1, 1)
        idx_domingo = (d.weekday() + 1) % 7
        start_week_1 = d - timedelta(days=idx_domingo)
        
        d = start_week_1
        weeks = []
        
        while d.year == year or (d + timedelta(days=6)).year == year:
            start_date = d
            end_date = d + timedelta(days=6)
            label = f"{start_date.strftime('%d/%m')} - {end_date.strftime('%d/%m')}"
            weeks.append({'value': start_date.strftime('%Y-%m-%d'), 'label': label})
            d += timedelta(weeks=1)
            if d.year > year + 1: break
        
        current_start, _ = get_current_week_range()
        
        if year == hoje.year:
            # Adiciona op√ß√£o de destaque "Esta Semana"
            weeks.insert(0, {
                'value': current_start.strftime('%Y-%m-%d'), 
                'label': f"ESTA SEMANA: {current_start.strftime('%d/%m')} - {(current_start + timedelta(days=6)).strftime('%d/%m')}"
            })
            
            # Remove duplicatas
            seen = set()
            unique_weeks = []
            for w in weeks:
                if w['value'] not in seen:
                    unique_weeks.append(w)
                    seen.add(w['value'])
            return unique_weeks
            
        return weeks
    except Exception as e:
        print(f"Erro generate_week_options: {e}")
        return []

# --- FUN√á√ÉO DE COMPATIBILIDADE (CR√çTICA PARA EVITAR ERRO) ---
def get_semanas_dropdown(year):
    return generate_week_options(year)

def get_filter_label(tipo, start, end):
    if tipo == 'dia': return start.strftime('%d/%m/%Y')
    elif tipo == 'semana': return f"{start.strftime('%d/%m')} - {end.strftime('%d/%m')}"
    elif tipo == 'mes': return f"{MESES_PT.get(start.month, '')[:3]}/{start.year}"
    elif tipo == 'anual': return f"{start.year}"
    return "Per√≠odo"

def get_date_range_local(tipo, valor):
    hoje_dt = get_brasilia_now()
    hoje = hoje_dt.date()
    start_date = end_date = hoje
    valor_ajustado = valor
    titulo = ""

    if tipo == 'dia':
        if not valor: valor = hoje.strftime('%Y-%m-%d')
        try: start_date = end_date = datetime.strptime(valor, '%Y-%m-%d').date()
        except: start_date = end_date = hoje
        valor_ajustado = start_date.strftime('%Y-%m-%d')
        titulo = start_date.strftime('%d/%m')
    
    elif tipo == 'semana':
        try:
            if valor:
                ref_date = datetime.strptime(valor, '%Y-%m-%d').date()
                start_date = ref_date
                end_date = start_date + timedelta(days=6)
            else:
                start_date, end_date = get_current_week_range()
            valor_ajustado = start_date.strftime('%Y-%m-%d')
            titulo = f"{start_date.strftime('%d/%m')} a {end_date.strftime('%d/%m')}"
        except:
            start_date, end_date = get_current_week_range()
            valor_ajustado = start_date.strftime('%Y-%m-%d')

    elif tipo == 'mes':
        try:
            if not valor: valor = hoje.strftime('%Y-%m')
            dt = datetime.strptime(valor + '-01', '%Y-%m-%d').date()
            start_date = dt
            end_date = date(dt.year, dt.month, calendar.monthrange(dt.year, dt.month)[1])
            valor_ajustado = valor
            titulo = MESES_PT.get(start_date.month, str(start_date.month))
        except:
            start_date = date(hoje.year, hoje.month, 1)
            end_date = date(hoje.year, hoje.month, calendar.monthrange(hoje.year, hoje.month)[1])
            valor_ajustado = hoje.strftime('%Y-%m')
        
    elif tipo == 'anual':
        try:
            if not valor: valor = str(hoje.year)
            ano = int(valor)
            start_date = date(ano, 1, 1)
            end_date = date(ano, 12, 31)
            valor_ajustado = str(ano)
            titulo = f"Ano {ano}"
        except:
            start_date = date(hoje.year, 1, 1)
            end_date = date(hoje.year, 12, 31)
            valor_ajustado = str(hoje.year)
        
    return start_date, end_date, titulo, valor_ajustado

def get_maintenance_prediction(user):
    try:
        km_inicial = safe_float(get_config(user.id, 'km_atual_carro'))
        km_rodado_total = db.session.query(func.sum(Diario.km_percorrido)).filter_by(user_id=user.id).scalar() or 0.0
        odo_atual = km_inicial + km_rodado_total

        hoje = get_brasilia_now().date()
        data_30_dias = hoje - timedelta(days=30)
        km_30_dias = db.session.query(func.sum(Diario.km_percorrido)).filter(Diario.user_id == user.id, Diario.data >= data_30_dias).scalar() or 0.0
        media_km_dia = float(km_30_dias) / 30.0

        itens = Manutencao.query.filter_by(user_id=user.id).all()
        resultado = []

        for i in itens:
            km_alvo = float(i.km_proxima)
            falta = km_alvo - odo_atual
            
            if falta <= 0: urgencia = 'critica'; previsao_txt = "VENCIDO!"
            elif falta < 500: urgencia = 'alta'; previsao_txt = "Esta Semana"
            elif falta < 1500: urgencia = 'media'; previsao_txt = "Em Breve"
            else: urgencia = 'baixa'; previsao_txt = "Tranquilo"

            if falta > 0 and media_km_dia > 10:
                dias_restantes = int(falta / media_km_dia)
                data_prevista = hoje + timedelta(days=dias_restantes)
                previsao_txt = data_prevista.strftime('%d/%m/%Y')
            elif falta > 0: previsao_txt = "Calculando..."

            resultado.append({'id': i.id, 'item': i.item, 'km_proxima': km_alvo, 'falta_km': falta, 'urgencia': urgencia, 'previsao_txt': previsao_txt})

        resultado.sort(key=lambda x: x['falta_km'])
        return odo_atual, resultado
    except Exception as e:
        print(f"Erro Manutencao Service: {e}")
        return 0.0, []

def calculate_dashboard(user, start_date, end_date):
    ganho = Decimal('0.00'); despesa_var = Decimal('0.00'); operacional = Decimal('0.00')
    km = 0.0; horas = 0.0
    metricas = {'ganho_km': 0, 'ganho_h': 0, 'ganho_corr': 0, 'ganho_dia': 0, 'lucro_km': 0, 'lucro_h': 0, 'lucro_corr': 0, 'lucro_dia': 0}
    dados_apps = [0,0,0,0]; lista_despesas = []; dados_rosca = []
    
    resumo_db = Diario.query.filter_by(user_id=user.id).filter(Diario.data >= start_date, Diario.data <= end_date).with_entities(
        func.sum(Diario.ganho_bruto), func.sum(Diario.despesa_combustivel), func.sum(Diario.despesa_alimentacao), func.sum(Diario.despesa_manutencao), 
        func.sum(Diario.km_percorrido), func.sum(Diario.horas_trabalhadas), func.sum(Diario.ganho_uber), func.sum(Diario.ganho_99), 
        func.sum(Diario.ganho_part), func.sum(Diario.ganho_outros), func.sum(Diario.qtd_uber), func.sum(Diario.qtd_99), 
        func.sum(Diario.qtd_part), func.sum(Diario.qtd_outros), func.count(Diario.id)
    ).first()

    total_corridas = 0; dias_trabalhados = 0

    if resumo_db and resumo_db[0] is not None:
        to_dec = lambda v: Decimal(str(v)) if v is not None else Decimal('0.00')
        ganho = to_dec(resumo_db[0])
        d_comb = to_dec(resumo_db[1]); d_alim = to_dec(resumo_db[2]); d_manu = to_dec(resumo_db[3])
        km = float(resumo_db[4] or 0.0); horas = float(resumo_db[5] or 0.0)
        
        g_uber = to_dec(resumo_db[6]); g_99 = to_dec(resumo_db[7]); g_part = to_dec(resumo_db[8]); g_out = to_dec(resumo_db[9])
        q_uber = int(resumo_db[10] or 0); q_99 = int(resumo_db[11] or 0); q_part = int(resumo_db[12] or 0); q_out = int(resumo_db[13] or 0)
        dias_trabalhados = int(resumo_db[14] or 0)
        
        despesa_var = d_comb + d_alim + d_manu; operacional = ganho - despesa_var
        dados_apps = [float(g_uber), float(g_99), float(g_part), float(g_out)]
        total_corridas = q_uber + q_99 + q_part + q_out
        
        if km > 0: metricas['ganho_km'] = float(ganho)/km; metricas['lucro_km'] = float(operacional)/km
        if horas > 0: metricas['ganho_h'] = float(ganho)/horas; metricas['lucro_h'] = float(operacional)/horas
        if total_corridas > 0: metricas['ganho_corr'] = float(ganho)/total_corridas; metricas['lucro_corr'] = float(operacional)/total_corridas
        if dias_trabalhados > 0: metricas['ganho_dia'] = float(ganho)/dias_trabalhados; metricas['lucro_dia'] = float(operacional)/dias_trabalhados
        
        lista_despesas = [{'nome':'Combust√≠vel','valor':float(d_comb),'cor':'#FFC107'}, {'nome':'Alimenta√ß√£o','valor':float(d_alim),'cor':'#FF5722'}, {'nome':'Manuten√ß√£o','valor':float(d_manu),'cor':'#9E9E9E'}]
        dados_rosca = [d['valor'] for d in lista_despesas]
    
    soma_apps = {'Uber': 0, '99': 0, 'Particular': 0, 'Outros': 0}
    if resumo_db and resumo_db[6] is not None:
         soma_apps['Uber'] = resumo_db[6] or 0; soma_apps['99'] = resumo_db[7] or 0; soma_apps['Particular'] = resumo_db[8] or 0; soma_apps['Outros'] = resumo_db[9] or 0

    domingo_atual, sabado_atual = get_current_week_range()
    acumulado_semanal_db = db.session.query(func.sum(Diario.ganho_bruto) - func.sum(func.coalesce(Diario.despesa_combustivel, 0) + func.coalesce(Diario.despesa_alimentacao, 0) + func.coalesce(Diario.despesa_manutencao, 0))).filter(Diario.user_id == user.id, Diario.data >= domingo_atual, Diario.data <= sabado_atual).scalar()
    lucro_semanal_acumulado = Decimal(str(acumulado_semanal_db)) if acumulado_semanal_db else Decimal('0.00')

    odo_atual, lista_manutencao = get_maintenance_prediction(user)
    lista_manutencao_dash = lista_manutencao[:3]

    return {'ganho': float(ganho), 'despesa_var': float(despesa_var), 'km': km, 'horas': horas, 'operacional': float(operacional), 'total_corridas': total_corridas, 'metricas': metricas, 'dados_apps': soma_apps, 'lista_despesas': lista_despesas, 'dados_rosca': dados_rosca, 'lucro_semanal_acumulado': float(lucro_semanal_acumulado), 'odo_atual': odo_atual, 'lista_manutencao': lista_manutencao_dash}

def calculate_smart_goal(user, lucro_acumulado, meta_semanal, metricas):
    meta_semanal = float(meta_semanal)
    if meta_semanal <= 0: return {'status': 'sem_meta', 'msg': 'Defina sua meta semanal!'}
    
    hoje = get_brasilia_now().date()
    ganho_hoje_res = db.session.query(func.sum(Diario.ganho_bruto), func.sum(Diario.despesa_combustivel + Diario.despesa_alimentacao + Diario.despesa_manutencao)).filter_by(user_id=user.id, data=hoje).first()
    gh = float(ganho_hoje_res[0] or 0); dh = float(ganho_hoje_res[1] or 0); lucro_hoje = gh - dh
    
    acumulado_total = float(lucro_acumulado)
    acumulado_anterior = acumulado_total - lucro_hoje 
    saldo_restante_inicio_dia = meta_semanal - acumulado_anterior
    
    if saldo_restante_inicio_dia <= 0: return {'status': 'superavit', 'msg': f"üèÜ Meta semanal j√° batida! Tudo hoje √© lucro extra.", 'hoje': lucro_hoje, 'meta_hoje': 0}

    idx_dia = (hoje.weekday() + 1) % 7; dias_restantes = 7 - idx_dia 
    if dias_restantes <= 0: dias_restantes = 1
    
    meta_do_dia = saldo_restante_inicio_dia / dias_restantes
    diff = lucro_hoje - meta_do_dia
    
    if diff >= 0:
        if diff > (meta_do_dia * 0.1): msg = f"üöÄ Incr√≠vel! Superou a meta l√≠quida de hoje em R$ {diff:.0f}."
        else: msg = f"‚úÖ Parab√©ns! Meta l√≠quida do dia batida."
        status = 'concluido'
    else:
        falta = abs(diff)
        msg = f"üéØ Meta l√≠quida de hoje: R$ {meta_do_dia:.0f}. Faltam R$ {falta:.0f} de lucro."
        status = 'pendente'

    return {'status': status, 'msg': msg, 'meta_hoje': meta_do_dia, 'hoje': lucro_hoje, 'falta_hoje': abs(diff) if diff < 0 else 0}




==================== FIM ARQUIVO: app/services/__init__.py ====================

==================== INICIO ARQUIVO: tests/conftest.py ====================
import pytest
from app import create_app
from app.extensions import db
from app.models import User
from config import Config

# Cria uma configura√ß√£o espec√≠fica para testes
class TestConfig(Config):
    TESTING = True
    # Usa SQLite em mem√≥ria (muito r√°pido e n√£o afeta o banco real)
    SQLALCHEMY_DATABASE_URI = 'sqlite:///:memory:'
    
    # --- CORRE√á√ÉO DO ERRO ---
    # Zera as configura√ß√µes de pool do Postgres, pois o SQLite n√£o suporta
    SQLALCHEMY_ENGINE_OPTIONS = {}
    
    # Desabilita prote√ß√£o CSRF nos testes para facilitar
    WTF_CSRF_ENABLED = False
    # Desabilita limita√ß√£o de taxa (Rate Limit) nos testes
    RATELIMIT_ENABLED = False

@pytest.fixture(scope='module')
def app():
    """Cria a inst√¢ncia da aplica√ß√£o Flask para o teste."""
    app = create_app(TestConfig)
    
    # Cria o contexto da aplica√ß√£o
    with app.app_context():
        yield app

@pytest.fixture(scope='module')
def test_client(app):
    """Cria um cliente HTTP simulado."""
    return app.test_client()

@pytest.fixture(scope='function')
def init_database(app):
    """
    Cria o banco de dados e as tabelas para cada teste.
    Depois do teste, apaga tudo.
    """
    db.create_all()
    
    # Cria um usu√°rio de teste padr√£o
    user = User(
        email='teste@motorista.pro', 
        nome='Tester', 
        password_hash='fakehash',
        category='subscriber',
        is_confirmed=True
    )
    db.session.add(user)
    db.session.commit()
    
    yield db  # Roda o teste aqui
    
    db.session.remove()
    db.drop_all()

@pytest.fixture(scope='function')
def sample_user(init_database):
    """Retorna o usu√°rio de teste j√° criado no banco."""
    return User.query.first()




==================== FIM ARQUIVO: tests/conftest.py ====================

==================== INICIO ARQUIVO: tests/test_financial.py ====================
import pytest
from decimal import Decimal
from datetime import date
from app.utils import safe_money
from app.services import calculate_dashboard
from app.models import Diario
from app.extensions import db

def test_safe_money_conversion():
    assert safe_money("R$ 1.200,50") == Decimal('1200.50')
    assert safe_money(19.90) == Decimal('19.90')
    assert safe_money(None) == Decimal('0.00')

def test_calculo_dashboard_precisao(app, sample_user):
    d1 = Diario(user_id=sample_user.id, data=date(2025, 1, 1), ganho_bruto=Decimal('100.10'), despesa_combustivel=Decimal('33.33'))
    d2 = Diario(user_id=sample_user.id, data=date(2025, 1, 2), ganho_bruto=Decimal('50.05'), despesa_combustivel=Decimal('0.00'))
    db.session.add_all([d1, d2])
    db.session.commit()
    
    resultado = calculate_dashboard(sample_user, date(2025, 1, 1), date(2025, 1, 31))
    
    assert resultado['ganho'] == 150.15 
    assert resultado['despesa_var'] == 33.33
    assert resultado['operacional'] == 116.82




==================== FIM ARQUIVO: tests/test_financial.py ====================
