<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrar - Motorista Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body { background-color: #F0F4F8; min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; padding: 20px; font-family: 'Plus Jakarta Sans', sans-serif; }
        .auth-card { background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.9); box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-radius: 30px; padding: 40px 30px; width: 100%; max-width: 380px; text-align: center; }
        .input-group { position: relative; margin-bottom: 15px; text-align: left; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #64748B; }
        .auth-input { width: 100%; padding: 16px 15px 16px 45px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); color: #0F172A; font-family: inherit; font-size: 14px; outline: none; box-sizing: border-box; }
        .auth-input:focus { background: white; border-color: #2563EB; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        
        .btn-auth { background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); border: none; width: 100%; padding: 18px; border-radius: 16px; color: white; font-weight: 800; font-size: 15px; cursor: pointer; margin-top: 10px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); transition: transform 0.2s; }
        .btn-auth:active { transform: scale(0.97); }
        
        /* BOTÃO GOOGLE */
        .btn-google {
            background: white; border: 1px solid #e2e8f0; width: 100%; padding: 15px; border-radius: 16px;
            color: #1e293b; font-weight: 700; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 20px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-google:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-google:active { transform: scale(0.98); }
        .google-icon { width: 20px; height: 20px; }

        .divider { display: flex; align-items: center; margin: 20px 0; color: #94a3b8; font-size: 12px; font-weight: 600; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }
        .divider span { padding: 0 10px; }

        .pass-eye { right: 15px; left: auto !important; cursor: pointer; }
        .app-logo-img { width: 80px; height: 80px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(37,99,235,0.25); object-fit: cover; }
    </style>
</head>
<body>
    <div style="position:fixed; top:-10%; left:-20%; width:400px; height:400px; background:#BFDBFE; filter:blur(90px); border-radius:50%; z-index:-1; opacity:0.5;"></div>
    <div style="position:fixed; bottom:10%; right:-10%; width:350px; height:350px; background:#C7D2FE; filter:blur(90px); border-radius:50%; z-index:-1; opacity:0.5;"></div>

    <div class="auth-card">
        <img src="/static/icons/icon-192.png" alt="Motorista Pro" class="app-logo-img">
        
        <h2 style="margin:0 0 5px 0; font-size:24px; font-weight:800; color:#0F172A;">Bem-vindo</h2>
        <p style="margin:0 0 20px 0; font-size:14px; color:#64748B;">Faça login para gerir os seus ganhos.</p>
        
        <div id="errorBox" style="background:#FEF2F2; color:#DC2626; padding:12px; border-radius:12px; font-size:13px; font-weight:600; margin-bottom:20px; display:none; border:1px solid #FCA5A5; word-wrap: break-word;"></div>
        
        <!-- BOTÃO GOOGLE -->
        <button type="button" class="btn-google" id="btnGoogle">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon">
            Continuar com Google
        </button>

        <div class="divider"><span>OU</span></div>

        <form id="loginForm">
            <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="email" class="auth-input" placeholder="Seu E-mail" required></div>
            <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="senha" class="auth-input" placeholder="Sua Senha" required><i class="fas fa-eye pass-eye" onclick="togglePass()"></i></div>
            <button type="submit" class="btn-auth" id="btnLogin">ENTRAR</button>
            <div id="loader" style="display:none; margin:10px auto; border:3px solid rgba(37,99,235,0.2); border-radius:50%; border-top:3px solid #2563EB; width:24px; height:24px; animation:spin 1s linear infinite;"></div>
            <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
        </form>
        
        <div style="margin-top:25px; display:flex; justify-content:space-between; font-size:13px; font-weight:600;">
            <a href="/recuperar_senha" style="color:#64748B; text-decoration:none;">Esqueci a senha</a>
            <a href="/register" style="color:#2563EB; text-decoration:none;">Criar Conta</a>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      
      const errorBox = document.getElementById('errorBox');
      const loader = document.getElementById('loader');
      const btnLogin = document.getElementById('btnLogin');
      const btnGoogle = document.getElementById('btnGoogle');

      function setLoading(isLoading) {
          loader.style.display = isLoading ? 'block' : 'none';
          btnLogin.style.display = isLoading ? 'none' : 'block';
          btnGoogle.style.opacity = isLoading ? '0.5' : '1';
          btnGoogle.style.pointerEvents = isLoading ? 'none' : 'auto';
      }

      try {
          const configRaw = '{{ FIREBASE_CONFIG_FRONTEND | safe }}';
          let firebaseConfig = JSON.parse(configRaw);
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);
          const googleProvider = new GoogleAuthProvider();

          // LOGIN EMAIL/SENHA
          document.getElementById('loginForm').addEventListener('submit', async (e) => {
              e.preventDefault();
              errorBox.style.display = 'none'; setLoading(true);
              
              const email = document.getElementById('email').value;
              const password = document.getElementById('senha').value;
              
              try {
                  const userCredential = await signInWithEmailAndPassword(auth, email, password);
                  await sendTokenToBackend(userCredential.user);
              } catch (error) {
                  handleAuthError(error);
              }
          });

          // LOGIN GOOGLE
          btnGoogle.addEventListener('click', async () => {
              errorBox.style.display = 'none';
              try {
                  const result = await signInWithPopup(auth, googleProvider);
                  // Aqui pegamos a foto do Google!
                  await sendTokenToBackend(result.user);
              } catch (error) {
                  handleAuthError(error);
              }
          });

          async function sendTokenToBackend(user) {
              setLoading(true);
              const idToken = await user.getIdToken(true);
              
              const response = await fetch('/auth/firebase_auth', { 
                  method: 'POST', 
                  headers: {'Content-Type': 'application/json'}, 
                  body: JSON.stringify({ 
                      idToken: idToken, 
                      nome: user.displayName, 
                      email: user.email,
                      photoURL: user.photoURL, // Enviando a foto
                      mode: 'login' 
                  }) 
              });
              
              const result = await response.json();
              if (result.success) { 
                  window.location.href = result.redirect; 
              } else { 
                  await signOut(auth); 
                  throw new Error(result.message); 
              }
          }

          function handleAuthError(error) {
              setLoading(false);
              let msg = error.message;
              if (error.code === 'auth/invalid-login-credentials' || error.code === 'auth/wrong-password') msg = "E-mail ou senha incorretos.";
              else if (error.code === 'auth/popup-closed-by-user') msg = "Login cancelado.";
              else if (error.code === 'auth/user-not-found') msg = "Usuário não encontrado.";
              
              errorBox.innerText = msg; 
              errorBox.style.display = 'block';
          }

          window.togglePass = function() { const i = document.getElementById('senha'); i.type = i.type === 'password' ? 'text' : 'password'; }
      } catch(err) { 
          console.error("Config Error:", err);
          errorBox.innerText = "Erro de configuração."; errorBox.style.display='block'; 
      }
    </script>
</body>
</html>



